---
title: "Biodomain NW & Key Drivers"
author: "Greg Cary"
date: "`r Sys.Date()`"
output: 
  html_document: 
    fig_width: 5
    fig_height: 4
  html_notebook:
    code_folding: hide
    theme: readable
    css: style.css
    toc: true
    toc_float: true
---
# Setup

```{r setup}
# # Package names
# packages <- c(
#   # 'paxtoolsr','org.Hs.eg.db','HotNetvieweR','clusterProfiler', 
#   'synapser','igraph','tidygraph','ggraph','tidyverse'
#   )
# 
# # Load packages
# invisible(lapply(packages, library, character.only = TRUE))

library(synapser)
library(igraph)
library(tidygraph)
library(ggraph)
library(tidyverse)

source('../../treatAD_biodomains/scripts/biodom_tally.R')
source('../../treatAD_biodomains/scripts/annotate_enr_term_biodomains.R')
source('../../treatAD_biodomains/scripts/biodom_enr_plots.R')

theme_set(theme_bw())
```

# Data
Grab relevant data from synapse, including:
1) Target Risk Scores ([syn25575156](https://www.synapse.org/#!Synapse:syn25575156){target="_blank"}) and Omics Scores ([syn22758536](https://www.synapse.org/#!Synapse:syn22758536){target="_blank"})  
2) Biodomain Definitions ([syn25428992](https://www.synapse.org/#!Synapse:syn25428992){target="_blank"})  
2) Risk-enriched Biodomain Terms ([syn45824995](https://www.synapse.org/#!Synapse:syn45824995){target="_blank"})
3) Base Network ([syn51110930](https://www.synapse.org/#!Synapse:syn51110930){target="_blank"})  
4) Synapse IDs of path-traced NW objects  
5) Synapse IDs of wKDA results 
6) CRISPRbrain simple phenotype screen data  

```{r}
synLogin()

# target risk scores
scores <- read_csv(
  synTableQuery('select * from syn25575156', includeRowIdAndRowVersion = F)$filepath
  , col_types = cols())
omics <- read_csv(
  synTableQuery('select * from syn22758536', includeRowIdAndRowVersion = F)$filepath
  , col_types = cols())

# biological domain annotations
biodom <- full_join(
  # biodomains
  readRDS(synGet('syn25428992')$path),
  # domain labels
  read_csv(synGet('syn26856828')$path, col_types = cols()),
  by = c('Biodomain'='domain')
) %>%
  mutate(Biodomain = case_when(Biodomain == 'none' ~ NA_character_, T ~ Biodomain))

domains = biodom %>% pull(Biodomain) %>% unique() %>% sort()

# enriched biodomain terms
enr.bd <- read_csv( synGet('syn45824995')$path, col_types = cols() ) %>% 
  mutate(leadingEdge_genes = str_split(leadingEdge_genes, '\\|'))

# base network
base_net <- igraph::read_graph(synGet('syn51110930')$path, format = 'graphml') 

# specify directed edge types
directed_edge_types = c("catalysis-precedes",
                        "controls-expression-of",
                        "controls-phosphorylation-of",
                        "controls-state-change-of",
                        "controls-transport-of"
                        )
```

pre-filtered NWs    
```{r}
undir <- base_net

# filt node & edge
tmp <- igraph::delete_vertices(
  base_net,
  igraph::V(base_net)[ igraph::V(base_net)$brain_exp == 0 ]
)
undir_node_edge <- igraph::subgraph.edges(
  tmp,
  igraph::E(tmp)[ igraph::E(tmp)$n_edge_evidence > 1 ],
  delete.vertices = T 
)

# filt node
undir_node <- igraph::delete_vertices(
    base_net,
    igraph::V(base_net)[ igraph::V(base_net)$brain_exp == 0 ]
  )

# filt edge
undir_edge <- igraph::subgraph.edges(
    base_net,
    igraph::E(base_net)[ igraph::E(base_net)$n_edge_evidence > 1 ],
    delete.vertices = T 
  )

# dir
dir <- igraph::subgraph.edges( 
    base_net, 
    igraph::E(base_net)[ igraph::E(base_net)$directed == 1 ],
    delete.vertices = T 
  ) %>% 
    as.directed(mode = 'arbitrary')

# dir node edge
dir_node_edge <- igraph::subgraph.edges( 
    undir_node_edge, 
    igraph::E(undir_node_edge)[ igraph::E(undir_node_edge)$directed == 1 ],
    delete.vertices = T 
  ) %>% 
    as.directed(mode = 'arbitrary')

# dir node
dir_node <- igraph::subgraph.edges( 
    undir_node, 
    igraph::E(undir_node)[ igraph::E(undir_node)$directed == 1 ],
    delete.vertices = T 
  ) %>% 
    as.directed(mode = 'arbitrary')

# dir edge
dir_edge <- igraph::subgraph.edges( 
    undir_edge, 
    igraph::E(undir_edge)[ igraph::E(undir_edge)$directed == 1 ],
    delete.vertices = T 
  ) %>% 
    as.directed(mode = 'arbitrary')

```

## cbrain data
Read CRISPRbrain phenotype data 
```{r warning=FALSE}
synLogin()

# CRISPRbrain data
syn.dir <- synGetChildren('syn51183357')$asList() %>% 
  tibble(f = .) %>% 
  unnest_wider(f)

# Simple Screens
simple <- map_dfr(
  syn.dir %>% with(which( !grepl('RNA|CROP',name) )),
  ~ { 
    id = syn.dir$id[.x]
    n = syn.dir$name[.x]
    synGet(id)$path %>% 
      read_csv( col_types = cols() ) %>% 
      mutate(cell = n %>% str_split_fixed(.,'-(?!M)', 2) %>% .[,1],
             mode = n %>% str_extract('CRISPR[ain]'),
             expt = n %>% str_remove_all('-CRISPR[ain].csv') %>% 
               str_split_fixed('-(?!M)',2) %>% .[,2] ) %>% 
      relocate(cell, mode, expt)
  }
  ) %>% 
  rename(pval = `P Value`, pheno = `Phenotype`, gene_score = `Gene Score`)

simple <- tibble(expt = simple$expt %>% unique() %>% sort(),
                 phenotype = c('Expansion (CD34 Staining)',
                                'Reactive Oxygen Species (CellRox Intensity)',
                                'Proliferation (CFSE Staining)',
                                'Survival (14 day)', 'Survival (21 day)', 'Survival (28 day)',
                                'Labile Iron (FeRhoNox Intensity)',
                                'Immune Activation (CD38 levels)',
                                'Lysosome Exocytosis (cell surface LAMP1), +IL1a +TNF +C1q',
                                'Lysosome Exocytosis (cell surface LAMP1), Vehicle',
                                'Peroxidized Lipids (Liperfluo intensity)',
                                'Lysosome (LysoTracker intensity)',
                                'Lysosome Mass or pH (LysoTracker staining), +IL1a +TNF +C1q',
                                'Lysosome Mass or pH (LysoTracker staining), Vehicle',
                                'Survival, no antioxidants',
                                'Phagocytosis (pHRodo-rat synaptosomes)',
                                'Phagocytosis (pHRodo-labeled synaptosomes), +IL1a +TNF +C1q',
                                'Phagocytosis (pHRodo-labeled synaptosomes), Vehicle',
                                'Survival, PSAP KO & no antioxidants',
                                'Survival, PSAP KO',
                                'Survival',
                                'Survival-Proliferation',
                                'Inflammatory activation (cell-surface VCAM1 levels), +IL1a +TNF +C1q')
                 ) %>% left_join(simple, . , by = 'expt')

# filter(cell %in% c('iAstrocyte','Glutamatergic Neuron','iTF-Microglia','iPSC')) # don't consider HSPC or T-cell
```

## NW & KDA data

read results from synapse  
```{r}
# top level biodom directory
doms <- synGetChildren('syn51739831')$asList() %>%
  tibble(f = .) %>% unnest_wider(f) %>%
  filter( !(name %in% c('pseudotime','nanostring_induced_subgraph.graphml', 'key_drivers_all_nw.csv')) ) %>%
  select(bd = name, id) %>% 
  arrange(bd) %>% 
  mutate(i = 1:nrow(.)) %>% 
  rowwise() %>% 
  mutate(
    nw.dir = synGetChildren(  parent = id  )$asList() %>% tibble(f = .) %>% unnest_wider(f) %>% list(),
    kd.dir = synGetChildren(  parent = nw.dir$id[grepl('kda',nw.dir$name)]  )$asList() %>% tibble(f = .) %>% unnest_wider(f) %>% list()
    )

```

<!-- ```{r} -->

<!-- # read NW results dir on Synapse -->
<!-- nw.dirs <- map_dfr( -->
<!--   synGetChildren('syn51739831')$asList() %>% -->
<!--     tibble(f = .) %>% unnest_wider(f) %>% -->
<!--     filter( -->
<!--       !(name %in% c('pseudotime','nanostring_induced_subgraph.graphml', 'key_drivers_all_nw.csv')) -->
<!--       ) %>% -->
<!--     pull(id), -->
<!--   ~{ synGetChildren(  parent = .x  )$asList() %>% -->
<!--       tibble(f = .) %>% unnest_wider(f) %>% -->
<!--       filter(grepl('graphml', name)) %>% -->
<!--       mutate( -->
<!--         bd = str_extract(name, '^(?<=[bdFiltered_]{0,1}).+(?=_[un]*directed)') %>% -->
<!--           str_remove_all('bdFiltered_') %>% str_replace_all('_',' '), -->
<!--         bd.filt = if_else(grepl('bdFiltered',name),T,F), -->
<!--         filt = str_extract(name, '(?<=_filt_).+(?=\\.graphml)'), -->
<!--         dir = str_extract(name, '[un]*directed') -->
<!--         ) %>% -->
<!--       relocate(bd, bd.filt, filt, dir) -->
<!--     } -->
<!-- ) %>% -->
<!--   filter(!grepl('Astro|Micro', filt)) -->

<!-- # read KDA results dir on Synapse -->
<!-- kda.dirs <- map_dfr( -->
<!--   synGetChildren('syn51739831')$asList() %>% -->
<!--     tibble(f = .) %>% unnest_wider(f) %>% -->
<!--     filter( -->
<!--       !(name %in% c('pseudotime','nanostring_induced_subgraph.graphml', 'key_drivers_all_nw.csv')) -->
<!--       ) %>% -->
<!--     pull(id), -->
<!--   ~{ id = synGetChildren( parent = .x )$asList() %>% -->
<!--       tibble(f = .) %>% unnest_wider(f) %>% -->
<!--       filter(grepl('kda', name)) %>% pull(id) -->

<!--      bd = synGet(.x)$properties$name -->

<!--      synGetChildren(id)$asList() %>% -->
<!--        tibble(f = .) %>% unnest_wider(f) %>% -->
<!--        filter(grepl('results|tophits',name)) %>% -->
<!--        mutate( -->
<!--           bd = bd %>% str_replace_all('_' ,' '), -->
<!--           filt = str_extract(name, '(?<=_filt_).+(?=_addWeights)'), -->
<!--           dir = str_extract(name, '[un]*directed'), -->
<!--           ef = str_extract(name, '(?<=_edgeFactor_)[0|1]') -->
<!--           ) %>% -->
<!--         relocate(bd, filt, dir, ef) -->
<!--     } -->
<!-- ) %>% -->
<!--   mutate(set = case_when(grepl('results', name) ~ 'full', grepl('top',name) ~ 'top', T ~ NA_character_)) %>% -->
<!--   relocate(set) %>% -->
<!--   filter(!grepl('Astro|Micro', filt)) -->
<!-- ``` -->

read local results directories
```{r}
# # read local results dir
# doms = list.files('../results/biodomain')
# nw.dirs <- tibble(bd = doms, i = 1:length(doms)) %>% 
#   rowwise() %>% 
#   mutate(
#     f = list.files( paste0('../results/biodomain/',bd) ) %>% list(),
#     kd = list.files( paste0('../results/biodomain/',bd,'/kda') ) %>% list()
#   )
# nw.dirs$kd[[ match('APP_Metabolism', nw.dirs$bd) ]]

# i = which(doms == 'Immune_Response')

# # check which trace / KDA jobs have completed
# nw.dirs %>% rowwise() %>% mutate(n = length(unlist(kd))) %>% arrange(desc(n))
```

## functions

### nw data

```{r}
read_nw <- function(dom_idx){
  
  nw = read.graph(
    synGet(
      doms$nw.dir[[dom_idx]] %>% filter( grepl('bdFiltered.+graphml', name) ) %>% pull(id)
    )$path,
    format = 'graphml'
    )

  return(nw)
  
}
```

<!-- ```{r} -->
<!-- read_nw <- function(dom_idx){ -->
<!--   nw = read.graph( -->
<!--     paste0(here::here(), '/results/biodomain/', doms[dom_idx], '/', -->
<!--            nw.dirs$f[[match(doms[dom_idx], nw.dirs$bd)]] %>% -->
<!--              str_subset(., 'bdFiltered') %>% str_subset('graphml')), -->
<!--     format = 'graphml') -->

<!--   return(nw) -->
<!-- } -->
<!-- ``` -->

### kda data

```{r}
read_kd <- function(dom_idx){

  kd.ef0 <- read_tsv(synGet(doms$kd.dir[[dom_idx]] %>% filter( grepl('edgeFactor_0.results.txt', name) ) %>% pull(id))$path, col_types = cols())
  kd.ef1 <- read_tsv(synGet(doms$kd.dir[[dom_idx]] %>% filter( grepl('edgeFactor_1.results.txt', name) ) %>% pull(id))$path, col_types = cols())
  kd.top <- read_tsv(synGet(doms$kd.dir[[dom_idx]] %>% filter( grepl('edgeFactor_1.tophits.txt', name) ) %>% pull(id))$path, col_types = cols()) %>% 
    mutate(kd = paste0(NODE,'-',MODULE))
    
  kd = bind_rows(
    kd.ef0 %>% mutate(ef = 'ef0_fdr'),
    kd.ef1 %>% mutate(ef = 'ef1_fdr')
    ) %>% 
    mutate(FDR = -log10(FDR)) %>%
    pivot_wider(id_cols = c(MODULE, NODE, MEMBER), names_from = ef, values_from = FDR, values_fill = 0) %>%
    mutate(delta_fdr = ef1_fdr - ef0_fdr) %>% arrange(desc(delta_fdr)) %>% 
    mutate(top = 0)
  
  if( any( kd.top$FDR < 0.05 ) ){
    kd$top[ which(paste0(kd$NODE,'-',kd$MODULE) %in% kd.top$kd[kd.top$FDR < 0.05]) ] <- 1
  }
  
  return(kd)
}

```

<!-- ```{r} -->
<!-- read_kd_local <- function(dom_idx){ -->

<!--   kd.pth <- paste0(here::here(), '/results/biodomain/', doms[dom_idx],'/kda') -->
<!--   kd.res <- list.files(kd.pth, full.names = T) %>% str_subset('results.txt') -->
<!--   kd.top <- list.files(kd.pth, full.names = T) %>% str_subset('tophits.txt') -->

<!--   kd = bind_rows( -->
<!--     read_tsv(kd.res %>% str_subset(.,'edgeFactor_0'), col_types = cols()) %>% mutate(ef = 'ef0_fdr'), -->
<!--     read_tsv(kd.res %>% str_subset(.,'edgeFactor_1'), col_types = cols()) %>% mutate(ef = 'ef1_fdr') -->
<!--     ) %>%  -->
<!--     mutate(FDR = -log10(FDR)) %>% -->
<!--     pivot_wider(id_cols = c(MODULE, NODE, MEMBER), names_from = ef, values_from = FDR, values_fill = 0) %>% -->
<!--     mutate(delta_fdr = ef1_fdr - ef0_fdr) %>% arrange(desc(delta_fdr)) %>%  -->
<!--     mutate(top = 0) -->

<!--   top = read_tsv(kd.top %>% str_subset('edgeFactor_1'), col_types = cols()) %>%  -->
<!--     mutate(kd = paste0(NODE,'-',MODULE)) -->

<!--   if( any( top$FDR < 0.05 ) ){ -->
<!--     kd$top[ which(paste0(kd$NODE,'-',kd$MODULE) %in% top$kd[top$FDR < 0.05]) ] <- 1 -->
<!--   } -->

<!--   return(kd) -->
<!-- } -->

<!-- ``` -->

### plot subnetwork
```{r}
plot_kd_subnet <- function(nw, kd, term) {
  
  vert_num <- match(kd, V(nw)$name)
  
  vert_neigh <- neighbors(nw, vert_num)
  
  term_num <- biodom %>%
    filter(GOterm_Name == term) %>%
    pull(symbol) %>% unlist() %>%
    match(., V(nw)$name) %>% .[!is.na(.)]
  
  g2 <- induced_subgraph(nw, c(vert_num, intersect(term_num, vert_neigh)))
  g3 <- induced_subgraph(nw, c(vert_num, term_num))
  
  cowplot::plot_grid(
    
    ggraph(g3, layout = 'linear', circular = TRUE) +
      geom_edge_arc(alpha = .3, color = 'grey75') +
      geom_node_point( shape = 21, color = "black", alpha = .3,
        aes(size = TargetRiskScore, fill = Pro_EffectScore, filter= .N()$name != kd)  )+
      geom_node_point( shape = 23, color = "black", alpha = .3,
        aes(size = TargetRiskScore, fill = Pro_EffectScore, filter = .N()$name == kd) )+
      geom_node_text(aes(label = name), size = 2) +
      coord_fixed() +
      scale_size_continuous( range = c(.5, 10), limits = c(0, 5), trans = 'exp')+
      scale_fill_gradient2(
        low = 'purple', mid = 'grey20', high = 'green', na.value = 'grey85',
        limits = c(-2.5,2.5) )+ #approx: range(omics$Pro_TE, na.rm = T)
      labs( title = 'All term genes in NW',
            subtitle = paste0('KD: ', kd, '\nTerm: ', term) )+
      theme_graph(background = 'white')
    ,
    ggraph(g2, layout = 'linear', circular = TRUE) +
            geom_edge_arc(alpha = .3, color = 'grey75') +
      geom_node_point( shape = 21, color = "black", alpha = .3,
        aes(size = TargetRiskScore, fill = Pro_EffectScore, filter= .N()$name != kd)  )+
      geom_node_point( shape = 23, color = "black", alpha = .3,
        aes(size = TargetRiskScore, fill = Pro_EffectScore, filter = .N()$name == kd) )+
      geom_node_text(aes(label = name), size = 2) +
      coord_fixed() +
      scale_size_continuous( range = c(.5, 10), limits = c(0, 5), trans = 'exp')+
      scale_fill_gradient2(
        low = 'purple', mid = 'grey20', high = 'green', na.value = 'grey85',
        limits = c(-2.5,2.5) )+ #approx: range(omics$Pro_TE, na.rm = T)
      labs( title = 'Term genes & KD neighbors in NW',
            subtitle = paste0('KD: ', kd, '\nTerm: ', term) )+
      theme_graph(background = 'white')
    ,
    ncol = 2
    
  )
}
```

<!-- ## kda data -->
<!-- functions to read KDA results and plot sub-networks from identified key drivers -->
<!-- ```{r} -->
<!-- read_kda_res <- function(ef0_synID, ef1_synID, ef1_top){ -->

<!--   res = bind_rows( -->
<!--     read_tsv(synGet(ef0_synID)$path, col_types = cols()) %>% mutate(ef = 'ef0_fdr'), -->
<!--     read_tsv(synGet(ef1_synID)$path, col_types = cols()) %>% mutate(ef = 'ef1_fdr') -->
<!--   ) %>% -->
<!--   mutate(FDR = -log10(FDR)) %>% -->
<!--   pivot_wider(id_cols = c(MODULE, NODE, MEMBER), names_from = ef, values_from = FDR) %>% -->
<!--   mutate(across(contains('_fdr'), ~ if_else(is.na(.x), 0, .x))) %>%  -->
<!--   mutate(delta_fdr = ef1_fdr - ef0_fdr) %>% arrange(desc(delta_fdr)) %>%  -->
<!--   mutate(top = 0) -->

<!--   top = read_tsv(synGet(ef1_top)$path, col_types = cols()) %>%  -->
<!--     mutate(kd = paste0(NODE,'-',MODULE)) -->

<!--   if( any( top$FDR < 0.05 ) ){ -->
<!--     res$top[ which(paste0(res$NODE,'-',res$MODULE) %in% top$kd[top$FDR < 0.05]) ] <- 1 -->
<!--   } -->

<!--   return(res) -->

<!-- } -->


<!-- plot_kd_subnet <- function(nw, kd, term) { -->

<!--   vert_num <- match(kd, V(nw)$name) -->

<!--   vert_neigh <- neighbors(nw, vert_num) -->

<!--   term_num <- biodom %>% -->
<!--     filter(GOterm_Name == term) %>% -->
<!--     pull(symbol) %>% unlist() %>% -->
<!--     match(., V(nw)$name) %>% .[!is.na(.)] -->

<!--   g2 <- induced_subgraph(nw, c(vert_num, intersect(term_num, vert_neigh))) -->
<!--   g3 <- induced_subgraph(nw, c(vert_num, term_num)) -->

<!--   cowplot::plot_grid( -->

<!--     ggraph(g3, layout = 'linear', circular = TRUE) + -->
<!--       geom_edge_arc(alpha = .3, color = 'grey75') + -->
<!--       geom_node_point( shape = 21, color = "black", alpha = .3, -->
<!--         aes(size = TargetRiskScore, fill = Pro_EffectScore, filter= .N()$name != kd)  )+ -->
<!--       geom_node_point( shape = 23, color = "black", alpha = .3, -->
<!--         aes(size = TargetRiskScore, fill = Pro_EffectScore, filter = .N()$name == kd) )+ -->
<!--       geom_node_text(aes(label = name), size = 2) + -->
<!--       coord_fixed() + -->
<!--       scale_size_continuous( range = c(.5, 10), limits = c(0, 5), trans = 'exp')+ -->
<!--       scale_fill_gradient2( -->
<!--         low = 'purple', mid = 'grey20', high = 'green', na.value = 'grey85', -->
<!--         limits = c(-2.5,2.5) )+ #approx: range(omics$Pro_TE, na.rm = T) -->
<!--       labs( title = 'All term genes in NW', -->
<!--             subtitle = paste0('KD: ', kd, '\nTerm: ', term) )+ -->
<!--       theme_graph(background = 'white') -->
<!--     , -->
<!--     ggraph(g2, layout = 'linear', circular = TRUE) + -->
<!--             geom_edge_arc(alpha = .3, color = 'grey75') + -->
<!--       geom_node_point( shape = 21, color = "black", alpha = .3, -->
<!--         aes(size = TargetRiskScore, fill = Pro_EffectScore, filter= .N()$name != kd)  )+ -->
<!--       geom_node_point( shape = 23, color = "black", alpha = .3, -->
<!--         aes(size = TargetRiskScore, fill = Pro_EffectScore, filter = .N()$name == kd) )+ -->
<!--       geom_node_text(aes(label = name), size = 2) + -->
<!--       coord_fixed() + -->
<!--       scale_size_continuous( range = c(.5, 10), limits = c(0, 5), trans = 'exp')+ -->
<!--       scale_fill_gradient2( -->
<!--         low = 'purple', mid = 'grey20', high = 'green', na.value = 'grey85', -->
<!--         limits = c(-2.5,2.5) )+ #approx: range(omics$Pro_TE, na.rm = T) -->
<!--       labs( title = 'Term genes & KD neighbors in NW', -->
<!--             subtitle = paste0('KD: ', kd, '\nTerm: ', term) )+ -->
<!--       theme_graph(background = 'white') -->
<!--     , -->
<!--     ncol = 2 -->

<!--   ) -->
<!-- } -->
<!-- ``` -->


# Key Driver Analysis 

Network by network explore the effects of NW filters on traces & KDs for these sets:
• node & edge filtering effects


## APP Metabolism {.tabset}
```{r}
dom = 'APP_Metabolism'
```

### KDA results
```{r}
# synIDs of BD-specific wKDA results
kd.res = read_kd( which(doms == dom) ) %>% 
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    )
  ) %>% 
  left_join(
    ., biodom %>% select(MODULE = GOterm_Name, Biodomain, abbr:color)
  )

am.kd.res <- kd.res 
```

```{r}
top <- bind_rows(
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_0.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef0'),
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_1.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef1')
  ) %>%   
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    ))
```

Top KDs depend on edge factor used
```{r fig.width=6, fig.height=8}

cowplot::plot_grid(
  
  ggplot(top, aes(FOLD, -log10(FDR) )) + 
    geom_point(aes(color = node_status), alpha = .5) + 
    theme(legend.position = 'top')+
    facet_wrap(~ef),
  
  top %>% 
    mutate(FDR = -log10(FDR)) %>% 
    pivot_wider(id_cols = c(NODE, MODULE, node_status),
                names_from = ef, values_from = FDR) %>% 
    mutate(across(c(ef0,ef1), ~ if_else(is.na(.x), 0, .x))) %>% 
    ggplot(aes(ef0, ef1))+
    geom_abline(intercept = 0, slope = 1, lty = 2)+
    geom_point( aes(color = node_status), alpha = .5)+
    theme(legend.position = 'top')+
    labs(x = '-log10(FDR)\nuniform edge weights',
         y = '-log10(FDR)\nAD risk edge weights'),
  
  nrow = 2, rel_heights = c(.6,1)
  
)
```


```{r fig.width=8,fig.height=5}
# p2 = 
kd.res %>% 
  ggplot(aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = dom)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .4, size = 1.5, aes(color = color, shape = node_status) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 3, aes(color = color, shape = node_status))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, 
                   ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[which( enr.bd$padj < 0.05 
                                                # & enr.bd$Biodomain == str_replace_all(dom, '_', ' ')
                                                )]
                   & delta_fdr > 0
                   # & !duplicated(NODE)
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  # facet_wrap(dir~filt, scales = 'free', ncol = 4)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

### KD ~ Biodomains

```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_term)) %>% 
  arrange(Biodomain, desc(n_term), desc(max_delta)) %>% 
  ggplot(aes(n_term, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(dom, ' Network Key Drivers'),
       subtitle = 'Biodomain GO terms')+ 
  theme(legend.position = 'bottom')
# +
#   facet_wrap(dir~filt, ncol = 4)
```


```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_node)) %>%
  ggplot(aes(n_node, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0( dom, ' Network Key Drivers'),
       subtitle = 'Nodes')+ 
  theme(legend.position = 'bottom')
# +facet_wrap(dir~filt, ncol = 4)
```

```{r fig.width=10,fig.height=5}
tmp <- kd.res %>% 
  filter( 
    ef1_fdr > -log10(0.05)
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
    , delta_fdr > 0 
         )

ggplot(tmp, aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', 
       title = dom,
       subtitle = 'signif KDs (EF1 FDR < 0.05), \u0394 FDR > 0, for GSEA-enriched terms'
       )+
  # geom_abline(intercept = 0, slope =1, lty= 2, lwd = .5)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 2, aes(color = color))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                   & delta_fdr > 0
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(~Biodomain)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

```{r}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_term), desc(max_delta), .by_group = T) %>%
  DT::datatable(rownames = F, filter = 'top')
```


### KDs ~ CBrain phenotypes
```{r fig.width=4, fig.height=4}
# crispr brain phenotype hits (any) vs non-hits
cb.hits = simple %>% filter(`Hit Class` != 'Non-Hit') %>% 
  pull(Gene) %>% unique()
cb.nonhits = simple %>% filter( (Gene %in% cb.hits)==F ) %>% 
  pull(Gene) %>% unique()

# ID key drivers from different parameter sets
# comb = kd.res %>% select(filt, dir) %>% distinct() %>% arrange(dir,filt)
kd.hits <- kd.res %>% filter(ef1_fdr > -log10(0.05), top == 1, delta_fdr > 0) %>% pull(NODE) %>% unique()
kd.nonhits <- kd.res %>% filter((NODE %in% kd.hits)==F) %>% pull(NODE) %>% unique()

# calculate fisher stats 
fisher.stats <- tibble(
      pheno_kd = intersect(cb.hits, kd.hits) %>% length(),
      noPheno_kd = intersect(cb.nonhits, kd.hits) %>% length(),
      pheno_nokd = intersect(cb.hits, kd.nonhits) %>% length(),
      noPheno_nokd = intersect(cb.nonhits, kd.nonhits) %>% length()
    ) %>% 
  rowwise() %>% 
  mutate(
      fisher.p = matrix(c(pheno_kd, noPheno_kd, pheno_nokd, noPheno_nokd), nrow = 2) %>% 
      fisher.test( ., alt = 'g') %>% broom::tidy() %>% pull(p.value)
    )

# make plots for each comb
p <- VennDiagram::venn.diagram(
      x = list(
        CRISPRbrain = cb.hits, 
        KeyDrivers = kd.hits
      ),
      filename = NULL,
      force.unique = T,
      lty = 0, alpha = .3, fill = c('light blue','pink'),
      hyper.test = T, 
      total.population = length(intersect(simple$Gene, names(V(base_net)))),
      
      # main = kd.res$bd %>% unique,
      main = paste0(
              'Fisher p = ', fisher.stats$fisher.p[1] %>% signif(digits = 2) ),
      main.cex = .75, sub.cex = .75,
      # cat.pos = c(315,45),
      cat.cex = .8,
      ext.pos = 180,
      ext.dist = -.1
      ) 

cowplot::plot_grid(p)

```

logistic regression
```{r}
nw = read_nw(which(doms == dom))

tmp = simple %>% 
  mutate(cb_hit = if_else( `Hit Class` == 'Non-Hit', 0, 1)) %>% 
  select(cell, mode, expt, Gene, cb_hit) %>% distinct() %>% 
  mutate(kd = if_else(Gene %in% kd.hits, 1, 0)) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>% 
  filter(!is.na(node_degree)) %>% 
  group_by(cell,mode,expt) %>% 
  mutate(
    lr = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>% broom::tidy() %>% 
           filter(term == 'kd') %>% 
           mutate(nobs = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>%  
                    broom::glance() %>% pull(nobs)) %>% list()
    ) %>% 
  unnest(lr)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

tmp %>% 
  select(cell:expt, estimate:p.value) %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'cb_hit ~ kd + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('estimate', 'std.error','statistic', 'p.value'))
```


linear regression  ~ KDA FDR
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         ef1_fdr = scale(ef1_fdr, center = T, scale = T) #/ max(ef1_fdr),
         ) #/ max(abs(gene_score))) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale(abs(gene_score), center = T, scale = T),
         lm = lm(gs~ef1_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'ef1_fdr') %>% 
           mutate(r.squared = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ ef1_fdr + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```

```{r fig.width=10, fig.height=8}
c = 'iAstrocyte'
m = 'CRISPRi'
e = 'LAMP1-ITC'

# kd.res %>% inner_join( simple,., by =c('Gene'='NODE')) %>%
tmp %>% 
  filter(
    cell == c,
    mode == m,
    expt == e,
    # ef1_fdr > -log10(0.2)
    ) %>% 
  mutate( gs = scale(abs(gene_score), center = T, scale = T)) %>% 
  # left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  ggplot( aes( ef1_fdr+node_degree, gs )) +
  geom_point(#data = subset(tmp, d > 0),
             aes(color = color,  size = delta_fdr), alpha = .5) +
  geom_hline(yintercept = 0, lwd = 0.5)+
  geom_vline(xintercept = 0, lwd = 0.5)+
  scale_size_continuous(name = 'KDA \u0394 FDR\nef1-ef0', range = c(.5,3))+ 
  # ggrepel::geom_label_repel(
  #   data = subset(tmp, d > 0), aes(label = paste0(Gene,'\n', go)),
  #   min.segment.length = 0, size = 2.5, max.overlaps = 12)+
  scale_color_identity(guide = 'none')+
  geom_smooth(method = 'lm', color = 'grey20',lty=2)+
  labs(y = 'CRISPRbrain phenotype score, absolute value',
       x = 'KDA FDR (-log10) + node_degree',
       title = paste0(c,', ',m,', ',e)) 
```


linear regression ~  KDA delta FDR e1/e0
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         delta_fdr = scale(delta_fdr, center = T, scale = T) #, / max(ef1_fdr),
         ) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale( abs(gene_score), center = T, scale = T),
         lm = lm(gs~delta_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'delta_fdr') %>% 
           mutate(r.squared = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ \u0394 fdr (ef1-ef0)', options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```

### Top KDs
```{r}
kd.summary = kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         ) %>% 
  group_by(NODE, node_status) %>% 
  summarise(n_bd = length(unique(Biodomain)),
            bds = list(unique(Biodomain)),
            n_term = length(unique(MODULE)),
            terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_bd), desc(max_delta)) 

DT::datatable(kd.summary %>% select(-bds, -terms), rownames = F, filter = 'top')
```

```{r}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , top == 1
         , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>% 
  DT::datatable(., rownames = F, filter = 'top') %>% 
  DT::formatSignif(columns = c('ef0_fdr','ef1_fdr','delta_fdr'))
```
### KD subnetworks
pull NW to view subgraphs
```{r}
nw = read_nw(which(doms == dom))
snw = igraph::simplify(nw, remove.multiple = T)
```

specify nodes
```{r}
kd.nodes <- kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , top == 1
         , delta_fdr > 0
  ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>%
  group_by(NODE) %>% 
  summarise(n_biodom = length(unique(Biodomain))
         , n_term = length(unique(MODULE))
         , ef1_max = max(ef1_fdr)
         , delta_max = max(delta_fdr)) 

```

subnetwork of just KD Nodes  
```{r}
vert_num <- match(kd.nodes$NODE, V(snw)$name)

g2 <- induced_subgraph(snw, vert_num)
unlinked <- names(degree(g2)[which(degree(g2)==0)])
g2 <- delete.vertices(g2, unlinked)

# KD evidence
x = tibble( node = V(g2) %>% names ) %>%
  left_join(., kd.nodes, by = c('node'='NODE'))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g2, names(x)[i], index = igraph::V(g2)) <- x %>% pull(i)
}

# plot
ggraph(g2, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey75') +
  geom_node_point( color = "black", alpha = .5, 
                   aes(size = n_term, fill = delta_max, shape = node_status )  )+
  geom_node_text(aes(label = name), size = 2) +
  scale_shape_manual( values = c(21,23) )+
  scale_size_continuous( range = c(2,10) )+
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')

```

subnetwork of KD and neighbors
```{r}
vert_neigh <- neighbors(snw, vert_num)

g3 <- induced_subgraph(snw, c(vert_num, vert_neigh))
unlinked <- names(degree(g3)[which(degree(g3)==0)])
g3 <- delete.vertices(g3, unlinked)

# KD evidence
x = tibble( node = V(g3) %>% names ) %>% 
  left_join(., kd.nodes, by = c('node'='NODE')) %>% 
  mutate(kd = if_else(is.na(n_term), 0, 1))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g3, names(x)[i], index = igraph::V(g3)) <- x %>% pull(i)
}

ggraph(g3, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey90') +
  geom_node_point( shape = 21, color = "black", alpha = .3, fill = 'grey90', 
                   aes(filter= .N()$kd == 0)  )+
  geom_node_point( shape = 23, color = "black", alpha = .6, 
                   aes(size = delta_max, fill = ef1_max, filter = .N()$kd == 1) )+
  scale_shape_manual(name='Driver Status', breaks=c('key driver', 'non-driver'),
                     values=c('key driver'=23, 'non-driver'=21))+
  geom_node_text(aes(label = name, filter = .N()$kd == 1), size = 2) +
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')
```


```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'GRIN2B',term = 'postsynaptic density') )
p
```

## Tau Homeostasis {.tabset}
```{r}
dom = 'Tau_Homeostasis'
```

### KDA results
```{r}
# synIDs of BD-specific wKDA results
kd.res = read_kd( which(doms == dom) ) %>% 
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    )
  ) %>% 
  left_join(
    ., biodom %>% select(MODULE = GOterm_Name, Biodomain, abbr:color)
  )

th.kd.res <- kd.res
```


```{r}
top <- bind_rows(
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_0.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef0'),
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_1.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef1')
  ) %>%   
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    ))
```

Top KDs depend on edge factor used
```{r fig.width=6, fig.height=8}

cowplot::plot_grid(
  
  ggplot(top, aes(FOLD, -log10(FDR) )) + 
    geom_point(aes(color = node_status), alpha = .5) + 
    theme(legend.position = 'top')+
    facet_wrap(~ef),
  
  top %>% 
    mutate(FDR = -log10(FDR)) %>% 
    pivot_wider(id_cols = c(NODE, MODULE, node_status),
                names_from = ef, values_from = FDR) %>% 
    mutate(across(c(ef0,ef1), ~ if_else(is.na(.x), 0, .x))) %>% 
    ggplot(aes(ef0, ef1))+
    geom_abline(intercept = 0, slope = 1, lty = 2)+
    geom_point( aes(color = node_status), alpha = .5)+
    theme(legend.position = 'top')+
    labs(x = '-log10(FDR)\nuniform edge weights',
         y = '-log10(FDR)\nAD risk edge weights'),
  
  nrow = 2, rel_heights = c(.6,1)
  
)
```

```{r fig.width=8,fig.height=5}
# p2 = 
kd.res %>% 
  ggplot(aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = dom)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .4, size = 1.5, aes(color = color, shape = node_status) )+
  geom_point(#data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0), 
             alpha = .6, size = 3, aes(color = color, shape = node_status))+
  # ggrepel::geom_label_repel(
  #   data = subset( kd.res, 
  #                  ef1_fdr > -log10(0.05)
  #                  & top == 1
  #                  & MODULE %in% enr.bd$pathway[which( enr.bd$padj < 0.05 
  #                                               # & enr.bd$Biodomain == str_replace_all(dom, '_', ' ')
  #                                               )]
  #                  & delta_fdr > 0
  #                  # & !duplicated(NODE)
  #                  ),
  #   aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
  #   size = 2, alpha = .7, min.segment.length = 0)+
  # facet_wrap(dir~filt, scales = 'free', ncol = 4)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

### KD ~ Biodomains

```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_term)) %>% 
  arrange(Biodomain, desc(n_term), desc(max_delta)) %>% 
  ggplot(aes(n_term, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(dom, ' Network Key Drivers'),
       subtitle = 'Biodomain GO terms')+ 
  theme(legend.position = 'bottom')
# +
#   facet_wrap(dir~filt, ncol = 4)
```


```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_node)) %>%
  ggplot(aes(n_node, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0( dom, ' Network Key Drivers'),
       subtitle = 'Nodes')+ 
  theme(legend.position = 'bottom')
# +facet_wrap(dir~filt, ncol = 4)
```

```{r fig.width=10,fig.height=5}
tmp <- kd.res 
# %>% 
#   filter( 
#     ef1_fdr > -log10(0.05)
#     , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
#     , delta_fdr > 0 
#          )

ggplot(tmp, aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', 
       title = dom,
       subtitle = 'signif KDs (EF1 FDR < 0.05), \u0394 FDR > 0, for GSEA-enriched terms'
       )+
  # geom_abline(intercept = 0, slope =1, lty= 2, lwd = .5)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(#data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0), 
             alpha = .6, size = 2, aes(color = color))+
  # ggrepel::geom_label_repel(
  #   data = subset( kd.res, ef1_fdr > -log10(0.05)
  #                  & top == 1
  #                  & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
  #                  & delta_fdr > 0
  #                  ),
  #   aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
  #   size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(~Biodomain)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

```{r}
kd.res %>% 
  # filter(ef1_fdr > -log10(0.05)
  #        # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
  #        , delta_fdr > 0
  #        , top == 1
  #        ) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_term), desc(max_delta), .by_group = T) %>%
  DT::datatable(rownames = F, filter = 'top')
```


<!-- ### KDs ~ CBrain phenotypes -->
<!-- ```{r fig.width=4, fig.height=4} -->
<!-- # crispr brain phenotype hits (any) vs non-hits -->
<!-- cb.hits = simple %>% filter(`Hit Class` != 'Non-Hit') %>%  -->
<!--   pull(Gene) %>% unique() -->
<!-- cb.nonhits = simple %>% filter( (Gene %in% cb.hits)==F ) %>%  -->
<!--   pull(Gene) %>% unique() -->

<!-- # ID key drivers from different parameter sets -->
<!-- # comb = kd.res %>% select(filt, dir) %>% distinct() %>% arrange(dir,filt) -->
<!-- kd.hits <- kd.res %>% filter(ef1_fdr > -log10(0.05), top == 1, delta_fdr > 0) %>% pull(NODE) %>% unique() -->
<!-- kd.nonhits <- kd.res %>% filter((NODE %in% kd.hits)==F) %>% pull(NODE) %>% unique() -->

<!-- # calculate fisher stats  -->
<!-- fisher.stats <- tibble( -->
<!--       pheno_kd = intersect(cb.hits, kd.hits) %>% length(), -->
<!--       noPheno_kd = intersect(cb.nonhits, kd.hits) %>% length(), -->
<!--       pheno_nokd = intersect(cb.hits, kd.nonhits) %>% length(), -->
<!--       noPheno_nokd = intersect(cb.nonhits, kd.nonhits) %>% length() -->
<!--     ) %>%  -->
<!--   rowwise() %>%  -->
<!--   mutate( -->
<!--       fisher.p = matrix(c(pheno_kd, noPheno_kd, pheno_nokd, noPheno_nokd), nrow = 2) %>%  -->
<!--       fisher.test( ., alt = 'g') %>% broom::tidy() %>% pull(p.value) -->
<!--     ) -->

<!-- # make plots for each comb -->
<!-- p <- VennDiagram::venn.diagram( -->
<!--       x = list( -->
<!--         CRISPRbrain = cb.hits,  -->
<!--         KeyDrivers = kd.hits -->
<!--       ), -->
<!--       filename = NULL, -->
<!--       force.unique = T, -->
<!--       lty = 0, alpha = .3, fill = c('light blue','pink'), -->
<!--       hyper.test = T,  -->
<!--       total.population = length(intersect(simple$Gene, names(V(base_net)))), -->

<!--       # main = kd.res$bd %>% unique, -->
<!--       main = paste0( -->
<!--               'Fisher p = ', fisher.stats$fisher.p[1] %>% signif(digits = 2) ), -->
<!--       main.cex = .75, sub.cex = .75, -->
<!--       # cat.pos = c(315,45), -->
<!--       cat.cex = .8, -->
<!--       ext.pos = 180, -->
<!--       ext.dist = -.1 -->
<!--       )  -->

<!-- cowplot::plot_grid(p) -->

<!-- ``` -->

<!-- logistic regression -->
<!-- ```{r} -->
<!-- nw = read_nw_local(which(doms == dom)) -->

<!-- tmp = simple %>%  -->
<!--   mutate(cb_hit = if_else( `Hit Class` == 'Non-Hit', 0, 1)) %>%  -->
<!--   select(cell, mode, expt, Gene, cb_hit) %>% distinct() %>%  -->
<!--   mutate(kd = if_else(Gene %in% kd.hits, 1, 0)) %>%  -->
<!--   left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%  -->
<!--   filter(!is.na(node_degree)) %>%  -->
<!--   group_by(cell,mode,expt) %>%  -->
<!--   mutate( -->
<!--     lr = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>% broom::tidy() %>%  -->
<!--            filter(term == 'kd') %>%  -->
<!--            mutate(nobs = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>%   -->
<!--                     broom::glance() %>% pull(nobs)) %>% list() -->
<!--     ) %>%  -->
<!--   unnest(lr)  %>%  -->
<!--   select(cell, mode, expt, term:nobs) %>% distinct() %>%  -->
<!--   # filter(p.value < 0.05) %>%  -->
<!--   arrange(desc(statistic),p.value) -->

<!-- tmp %>%  -->
<!--   select(cell:expt, estimate:p.value) %>%  -->
<!--   DT::datatable(rownames = F, filter = 'top', caption = 'cb_hit ~ kd + node_degree',  -->
<!--                 options = list(pageLength = 6)) %>% # -->
<!--   DT::formatSignif(columns = c('estimate', 'std.error','statistic', 'p.value')) -->
<!-- ``` -->


<!-- linear regression  ~ KDA FDR -->
<!-- ```{r} -->
<!-- nw = read_nw_local(which(doms == dom)) -->

<!-- tmp <- kd.res %>% inner_join( simple,., by =c('Gene'='NODE')) %>%  -->
<!--   left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>% -->
<!--   mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree), -->
<!--          ef1_fdr = scale(ef1_fdr, center = T, scale = T) #/ max(ef1_fdr), -->
<!--          ) #/ max(abs(gene_score)))  -->

<!-- res <- tmp %>%  -->
<!--   group_by(cell,mode,expt) %>%  -->
<!--   mutate(gs = scale(abs(gene_score), center = T, scale = T), -->
<!--          lm = lm(gs~ef1_fdr+node_degree) %>% broom::tidy() %>%  -->
<!--            filter(term == 'ef1_fdr') %>%  -->
<!--            mutate(r.squared = lm(abs(gene_score)~ef1_fdr+node_degree) %>%  -->
<!--                     broom::glance() %>% pull(r.squared), -->
<!--                   nobs = lm(abs(gene_score)~ef1_fdr+node_degree) %>%  -->
<!--                     broom::glance() %>% pull(nobs)) %>% list()) %>%  -->
<!--   unnest(lm)  %>%  -->
<!--   select(cell, mode, expt, term:nobs) %>% distinct() %>%  -->
<!--   # filter(p.value < 0.05) %>%  -->
<!--   arrange(desc(statistic),p.value) -->

<!-- res %>%  -->
<!--   DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ ef1_fdr + node_degree',  -->
<!--                 options = list(pageLength = 6)) %>% # -->
<!--   DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate')) -->
<!-- ``` -->

<!-- ```{r fig.width=10, fig.height=8} -->
<!-- c = 'iAstrocyte' -->
<!-- m = 'CRISPRi' -->
<!-- e = 'LAMP1-ITC' -->

<!-- # kd.res %>% inner_join( simple,., by =c('Gene'='NODE')) %>% -->
<!-- tmp %>%  -->
<!--   filter( -->
<!--     cell == c, -->
<!--     mode == m, -->
<!--     expt == e, -->
<!--     # ef1_fdr > -log10(0.2) -->
<!--     ) %>%  -->
<!--   mutate( gs = scale(abs(gene_score), center = T, scale = T)) %>%  -->
<!--   # left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>% -->
<!--   ggplot( aes( ef1_fdr+node_degree, gs )) + -->
<!--   geom_point(#data = subset(tmp, d > 0), -->
<!--              aes(color = color,  size = delta_fdr), alpha = .5) + -->
<!--   geom_hline(yintercept = 0, lwd = 0.5)+ -->
<!--   geom_vline(xintercept = 0, lwd = 0.5)+ -->
<!--   scale_size_continuous(name = 'KDA \u0394 FDR\nef1-ef0', range = c(.5,3))+  -->
<!--   # ggrepel::geom_label_repel( -->
<!--   #   data = subset(tmp, d > 0), aes(label = paste0(Gene,'\n', go)), -->
<!--   #   min.segment.length = 0, size = 2.5, max.overlaps = 12)+ -->
<!--   scale_color_identity(guide = 'none')+ -->
<!--   geom_smooth(method = 'lm', color = 'grey20',lty=2)+ -->
<!--   labs(y = 'CRISPRbrain phenotype score, absolute value', -->
<!--        x = 'KDA FDR (-log10) + node_degree', -->
<!--        title = paste0(c,', ',m,', ',e))  -->
<!-- ``` -->


<!-- linear regression ~  KDA delta FDR e1/e0 -->
<!-- ```{r} -->
<!-- nw = read_nw_local(which(doms == dom)) -->

<!-- tmp <- kd.res %>% inner_join( simple,., by =c('Gene'='NODE')) %>%  -->
<!--   left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>% -->
<!--   mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree), -->
<!--          delta_fdr = scale(delta_fdr, center = T, scale = T) #, / max(ef1_fdr), -->
<!--          )  -->

<!-- res <- tmp %>%  -->
<!--   group_by(cell,mode,expt) %>%  -->
<!--   mutate(gs = scale( abs(gene_score), center = T, scale = T), -->
<!--          lm = lm(gs~delta_fdr+node_degree) %>% broom::tidy() %>%  -->
<!--            filter(term == 'delta_fdr') %>%  -->
<!--            mutate(r.squared = lm(gs~delta_fdr+node_degree) %>%  -->
<!--                     broom::glance() %>% pull(r.squared), -->
<!--                   nobs = lm(gs~delta_fdr+node_degree) %>%  -->
<!--                     broom::glance() %>% pull(nobs)) %>% list()) %>%  -->
<!--   unnest(lm)  %>%  -->
<!--   select(cell, mode, expt, term:nobs) %>% distinct() %>%  -->
<!--   # filter(p.value < 0.05) %>%  -->
<!--   arrange(desc(statistic),p.value) -->

<!-- res %>%  -->
<!--   DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ \u0394 fdr (ef1-ef0)', options = list(pageLength = 6)) %>% # -->
<!--   DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate')) -->
<!-- ``` -->

### Top KDs
```{r}
kd.summary = kd.res %>% 
  # filter(ef1_fdr > -log10(0.05)
  #        , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
  #        , delta_fdr > 0
  #        ) %>% 
  group_by(NODE, node_status) %>% 
  summarise(n_bd = length(unique(Biodomain)),
            bds = list(unique(Biodomain)),
            n_term = length(unique(MODULE)),
            terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_bd), desc(max_delta)) 

DT::datatable(kd.summary %>% select(-bds, -terms), rownames = F, filter = 'top')
```

```{r}
kd.res %>% 
  # filter(ef1_fdr > -log10(0.05)
  #        # , top == 1
  #        , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
  #        , delta_fdr > 0
  #        ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>% 
  DT::datatable(., rownames = F, filter = 'top') %>% 
  DT::formatSignif(columns = c('ef0_fdr','ef1_fdr','delta_fdr'))
```
### KD subnetworks
pull NW to view subgraphs
pull NW to view subgraphs
```{r}
nw = read_nw(which(doms == dom))
snw = igraph::simplify(nw, remove.multiple = T)
```

specify nodes
```{r}
kd.nodes <- kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , top == 1
         , delta_fdr > 0
  ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>%
  group_by(NODE) %>% 
  summarise(n_biodom = length(unique(Biodomain))
         , n_term = length(unique(MODULE))
         , ef1_max = max(ef1_fdr)
         , delta_max = max(delta_fdr)) 

```

<!-- subnetwork of just KD Nodes   -->
<!-- ```{r} -->
<!-- vert_num <- match(kd.nodes$NODE, V(snw)$name) -->

<!-- g2 <- induced_subgraph(snw, vert_num) -->
<!-- unlinked <- names(degree(g2)[which(degree(g2)==0)]) -->
<!-- g2 <- delete.vertices(g2, unlinked) -->

<!-- # KD evidence -->
<!-- x = tibble( node = V(g2) %>% names ) %>% -->
<!--   left_join(., kd.nodes, by = c('node'='NODE')) -->
<!-- for(i in 2:ncol(x)){ -->
<!--   igraph::vertex_attr(g2, names(x)[i], index = igraph::V(g2)) <- x %>% pull(i) -->
<!-- } -->

<!-- # plot -->
<!-- ggraph(g2, layout = 'graphopt') + -->
<!--   geom_edge_link(alpha = .3, color = 'grey75') + -->
<!--   geom_node_point( color = "black", alpha = .5,  -->
<!--                    aes(size = n_term, fill = delta_max, shape = node_status )  )+ -->
<!--   geom_node_text(aes(label = name), size = 2) + -->
<!--   scale_shape_manual( values = c(21,23) )+ -->
<!--   scale_size_continuous( range = c(2,10) )+ -->
<!--   viridis::scale_fill_viridis()+ -->
<!--   theme_graph(background = 'white') -->

<!-- ``` -->

<!-- subnetwork of KD and neighbors -->
<!-- ```{r} -->
<!-- vert_neigh <- neighbors(snw, vert_num) -->

<!-- g3 <- induced_subgraph(snw, c(vert_num, vert_neigh)) -->
<!-- unlinked <- names(degree(g3)[which(degree(g3)==0)]) -->
<!-- g3 <- delete.vertices(g3, unlinked) -->

<!-- # KD evidence -->
<!-- x = tibble( node = V(g3) %>% names ) %>%  -->
<!--   left_join(., kd.nodes, by = c('node'='NODE')) %>%  -->
<!--   mutate(kd = if_else(is.na(n_term), 0, 1)) -->
<!-- for(i in 2:ncol(x)){ -->
<!--   igraph::vertex_attr(g3, names(x)[i], index = igraph::V(g3)) <- x %>% pull(i) -->
<!-- } -->

<!-- ggraph(g3, layout = 'graphopt') + -->
<!--   geom_edge_link(alpha = .3, color = 'grey90') + -->
<!--   geom_node_point( shape = 21, color = "black", alpha = .3, fill = 'grey90',  -->
<!--                    aes(filter= .N()$kd == 0)  )+ -->
<!--   geom_node_point( shape = 23, color = "black", alpha = .6,  -->
<!--                    aes(size = delta_max, fill = ef1_max, filter = .N()$kd == 1) )+ -->
<!--   scale_shape_manual(name='Driver Status', breaks=c('key driver', 'non-driver'), -->
<!--                      values=c('key driver'=23, 'non-driver'=21))+ -->
<!--   geom_node_text(aes(label = name, filter = .N()$kd == 1), size = 2) + -->
<!--   viridis::scale_fill_viridis()+ -->
<!--   theme_graph(background = 'white') -->
<!-- ``` -->
```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'MAPT',term = 'somatodendritic compartment') )
p
```


## Endolysosome {.tabset}
```{r}
dom = 'Endolysosome'
```

### KDA results
```{r}
# synIDs of BD-specific wKDA results
kd.res = read_kd( which(doms == dom) ) %>% 
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    )
  ) %>% 
  left_join(
    ., biodom %>% select(MODULE = GOterm_Name, Biodomain, abbr:color)
  )

en.kd.res <- kd.res 
```

```{r}
top <- bind_rows(
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_0.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef0'),
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_1.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef1')
  ) %>%   
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    ))
```

Top KDs depend on edge factor used
```{r fig.width=6, fig.height=8}

cowplot::plot_grid(
  
  ggplot(top, aes(FOLD, -log10(FDR) )) + 
    geom_point(aes(color = node_status), alpha = .5) + 
    theme(legend.position = 'top')+
    facet_wrap(~ef),
  
  top %>% 
    mutate(FDR = -log10(FDR)) %>% 
    pivot_wider(id_cols = c(NODE, MODULE, node_status),
                names_from = ef, values_from = FDR) %>% 
    mutate(across(c(ef0,ef1), ~ if_else(is.na(.x), 0, .x))) %>% 
    ggplot(aes(ef0, ef1))+
    geom_abline(intercept = 0, slope = 1, lty = 2)+
    geom_point( aes(color = node_status), alpha = .5)+
    theme(legend.position = 'top')+
    labs(x = '-log10(FDR)\nuniform edge weights',
         y = '-log10(FDR)\nAD risk edge weights'),
  
  nrow = 2, rel_heights = c(.6,1)
  
)
```


```{r fig.width=8,fig.height=5}
# p2 = 
kd.res %>% 
  ggplot(aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = dom)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .4, size = 1.5, aes(color = color, shape = node_status) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 3, aes(color = color, shape = node_status))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, 
                   ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[which( enr.bd$padj < 0.05 
                                                # & enr.bd$Biodomain == str_replace_all(dom, '_', ' ')
                                                )]
                   & delta_fdr > 0
                   # & !duplicated(NODE)
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  # facet_wrap(dir~filt, scales = 'free', ncol = 4)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

### KD ~ Biodomains

```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_term)) %>% 
  arrange(Biodomain, desc(n_term), desc(max_delta)) %>% 
  ggplot(aes(n_term, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(dom, ' Network Key Drivers'),
       subtitle = 'Biodomain GO terms')+ 
  theme(legend.position = 'bottom')
# +
#   facet_wrap(dir~filt, ncol = 4)
```


```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_node)) %>%
  ggplot(aes(n_node, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0( dom, ' Network Key Drivers'),
       subtitle = 'Nodes')+ 
  theme(legend.position = 'bottom')
# +facet_wrap(dir~filt, ncol = 4)
```

```{r fig.width=10,fig.height=10}
tmp <- kd.res %>% 
  filter( 
    ef1_fdr > -log10(0.05)
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
    , delta_fdr > 0 
         )

ggplot(tmp, aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', 
       title = dom,
       subtitle = 'signif KDs (EF1 FDR < 0.05), \u0394 FDR > 0, for GSEA-enriched terms'
       )+
  # geom_abline(intercept = 0, slope =1, lty= 2, lwd = .5)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 2, aes(color = color))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                   & delta_fdr > 0
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(~Biodomain)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

```{r}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_term), desc(max_delta), .by_group = T) %>%
  DT::datatable(rownames = F, filter = 'top')
```


### KDs ~ CBrain phenotypes
```{r fig.width=4, fig.height=4}
# crispr brain phenotype hits (any) vs non-hits
cb.hits = simple %>% filter(`Hit Class` != 'Non-Hit') %>% 
  pull(Gene) %>% unique()
cb.nonhits = simple %>% filter( (Gene %in% cb.hits)==F ) %>% 
  pull(Gene) %>% unique()

# ID key drivers from different parameter sets
# comb = kd.res %>% select(filt, dir) %>% distinct() %>% arrange(dir,filt)
kd.hits <- kd.res %>% filter(ef1_fdr > -log10(0.05), top == 1, delta_fdr > 0) %>% pull(NODE) %>% unique()
kd.nonhits <- kd.res %>% filter((NODE %in% kd.hits)==F) %>% pull(NODE) %>% unique()

# calculate fisher stats 
fisher.stats <- tibble(
      pheno_kd = intersect(cb.hits, kd.hits) %>% length(),
      noPheno_kd = intersect(cb.nonhits, kd.hits) %>% length(),
      pheno_nokd = intersect(cb.hits, kd.nonhits) %>% length(),
      noPheno_nokd = intersect(cb.nonhits, kd.nonhits) %>% length()
    ) %>% 
  rowwise() %>% 
  mutate(
      fisher.p = matrix(c(pheno_kd, noPheno_kd, pheno_nokd, noPheno_nokd), nrow = 2) %>% 
      fisher.test( ., alt = 'g') %>% broom::tidy() %>% pull(p.value)
    )

# make plots for each comb
p <- VennDiagram::venn.diagram(
      x = list(
        CRISPRbrain = cb.hits, 
        KeyDrivers = kd.hits
      ),
      filename = NULL,
      force.unique = T,
      lty = 0, alpha = .3, fill = c('light blue','pink'),
      hyper.test = T, 
      total.population = length(intersect(simple$Gene, names(V(base_net)))),
      
      # main = kd.res$bd %>% unique,
      main = paste0(
              'Fisher p = ', fisher.stats$fisher.p[1] %>% signif(digits = 2) ),
      main.cex = .75, sub.cex = .75,
      # cat.pos = c(315,45),
      cat.cex = .8,
      ext.pos = 180,
      ext.dist = -.1
      ) 

cowplot::plot_grid(p)

```

logistic regression
```{r}
nw = read_nw(which(doms == dom))

tmp = simple %>% 
  mutate(cb_hit = if_else( `Hit Class` == 'Non-Hit', 0, 1)) %>% 
  select(cell, mode, expt, Gene, cb_hit) %>% distinct() %>% 
  mutate(kd = if_else(Gene %in% kd.hits, 1, 0)) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>% 
  filter(!is.na(node_degree)) %>% 
  group_by(cell,mode,expt) %>% 
  mutate(
    lr = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>% broom::tidy() %>% 
           filter(term == 'kd') %>% 
           mutate(nobs = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>%  
                    broom::glance() %>% pull(nobs)) %>% list()
    ) %>% 
  unnest(lr)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

tmp %>% 
  select(cell:expt, estimate:nobs) %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'cb_hit ~ kd + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('estimate', 'std.error','statistic', 'p.value'))
```


linear regression  ~ KDA FDR
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(ef1_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         ef1_fdr = scale(ef1_fdr, center = T, scale = T) #/ max(ef1_fdr),
         ) #/ max(abs(gene_score))) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale(abs(gene_score), center = T, scale = T),
         lm = lm(gs~ef1_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'ef1_fdr') %>% 
           mutate(r.squared = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ ef1_fdr + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```


linear regression ~  KDA delta FDR e1/e0
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(delta_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         delta_fdr = scale(delta_fdr, center = T, scale = T) #, / max(ef1_fdr),
         ) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale( abs(gene_score), center = T, scale = T),
         lm = lm(gs~delta_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'delta_fdr') %>% 
           mutate(r.squared = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ \u0394 fdr (ef1-ef0)', options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```

### Top KDs
```{r}
kd.summary = kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         ) %>% 
  group_by(NODE, node_status) %>% 
  summarise(n_bd = length(unique(Biodomain)),
            bds = list(unique(Biodomain)),
            n_term = length(unique(MODULE)),
            terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_bd), desc(max_delta)) 

DT::datatable(kd.summary %>% select(-bds, -terms), rownames = F, filter = 'top')
```

```{r}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , top == 1
         , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>% 
  DT::datatable(., rownames = F, filter = 'top') %>% 
  DT::formatSignif(columns = c('ef0_fdr','ef1_fdr','delta_fdr'))
```
### KD subnetworks
pull NW to view subgraphs
pull NW to view subgraphs
```{r}
nw = read_nw(which(doms == dom))
snw = igraph::simplify(nw, remove.multiple = T)
```

specify nodes
```{r}
kd.nodes <- kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , top == 1
         , delta_fdr > 0
  ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>%
  group_by(NODE) %>% 
  summarise(n_biodom = length(unique(Biodomain))
         , n_term = length(unique(MODULE))
         , ef1_max = max(ef1_fdr)
         , delta_max = max(delta_fdr)) 

```

subnetwork of just KD Nodes  
```{r}
vert_num <- match(kd.nodes$NODE, V(snw)$name)

g2 <- induced_subgraph(snw, vert_num)
unlinked <- names(degree(g2)[which(degree(g2)==0)])
g2 <- delete.vertices(g2, unlinked)

# KD evidence
x = tibble( node = V(g2) %>% names ) %>%
  left_join(., kd.nodes, by = c('node'='NODE'))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g2, names(x)[i], index = igraph::V(g2)) <- x %>% pull(i)
}

# plot
ggraph(g2, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey75') +
  geom_node_point( color = "black", alpha = .5, 
                   aes(size = n_term, fill = delta_max, shape = node_status )  )+
  geom_node_text(aes(label = name), size = 2) +
  scale_shape_manual( values = c(21,23) )+
  scale_size_continuous( range = c(2,10) )+
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')

```

subnetwork of KD and neighbors
```{r}
vert_neigh <- neighbors(snw, vert_num)

g3 <- induced_subgraph(snw, c(vert_num, vert_neigh))
unlinked <- names(degree(g3)[which(degree(g3)==0)])
g3 <- delete.vertices(g3, unlinked)

# KD evidence
x = tibble( node = V(g3) %>% names ) %>% 
  left_join(., kd.nodes, by = c('node'='NODE')) %>% 
  mutate(kd = if_else(is.na(n_term), 0, 1))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g3, names(x)[i], index = igraph::V(g3)) <- x %>% pull(i)
}

ggraph(g3, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey90') +
  geom_node_point( shape = 21, color = "black", alpha = .3, fill = 'grey90', 
                   aes(filter= .N()$kd == 0)  )+
  geom_node_point( shape = 23, color = "black", alpha = .6, 
                   aes(size = delta_max, fill = ef1_max, filter = .N()$kd == 1) )+
  scale_shape_manual(name='Driver Status', breaks=c('key driver', 'non-driver'),
                     values=c('key driver'=23, 'non-driver'=21))+
  geom_node_text(aes(label = name, filter = .N()$kd == 1), size = 2) +
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'IL7R', term = 'glycerolipid biosynthetic process') )
p
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'AMPH', term = 'clathrin-coated endocytic vesicle membrane') )
p
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'SNAP25', term = 'positive regulation of synaptic transmission') )
p
```


## Immune Response {.tabset}
```{r}
dom = 'Immune_Response'
```

### KDA results
```{r}
# synIDs of BD-specific wKDA results
kd.res = read_kd( which(doms == dom) ) %>% 
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    )
  ) %>% 
  left_join(
    ., biodom %>% select(MODULE = GOterm_Name, Biodomain, abbr:color)
  )

ir.kd.res <- kd.res 
```


```{r}
top <- bind_rows(
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_0.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef0'),
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_1.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef1')
  ) %>%   
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    ))
```

Top KDs depend on edge factor used
```{r fig.width=6, fig.height=8}

cowplot::plot_grid(
  
  ggplot(top, aes(FOLD, -log10(FDR) )) + 
    geom_point(aes(color = node_status), alpha = .5) + 
    theme(legend.position = 'top')+
    facet_wrap(~ef),
  
  top %>% 
    mutate(FDR = -log10(FDR)) %>% 
    pivot_wider(id_cols = c(NODE, MODULE, node_status),
                names_from = ef, values_from = FDR) %>% 
    mutate(across(c(ef0,ef1), ~ if_else(is.na(.x), 0, .x))) %>% 
    ggplot(aes(ef0, ef1))+
    geom_abline(intercept = 0, slope = 1, lty = 2)+
    geom_point( aes(color = node_status), alpha = .5)+
    theme(legend.position = 'top')+
    labs(x = '-log10(FDR)\nuniform edge weights',
         y = '-log10(FDR)\nAD risk edge weights'),
  
  nrow = 2, rel_heights = c(.6,1)
  
)
```


```{r fig.width=8,fig.height=5}
# p2 = 
kd.res %>% 
  ggplot(aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = dom)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .4, size = 1.5, aes(color = color, shape = node_status) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 3, aes(color = color, shape = node_status))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, 
                   ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[which( enr.bd$padj < 0.05 
                                                # & enr.bd$Biodomain == str_replace_all(dom, '_', ' ')
                                                )]
                   & delta_fdr > 0
                   # & !duplicated(NODE)
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  # facet_wrap(dir~filt, scales = 'free', ncol = 4)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

### KD ~ Biodomains

```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_term)) %>% 
  arrange(Biodomain, desc(n_term), desc(max_delta)) %>% 
  ggplot(aes(n_term, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(dom, ' Network Key Drivers'),
       subtitle = 'Biodomain GO terms')+ 
  theme(legend.position = 'bottom')
# +
#   facet_wrap(dir~filt, ncol = 4)
```


```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_node)) %>%
  ggplot(aes(n_node, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0( dom, ' Network Key Drivers'),
       subtitle = 'Nodes')+ 
  theme(legend.position = 'bottom')
# +facet_wrap(dir~filt, ncol = 4)
```

```{r fig.width=10,fig.height=10}
tmp <- kd.res %>% 
  filter( 
    ef1_fdr > -log10(0.05)
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
    , delta_fdr > 0 
         )

ggplot(tmp, aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', 
       title = dom,
       subtitle = 'signif KDs (EF1 FDR < 0.05), \u0394 FDR > 0, for GSEA-enriched terms'
       )+
  # geom_abline(intercept = 0, slope =1, lty= 2, lwd = .5)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 2, aes(color = color))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                   & delta_fdr > 0
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(~Biodomain)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

```{r fig.width=5, fig.height=7}
tmp <- kd.res %>% 
    filter(top == 1
           # ,ef1_fdr > -log10(0.05), delta_fdr > 0, 
           # MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
      ) %>%
  group_by(Biodomain) %>% 
  mutate(n_kd = length(unique(paste0(NODE,':',MODULE)))) %>% 
  ungroup() %>% 
  mutate(Biodomain = fct_reorder(Biodomain, n_kd)) %>% 
  arrange(Biodomain)

ggplot(tmp, aes(delta_fdr, Biodomain))+
  geom_vline(xintercept = 0)+
  geom_jitter(alpha = .2, aes(color = color))+
  geom_violin(aes(color = color), scale = 'width', alpha=.3)+
  labs(y = '', x = '\u0394 FDR, ef1 - ef0')+
  scale_color_identity()
```

```{r}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_term), desc(max_delta), .by_group = T) %>%
  DT::datatable(rownames = F, filter = 'top')
```


### KDs ~ CBrain phenotypes
```{r fig.width=4, fig.height=4}
# crispr brain phenotype hits (any) vs non-hits
cb.hits = simple %>% filter(`Hit Class` != 'Non-Hit') %>% 
  pull(Gene) %>% unique()
cb.nonhits = simple %>% filter( (Gene %in% cb.hits)==F ) %>% 
  pull(Gene) %>% unique()

# ID key drivers from different parameter sets
# comb = kd.res %>% select(filt, dir) %>% distinct() %>% arrange(dir,filt)
kd.hits <- kd.res %>% filter(ef1_fdr > -log10(0.05), top == 1, delta_fdr > 0) %>% pull(NODE) %>% unique()
kd.nonhits <- kd.res %>% filter((NODE %in% kd.hits)==F) %>% pull(NODE) %>% unique()

# calculate fisher stats 
fisher.stats <- tibble(
      pheno_kd = intersect(cb.hits, kd.hits) %>% length(),
      noPheno_kd = intersect(cb.nonhits, kd.hits) %>% length(),
      pheno_nokd = intersect(cb.hits, kd.nonhits) %>% length(),
      noPheno_nokd = intersect(cb.nonhits, kd.nonhits) %>% length()
    ) %>% 
  rowwise() %>% 
  mutate(
      fisher.p = matrix(c(pheno_kd, noPheno_kd, pheno_nokd, noPheno_nokd), nrow = 2) %>% 
      fisher.test( ., alt = 'g') %>% broom::tidy() %>% pull(p.value)
    )

# make plots for each comb
p <- VennDiagram::venn.diagram(
      x = list(
        CRISPRbrain = cb.hits, 
        KeyDrivers = kd.hits
      ),
      filename = NULL,
      force.unique = T,
      lty = 0, alpha = .3, fill = c('light blue','pink'),
      hyper.test = T, 
      total.population = length(intersect(simple$Gene, names(V(base_net)))),
      
      # main = kd.res$bd %>% unique,
      main = paste0(
              'Fisher p = ', fisher.stats$fisher.p[1] %>% signif(digits = 2) ),
      main.cex = .75, sub.cex = .75,
      # cat.pos = c(315,45),
      cat.cex = .8,
      ext.pos = 180,
      ext.dist = -.1
      ) 

cowplot::plot_grid(p)

```

logistic regression
```{r}
nw = read_nw(which(doms == dom))

tmp = simple %>% 
  mutate(cb_hit = if_else( `Hit Class` == 'Non-Hit', 0, 1)) %>% 
  select(cell, mode, expt, Gene, cb_hit) %>% distinct() %>% 
  mutate(kd = if_else(Gene %in% kd.hits, 1, 0)) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>% 
  filter(!is.na(node_degree)) %>% 
  group_by(cell,mode,expt) %>% 
  mutate(
    lr = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>% broom::tidy() %>% 
           filter(term == 'kd') %>% 
           mutate(nobs = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>%  
                    broom::glance() %>% pull(nobs)) %>% list()
    ) %>% 
  unnest(lr)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

tmp %>% 
  select(cell:expt, estimate:nobs) %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'cb_hit ~ kd + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('estimate', 'std.error','statistic', 'p.value'))
```


linear regression  ~ KDA FDR
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(ef1_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         ef1_fdr = scale(ef1_fdr, center = T, scale = T) #/ max(ef1_fdr),
         ) #/ max(abs(gene_score))) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale(abs(gene_score), center = T, scale = T),
         lm = lm(gs~ef1_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'ef1_fdr') %>% 
           mutate(r.squared = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ ef1_fdr + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```


linear regression ~  KDA delta FDR e1/e0
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(delta_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         delta_fdr = scale(delta_fdr, center = T, scale = T) #, / max(ef1_fdr),
         ) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale( abs(gene_score), center = T, scale = T),
         lm = lm(gs~delta_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'delta_fdr') %>% 
           mutate(r.squared = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ \u0394 fdr (ef1-ef0)', options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```

### Top KDs
```{r}
kd.summary = kd.res %>% 
  filter(
    top == 1
    , delta_fdr > 0
    , ef1_fdr > -log10(0.05)
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(NODE, node_status) %>% 
  summarise(n_bd = length(unique(Biodomain)),
            bds = list(unique(Biodomain)),
            n_term = length(unique(MODULE)),
            terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_bd), desc(max_delta)) 

DT::datatable(kd.summary %>% select(-bds, -terms), rownames = F, filter = 'top')
```

```{r}
kd.res %>% 
  filter(
        top == 1
        , delta_fdr > 0
        , ef1_fdr > -log10(0.05)
        , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>% 
  DT::datatable(., rownames = F, filter = 'top') %>% 
  DT::formatSignif(columns = c('ef0_fdr','ef1_fdr','delta_fdr'))
```
### KD subnetworks
pull NW to view subgraphs
```{r}
nw = read_nw(which(doms == dom))
snw = igraph::simplify(nw, remove.multiple = T)
```

specify nodes
```{r}
kd.nodes <- kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , top == 1
         , delta_fdr > 0
  ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>%
  group_by(NODE) %>% 
  summarise(n_biodom = length(unique(Biodomain))
         , n_term = length(unique(MODULE))
         , ef1_max = max(ef1_fdr)
         , delta_max = max(delta_fdr)) 

```

subnetwork of just KD Nodes  
```{r}
vert_num <- match(kd.nodes$NODE, V(snw)$name)

g2 <- induced_subgraph(snw, vert_num)
unlinked <- names(degree(g2)[which(degree(g2)==0)])
g2 <- delete.vertices(g2, unlinked)

# KD evidence
x = tibble( node = V(g2) %>% names ) %>%
  left_join(., kd.nodes, by = c('node'='NODE'))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g2, names(x)[i], index = igraph::V(g2)) <- x %>% pull(i)
}

# plot
ggraph(g2, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey75') +
  geom_node_point( color = "black", alpha = .5, 
                   aes(size = n_term, fill = delta_max, shape = node_status )  )+
  geom_node_text(aes(label = name), size = 2) +
  scale_shape_manual( values = c(21,23) )+
  scale_size_continuous( range = c(2,10) )+
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')

```

subnetwork of KD and neighbors
```{r}
vert_neigh <- neighbors(snw, vert_num)

g3 <- induced_subgraph(snw, c(vert_num, vert_neigh))
unlinked <- names(degree(g3)[which(degree(g3)==0)])
g3 <- delete.vertices(g3, unlinked)

# KD evidence
x = tibble( node = V(g3) %>% names ) %>% 
  left_join(., kd.nodes, by = c('node'='NODE')) %>% 
  mutate(kd = if_else(is.na(n_term), 0, 1))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g3, names(x)[i], index = igraph::V(g3)) <- x %>% pull(i)
}

ggraph(g3, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey90') +
  geom_node_point( shape = 21, color = "black", alpha = .3, fill = 'grey90', 
                   aes(filter= .N()$kd == 0)  )+
  geom_node_point( shape = 23, color = "black", alpha = .6, 
                   aes(size = delta_max, fill = ef1_max, filter = .N()$kd == 1) )+
  scale_shape_manual(name='Driver Status', breaks=c('key driver', 'non-driver'),
                     values=c('key driver'=23, 'non-driver'=21))+
  geom_node_text(aes(label = name, filter = .N()$kd == 1), size = 2) +
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'ATM',term = 'regulation of response to DNA damage stimulus') )
p
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'CTSL', term = 'antigen processing and presentation') )
p
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'IKBKB', term = 'I-kappaB kinase/NF-kappaB signaling') )
p
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'PRKACA', term = 'ion channel binding') )
p
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'TRAF2', term = 'tumor necrosis factor-mediated signaling pathway') )
p
```

## Lipid Metabolism {.tabset}
```{r}
dom = 'Lipid_Metabolism'
```

### KDA results
```{r}
# synIDs of BD-specific wKDA results
kd.res = read_kd( which(doms == dom) ) %>% 
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    )
  ) %>% 
  left_join(
    ., biodom %>% select(MODULE = GOterm_Name, Biodomain, abbr:color)
  )

lm.kd.res <- kd.res 
```


```{r}
top <- bind_rows(
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_0.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef0'),
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_1.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef1')
  ) %>%   
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    ))
```

Top KDs depend on edge factor used
```{r fig.width=6, fig.height=8}

cowplot::plot_grid(
  
  ggplot(top, aes(FOLD, -log10(FDR) )) + 
    geom_point(aes(color = node_status), alpha = .5) + 
    theme(legend.position = 'top')+
    facet_wrap(~ef),
  
  top %>% 
    mutate(FDR = -log10(FDR)) %>% 
    pivot_wider(id_cols = c(NODE, MODULE, node_status),
                names_from = ef, values_from = FDR) %>% 
    mutate(across(c(ef0,ef1), ~ if_else(is.na(.x), 0, .x))) %>% 
    ggplot(aes(ef0, ef1))+
    geom_abline(intercept = 0, slope = 1, lty = 2)+
    geom_point( aes(color = node_status), alpha = .5)+
    theme(legend.position = 'top')+
    labs(x = '-log10(FDR)\nuniform edge weights',
         y = '-log10(FDR)\nAD risk edge weights'),
  
  nrow = 2, rel_heights = c(.6,1)
  
)
```


```{r fig.width=8,fig.height=5}
# p2 = 
kd.res %>% 
  ggplot(aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = dom)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .4, size = 1.5, aes(color = color, shape = node_status) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 3, aes(color = color, shape = node_status))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, 
                   ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[which( enr.bd$padj < 0.05 
                                                # & enr.bd$Biodomain == str_replace_all(dom, '_', ' ')
                                                )]
                   & delta_fdr > 0
                   # & !duplicated(NODE)
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  # facet_wrap(dir~filt, scales = 'free', ncol = 4)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

### KD ~ Biodomains

```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_term)) %>% 
  arrange(Biodomain, desc(n_term), desc(max_delta)) %>% 
  ggplot(aes(n_term, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(dom, ' Network Key Drivers'),
       subtitle = 'Biodomain GO terms')+ 
  theme(legend.position = 'bottom')
# +
#   facet_wrap(dir~filt, ncol = 4)
```


```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_node)) %>%
  ggplot(aes(n_node, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0( dom, ' Network Key Drivers'),
       subtitle = 'Nodes')+ 
  theme(legend.position = 'bottom')
# +facet_wrap(dir~filt, ncol = 4)
```

```{r fig.width=10,fig.height=10}
tmp <- kd.res %>% 
  filter( 
    ef1_fdr > -log10(0.05)
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
    , delta_fdr > 0 
         )

ggplot(tmp, aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', 
       title = dom,
       subtitle = 'signif KDs (EF1 FDR < 0.05), \u0394 FDR > 0, for GSEA-enriched terms'
       )+
  # geom_abline(intercept = 0, slope =1, lty= 2, lwd = .5)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 2, aes(color = color))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                   & delta_fdr > 0
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(~Biodomain)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

```{r fig.width=5, fig.height=7}
tmp <- kd.res %>% 
    filter(top == 1
           , ef1_fdr > -log10(0.05)
           , delta_fdr > 0
           , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
      ) %>%
  group_by(Biodomain) %>% 
  mutate(n_kd = length(unique(paste0(NODE,':',MODULE)))) %>% 
  ungroup() %>% 
  mutate(Biodomain = fct_reorder(Biodomain, n_kd)) %>% 
  arrange(Biodomain)

ggplot(tmp, aes(delta_fdr, Biodomain))+
  geom_vline(xintercept = 0)+
  geom_jitter(alpha = .2, aes(color = color))+
  geom_violin(aes(color = color), scale = 'width', alpha=.3)+
  labs(y = '', x = '\u0394 FDR, ef1 - ef0')+
  scale_color_identity()
```

```{r}
kd.res %>% 
  filter(top == 1
         , ef1_fdr > -log10(0.05)
         , delta_fdr > 0
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_term), desc(max_delta), .by_group = T) %>%
  DT::datatable(rownames = F, filter = 'top')
```


### KDs ~ CBrain phenotypes
```{r fig.width=4, fig.height=4}
# crispr brain phenotype hits (any) vs non-hits
cb.hits = simple %>% filter(`Hit Class` != 'Non-Hit') %>% 
  pull(Gene) %>% unique()
cb.nonhits = simple %>% filter( (Gene %in% cb.hits)==F ) %>% 
  pull(Gene) %>% unique()

# ID key drivers from different parameter sets
# comb = kd.res %>% select(filt, dir) %>% distinct() %>% arrange(dir,filt)
kd.hits <- kd.res %>% filter(ef1_fdr > -log10(0.05), top == 1, delta_fdr > 0) %>% pull(NODE) %>% unique()
kd.nonhits <- kd.res %>% filter((NODE %in% kd.hits)==F) %>% pull(NODE) %>% unique()

# calculate fisher stats 
fisher.stats <- tibble(
      pheno_kd = intersect(cb.hits, kd.hits) %>% length(),
      noPheno_kd = intersect(cb.nonhits, kd.hits) %>% length(),
      pheno_nokd = intersect(cb.hits, kd.nonhits) %>% length(),
      noPheno_nokd = intersect(cb.nonhits, kd.nonhits) %>% length()
    ) %>% 
  rowwise() %>% 
  mutate(
      fisher.p = matrix(c(pheno_kd, noPheno_kd, pheno_nokd, noPheno_nokd), nrow = 2) %>% 
      fisher.test( ., alt = 'g') %>% broom::tidy() %>% pull(p.value)
    )

# make plots for each comb
p <- VennDiagram::venn.diagram(
      x = list(
        CRISPRbrain = cb.hits, 
        KeyDrivers = kd.hits
      ),
      filename = NULL,
      force.unique = T,
      lty = 0, alpha = .3, fill = c('light blue','pink'),
      hyper.test = T, 
      total.population = length(intersect(simple$Gene, names(V(undir_node_edge)))),
      
      # main = kd.res$bd %>% unique,
      main = paste0(
              'Fisher p = ', fisher.stats$fisher.p[1] %>% signif(digits = 2) ),
      main.cex = .75, sub.cex = .75,
      # cat.pos = c(315,45),
      cat.cex = .8,
      ext.pos = 180,
      ext.dist = -.1
      ) 

cowplot::plot_grid(p)

```

logistic regression
```{r}
nw = read_nw(which(doms == dom))

tmp = simple %>% 
  mutate(cb_hit = if_else( `Hit Class` == 'Non-Hit', 0, 1)) %>% 
  select(cell, mode, expt, Gene, cb_hit) %>% distinct() %>% 
  mutate(kd = if_else(Gene %in% kd.hits, 1, 0)) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>% 
  filter(!is.na(node_degree)) %>% 
  group_by(cell,mode,expt) %>% 
  mutate(
    lr = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>% broom::tidy() %>% 
           filter(term == 'kd') %>% 
           mutate(nobs = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>%  
                    broom::glance() %>% pull(nobs)) %>% list()
    ) %>% 
  unnest(lr)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

tmp %>% 
  select(cell:expt, estimate:nobs) %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'cb_hit ~ kd + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('estimate', 'std.error','statistic', 'p.value'))
```


linear regression  ~ KDA FDR
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(ef1_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         ef1_fdr = scale(ef1_fdr, center = T, scale = T) #/ max(ef1_fdr),
         ) #/ max(abs(gene_score))) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale(abs(gene_score), center = T, scale = T),
         lm = lm(gs~ef1_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'ef1_fdr') %>% 
           mutate(r.squared = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ ef1_fdr + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```


linear regression ~  KDA delta FDR e1/e0
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(delta_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         delta_fdr = scale(delta_fdr, center = T, scale = T) #, / max(ef1_fdr),
         ) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale( abs(gene_score), center = T, scale = T),
         lm = lm(gs~delta_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'delta_fdr') %>% 
           mutate(r.squared = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ \u0394 fdr (ef1-ef0)', options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```

### Top KDs
```{r}
kd.summary = kd.res %>% 
  filter(
    top == 1
    , delta_fdr > 0
    , ef1_fdr > -log10(0.05)
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(NODE, node_status) %>% 
  summarise(n_bd = length(unique(Biodomain)),
            bds = list(unique(Biodomain)),
            n_term = length(unique(MODULE)),
            terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_bd), desc(max_delta)) 

DT::datatable(kd.summary %>% select(-bds, -terms), rownames = F, filter = 'top')
```

```{r}
kd.res %>% 
  filter(
        top == 1
        , delta_fdr > 0
        , ef1_fdr > -log10(0.05)
        , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>% 
  DT::datatable(., rownames = F, filter = 'top') %>% 
  DT::formatSignif(columns = c('ef0_fdr','ef1_fdr','delta_fdr'))
```
### KD subnetworks
pull NW to view subgraphs
pull NW to view subgraphs
```{r}
nw = read_nw(which(doms == dom))
snw = igraph::simplify(nw, remove.multiple = T)
```

specify nodes
```{r}
kd.nodes <- kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , top == 1
         , delta_fdr > 0
  ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>%
  group_by(NODE) %>% 
  summarise(n_biodom = length(unique(Biodomain))
         , n_term = length(unique(MODULE))
         , ef1_max = max(ef1_fdr)
         , delta_max = max(delta_fdr)) 

```

subnetwork of just KD Nodes  
```{r}
vert_num <- match(kd.nodes$NODE, V(snw)$name)

g2 <- induced_subgraph(snw, vert_num)
unlinked <- names(degree(g2)[which(degree(g2)==0)])
g2 <- delete.vertices(g2, unlinked)

# KD evidence
x = tibble( node = V(g2) %>% names ) %>%
  left_join(., kd.nodes, by = c('node'='NODE'))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g2, names(x)[i], index = igraph::V(g2)) <- x %>% pull(i)
}

# plot
ggraph(g2, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey75') +
  geom_node_point( color = "black", alpha = .5, 
                   aes(size = n_term, fill = delta_max, shape = node_status )  )+
  geom_node_text(aes(label = name), size = 2) +
  scale_shape_manual( values = c(21,23) )+
  scale_size_continuous( range = c(2,10) )+
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')

```

subnetwork of KD and neighbors
```{r}
vert_neigh <- neighbors(snw, vert_num)

g3 <- induced_subgraph(snw, c(vert_num, vert_neigh))
unlinked <- names(degree(g3)[which(degree(g3)==0)])
g3 <- delete.vertices(g3, unlinked)

# KD evidence
x = tibble( node = V(g3) %>% names ) %>% 
  left_join(., kd.nodes, by = c('node'='NODE')) %>% 
  mutate(kd = if_else(is.na(n_term), 0, 1))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g3, names(x)[i], index = igraph::V(g3)) <- x %>% pull(i)
}

ggraph(g3, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey90') +
  geom_node_point( shape = 21, color = "black", alpha = .3, fill = 'grey90', 
                   aes(filter= .N()$kd == 0)  )+
  geom_node_point( shape = 23, color = "black", alpha = .6, 
                   aes(size = delta_max, fill = ef1_max, filter = .N()$kd == 1) )+
  scale_shape_manual(name='Driver Status', breaks=c('key driver', 'non-driver'),
                     values=c('key driver'=23, 'non-driver'=21))+
  geom_node_text(aes(label = name, filter = .N()$kd == 1), size = 2) +
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'ATM',term = 'regulation of response to DNA damage stimulus') )
p
```

## Mitochondrial Metabolism {.tabset}
```{r}
dom = 'Mitochondrial_Metabolism'
```

### KDA results
```{r}
# synIDs of BD-specific wKDA results
kd.res = read_kd( which(doms == dom) ) %>% 
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    )
  ) %>% 
  left_join(
    ., biodom %>% select(MODULE = GOterm_Name, Biodomain, abbr:color)
  )

mm.kd.res <- kd.res 
```


```{r}
top <- bind_rows(
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_0.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef0'),
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_1.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef1')
  ) %>%   
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    ))
```

Top KDs depend on edge factor used
```{r fig.width=6, fig.height=8}

cowplot::plot_grid(
  
  ggplot(top, aes(FOLD, -log10(FDR) )) + 
    geom_point(aes(color = node_status), alpha = .5) + 
    theme(legend.position = 'top')+
    facet_wrap(~ef),
  
  top %>% 
    mutate(FDR = -log10(FDR)) %>% 
    pivot_wider(id_cols = c(NODE, MODULE, node_status),
                names_from = ef, values_from = FDR) %>% 
    mutate(across(c(ef0,ef1), ~ if_else(is.na(.x), 0, .x))) %>% 
    ggplot(aes(ef0, ef1))+
    geom_abline(intercept = 0, slope = 1, lty = 2)+
    geom_point( aes(color = node_status), alpha = .5)+
    theme(legend.position = 'top')+
    labs(x = '-log10(FDR)\nuniform edge weights',
         y = '-log10(FDR)\nAD risk edge weights'),
  
  nrow = 2, rel_heights = c(.6,1)
  
)
```

```{r fig.width=8,fig.height=5}
# p2 = 
kd.res %>% 
  ggplot(aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = dom)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .4, size = 1.5, aes(color = color, shape = node_status) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 3, aes(color = color, shape = node_status))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, 
                   ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[which( enr.bd$padj < 0.05 
                                                # & enr.bd$Biodomain == str_replace_all(dom, '_', ' ')
                                                )]
                   & delta_fdr > 0
                   # & !duplicated(NODE)
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  # facet_wrap(dir~filt, scales = 'free', ncol = 4)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

### KD ~ Biodomains

```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_term)) %>% 
  arrange(Biodomain, desc(n_term), desc(max_delta)) %>% 
  ggplot(aes(n_term, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(dom, ' Network Key Drivers'),
       subtitle = 'Biodomain GO terms')+ 
  theme(legend.position = 'bottom')
# +
#   facet_wrap(dir~filt, ncol = 4)
```


```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_node)) %>%
  ggplot(aes(n_node, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0( dom, ' Network Key Drivers'),
       subtitle = 'Nodes')+ 
  theme(legend.position = 'bottom')
# +facet_wrap(dir~filt, ncol = 4)
```

```{r fig.width=10,fig.height=10}
tmp <- kd.res %>% 
  filter( 
    top == 1
    , ef1_fdr > -log10(0.05)
    , delta_fdr > 0 
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         )

ggplot(tmp, aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', 
       title = dom,
       subtitle = 'signif KDs (EF1 FDR < 0.05), \u0394 FDR > 0, for GSEA-enriched terms'
       )+
  # geom_abline(intercept = 0, slope =1, lty= 2, lwd = .5)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 2, aes(color = color))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                   & delta_fdr > 0
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(~Biodomain)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

```{r fig.width=5, fig.height=7}
tmp <- kd.res %>% 
    filter(top == 1
           , ef1_fdr > -log10(0.05)
           , delta_fdr > 0
           # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
      ) %>%
  group_by(Biodomain) %>% 
  mutate(n_kd = length(unique(paste0(NODE,':',MODULE)))) %>% 
  ungroup() %>% 
  mutate(Biodomain = fct_reorder(Biodomain, n_kd)) %>% 
  arrange(Biodomain)

ggplot(tmp, aes(delta_fdr, Biodomain))+
  geom_vline(xintercept = 0)+
  geom_jitter(alpha = .2, aes(color = color))+
  geom_violin(aes(color = color), scale = 'width', alpha=.3)+
  labs(y = '', x = '\u0394 FDR, ef1 - ef0')+
  scale_color_identity()
```

```{r}
kd.res %>% 
  filter(top == 1
         , ef1_fdr > -log10(0.05)
         , delta_fdr > 0
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(Biodomain) %>% 
  summarise(n_node = length(unique(NODE)),
            n_term = length(unique(MODULE)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_term), desc(max_delta), .by_group = T) %>%
  DT::datatable(rownames = F, filter = 'top')
```


### KDs ~ CBrain phenotypes
```{r fig.width=4, fig.height=4}
# crispr brain phenotype hits (any) vs non-hits
cb.hits = simple %>% filter(`Hit Class` != 'Non-Hit') %>% 
  pull(Gene) %>% unique()
cb.nonhits = simple %>% filter( (Gene %in% cb.hits)==F ) %>% 
  pull(Gene) %>% unique()

# ID key drivers from different parameter sets
# comb = kd.res %>% select(filt, dir) %>% distinct() %>% arrange(dir,filt)
kd.hits <- kd.res %>% filter(ef1_fdr > -log10(0.05), top == 1, delta_fdr > 0) %>% pull(NODE) %>% unique()
kd.nonhits <- kd.res %>% filter((NODE %in% kd.hits)==F) %>% pull(NODE) %>% unique()

# calculate fisher stats 
fisher.stats <- tibble(
      pheno_kd = intersect(cb.hits, kd.hits) %>% length(),
      noPheno_kd = intersect(cb.nonhits, kd.hits) %>% length(),
      pheno_nokd = intersect(cb.hits, kd.nonhits) %>% length(),
      noPheno_nokd = intersect(cb.nonhits, kd.nonhits) %>% length()
    ) %>% 
  rowwise() %>% 
  mutate(
      fisher.p = matrix(c(pheno_kd, noPheno_kd, pheno_nokd, noPheno_nokd), nrow = 2) %>% 
      fisher.test( ., alt = 'g') %>% broom::tidy() %>% pull(p.value)
    )

# make plots for each comb
p <- VennDiagram::venn.diagram(
      x = list(
        CRISPRbrain = cb.hits, 
        KeyDrivers = kd.hits
      ),
      filename = NULL,
      force.unique = T,
      lty = 0, alpha = .3, fill = c('light blue','pink'),
      hyper.test = T, 
      total.population = length(intersect(simple$Gene, names(V(undir_node_edge)))),
      
      # main = kd.res$bd %>% unique,
      main = paste0(
              'Fisher p = ', fisher.stats$fisher.p[1] %>% signif(digits = 2) ),
      main.cex = .75, sub.cex = .75,
      # cat.pos = c(315,45),
      cat.cex = .8,
      ext.pos = 180,
      ext.dist = -.1
      ) 

cowplot::plot_grid(p)

```

logistic regression
```{r}
nw = read_nw(which(doms == dom))

tmp = simple %>% 
  mutate(cb_hit = if_else( `Hit Class` == 'Non-Hit', 0, 1)) %>% 
  select(cell, mode, expt, Gene, cb_hit) %>% distinct() %>% 
  mutate(kd = if_else(Gene %in% kd.hits, 1, 0)) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>% 
  filter(!is.na(node_degree)) %>% 
  group_by(cell,mode,expt) %>% 
  mutate(
    lr = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>% broom::tidy() %>% 
           filter(term == 'kd') %>% 
           mutate(nobs = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>%  
                    broom::glance() %>% pull(nobs)) %>% list()
    ) %>% 
  unnest(lr)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

tmp %>% 
  select(cell:expt, estimate:nobs) %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'cb_hit ~ kd + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('estimate', 'std.error','statistic', 'p.value'))
```


linear regression  ~ KDA FDR
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(ef1_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         ef1_fdr = scale(ef1_fdr, center = T, scale = T) #/ max(ef1_fdr),
         ) #/ max(abs(gene_score))) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale(abs(gene_score), center = T, scale = T),
         lm = lm(gs~ef1_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'ef1_fdr') %>% 
           mutate(r.squared = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ ef1_fdr + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```


linear regression ~  KDA delta FDR e1/e0
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(delta_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         delta_fdr = scale(delta_fdr, center = T, scale = T) #, / max(ef1_fdr),
         ) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale( abs(gene_score), center = T, scale = T),
         lm = lm(gs~delta_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'delta_fdr') %>% 
           mutate(r.squared = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ \u0394 fdr (ef1-ef0)', options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```

### Top KDs
```{r}
kd.summary = kd.res %>% 
  filter(
    top == 1
    , delta_fdr > 0
    , ef1_fdr > -log10(0.05)
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(NODE, node_status) %>% 
  summarise(n_bd = length(unique(Biodomain)),
            bds = list(unique(Biodomain)),
            n_term = length(unique(MODULE)),
            terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_bd), desc(max_delta)) 

DT::datatable(kd.summary %>% select(-bds, -terms), rownames = F, filter = 'top')
```

```{r}
kd.res %>% 
  filter(
        top == 1
        , delta_fdr > 0
        , ef1_fdr > -log10(0.05)
        , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>% 
  DT::datatable(., rownames = F, filter = 'top') %>% 
  DT::formatSignif(columns = c('ef0_fdr','ef1_fdr','delta_fdr'))
```
### KD subnetworks
pull NW to view subgraphs
pull NW to view subgraphs
```{r}
nw = read_nw(which(doms == dom))
snw = igraph::simplify(nw, remove.multiple = T)
```

specify nodes
```{r}
kd.nodes <- kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , top == 1
         , delta_fdr > 0
  ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>%
  group_by(NODE) %>% 
  summarise(n_biodom = length(unique(Biodomain))
         , n_term = length(unique(MODULE))
         , ef1_max = max(ef1_fdr)
         , delta_max = max(delta_fdr)) 

```

subnetwork of just KD Nodes  
```{r}
vert_num <- match(kd.nodes$NODE, V(snw)$name)

g2 <- induced_subgraph(snw, vert_num)
unlinked <- names(degree(g2)[which(degree(g2)==0)])
g2 <- delete.vertices(g2, unlinked)

# KD evidence
x = tibble( node = V(g2) %>% names ) %>%
  left_join(., kd.nodes, by = c('node'='NODE'))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g2, names(x)[i], index = igraph::V(g2)) <- x %>% pull(i)
}

# plot
ggraph(g2, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey75') +
  geom_node_point( color = "black", alpha = .5, 
                   aes(size = n_term, fill = delta_max, shape = node_status )  )+
  geom_node_text(aes(label = name), size = 2) +
  scale_shape_manual( values = c(21,23) )+
  scale_size_continuous( range = c(2,10) )+
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')

```

subnetwork of KD and neighbors
```{r}
vert_neigh <- neighbors(snw, vert_num)

g3 <- induced_subgraph(snw, c(vert_num, vert_neigh))
unlinked <- names(degree(g3)[which(degree(g3)==0)])
g3 <- delete.vertices(g3, unlinked)

# KD evidence
x = tibble( node = V(g3) %>% names ) %>% 
  left_join(., kd.nodes, by = c('node'='NODE')) %>% 
  mutate(kd = if_else(is.na(n_term), 0, 1))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g3, names(x)[i], index = igraph::V(g3)) <- x %>% pull(i)
}

ggraph(g3, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey90') +
  geom_node_point( shape = 21, color = "black", alpha = .3, fill = 'grey90', 
                   aes(filter= .N()$kd == 0)  )+
  geom_node_point( shape = 23, color = "black", alpha = .6, 
                   aes(size = delta_max, fill = ef1_max, filter = .N()$kd == 1) )+
  scale_shape_manual(name='Driver Status', breaks=c('key driver', 'non-driver'),
                     values=c('key driver'=23, 'non-driver'=21))+
  geom_node_text(aes(label = name, filter = .N()$kd == 1), size = 2) +
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'ATM',term = 'regulation of response to DNA damage stimulus') )
p
```

## Synapse {.tabset}
```{r}
dom = 'Synapse'
```

### KDA results
```{r}
# synIDs of BD-specific wKDA results
kd.res = read_kd( which(doms == dom) ) %>% 
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    )
  ) %>% 
  left_join(
    ., biodom %>% select(MODULE = GOterm_Name, Biodomain, abbr:color)
  )

sy.kd.res <- kd.res 
```


```{r}
top <- bind_rows(
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_0.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef0'),
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_1.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef1')
  ) %>%   
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    ))
```

Top KDs depend on edge factor used
```{r fig.width=6, fig.height=8}

cowplot::plot_grid(
  
  ggplot(top, aes(FOLD, -log10(FDR) )) + 
    geom_point(aes(color = node_status), alpha = .5) + 
    theme(legend.position = 'top')+
    facet_wrap(~ef),
  
  top %>% 
    mutate(FDR = -log10(FDR)) %>% 
    pivot_wider(id_cols = c(NODE, MODULE, node_status),
                names_from = ef, values_from = FDR) %>% 
    mutate(across(c(ef0,ef1), ~ if_else(is.na(.x), 0, .x))) %>% 
    ggplot(aes(ef0, ef1))+
    geom_abline(intercept = 0, slope = 1, lty = 2)+
    geom_point( aes(color = node_status), alpha = .5)+
    theme(legend.position = 'top')+
    labs(x = '-log10(FDR)\nuniform edge weights',
         y = '-log10(FDR)\nAD risk edge weights'),
  
  nrow = 2, rel_heights = c(.6,1)
  
)
```

```{r}
top %>% 
  mutate(FDR = -log10(FDR)) %>% 
  pivot_wider(id_cols = c(NODE, MODULE, node_status),
              names_from = ef, values_from = FDR) %>% 
  mutate(across(c(ef0,ef1), ~ if_else(is.na(.x), 0, .x))) %>% 
  ggplot(aes(ef0, ef1))+
  geom_abline(intercept = 0, slope = 1, lty = 2)+
  geom_point( aes(color = node_status), alpha = .5)+
  labs(x = '-log10(FDR)\nuniform edge weights',
       y = '-log10(FDR)\nAD risk edge weights')
```


```{r fig.width=8,fig.height=5}
# p2 = 
kd.res %>% 
  ggplot(aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = dom)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .4, size = 1.5, aes(color = color, shape = node_status) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 3, aes(color = color, shape = node_status))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, 
                   ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[which( enr.bd$padj < 0.05 
                                                # & enr.bd$Biodomain == str_replace_all(dom, '_', ' ')
                                                )]
                   & delta_fdr > 0
                   # & !duplicated(NODE)
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  # facet_wrap(dir~filt, scales = 'free', ncol = 4)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

### KD ~ Biodomains

```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_term)) %>% 
  arrange(Biodomain, desc(n_term), desc(max_delta)) %>% 
  ggplot(aes(n_term, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(dom, ' Network Key Drivers'),
       subtitle = 'Biodomain GO terms')+ 
  theme(legend.position = 'bottom')
# +
#   facet_wrap(dir~filt, ncol = 4)
```


```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_node)) %>%
  ggplot(aes(n_node, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0( dom, ' Network Key Drivers'),
       subtitle = 'Nodes')+ 
  theme(legend.position = 'bottom')
# +facet_wrap(dir~filt, ncol = 4)
```

```{r fig.width=10,fig.height=10}
tmp <- kd.res %>% 
  filter( 
    top == 1
    , ef1_fdr > -log10(0.05)
    , delta_fdr > 0 
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         )

ggplot(tmp, aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', 
       title = dom,
       subtitle = 'signif KDs (EF1 FDR < 0.05), \u0394 FDR > 0, for GSEA-enriched terms'
       )+
  # geom_abline(intercept = 0, slope =1, lty= 2, lwd = .5)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 2, aes(color = color))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                   & delta_fdr > 0
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(~Biodomain)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

```{r fig.width=5, fig.height=7}
tmp <- kd.res %>% 
    filter(top == 1
           , ef1_fdr > -log10(0.05)
           , delta_fdr > 0
           # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
      ) %>%
  group_by(Biodomain) %>% 
  mutate(n_kd = length(unique(paste0(NODE,':',MODULE)))) %>% 
  ungroup() %>% 
  mutate(Biodomain = fct_reorder(Biodomain, n_kd)) %>% 
  arrange(Biodomain)

ggplot(tmp, aes(delta_fdr, Biodomain))+
  geom_vline(xintercept = 0)+
  geom_jitter(alpha = .2, aes(color = color))+
  geom_violin(aes(color = color), scale = 'width', alpha=.3)+
  labs(y = '', x = '\u0394 FDR, ef1 - ef0')+
  scale_color_identity()
```

```{r}
kd.res %>% 
  filter(top == 1
         , ef1_fdr > -log10(0.05)
         , delta_fdr > 0
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(Biodomain) %>% 
  summarise(n_node = length(unique(NODE)),
            n_term = length(unique(MODULE)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_term), desc(max_delta), .by_group = T) %>%
  DT::datatable(rownames = F, filter = 'top')
```


### KDs ~ CBrain phenotypes
```{r fig.width=4, fig.height=4}
# crispr brain phenotype hits (any) vs non-hits
cb.hits = simple %>% filter(`Hit Class` != 'Non-Hit') %>% 
  pull(Gene) %>% unique()
cb.nonhits = simple %>% filter( (Gene %in% cb.hits)==F ) %>% 
  pull(Gene) %>% unique()

# ID key drivers from different parameter sets
# comb = kd.res %>% select(filt, dir) %>% distinct() %>% arrange(dir,filt)
kd.hits <- kd.res %>% filter(ef1_fdr > -log10(0.05), top == 1, delta_fdr > 0) %>% pull(NODE) %>% unique()
kd.nonhits <- kd.res %>% filter((NODE %in% kd.hits)==F) %>% pull(NODE) %>% unique()

# calculate fisher stats 
fisher.stats <- tibble(
      pheno_kd = intersect(cb.hits, kd.hits) %>% length(),
      noPheno_kd = intersect(cb.nonhits, kd.hits) %>% length(),
      pheno_nokd = intersect(cb.hits, kd.nonhits) %>% length(),
      noPheno_nokd = intersect(cb.nonhits, kd.nonhits) %>% length()
    ) %>% 
  rowwise() %>% 
  mutate(
      fisher.p = matrix(c(pheno_kd, noPheno_kd, pheno_nokd, noPheno_nokd), nrow = 2) %>% 
      fisher.test( ., alt = 'g') %>% broom::tidy() %>% pull(p.value)
    )

# make plots for each comb
p <- VennDiagram::venn.diagram(
      x = list(
        CRISPRbrain = cb.hits, 
        KeyDrivers = kd.hits
      ),
      filename = NULL,
      force.unique = T,
      lty = 0, alpha = .3, fill = c('light blue','pink'),
      hyper.test = T, 
      total.population = length(intersect(simple$Gene, names(V(undir_node_edge)))),
      
      # main = kd.res$bd %>% unique,
      main = paste0(
              'Fisher p = ', fisher.stats$fisher.p[1] %>% signif(digits = 2) ),
      main.cex = .75, sub.cex = .75,
      # cat.pos = c(315,45),
      cat.cex = .8,
      ext.pos = 180,
      ext.dist = -.1
      ) 

cowplot::plot_grid(p)

```

logistic regression
```{r}
nw = read_nw(which(doms == dom))

tmp = simple %>% 
  mutate(cb_hit = if_else( `Hit Class` == 'Non-Hit', 0, 1)) %>% 
  select(cell, mode, expt, Gene, cb_hit) %>% distinct() %>% 
  mutate(kd = if_else(Gene %in% kd.hits, 1, 0)) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>% 
  filter(!is.na(node_degree)) %>% 
  group_by(cell,mode,expt) %>% 
  mutate(
    lr = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>% broom::tidy() %>% 
           filter(term == 'kd') %>% 
           mutate(nobs = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>%  
                    broom::glance() %>% pull(nobs)) %>% list()
    ) %>% 
  unnest(lr)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

tmp %>% 
  select(cell:expt, estimate:nobs) %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'cb_hit ~ kd + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('estimate', 'std.error','statistic', 'p.value'))
```


linear regression  ~ KDA FDR
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(ef1_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         ef1_fdr = scale(ef1_fdr, center = T, scale = T) #/ max(ef1_fdr),
         ) #/ max(abs(gene_score))) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale(abs(gene_score), center = T, scale = T),
         lm = lm(gs~ef1_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'ef1_fdr') %>% 
           mutate(r.squared = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ ef1_fdr + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```


linear regression ~  KDA delta FDR e1/e0
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(delta_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         delta_fdr = scale(delta_fdr, center = T, scale = T) #, / max(ef1_fdr),
         ) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale( abs(gene_score), center = T, scale = T),
         lm = lm(gs~delta_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'delta_fdr') %>% 
           mutate(r.squared = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ \u0394 fdr (ef1-ef0)', options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```

### Top KDs
```{r}
kd.summary = kd.res %>% 
  filter(
    top == 1
    , delta_fdr > 0
    , ef1_fdr > -log10(0.05)
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(NODE, node_status) %>% 
  summarise(n_bd = length(unique(Biodomain)),
            bds = list(unique(Biodomain)),
            n_term = length(unique(MODULE)),
            terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_bd), desc(max_delta)) 

DT::datatable(kd.summary %>% select(-bds, -terms), rownames = F, filter = 'top')
```

```{r}
kd.res %>% 
  filter(
        top == 1
        , delta_fdr > 0
        , ef1_fdr > -log10(0.05)
        , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>% 
  DT::datatable(., rownames = F, filter = 'top') %>% 
  DT::formatSignif(columns = c('ef0_fdr','ef1_fdr','delta_fdr'))
```
### KD subnetworks
pull NW to view subgraphs
pull NW to view subgraphs
```{r}
nw = read_nw(which(doms == dom))
snw = igraph::simplify(nw, remove.multiple = T)
```

specify nodes
```{r}
kd.nodes <- kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , top == 1
         , delta_fdr > 0
  ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>%
  group_by(NODE) %>% 
  summarise(n_biodom = length(unique(Biodomain))
         , n_term = length(unique(MODULE))
         , ef1_max = max(ef1_fdr)
         , delta_max = max(delta_fdr)) 

```

subnetwork of just KD Nodes  
```{r}
vert_num <- match(kd.nodes$NODE, V(snw)$name)

g2 <- induced_subgraph(snw, vert_num)
unlinked <- names(degree(g2)[which(degree(g2)==0)])
g2 <- delete.vertices(g2, unlinked)

# KD evidence
x = tibble( node = V(g2) %>% names ) %>%
  left_join(., kd.nodes, by = c('node'='NODE'))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g2, names(x)[i], index = igraph::V(g2)) <- x %>% pull(i)
}

# plot
ggraph(g2, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey75') +
  geom_node_point( color = "black", alpha = .5, 
                   aes(size = n_term, fill = delta_max, shape = node_status )  )+
  geom_node_text(aes(label = name), size = 2) +
  scale_shape_manual( values = c(21,23) )+
  scale_size_continuous( range = c(2,10) )+
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')

```

subnetwork of KD and neighbors
```{r}
vert_neigh <- neighbors(snw, vert_num)

g3 <- induced_subgraph(snw, c(vert_num, vert_neigh))
unlinked <- names(degree(g3)[which(degree(g3)==0)])
g3 <- delete.vertices(g3, unlinked)

# KD evidence
x = tibble( node = V(g3) %>% names ) %>% 
  left_join(., kd.nodes, by = c('node'='NODE')) %>% 
  mutate(kd = if_else(is.na(n_term), 0, 1))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g3, names(x)[i], index = igraph::V(g3)) <- x %>% pull(i)
}

ggraph(g3, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey90') +
  geom_node_point( shape = 21, color = "black", alpha = .3, fill = 'grey90', 
                   aes(filter= .N()$kd == 0)  )+
  geom_node_point( shape = 23, color = "black", alpha = .6, 
                   aes(size = delta_max, fill = ef1_max, filter = .N()$kd == 1) )+
  scale_shape_manual(name='Driver Status', breaks=c('key driver', 'non-driver'),
                     values=c('key driver'=23, 'non-driver'=21))+
  geom_node_text(aes(label = name, filter = .N()$kd == 1), size = 2) +
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')
```

<!-- ```{r fig.width=12,fig.height=8} -->
<!-- p = suppressWarnings( plot_kd_subnet(nw, kd = 'ATM',term = 'regulation of response to DNA damage stimulus') ) -->
<!-- p -->
<!-- ``` -->


## Structural Stabilization {.tabset}
```{r}
dom = 'Structural_Stabilization'
```

### KDA results
```{r}
# synIDs of BD-specific wKDA results
kd.res = read_kd( which(doms == dom) ) %>% 
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    )
  ) %>% 
  left_join(
    ., biodom %>% select(MODULE = GOterm_Name, Biodomain, abbr:color)
  )

ss.kd.res <- kd.res 
```


```{r}
top <- bind_rows(
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_0.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef0'),
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_1.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef1')
  ) %>%   
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    ))
```

Top KDs depend on edge factor used
```{r fig.width=6, fig.height=8}

cowplot::plot_grid(
  
  ggplot(top, aes(FOLD, -log10(FDR) )) + 
    geom_point(aes(color = node_status), alpha = .5) + 
    theme(legend.position = 'top')+
    facet_wrap(~ef),
  
  top %>% 
    mutate(FDR = -log10(FDR)) %>% 
    pivot_wider(id_cols = c(NODE, MODULE, node_status),
                names_from = ef, values_from = FDR) %>% 
    mutate(across(c(ef0,ef1), ~ if_else(is.na(.x), 0, .x))) %>% 
    ggplot(aes(ef0, ef1))+
    geom_abline(intercept = 0, slope = 1, lty = 2)+
    geom_point( aes(color = node_status), alpha = .5)+
    theme(legend.position = 'top')+
    labs(x = '-log10(FDR)\nuniform edge weights',
         y = '-log10(FDR)\nAD risk edge weights'),
  
  nrow = 2, rel_heights = c(.6,1)
  
)
```


```{r fig.width=8,fig.height=5}
# p2 = 
kd.res %>% 
  ggplot(aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = dom)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .4, size = 1.5, aes(color = color, shape = node_status) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 3, aes(color = color, shape = node_status))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, 
                   ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[which( enr.bd$padj < 0.05 
                                                # & enr.bd$Biodomain == str_replace_all(dom, '_', ' ')
                                                )]
                   & delta_fdr > 0
                   # & !duplicated(NODE)
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  # facet_wrap(dir~filt, scales = 'free', ncol = 4)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

### KD ~ Biodomains

```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_term)) %>% 
  arrange(Biodomain, desc(n_term), desc(max_delta)) %>% 
  ggplot(aes(n_term, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(dom, ' Network Key Drivers'),
       subtitle = 'Biodomain GO terms')+ 
  theme(legend.position = 'bottom')
# +
#   facet_wrap(dir~filt, ncol = 4)
```


```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_node)) %>%
  ggplot(aes(n_node, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0( dom, ' Network Key Drivers'),
       subtitle = 'Nodes')+ 
  theme(legend.position = 'bottom')
# +facet_wrap(dir~filt, ncol = 4)
```

```{r fig.width=10,fig.height=10}
tmp <- kd.res %>% 
  filter( 
    top == 1
    , ef1_fdr > -log10(0.05)
    , delta_fdr > 0 
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         )

ggplot(tmp, aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', 
       title = dom,
       subtitle = 'signif KDs (EF1 FDR < 0.05), \u0394 FDR > 0, for GSEA-enriched terms'
       )+
  # geom_abline(intercept = 0, slope =1, lty= 2, lwd = .5)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 2, aes(color = color))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                   & delta_fdr > 0
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(~Biodomain)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

```{r fig.width=5, fig.height=7}
tmp <- kd.res %>% 
    filter(top == 1
           , ef1_fdr > -log10(0.05)
           , delta_fdr > 0
           # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
      ) %>%
  group_by(Biodomain) %>% 
  mutate(n_kd = length(unique(paste0(NODE,':',MODULE)))) %>% 
  ungroup() %>% 
  mutate(Biodomain = fct_reorder(Biodomain, n_kd)) %>% 
  arrange(Biodomain)

ggplot(tmp, aes(delta_fdr, Biodomain))+
  geom_vline(xintercept = 0)+
  geom_jitter(alpha = .2, aes(color = color))+
  geom_violin(aes(color = color), scale = 'width', alpha=.3)+
  labs(y = '', x = '\u0394 FDR, ef1 - ef0')+
  scale_color_identity()
```

```{r}
kd.res %>% 
  filter(top == 1
         , ef1_fdr > -log10(0.05)
         , delta_fdr > 0
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(Biodomain) %>% 
  summarise(n_node = length(unique(NODE)),
            n_term = length(unique(MODULE)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_term), desc(max_delta), .by_group = T) %>%
  DT::datatable(rownames = F, filter = 'top')
```


### KDs ~ CBrain phenotypes
```{r fig.width=4, fig.height=4}
# crispr brain phenotype hits (any) vs non-hits
cb.hits = simple %>% filter(`Hit Class` != 'Non-Hit') %>% 
  pull(Gene) %>% unique()
cb.nonhits = simple %>% filter( (Gene %in% cb.hits)==F ) %>% 
  pull(Gene) %>% unique()

# ID key drivers from different parameter sets
# comb = kd.res %>% select(filt, dir) %>% distinct() %>% arrange(dir,filt)
kd.hits <- kd.res %>% filter(ef1_fdr > -log10(0.05), top == 1, delta_fdr > 0) %>% pull(NODE) %>% unique()
kd.nonhits <- kd.res %>% filter((NODE %in% kd.hits)==F) %>% pull(NODE) %>% unique()

# calculate fisher stats 
fisher.stats <- tibble(
      pheno_kd = intersect(cb.hits, kd.hits) %>% length(),
      noPheno_kd = intersect(cb.nonhits, kd.hits) %>% length(),
      pheno_nokd = intersect(cb.hits, kd.nonhits) %>% length(),
      noPheno_nokd = intersect(cb.nonhits, kd.nonhits) %>% length()
    ) %>% 
  rowwise() %>% 
  mutate(
      fisher.p = matrix(c(pheno_kd, noPheno_kd, pheno_nokd, noPheno_nokd), nrow = 2) %>% 
      fisher.test( ., alt = 'g') %>% broom::tidy() %>% pull(p.value)
    )

# make plots for each comb
p <- VennDiagram::venn.diagram(
      x = list(
        CRISPRbrain = cb.hits, 
        KeyDrivers = kd.hits
      ),
      filename = NULL,
      force.unique = T,
      lty = 0, alpha = .3, fill = c('light blue','pink'),
      hyper.test = T, 
      total.population = length(intersect(simple$Gene, names(V(undir_node_edge)))),
      
      # main = kd.res$bd %>% unique,
      main = paste0(
              'Fisher p = ', fisher.stats$fisher.p[1] %>% signif(digits = 2) ),
      main.cex = .75, sub.cex = .75,
      # cat.pos = c(315,45),
      cat.cex = .8,
      ext.pos = 180,
      ext.dist = -.1
      ) 

cowplot::plot_grid(p)

```

logistic regression
```{r}
nw = read_nw(which(doms == dom))

tmp = simple %>% 
  mutate(cb_hit = if_else( `Hit Class` == 'Non-Hit', 0, 1)) %>% 
  select(cell, mode, expt, Gene, cb_hit) %>% distinct() %>% 
  mutate(kd = if_else(Gene %in% kd.hits, 1, 0)) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>% 
  filter(!is.na(node_degree)) %>% 
  group_by(cell,mode,expt) %>% 
  mutate(
    lr = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>% broom::tidy() %>% 
           filter(term == 'kd') %>% 
           mutate(nobs = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>%  
                    broom::glance() %>% pull(nobs)) %>% list()
    ) %>% 
  unnest(lr)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

tmp %>% 
  select(cell:expt, estimate:nobs) %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'cb_hit ~ kd + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('estimate', 'std.error','statistic', 'p.value'))
```


linear regression  ~ KDA FDR
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(ef1_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         ef1_fdr = scale(ef1_fdr, center = T, scale = T) #/ max(ef1_fdr),
         ) #/ max(abs(gene_score))) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale(abs(gene_score), center = T, scale = T),
         lm = lm(gs~ef1_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'ef1_fdr') %>% 
           mutate(r.squared = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ ef1_fdr + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```


linear regression ~  KDA delta FDR e1/e0
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(delta_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         delta_fdr = scale(delta_fdr, center = T, scale = T) #, / max(ef1_fdr),
         ) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale( abs(gene_score), center = T, scale = T),
         lm = lm(gs~delta_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'delta_fdr') %>% 
           mutate(r.squared = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ \u0394 fdr (ef1-ef0)', options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```

### Top KDs
```{r}
kd.summary = kd.res %>% 
  filter(
    top == 1
    , delta_fdr > 0
    , ef1_fdr > -log10(0.05)
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(NODE, node_status) %>% 
  summarise(n_bd = length(unique(Biodomain)),
            bds = list(unique(Biodomain)),
            n_term = length(unique(MODULE)),
            terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_bd), desc(max_delta)) 

DT::datatable(kd.summary %>% select(-bds, -terms), rownames = F, filter = 'top')
```

```{r}
kd.res %>% 
  filter(
        top == 1
        , delta_fdr > 0
        , ef1_fdr > -log10(0.05)
        , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>% 
  DT::datatable(., rownames = F, filter = 'top') %>% 
  DT::formatSignif(columns = c('ef0_fdr','ef1_fdr','delta_fdr'))
```
### KD subnetworks
pull NW to view subgraphs
pull NW to view subgraphs
```{r}
nw = read_nw(which(doms == dom))
snw = igraph::simplify(nw, remove.multiple = T)
```

specify nodes
```{r}
kd.nodes <- kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , top == 1
         , delta_fdr > 0
  ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>%
  group_by(NODE) %>% 
  summarise(n_biodom = length(unique(Biodomain))
         , n_term = length(unique(MODULE))
         , ef1_max = max(ef1_fdr)
         , delta_max = max(delta_fdr)) 

```

subnetwork of just KD Nodes  
```{r}
vert_num <- match(kd.nodes$NODE, V(snw)$name)

g2 <- induced_subgraph(snw, vert_num)
unlinked <- names(degree(g2)[which(degree(g2)==0)])
g2 <- delete.vertices(g2, unlinked)

# KD evidence
x = tibble( node = V(g2) %>% names ) %>%
  left_join(., kd.nodes, by = c('node'='NODE'))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g2, names(x)[i], index = igraph::V(g2)) <- x %>% pull(i)
}

# plot
ggraph(g2, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey75') +
  geom_node_point( color = "black", alpha = .5, 
                   aes(size = n_term, fill = delta_max, shape = node_status )  )+
  geom_node_text(aes(label = name), size = 2) +
  scale_shape_manual( values = c(21,23) )+
  scale_size_continuous( range = c(2,10) )+
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')

```

subnetwork of KD and neighbors
```{r}
vert_neigh <- neighbors(snw, vert_num)

g3 <- induced_subgraph(snw, c(vert_num, vert_neigh))
unlinked <- names(degree(g3)[which(degree(g3)==0)])
g3 <- delete.vertices(g3, unlinked)

# KD evidence
x = tibble( node = V(g3) %>% names ) %>% 
  left_join(., kd.nodes, by = c('node'='NODE')) %>% 
  mutate(kd = if_else(is.na(n_term), 0, 1))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g3, names(x)[i], index = igraph::V(g3)) <- x %>% pull(i)
}

ggraph(g3, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey90') +
  geom_node_point( shape = 21, color = "black", alpha = .3, fill = 'grey90', 
                   aes(filter= .N()$kd == 0)  )+
  geom_node_point( shape = 23, color = "black", alpha = .6, 
                   aes(size = delta_max, fill = ef1_max, filter = .N()$kd == 1) )+
  scale_shape_manual(name='Driver Status', breaks=c('key driver', 'non-driver'),
                     values=c('key driver'=23, 'non-driver'=21))+
  geom_node_text(aes(label = name, filter = .N()$kd == 1), size = 2) +
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')
```

<!-- ```{r fig.width=12,fig.height=8} -->
<!-- p = suppressWarnings( plot_kd_subnet(nw, kd = 'MRPL4',term = 'mitochondrial large ribosomal subunit') ) -->
<!-- p -->
<!-- ``` -->

## Proteostasis {.tabset}
```{r}
dom = 'Proteostasis'
```

### KDA results
```{r}
# synIDs of BD-specific wKDA results
kd.res = read_kd( which(doms == dom) ) %>% 
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    )
  ) %>% 
  left_join(
    ., biodom %>% select(MODULE = GOterm_Name, Biodomain, abbr:color)
  )

pr.kd.res <- kd.res 
```


```{r}
top <- bind_rows(
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_0.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef0'),
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_1.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef1')
  ) %>%   
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    ))
```

Top KDs depend on edge factor used
```{r fig.width=6, fig.height=8}

cowplot::plot_grid(
  
  ggplot(top, aes(FOLD, -log10(FDR) )) + 
    geom_point(aes(color = node_status), alpha = .5) + 
    theme(legend.position = 'top')+
    facet_wrap(~ef),
  
  top %>% 
    mutate(FDR = -log10(FDR)) %>% 
    pivot_wider(id_cols = c(NODE, MODULE, node_status),
                names_from = ef, values_from = FDR) %>% 
    mutate(across(c(ef0,ef1), ~ if_else(is.na(.x), 0, .x))) %>% 
    ggplot(aes(ef0, ef1))+
    geom_abline(intercept = 0, slope = 1, lty = 2)+
    geom_point( aes(color = node_status), alpha = .5)+
    theme(legend.position = 'top')+
    labs(x = '-log10(FDR)\nuniform edge weights',
         y = '-log10(FDR)\nAD risk edge weights'),
  
  nrow = 2, rel_heights = c(.6,1)
  
)
```

```{r fig.width=8,fig.height=5}
# p2 = 
kd.res %>% 
  ggplot(aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = dom)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .4, size = 1.5, aes(color = color, shape = node_status) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 3, aes(color = color, shape = node_status))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, 
                   ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[which( enr.bd$padj < 0.05 
                                                # & enr.bd$Biodomain == str_replace_all(dom, '_', ' ')
                                                )]
                   & delta_fdr > 0
                   # & !duplicated(NODE)
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  # facet_wrap(dir~filt, scales = 'free', ncol = 4)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

### KD ~ Biodomains

```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_term)) %>% 
  arrange(Biodomain, desc(n_term), desc(max_delta)) %>% 
  ggplot(aes(n_term, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(dom, ' Network Key Drivers'),
       subtitle = 'Biodomain GO terms')+ 
  theme(legend.position = 'bottom')
# +
#   facet_wrap(dir~filt, ncol = 4)
```


```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_node)) %>%
  ggplot(aes(n_node, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0( dom, ' Network Key Drivers'),
       subtitle = 'Nodes')+ 
  theme(legend.position = 'bottom')
# +facet_wrap(dir~filt, ncol = 4)
```

```{r fig.width=10,fig.height=10}
tmp <- kd.res %>% 
  filter( 
    top == 1
    , ef1_fdr > -log10(0.05)
    , delta_fdr > 0 
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         )

ggplot(tmp, aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', 
       title = dom,
       subtitle = 'signif KDs (EF1 FDR < 0.05), \u0394 FDR > 0, for GSEA-enriched terms'
       )+
  # geom_abline(intercept = 0, slope =1, lty= 2, lwd = .5)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 2, aes(color = color))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                   & delta_fdr > 0
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(~Biodomain)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

```{r fig.width=5, fig.height=7}
tmp <- kd.res %>% 
    filter(top == 1
           , ef1_fdr > -log10(0.05)
           , delta_fdr > 0
           # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
      ) %>%
  group_by(Biodomain) %>% 
  mutate(n_kd = length(unique(paste0(NODE,':',MODULE)))) %>% 
  ungroup() %>% 
  mutate(Biodomain = fct_reorder(Biodomain, n_kd)) %>% 
  arrange(Biodomain)

ggplot(tmp, aes(delta_fdr, Biodomain))+
  geom_vline(xintercept = 0)+
  geom_jitter(alpha = .2, aes(color = color))+
  geom_violin(aes(color = color), scale = 'width', alpha=.3)+
  labs(y = '', x = '\u0394 FDR, ef1 - ef0')+
  scale_color_identity()
```

```{r}
kd.res %>% 
  filter(top == 1
         , ef1_fdr > -log10(0.05)
         , delta_fdr > 0
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(Biodomain) %>% 
  summarise(n_node = length(unique(NODE)),
            n_term = length(unique(MODULE)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_term), desc(max_delta), .by_group = T) %>%
  DT::datatable(rownames = F, filter = 'top')
```


### KDs ~ CBrain phenotypes
```{r fig.width=4, fig.height=4}
# crispr brain phenotype hits (any) vs non-hits
cb.hits = simple %>% filter(`Hit Class` != 'Non-Hit') %>% 
  pull(Gene) %>% unique()
cb.nonhits = simple %>% filter( (Gene %in% cb.hits)==F ) %>% 
  pull(Gene) %>% unique()

# ID key drivers from different parameter sets
# comb = kd.res %>% select(filt, dir) %>% distinct() %>% arrange(dir,filt)
kd.hits <- kd.res %>% filter(ef1_fdr > -log10(0.05), top == 1, delta_fdr > 0) %>% pull(NODE) %>% unique()
kd.nonhits <- kd.res %>% filter((NODE %in% kd.hits)==F) %>% pull(NODE) %>% unique()

# calculate fisher stats 
fisher.stats <- tibble(
      pheno_kd = intersect(cb.hits, kd.hits) %>% length(),
      noPheno_kd = intersect(cb.nonhits, kd.hits) %>% length(),
      pheno_nokd = intersect(cb.hits, kd.nonhits) %>% length(),
      noPheno_nokd = intersect(cb.nonhits, kd.nonhits) %>% length()
    ) %>% 
  rowwise() %>% 
  mutate(
      fisher.p = matrix(c(pheno_kd, noPheno_kd, pheno_nokd, noPheno_nokd), nrow = 2) %>% 
      fisher.test( ., alt = 'g') %>% broom::tidy() %>% pull(p.value)
    )

# make plots for each comb
p <- VennDiagram::venn.diagram(
      x = list(
        CRISPRbrain = cb.hits, 
        KeyDrivers = kd.hits
      ),
      filename = NULL,
      force.unique = T,
      lty = 0, alpha = .3, fill = c('light blue','pink'),
      hyper.test = T, 
      total.population = length(intersect(simple$Gene, names(V(undir_node_edge)))),
      
      # main = kd.res$bd %>% unique,
      main = paste0(
              'Fisher p = ', fisher.stats$fisher.p[1] %>% signif(digits = 2) ),
      main.cex = .75, sub.cex = .75,
      # cat.pos = c(315,45),
      cat.cex = .8,
      ext.pos = 180,
      ext.dist = -.1
      ) 

cowplot::plot_grid(p)

```

logistic regression
```{r}
nw = read_nw(which(doms == dom))

tmp = simple %>% 
  mutate(cb_hit = if_else( `Hit Class` == 'Non-Hit', 0, 1)) %>% 
  select(cell, mode, expt, Gene, cb_hit) %>% distinct() %>% 
  mutate(kd = if_else(Gene %in% kd.hits, 1, 0)) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>% 
  filter(!is.na(node_degree)) %>% 
  group_by(cell,mode,expt) %>% 
  mutate(
    lr = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>% broom::tidy() %>% 
           filter(term == 'kd') %>% 
           mutate(nobs = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>%  
                    broom::glance() %>% pull(nobs)) %>% list()
    ) %>% 
  unnest(lr)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

tmp %>% 
  select(cell:expt, estimate:nobs) %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'cb_hit ~ kd + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('estimate', 'std.error','statistic', 'p.value'))
```


linear regression  ~ KDA FDR
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(ef1_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         ef1_fdr = scale(ef1_fdr, center = T, scale = T) #/ max(ef1_fdr),
         ) #/ max(abs(gene_score))) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale(abs(gene_score), center = T, scale = T),
         lm = lm(gs~ef1_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'ef1_fdr') %>% 
           mutate(r.squared = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ ef1_fdr + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```


linear regression ~  KDA delta FDR e1/e0
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(delta_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         delta_fdr = scale(delta_fdr, center = T, scale = T) #, / max(ef1_fdr),
         ) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale( abs(gene_score), center = T, scale = T),
         lm = lm(gs~delta_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'delta_fdr') %>% 
           mutate(r.squared = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ \u0394 fdr (ef1-ef0)', options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```

### Top KDs
```{r}
kd.summary = kd.res %>% 
  filter(
    top == 1
    , delta_fdr > 0
    , ef1_fdr > -log10(0.05)
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(NODE, node_status) %>% 
  summarise(n_bd = length(unique(Biodomain)),
            bds = list(unique(Biodomain)),
            n_term = length(unique(MODULE)),
            terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_bd), desc(max_delta)) 

DT::datatable(kd.summary %>% select(-bds, -terms), rownames = F, filter = 'top')
```

```{r}
kd.res %>% 
  filter(
        top == 1
        , delta_fdr > 0
        , ef1_fdr > -log10(0.05)
        , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>% 
  DT::datatable(., rownames = F, filter = 'top') %>% 
  DT::formatSignif(columns = c('ef0_fdr','ef1_fdr','delta_fdr'))
```
### KD subnetworks
pull NW to view subgraphs
pull NW to view subgraphs
```{r}
nw = read_nw(which(doms == dom))
snw = igraph::simplify(nw, remove.multiple = T)
```

specify nodes
```{r}
kd.nodes <- kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , top == 1
         , delta_fdr > 0
  ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>%
  group_by(NODE) %>% 
  summarise(n_biodom = length(unique(Biodomain))
         , n_term = length(unique(MODULE))
         , ef1_max = max(ef1_fdr)
         , delta_max = max(delta_fdr)) 

```

subnetwork of just KD Nodes  
```{r}
vert_num <- match(kd.nodes$NODE, V(snw)$name)

g2 <- induced_subgraph(snw, vert_num)
unlinked <- names(degree(g2)[which(degree(g2)==0)])
g2 <- delete.vertices(g2, unlinked)

# KD evidence
x = tibble( node = V(g2) %>% names ) %>%
  left_join(., kd.nodes, by = c('node'='NODE'))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g2, names(x)[i], index = igraph::V(g2)) <- x %>% pull(i)
}

# plot
ggraph(g2, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey75') +
  geom_node_point( color = "black", alpha = .5, 
                   aes(size = n_term, fill = delta_max, shape = node_status )  )+
  geom_node_text(aes(label = name), size = 2) +
  scale_shape_manual( values = c(21,23) )+
  scale_size_continuous( range = c(2,10) )+
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')

```

subnetwork of KD and neighbors
```{r}
vert_neigh <- neighbors(snw, vert_num)

g3 <- induced_subgraph(snw, c(vert_num, vert_neigh))
unlinked <- names(degree(g3)[which(degree(g3)==0)])
g3 <- delete.vertices(g3, unlinked)

# KD evidence
x = tibble( node = V(g3) %>% names ) %>% 
  left_join(., kd.nodes, by = c('node'='NODE')) %>% 
  mutate(kd = if_else(is.na(n_term), 0, 1))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g3, names(x)[i], index = igraph::V(g3)) <- x %>% pull(i)
}

ggraph(g3, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey90') +
  geom_node_point( shape = 21, color = "black", alpha = .3, fill = 'grey90', 
                   aes(filter= .N()$kd == 0)  )+
  geom_node_point( shape = 23, color = "black", alpha = .6, 
                   aes(size = delta_max, fill = ef1_max, filter = .N()$kd == 1) )+
  scale_shape_manual(name='Driver Status', breaks=c('key driver', 'non-driver'),
                     values=c('key driver'=23, 'non-driver'=21))+
  geom_node_text(aes(label = name, filter = .N()$kd == 1), size = 2) +
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')
```

<!-- ```{r fig.width=12,fig.height=8} -->
<!-- p = suppressWarnings( plot_kd_subnet(nw, kd = 'MRPL4',term = 'mitochondrial large ribosomal subunit') ) -->
<!-- p -->
<!-- ``` -->

## Cell Cycle {.tabset}
```{r}
dom = 'Cell_Cycle'
```

### KDA results
```{r}
# synIDs of BD-specific wKDA results
kd.res = read_kd( which(doms == dom) ) %>% 
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    )
  ) %>% 
  left_join(
    ., biodom %>% select(MODULE = GOterm_Name, Biodomain, abbr:color)
  )

cc.kd.res <- kd.res 
```


```{r}
top <- bind_rows(
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_0.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef0'),
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_1.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef1')
  ) %>%   
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    ))
```

Top KDs depend on edge factor used
```{r fig.width=6, fig.height=8}

cowplot::plot_grid(
  
  ggplot(top, aes(FOLD, -log10(FDR) )) + 
    geom_point(aes(color = node_status), alpha = .5) + 
    theme(legend.position = 'top')+
    facet_wrap(~ef),
  
  top %>% 
    mutate(FDR = -log10(FDR)) %>% 
    pivot_wider(id_cols = c(NODE, MODULE, node_status),
                names_from = ef, values_from = FDR) %>% 
    mutate(across(c(ef0,ef1), ~ if_else(is.na(.x), 0, .x))) %>% 
    ggplot(aes(ef0, ef1))+
    geom_abline(intercept = 0, slope = 1, lty = 2)+
    geom_point( aes(color = node_status), alpha = .5)+
    theme(legend.position = 'top')+
    labs(x = '-log10(FDR)\nuniform edge weights',
         y = '-log10(FDR)\nAD risk edge weights'),
  
  nrow = 2, rel_heights = c(.6,1)
  
)
```


```{r fig.width=8,fig.height=5}
# p2 = 
kd.res %>% 
  ggplot(aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = dom)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .4, size = 1.5, aes(color = color, shape = node_status) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 3, aes(color = color, shape = node_status))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, 
                   ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[which( enr.bd$padj < 0.05 
                                                # & enr.bd$Biodomain == str_replace_all(dom, '_', ' ')
                                                )]
                   & delta_fdr > 0
                   # & !duplicated(NODE)
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  # facet_wrap(dir~filt, scales = 'free', ncol = 4)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

### KD ~ Biodomains

```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_term)) %>% 
  arrange(Biodomain, desc(n_term), desc(max_delta)) %>% 
  ggplot(aes(n_term, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(dom, ' Network Key Drivers'),
       subtitle = 'Biodomain GO terms')+ 
  theme(legend.position = 'bottom')
# +
#   facet_wrap(dir~filt, ncol = 4)
```


```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_node)) %>%
  ggplot(aes(n_node, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0( dom, ' Network Key Drivers'),
       subtitle = 'Nodes')+ 
  theme(legend.position = 'bottom')
# +facet_wrap(dir~filt, ncol = 4)
```

```{r fig.width=10,fig.height=10}
tmp <- kd.res %>% 
  filter( 
    top == 1
    , ef1_fdr > -log10(0.05)
    , delta_fdr > 0 
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         )

ggplot(tmp, aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', 
       title = dom,
       subtitle = 'signif KDs (EF1 FDR < 0.05), \u0394 FDR > 0, for GSEA-enriched terms'
       )+
  # geom_abline(intercept = 0, slope =1, lty= 2, lwd = .5)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 2, aes(color = color))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                   & delta_fdr > 0
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(~Biodomain)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

```{r fig.width=5, fig.height=7}
tmp <- kd.res %>% 
    filter(top == 1
           , ef1_fdr > -log10(0.05)
           , delta_fdr > 0
           # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
      ) %>%
  group_by(Biodomain) %>% 
  mutate(n_kd = length(unique(paste0(NODE,':',MODULE)))) %>% 
  ungroup() %>% 
  mutate(Biodomain = fct_reorder(Biodomain, n_kd)) %>% 
  arrange(Biodomain)

ggplot(tmp, aes(delta_fdr, Biodomain))+
  geom_vline(xintercept = 0)+
  geom_jitter(alpha = .2, aes(color = color))+
  geom_violin(aes(color = color), scale = 'width', alpha=.3)+
  labs(y = '', x = '\u0394 FDR, ef1 - ef0')+
  scale_color_identity()
```

```{r}
kd.res %>% 
  filter(top == 1
         , ef1_fdr > -log10(0.05)
         , delta_fdr > 0
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(Biodomain) %>% 
  summarise(n_node = length(unique(NODE)),
            n_term = length(unique(MODULE)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_term), desc(max_delta), .by_group = T) %>%
  DT::datatable(rownames = F, filter = 'top')
```


### KDs ~ CBrain phenotypes
```{r fig.width=4, fig.height=4}
# crispr brain phenotype hits (any) vs non-hits
cb.hits = simple %>% filter(`Hit Class` != 'Non-Hit') %>% 
  pull(Gene) %>% unique()
cb.nonhits = simple %>% filter( (Gene %in% cb.hits)==F ) %>% 
  pull(Gene) %>% unique()

# ID key drivers from different parameter sets
# comb = kd.res %>% select(filt, dir) %>% distinct() %>% arrange(dir,filt)
kd.hits <- kd.res %>% filter(ef1_fdr > -log10(0.05), top == 1, delta_fdr > 0) %>% pull(NODE) %>% unique()
kd.nonhits <- kd.res %>% filter((NODE %in% kd.hits)==F) %>% pull(NODE) %>% unique()

# calculate fisher stats 
fisher.stats <- tibble(
      pheno_kd = intersect(cb.hits, kd.hits) %>% length(),
      noPheno_kd = intersect(cb.nonhits, kd.hits) %>% length(),
      pheno_nokd = intersect(cb.hits, kd.nonhits) %>% length(),
      noPheno_nokd = intersect(cb.nonhits, kd.nonhits) %>% length()
    ) %>% 
  rowwise() %>% 
  mutate(
      fisher.p = matrix(c(pheno_kd, noPheno_kd, pheno_nokd, noPheno_nokd), nrow = 2) %>% 
      fisher.test( ., alt = 'g') %>% broom::tidy() %>% pull(p.value)
    )

# make plots for each comb
p <- VennDiagram::venn.diagram(
      x = list(
        CRISPRbrain = cb.hits, 
        KeyDrivers = kd.hits
      ),
      filename = NULL,
      force.unique = T,
      lty = 0, alpha = .3, fill = c('light blue','pink'),
      hyper.test = T, 
      total.population = length(intersect(simple$Gene, names(V(undir_node_edge)))),
      
      # main = kd.res$bd %>% unique,
      main = paste0(
              'Fisher p = ', fisher.stats$fisher.p[1] %>% signif(digits = 2) ),
      main.cex = .75, sub.cex = .75,
      # cat.pos = c(315,45),
      cat.cex = .8,
      ext.pos = 180,
      ext.dist = -.1
      ) 

cowplot::plot_grid(p)

```

logistic regression
```{r}
nw = read_nw(which(doms == dom))

tmp = simple %>% 
  mutate(cb_hit = if_else( `Hit Class` == 'Non-Hit', 0, 1)) %>% 
  select(cell, mode, expt, Gene, cb_hit) %>% distinct() %>% 
  mutate(kd = if_else(Gene %in% kd.hits, 1, 0)) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>% 
  filter(!is.na(node_degree)) %>% 
  group_by(cell,mode,expt) %>% 
  mutate(
    lr = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>% broom::tidy() %>% 
           filter(term == 'kd') %>% 
           mutate(nobs = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>%  
                    broom::glance() %>% pull(nobs)) %>% list()
    ) %>% 
  unnest(lr)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

tmp %>% 
  select(cell:expt, estimate:nobs) %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'cb_hit ~ kd + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('estimate', 'std.error','statistic', 'p.value'))
```


linear regression  ~ KDA FDR
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(ef1_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         ef1_fdr = scale(ef1_fdr, center = T, scale = T) #/ max(ef1_fdr),
         ) #/ max(abs(gene_score))) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale(abs(gene_score), center = T, scale = T),
         lm = lm(gs~ef1_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'ef1_fdr') %>% 
           mutate(r.squared = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ ef1_fdr + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```


linear regression ~  KDA delta FDR e1/e0
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(delta_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         delta_fdr = scale(delta_fdr, center = T, scale = T) #, / max(ef1_fdr),
         ) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale( abs(gene_score), center = T, scale = T),
         lm = lm(gs~delta_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'delta_fdr') %>% 
           mutate(r.squared = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ \u0394 fdr (ef1-ef0)', options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```

### Top KDs
```{r}
kd.summary = kd.res %>% 
  filter(
    top == 1
    , delta_fdr > 0
    , ef1_fdr > -log10(0.05)
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(NODE, node_status) %>% 
  summarise(n_bd = length(unique(Biodomain)),
            bds = list(unique(Biodomain)),
            n_term = length(unique(MODULE)),
            terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_bd), desc(max_delta)) 

DT::datatable(kd.summary %>% select(-bds, -terms), rownames = F, filter = 'top')
```

```{r}
kd.res %>% 
  filter(
        top == 1
        , delta_fdr > 0
        , ef1_fdr > -log10(0.05)
        , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>% 
  DT::datatable(., rownames = F, filter = 'top') %>% 
  DT::formatSignif(columns = c('ef0_fdr','ef1_fdr','delta_fdr'))
```
### KD subnetworks
pull NW to view subgraphs
pull NW to view subgraphs
```{r}
nw = read_nw(which(doms == dom))
snw = igraph::simplify(nw, remove.multiple = T)
```

specify nodes
```{r}
kd.nodes <- kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , top == 1
         , delta_fdr > 0
  ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>%
  group_by(NODE) %>% 
  summarise(n_biodom = length(unique(Biodomain))
         , n_term = length(unique(MODULE))
         , ef1_max = max(ef1_fdr)
         , delta_max = max(delta_fdr)) 

```

subnetwork of just KD Nodes  
```{r}
vert_num <- match(kd.nodes$NODE, V(snw)$name)

g2 <- induced_subgraph(snw, vert_num)
unlinked <- names(degree(g2)[which(degree(g2)==0)])
g2 <- delete.vertices(g2, unlinked)

# KD evidence
x = tibble( node = V(g2) %>% names ) %>%
  left_join(., kd.nodes, by = c('node'='NODE'))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g2, names(x)[i], index = igraph::V(g2)) <- x %>% pull(i)
}

# plot
ggraph(g2, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey75') +
  geom_node_point( color = "black", alpha = .5, 
                   aes(size = n_term, fill = delta_max, shape = node_status )  )+
  geom_node_text(aes(label = name), size = 2) +
  scale_shape_manual( values = c(21,23) )+
  scale_size_continuous( range = c(2,10) )+
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')

```

subnetwork of KD and neighbors
```{r}
vert_neigh <- neighbors(snw, vert_num)

g3 <- induced_subgraph(snw, c(vert_num, vert_neigh))
unlinked <- names(degree(g3)[which(degree(g3)==0)])
g3 <- delete.vertices(g3, unlinked)

# KD evidence
x = tibble( node = V(g3) %>% names ) %>% 
  left_join(., kd.nodes, by = c('node'='NODE')) %>% 
  mutate(kd = if_else(is.na(n_term), 0, 1))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g3, names(x)[i], index = igraph::V(g3)) <- x %>% pull(i)
}

ggraph(g3, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey90') +
  geom_node_point( shape = 21, color = "black", alpha = .3, fill = 'grey90', 
                   aes(filter= .N()$kd == 0)  )+
  geom_node_point( shape = 23, color = "black", alpha = .6, 
                   aes(size = delta_max, fill = ef1_max, filter = .N()$kd == 1) )+
  scale_shape_manual(name='Driver Status', breaks=c('key driver', 'non-driver'),
                     values=c('key driver'=23, 'non-driver'=21))+
  geom_node_text(aes(label = name, filter = .N()$kd == 1), size = 2) +
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')
```

<!-- ```{r fig.width=12,fig.height=8} -->
<!-- p = suppressWarnings( plot_kd_subnet(nw, kd = 'MRPL4',term = 'mitochondrial large ribosomal subunit') ) -->
<!-- p -->
<!-- ``` -->

## Apoptosis {.tabset}
```{r}
dom = 'Apoptosis'
```

### KDA results
```{r}
# synIDs of BD-specific wKDA results
kd.res = read_kd( which(doms == dom) ) %>% 
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    )
  ) %>% 
  left_join(
    ., biodom %>% select(MODULE = GOterm_Name, Biodomain, abbr:color)
  )

ap.kd.res <- kd.res 
```


```{r}
top <- bind_rows(
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_0.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef0'),
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_1.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef1')
  ) %>%   
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    ))
```

Top KDs depend on edge factor used
```{r fig.width=6, fig.height=8}

cowplot::plot_grid(
  
  ggplot(top, aes(FOLD, -log10(FDR) )) + 
    geom_point(aes(color = node_status), alpha = .5) + 
    theme(legend.position = 'top')+
    facet_wrap(~ef),
  
  top %>% 
    mutate(FDR = -log10(FDR)) %>% 
    pivot_wider(id_cols = c(NODE, MODULE, node_status),
                names_from = ef, values_from = FDR) %>% 
    mutate(across(c(ef0,ef1), ~ if_else(is.na(.x), 0, .x))) %>% 
    ggplot(aes(ef0, ef1))+
    geom_abline(intercept = 0, slope = 1, lty = 2)+
    geom_point( aes(color = node_status), alpha = .5)+
    theme(legend.position = 'top')+
    labs(x = '-log10(FDR)\nuniform edge weights',
         y = '-log10(FDR)\nAD risk edge weights'),
  
  nrow = 2, rel_heights = c(.6,1)
  
)
```


```{r fig.width=8,fig.height=5}
# p2 = 
kd.res %>% 
  ggplot(aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = dom)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .4, size = 1.5, aes(color = color, shape = node_status) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 3, aes(color = color, shape = node_status))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, 
                   ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[which( enr.bd$padj < 0.05 
                                                # & enr.bd$Biodomain == str_replace_all(dom, '_', ' ')
                                                )]
                   & delta_fdr > 0
                   # & !duplicated(NODE)
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  # facet_wrap(dir~filt, scales = 'free', ncol = 4)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

### KD ~ Biodomains

```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_term)) %>% 
  arrange(Biodomain, desc(n_term), desc(max_delta)) %>% 
  ggplot(aes(n_term, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(dom, ' Network Key Drivers'),
       subtitle = 'Biodomain GO terms')+ 
  theme(legend.position = 'bottom')
# +
#   facet_wrap(dir~filt, ncol = 4)
```


```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_node)) %>%
  ggplot(aes(n_node, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0( dom, ' Network Key Drivers'),
       subtitle = 'Nodes')+ 
  theme(legend.position = 'bottom')
# +facet_wrap(dir~filt, ncol = 4)
```

```{r fig.width=10,fig.height=10}
tmp <- kd.res %>% 
  filter( 
    top == 1
    , ef1_fdr > -log10(0.05)
    , delta_fdr > 0 
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         )

ggplot(tmp, aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', 
       title = dom,
       subtitle = 'signif KDs (EF1 FDR < 0.05), \u0394 FDR > 0, for GSEA-enriched terms'
       )+
  # geom_abline(intercept = 0, slope =1, lty= 2, lwd = .5)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 2, aes(color = color))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                   & delta_fdr > 0
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(~Biodomain)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

```{r fig.width=5, fig.height=7}
tmp <- kd.res %>% 
    filter(top == 1
           , ef1_fdr > -log10(0.05)
           , delta_fdr > 0
           # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
      ) %>%
  group_by(Biodomain) %>% 
  mutate(n_kd = length(unique(paste0(NODE,':',MODULE)))) %>% 
  ungroup() %>% 
  mutate(Biodomain = fct_reorder(Biodomain, n_kd)) %>% 
  arrange(Biodomain)

ggplot(tmp, aes(delta_fdr, Biodomain))+
  geom_vline(xintercept = 0)+
  geom_jitter(alpha = .2, aes(color = color))+
  geom_violin(aes(color = color), scale = 'width', alpha=.3)+
  labs(y = '', x = '\u0394 FDR, ef1 - ef0')+
  scale_color_identity()
```

```{r}
kd.res %>% 
  filter(top == 1
         , ef1_fdr > -log10(0.05)
         , delta_fdr > 0
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(Biodomain) %>% 
  summarise(n_node = length(unique(NODE)),
            n_term = length(unique(MODULE)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_term), desc(max_delta), .by_group = T) %>%
  DT::datatable(rownames = F, filter = 'top')
```


### KDs ~ CBrain phenotypes
```{r fig.width=4, fig.height=4}
# crispr brain phenotype hits (any) vs non-hits
cb.hits = simple %>% filter(`Hit Class` != 'Non-Hit') %>% 
  pull(Gene) %>% unique()
cb.nonhits = simple %>% filter( (Gene %in% cb.hits)==F ) %>% 
  pull(Gene) %>% unique()

# ID key drivers from different parameter sets
# comb = kd.res %>% select(filt, dir) %>% distinct() %>% arrange(dir,filt)
kd.hits <- kd.res %>% filter(ef1_fdr > -log10(0.05), top == 1, delta_fdr > 0) %>% pull(NODE) %>% unique()
kd.nonhits <- kd.res %>% filter((NODE %in% kd.hits)==F) %>% pull(NODE) %>% unique()

# calculate fisher stats 
fisher.stats <- tibble(
      pheno_kd = intersect(cb.hits, kd.hits) %>% length(),
      noPheno_kd = intersect(cb.nonhits, kd.hits) %>% length(),
      pheno_nokd = intersect(cb.hits, kd.nonhits) %>% length(),
      noPheno_nokd = intersect(cb.nonhits, kd.nonhits) %>% length()
    ) %>% 
  rowwise() %>% 
  mutate(
      fisher.p = matrix(c(pheno_kd, noPheno_kd, pheno_nokd, noPheno_nokd), nrow = 2) %>% 
      fisher.test( ., alt = 'g') %>% broom::tidy() %>% pull(p.value)
    )

# make plots for each comb
p <- VennDiagram::venn.diagram(
      x = list(
        CRISPRbrain = cb.hits, 
        KeyDrivers = kd.hits
      ),
      filename = NULL,
      force.unique = T,
      lty = 0, alpha = .3, fill = c('light blue','pink'),
      hyper.test = T, 
      total.population = length(intersect(simple$Gene, names(V(undir_node_edge)))),
      
      # main = kd.res$bd %>% unique,
      main = paste0(
              'Fisher p = ', fisher.stats$fisher.p[1] %>% signif(digits = 2) ),
      main.cex = .75, sub.cex = .75,
      # cat.pos = c(315,45),
      cat.cex = .8,
      ext.pos = 180,
      ext.dist = -.1
      ) 

cowplot::plot_grid(p)

```

logistic regression
```{r}
nw = read_nw(which(doms == dom))

tmp = simple %>% 
  mutate(cb_hit = if_else( `Hit Class` == 'Non-Hit', 0, 1)) %>% 
  select(cell, mode, expt, Gene, cb_hit) %>% distinct() %>% 
  mutate(kd = if_else(Gene %in% kd.hits, 1, 0)) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>% 
  filter(!is.na(node_degree)) %>% 
  group_by(cell,mode,expt) %>% 
  mutate(
    lr = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>% broom::tidy() %>% 
           filter(term == 'kd') %>% 
           mutate(nobs = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>%  
                    broom::glance() %>% pull(nobs)) %>% list()
    ) %>% 
  unnest(lr)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

tmp %>% 
  select(cell:expt, estimate:nobs) %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'cb_hit ~ kd + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('estimate', 'std.error','statistic', 'p.value'))
```


linear regression  ~ KDA FDR
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(ef1_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         ef1_fdr = scale(ef1_fdr, center = T, scale = T) #/ max(ef1_fdr),
         ) #/ max(abs(gene_score))) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale(abs(gene_score), center = T, scale = T),
         lm = lm(gs~ef1_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'ef1_fdr') %>% 
           mutate(r.squared = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ ef1_fdr + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```


linear regression ~  KDA delta FDR e1/e0
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(delta_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         delta_fdr = scale(delta_fdr, center = T, scale = T) #, / max(ef1_fdr),
         ) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale( abs(gene_score), center = T, scale = T),
         lm = lm(gs~delta_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'delta_fdr') %>% 
           mutate(r.squared = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ \u0394 fdr (ef1-ef0)', options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```

### Top KDs
```{r}
kd.summary = kd.res %>% 
  filter(
    top == 1
    , delta_fdr > 0
    , ef1_fdr > -log10(0.05)
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(NODE, node_status) %>% 
  summarise(n_bd = length(unique(Biodomain)),
            bds = list(unique(Biodomain)),
            n_term = length(unique(MODULE)),
            terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_bd), desc(max_delta)) 

DT::datatable(kd.summary %>% select(-bds, -terms), rownames = F, filter = 'top')
```

```{r}
kd.res %>% 
  filter(
        top == 1
        , delta_fdr > 0
        , ef1_fdr > -log10(0.05)
        , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>% 
  DT::datatable(., rownames = F, filter = 'top') %>% 
  DT::formatSignif(columns = c('ef0_fdr','ef1_fdr','delta_fdr'))
```
### KD subnetworks
pull NW to view subgraphs
pull NW to view subgraphs
```{r}
nw = read_nw(which(doms == dom))
snw = igraph::simplify(nw, remove.multiple = T)
```

specify nodes
```{r}
kd.nodes <- kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , top == 1
         , delta_fdr > 0
  ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>%
  group_by(NODE) %>% 
  summarise(n_biodom = length(unique(Biodomain))
         , n_term = length(unique(MODULE))
         , ef1_max = max(ef1_fdr)
         , delta_max = max(delta_fdr)) 

```

subnetwork of just KD Nodes  
```{r}
vert_num <- match(kd.nodes$NODE, V(snw)$name)

g2 <- induced_subgraph(snw, vert_num)
unlinked <- names(degree(g2)[which(degree(g2)==0)])
g2 <- delete.vertices(g2, unlinked)

# KD evidence
x = tibble( node = V(g2) %>% names ) %>%
  left_join(., kd.nodes, by = c('node'='NODE'))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g2, names(x)[i], index = igraph::V(g2)) <- x %>% pull(i)
}

# plot
ggraph(g2, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey75') +
  geom_node_point( color = "black", alpha = .5, 
                   aes(size = n_term, fill = delta_max, shape = node_status )  )+
  geom_node_text(aes(label = name), size = 2) +
  scale_shape_manual( values = c(21,23) )+
  scale_size_continuous( range = c(2,10) )+
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')

```

subnetwork of KD and neighbors
```{r}
vert_neigh <- neighbors(snw, vert_num)

g3 <- induced_subgraph(snw, c(vert_num, vert_neigh))
unlinked <- names(degree(g3)[which(degree(g3)==0)])
g3 <- delete.vertices(g3, unlinked)

# KD evidence
x = tibble( node = V(g3) %>% names ) %>% 
  left_join(., kd.nodes, by = c('node'='NODE')) %>% 
  mutate(kd = if_else(is.na(n_term), 0, 1))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g3, names(x)[i], index = igraph::V(g3)) <- x %>% pull(i)
}

ggraph(g3, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey90') +
  geom_node_point( shape = 21, color = "black", alpha = .3, fill = 'grey90', 
                   aes(filter= .N()$kd == 0)  )+
  geom_node_point( shape = 23, color = "black", alpha = .6, 
                   aes(size = delta_max, fill = ef1_max, filter = .N()$kd == 1) )+
  scale_shape_manual(name='Driver Status', breaks=c('key driver', 'non-driver'),
                     values=c('key driver'=23, 'non-driver'=21))+
  geom_node_text(aes(label = name, filter = .N()$kd == 1), size = 2) +
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')
```


<!-- ```{r fig.width=12,fig.height=8} -->
<!-- p = suppressWarnings( plot_kd_subnet(nw, kd = 'MRPL4',term = 'mitochondrial large ribosomal subunit') ) -->
<!-- p -->
<!-- ``` -->

## Vasculature {.tabset}
```{r}
dom = 'Vasculature'
```

### KDA results
```{r}
# synIDs of BD-specific wKDA results
kd.res = read_kd( which(doms == dom) ) %>% 
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    )
  ) %>% 
  left_join(
    ., biodom %>% select(MODULE = GOterm_Name, Biodomain, abbr:color)
  )

va.kd.res <- kd.res 
```


```{r}
top <- bind_rows(
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_0.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef0'),
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_1.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef1')
  ) %>%   
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    ))
```

Top KDs depend on edge factor used
```{r fig.width=6, fig.height=8}

cowplot::plot_grid(
  
  ggplot(top, aes(FOLD, -log10(FDR) )) + 
    geom_point(aes(color = node_status), alpha = .5) + 
    theme(legend.position = 'top')+
    facet_wrap(~ef),
  
  top %>% 
    mutate(FDR = -log10(FDR)) %>% 
    pivot_wider(id_cols = c(NODE, MODULE, node_status),
                names_from = ef, values_from = FDR) %>% 
    mutate(across(c(ef0,ef1), ~ if_else(is.na(.x), 0, .x))) %>% 
    ggplot(aes(ef0, ef1))+
    geom_abline(intercept = 0, slope = 1, lty = 2)+
    geom_point( aes(color = node_status), alpha = .5)+
    theme(legend.position = 'top')+
    labs(x = '-log10(FDR)\nuniform edge weights',
         y = '-log10(FDR)\nAD risk edge weights'),
  
  nrow = 2, rel_heights = c(.6,1)
  
)
```


```{r fig.width=8,fig.height=5}
# p2 = 
kd.res %>% 
  ggplot(aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = dom)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .4, size = 1.5, aes(color = color, shape = node_status) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 3, aes(color = color, shape = node_status))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, 
                   ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[which( enr.bd$padj < 0.05 
                                                # & enr.bd$Biodomain == str_replace_all(dom, '_', ' ')
                                                )]
                   & delta_fdr > 0
                   # & !duplicated(NODE)
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  # facet_wrap(dir~filt, scales = 'free', ncol = 4)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

### KD ~ Biodomains

```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_term)) %>% 
  arrange(Biodomain, desc(n_term), desc(max_delta)) %>% 
  ggplot(aes(n_term, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(dom, ' Network Key Drivers'),
       subtitle = 'Biodomain GO terms')+ 
  theme(legend.position = 'bottom')
# +
#   facet_wrap(dir~filt, ncol = 4)
```


```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_node)) %>%
  ggplot(aes(n_node, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0( dom, ' Network Key Drivers'),
       subtitle = 'Nodes')+ 
  theme(legend.position = 'bottom')
# +facet_wrap(dir~filt, ncol = 4)
```

```{r fig.width=10,fig.height=10}
tmp <- kd.res %>% 
  filter( 
    top == 1
    , ef1_fdr > -log10(0.05)
    , delta_fdr > 0 
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         )

ggplot(tmp, aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', 
       title = dom,
       subtitle = 'signif KDs (EF1 FDR < 0.05), \u0394 FDR > 0, for GSEA-enriched terms'
       )+
  # geom_abline(intercept = 0, slope =1, lty= 2, lwd = .5)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 2, aes(color = color))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                   & delta_fdr > 0
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(~Biodomain)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

```{r fig.width=5, fig.height=7}
tmp <- kd.res %>% 
    filter(top == 1
           , ef1_fdr > -log10(0.05)
           , delta_fdr > 0
           # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
      ) %>%
  group_by(Biodomain) %>% 
  mutate(n_kd = length(unique(paste0(NODE,':',MODULE)))) %>% 
  ungroup() %>% 
  mutate(Biodomain = fct_reorder(Biodomain, n_kd)) %>% 
  arrange(Biodomain)

ggplot(tmp, aes(delta_fdr, Biodomain))+
  geom_vline(xintercept = 0)+
  geom_jitter(alpha = .2, aes(color = color))+
  geom_violin(aes(color = color), scale = 'width', alpha=.3)+
  labs(y = '', x = '\u0394 FDR, ef1 - ef0')+
  scale_color_identity()
```

```{r}
kd.res %>% 
  filter(top == 1
         , ef1_fdr > -log10(0.05)
         , delta_fdr > 0
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(Biodomain) %>% 
  summarise(n_node = length(unique(NODE)),
            n_term = length(unique(MODULE)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_term), desc(max_delta), .by_group = T) %>%
  DT::datatable(rownames = F, filter = 'top')
```


### KDs ~ CBrain phenotypes
```{r fig.width=4, fig.height=4}
# crispr brain phenotype hits (any) vs non-hits
cb.hits = simple %>% filter(`Hit Class` != 'Non-Hit') %>% 
  pull(Gene) %>% unique()
cb.nonhits = simple %>% filter( (Gene %in% cb.hits)==F ) %>% 
  pull(Gene) %>% unique()

# ID key drivers from different parameter sets
# comb = kd.res %>% select(filt, dir) %>% distinct() %>% arrange(dir,filt)
kd.hits <- kd.res %>% filter(ef1_fdr > -log10(0.05), top == 1, delta_fdr > 0) %>% pull(NODE) %>% unique()
kd.nonhits <- kd.res %>% filter((NODE %in% kd.hits)==F) %>% pull(NODE) %>% unique()

# calculate fisher stats 
fisher.stats <- tibble(
      pheno_kd = intersect(cb.hits, kd.hits) %>% length(),
      noPheno_kd = intersect(cb.nonhits, kd.hits) %>% length(),
      pheno_nokd = intersect(cb.hits, kd.nonhits) %>% length(),
      noPheno_nokd = intersect(cb.nonhits, kd.nonhits) %>% length()
    ) %>% 
  rowwise() %>% 
  mutate(
      fisher.p = matrix(c(pheno_kd, noPheno_kd, pheno_nokd, noPheno_nokd), nrow = 2) %>% 
      fisher.test( ., alt = 'g') %>% broom::tidy() %>% pull(p.value)
    )

# make plots for each comb
p <- VennDiagram::venn.diagram(
      x = list(
        CRISPRbrain = cb.hits, 
        KeyDrivers = kd.hits
      ),
      filename = NULL,
      force.unique = T,
      lty = 0, alpha = .3, fill = c('light blue','pink'),
      hyper.test = T, 
      total.population = length(intersect(simple$Gene, names(V(undir_node_edge)))),
      
      # main = kd.res$bd %>% unique,
      main = paste0(
              'Fisher p = ', fisher.stats$fisher.p[1] %>% signif(digits = 2) ),
      main.cex = .75, sub.cex = .75,
      # cat.pos = c(315,45),
      cat.cex = .8,
      ext.pos = 180,
      ext.dist = -.1
      ) 

cowplot::plot_grid(p)

```

logistic regression
```{r}
nw = read_nw(which(doms == dom))

tmp = simple %>% 
  mutate(cb_hit = if_else( `Hit Class` == 'Non-Hit', 0, 1)) %>% 
  select(cell, mode, expt, Gene, cb_hit) %>% distinct() %>% 
  mutate(kd = if_else(Gene %in% kd.hits, 1, 0)) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>% 
  filter(!is.na(node_degree)) %>% 
  group_by(cell,mode,expt) %>% 
  mutate(
    lr = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>% broom::tidy() %>% 
           filter(term == 'kd') %>% 
           mutate(nobs = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>%  
                    broom::glance() %>% pull(nobs)) %>% list()
    ) %>% 
  unnest(lr)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

tmp %>% 
  select(cell:expt, estimate:nobs) %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'cb_hit ~ kd + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('estimate', 'std.error','statistic', 'p.value'))
```


linear regression  ~ KDA FDR
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(ef1_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         ef1_fdr = scale(ef1_fdr, center = T, scale = T) #/ max(ef1_fdr),
         ) #/ max(abs(gene_score))) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale(abs(gene_score), center = T, scale = T),
         lm = lm(gs~ef1_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'ef1_fdr') %>% 
           mutate(r.squared = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ ef1_fdr + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```


linear regression ~  KDA delta FDR e1/e0
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(delta_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         delta_fdr = scale(delta_fdr, center = T, scale = T) #, / max(ef1_fdr),
         ) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale( abs(gene_score), center = T, scale = T),
         lm = lm(gs~delta_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'delta_fdr') %>% 
           mutate(r.squared = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ \u0394 fdr (ef1-ef0)', options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```

### Top KDs
```{r}
kd.summary = kd.res %>% 
  filter(
    top == 1
    , delta_fdr > 0
    , ef1_fdr > -log10(0.05)
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(NODE, node_status) %>% 
  summarise(n_bd = length(unique(Biodomain)),
            bds = list(unique(Biodomain)),
            n_term = length(unique(MODULE)),
            terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_bd), desc(max_delta)) 

DT::datatable(kd.summary %>% select(-bds, -terms), rownames = F, filter = 'top')
```

```{r}
kd.res %>% 
  filter(
        top == 1
        , delta_fdr > 0
        , ef1_fdr > -log10(0.05)
        , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>% 
  DT::datatable(., rownames = F, filter = 'top') %>% 
  DT::formatSignif(columns = c('ef0_fdr','ef1_fdr','delta_fdr'))
```
### KD subnetworks
pull NW to view subgraphs
pull NW to view subgraphs
```{r}
nw = read_nw(which(doms == dom))
snw = igraph::simplify(nw, remove.multiple = T)
```

specify nodes
```{r}
kd.nodes <- kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , top == 1
         , delta_fdr > 0
  ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>%
  group_by(NODE) %>% 
  summarise(n_biodom = length(unique(Biodomain))
         , n_term = length(unique(MODULE))
         , ef1_max = max(ef1_fdr)
         , delta_max = max(delta_fdr)) 

```

subnetwork of just KD Nodes  
```{r}
vert_num <- match(kd.nodes$NODE, V(snw)$name)

g2 <- induced_subgraph(snw, vert_num)
unlinked <- names(degree(g2)[which(degree(g2)==0)])
g2 <- delete.vertices(g2, unlinked)

# KD evidence
x = tibble( node = V(g2) %>% names ) %>%
  left_join(., kd.nodes, by = c('node'='NODE'))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g2, names(x)[i], index = igraph::V(g2)) <- x %>% pull(i)
}

# plot
ggraph(g2, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey75') +
  geom_node_point( color = "black", alpha = .5, 
                   aes(size = n_term, fill = delta_max, shape = node_status )  )+
  geom_node_text(aes(label = name), size = 2) +
  scale_shape_manual( values = c(21,23) )+
  scale_size_continuous( range = c(2,10) )+
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')

```

subnetwork of KD and neighbors
```{r}
vert_neigh <- neighbors(snw, vert_num)

g3 <- induced_subgraph(snw, c(vert_num, vert_neigh))
unlinked <- names(degree(g3)[which(degree(g3)==0)])
g3 <- delete.vertices(g3, unlinked)

# KD evidence
x = tibble( node = V(g3) %>% names ) %>% 
  left_join(., kd.nodes, by = c('node'='NODE')) %>% 
  mutate(kd = if_else(is.na(n_term), 0, 1))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g3, names(x)[i], index = igraph::V(g3)) <- x %>% pull(i)
}

ggraph(g3, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey90') +
  geom_node_point( shape = 21, color = "black", alpha = .3, fill = 'grey90', 
                   aes(filter= .N()$kd == 0)  )+
  geom_node_point( shape = 23, color = "black", alpha = .6, 
                   aes(size = delta_max, fill = ef1_max, filter = .N()$kd == 1) )+
  scale_shape_manual(name='Driver Status', breaks=c('key driver', 'non-driver'),
                     values=c('key driver'=23, 'non-driver'=21))+
  geom_node_text(aes(label = name, filter = .N()$kd == 1), size = 2) +
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')
```


<!-- ```{r fig.width=12,fig.height=8} -->
<!-- p = suppressWarnings( plot_kd_subnet(nw, kd = 'MRPL4',term = 'mitochondrial large ribosomal subunit') ) -->
<!-- p -->
<!-- ``` -->

## Myelination {.tabset}
```{r}
dom = 'Myelination'
```

### KDA results
```{r}
# synIDs of BD-specific wKDA results
kd.res = read_kd( which(doms == dom) ) %>% 
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    )
  ) %>% 
  left_join(
    ., biodom %>% select(MODULE = GOterm_Name, Biodomain, abbr:color)
  )

my.kd.res <- kd.res 
```


```{r}
top <- bind_rows(
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_0.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef0'),
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_1.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef1')
  ) %>%   
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    ))
```

Top KDs depend on edge factor used
```{r fig.width=6, fig.height=8}

cowplot::plot_grid(
  
  ggplot(top, aes(FOLD, -log10(FDR) )) + 
    geom_point(aes(color = node_status), alpha = .5) + 
    theme(legend.position = 'top')+
    facet_wrap(~ef),
  
  top %>% 
    mutate(FDR = -log10(FDR)) %>% 
    pivot_wider(id_cols = c(NODE, MODULE, node_status),
                names_from = ef, values_from = FDR) %>% 
    mutate(across(c(ef0,ef1), ~ if_else(is.na(.x), 0, .x))) %>% 
    ggplot(aes(ef0, ef1))+
    geom_abline(intercept = 0, slope = 1, lty = 2)+
    geom_point( aes(color = node_status), alpha = .5)+
    theme(legend.position = 'top')+
    labs(x = '-log10(FDR)\nuniform edge weights',
         y = '-log10(FDR)\nAD risk edge weights'),
  
  nrow = 2, rel_heights = c(.6,1)
  
)
```

```{r fig.width=8,fig.height=5}
# p2 = 
kd.res %>% 
  ggplot(aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = dom)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .4, size = 1.5, aes(color = color, shape = node_status) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 3, aes(color = color, shape = node_status))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, 
                   ef1_fdr > -log10(0.05)
                   & top == 1
                   # & MODULE %in% enr.bd$pathway[which( enr.bd$padj < 0.05 
                   #                              # & enr.bd$Biodomain == str_replace_all(dom, '_', ' ')
                   #                              )]
                   & delta_fdr > 0
                   # & !duplicated(NODE)
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  # facet_wrap(dir~filt, scales = 'free', ncol = 4)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

### KD ~ Biodomains

```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_term)) %>% 
  arrange(Biodomain, desc(n_term), desc(max_delta)) %>% 
  ggplot(aes(n_term, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(dom, ' Network Key Drivers'),
       subtitle = 'Biodomain GO terms')+ 
  theme(legend.position = 'bottom')
# +
#   facet_wrap(dir~filt, ncol = 4)
```


```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_node)) %>%
  ggplot(aes(n_node, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0( dom, ' Network Key Drivers'),
       subtitle = 'Nodes')+ 
  theme(legend.position = 'bottom')
# +facet_wrap(dir~filt, ncol = 4)
```

```{r fig.width=10,fig.height=10}
tmp <- kd.res %>% 
  filter( 
    top == 1
    , ef1_fdr > -log10(0.05)
    , delta_fdr > 0 
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         )

ggplot(tmp, aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', 
       title = dom,
       subtitle = 'signif KDs (EF1 FDR < 0.05), \u0394 FDR > 0, for GSEA-enriched terms'
       )+
  # geom_abline(intercept = 0, slope =1, lty= 2, lwd = .5)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 2, aes(color = color))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, ef1_fdr > -log10(0.05)
                   & top == 1
                   # & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                   & delta_fdr > 0
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(~Biodomain)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

```{r fig.width=5, fig.height=7}
tmp <- kd.res %>% 
    filter(top == 1
           , ef1_fdr > -log10(0.05)
           , delta_fdr > 0
           # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
      ) %>%
  group_by(Biodomain) %>% 
  mutate(n_kd = length(unique(paste0(NODE,':',MODULE)))) %>% 
  ungroup() %>% 
  mutate(Biodomain = fct_reorder(Biodomain, n_kd)) %>% 
  arrange(Biodomain)

ggplot(tmp, aes(delta_fdr, Biodomain))+
  geom_vline(xintercept = 0)+
  geom_jitter(alpha = .2, aes(color = color))+
  geom_violin(aes(color = color), scale = 'width', alpha=.3)+
  labs(y = '', x = '\u0394 FDR, ef1 - ef0')+
  scale_color_identity()
```

```{r}
kd.res %>% 
  filter(top == 1
         , ef1_fdr > -log10(0.05)
         , delta_fdr > 0
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(Biodomain) %>% 
  summarise(n_node = length(unique(NODE)),
            n_term = length(unique(MODULE)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_term), desc(max_delta), .by_group = T) %>%
  DT::datatable(rownames = F, filter = 'top')
```


### KDs ~ CBrain phenotypes
```{r fig.width=4, fig.height=4}
# crispr brain phenotype hits (any) vs non-hits
cb.hits = simple %>% filter(`Hit Class` != 'Non-Hit') %>% 
  pull(Gene) %>% unique()
cb.nonhits = simple %>% filter( (Gene %in% cb.hits)==F ) %>% 
  pull(Gene) %>% unique()

# ID key drivers from different parameter sets
# comb = kd.res %>% select(filt, dir) %>% distinct() %>% arrange(dir,filt)
kd.hits <- kd.res %>% filter(ef1_fdr > -log10(0.05), top == 1, delta_fdr > 0) %>% pull(NODE) %>% unique()
kd.nonhits <- kd.res %>% filter((NODE %in% kd.hits)==F) %>% pull(NODE) %>% unique()

# calculate fisher stats 
fisher.stats <- tibble(
      pheno_kd = intersect(cb.hits, kd.hits) %>% length(),
      noPheno_kd = intersect(cb.nonhits, kd.hits) %>% length(),
      pheno_nokd = intersect(cb.hits, kd.nonhits) %>% length(),
      noPheno_nokd = intersect(cb.nonhits, kd.nonhits) %>% length()
    ) %>% 
  rowwise() %>% 
  mutate(
      fisher.p = matrix(c(pheno_kd, noPheno_kd, pheno_nokd, noPheno_nokd), nrow = 2) %>% 
      fisher.test( ., alt = 'g') %>% broom::tidy() %>% pull(p.value)
    )

# make plots for each comb
p <- VennDiagram::venn.diagram(
      x = list(
        CRISPRbrain = cb.hits, 
        KeyDrivers = kd.hits
      ),
      filename = NULL,
      force.unique = T,
      lty = 0, alpha = .3, fill = c('light blue','pink'),
      hyper.test = T, 
      total.population = length(intersect(simple$Gene, names(V(undir_node_edge)))),
      
      # main = kd.res$bd %>% unique,
      main = paste0(
              'Fisher p = ', fisher.stats$fisher.p[1] %>% signif(digits = 2) ),
      main.cex = .75, sub.cex = .75,
      # cat.pos = c(315,45),
      cat.cex = .8,
      ext.pos = 180,
      ext.dist = -.1
      ) 

cowplot::plot_grid(p)

```

logistic regression
```{r}
nw = read_nw(which(doms == dom))

tmp = simple %>% 
  mutate(cb_hit = if_else( `Hit Class` == 'Non-Hit', 0, 1)) %>% 
  select(cell, mode, expt, Gene, cb_hit) %>% distinct() %>% 
  mutate(kd = if_else(Gene %in% kd.hits, 1, 0)) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>% 
  filter(!is.na(node_degree)) %>% 
  group_by(cell,mode,expt) %>% 
  mutate(
    lr = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>% broom::tidy() %>% 
           filter(term == 'kd') %>% 
           mutate(nobs = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>%  
                    broom::glance() %>% pull(nobs)) %>% list()
    ) %>% 
  unnest(lr)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

tmp %>% 
  select(cell:expt, estimate:nobs) %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'cb_hit ~ kd + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('estimate', 'std.error','statistic', 'p.value'))
```


linear regression  ~ KDA FDR
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(ef1_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         ef1_fdr = scale(ef1_fdr, center = T, scale = T) #/ max(ef1_fdr),
         ) #/ max(abs(gene_score))) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale(abs(gene_score), center = T, scale = T),
         lm = lm(gs~ef1_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'ef1_fdr') %>% 
           mutate(r.squared = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ ef1_fdr + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```


linear regression ~  KDA delta FDR e1/e0
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(delta_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         delta_fdr = scale(delta_fdr, center = T, scale = T) #, / max(ef1_fdr),
         ) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale( abs(gene_score), center = T, scale = T),
         lm = lm(gs~delta_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'delta_fdr') %>% 
           mutate(r.squared = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ \u0394 fdr (ef1-ef0)', options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```

### Top KDs
```{r}
kd.summary = kd.res %>% 
  filter(
    top == 1
    , delta_fdr > 0
    , ef1_fdr > -log10(0.05)
    # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(NODE, node_status) %>% 
  summarise(n_bd = length(unique(Biodomain)),
            bds = list(unique(Biodomain)),
            n_term = length(unique(MODULE)),
            terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_bd), desc(max_delta)) 

DT::datatable(kd.summary %>% select(-bds, -terms), rownames = F, filter = 'top')
```

```{r}
kd.res %>% 
  filter(
        top == 1
        , delta_fdr > 0
        , ef1_fdr > -log10(0.05)
        # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>% 
  DT::datatable(., rownames = F, filter = 'top') %>% 
  DT::formatSignif(columns = c('ef0_fdr','ef1_fdr','delta_fdr'))
```
### KD subnetworks
pull NW to view subgraphs
pull NW to view subgraphs
```{r}
nw = read_nw(which(doms == dom))
snw = igraph::simplify(nw, remove.multiple = T)
```

specify nodes
```{r}
kd.nodes <- kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , top == 1
         , delta_fdr > 0
  ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>%
  group_by(NODE) %>% 
  summarise(n_biodom = length(unique(Biodomain))
         , n_term = length(unique(MODULE))
         , ef1_max = max(ef1_fdr)
         , delta_max = max(delta_fdr)) 

```

subnetwork of just KD Nodes  
```{r}
vert_num <- match(kd.nodes$NODE, V(snw)$name)

g2 <- induced_subgraph(snw, vert_num)
unlinked <- names(degree(g2)[which(degree(g2)==0)])
g2 <- delete.vertices(g2, unlinked)

# KD evidence
x = tibble( node = V(g2) %>% names ) %>%
  left_join(., kd.nodes, by = c('node'='NODE'))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g2, names(x)[i], index = igraph::V(g2)) <- x %>% pull(i)
}

# plot
ggraph(g2, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey75') +
  geom_node_point( color = "black", alpha = .5, 
                   aes(size = n_term, fill = delta_max, shape = node_status )  )+
  geom_node_text(aes(label = name), size = 2) +
  scale_shape_manual( values = c(21,23) )+
  scale_size_continuous( range = c(2,10) )+
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')

```

subnetwork of KD and neighbors
```{r}
vert_neigh <- neighbors(snw, vert_num)

g3 <- induced_subgraph(snw, c(vert_num, vert_neigh))
unlinked <- names(degree(g3)[which(degree(g3)==0)])
g3 <- delete.vertices(g3, unlinked)

# KD evidence
x = tibble( node = V(g3) %>% names ) %>% 
  left_join(., kd.nodes, by = c('node'='NODE')) %>% 
  mutate(kd = if_else(is.na(n_term), 0, 1))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g3, names(x)[i], index = igraph::V(g3)) <- x %>% pull(i)
}

ggraph(g3, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey90') +
  geom_node_point( shape = 21, color = "black", alpha = .3, fill = 'grey90', 
                   aes(filter= .N()$kd == 0)  )+
  geom_node_point( shape = 23, color = "black", alpha = .6, 
                   aes(size = delta_max, fill = ef1_max, filter = .N()$kd == 1) )+
  scale_shape_manual(name='Driver Status', breaks=c('key driver', 'non-driver'),
                     values=c('key driver'=23, 'non-driver'=21))+
  geom_node_text(aes(label = name, filter = .N()$kd == 1), size = 2) +
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')
```


<!-- ```{r fig.width=12,fig.height=8} -->
<!-- p = suppressWarnings( plot_kd_subnet(nw, kd = 'MRPL4',term = 'mitochondrial large ribosomal subunit') ) -->
<!-- p -->
<!-- ``` -->

## Oxidative Stress {.tabset}
```{r}
dom = 'Oxidative_Stress'
```

### KDA results
```{r}
# synIDs of BD-specific wKDA results
kd.res = read_kd( which(doms == dom) ) %>% 
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    )
  ) %>% 
  left_join(
    ., biodom %>% select(MODULE = GOterm_Name, Biodomain, abbr:color)
  )

os.kd.res <- kd.res 
```


```{r}
top <- bind_rows(
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_0.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef0'),
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_1.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef1')
  ) %>%   
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    ))
```

Top KDs depend on edge factor used
```{r fig.width=6, fig.height=8}

cowplot::plot_grid(
  
  ggplot(top, aes(FOLD, -log10(FDR) )) + 
    geom_point(aes(color = node_status), alpha = .5) + 
    theme(legend.position = 'top')+
    facet_wrap(~ef),
  
  top %>% 
    mutate(FDR = -log10(FDR)) %>% 
    pivot_wider(id_cols = c(NODE, MODULE, node_status),
                names_from = ef, values_from = FDR) %>% 
    mutate(across(c(ef0,ef1), ~ if_else(is.na(.x), 0, .x))) %>% 
    ggplot(aes(ef0, ef1))+
    geom_abline(intercept = 0, slope = 1, lty = 2)+
    geom_point( aes(color = node_status), alpha = .5)+
    theme(legend.position = 'top')+
    labs(x = '-log10(FDR)\nuniform edge weights',
         y = '-log10(FDR)\nAD risk edge weights'),
  
  nrow = 2, rel_heights = c(.6,1)
  
)
```


```{r fig.width=8,fig.height=5}
# p2 = 
kd.res %>% 
  ggplot(aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = dom)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .4, size = 1.5, aes(color = color, shape = node_status) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 3, aes(color = color, shape = node_status))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, 
                   ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[which( enr.bd$padj < 0.05 
                                                # & enr.bd$Biodomain == str_replace_all(dom, '_', ' ')
                                                )]
                   & delta_fdr > 0
                   # & !duplicated(NODE)
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  # facet_wrap(dir~filt, scales = 'free', ncol = 4)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

### KD ~ Biodomains

```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_term)) %>% 
  arrange(Biodomain, desc(n_term), desc(max_delta)) %>% 
  ggplot(aes(n_term, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(dom, ' Network Key Drivers'),
       subtitle = 'Biodomain GO terms')+ 
  theme(legend.position = 'bottom')
# +
#   facet_wrap(dir~filt, ncol = 4)
```


```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_node)) %>%
  ggplot(aes(n_node, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0( dom, ' Network Key Drivers'),
       subtitle = 'Nodes')+ 
  theme(legend.position = 'bottom')
# +facet_wrap(dir~filt, ncol = 4)
```

```{r fig.width=10,fig.height=10}
tmp <- kd.res %>% 
  filter( 
    top == 1
    , ef1_fdr > -log10(0.05)
    , delta_fdr > 0 
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         )

ggplot(tmp, aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', 
       title = dom,
       subtitle = 'signif KDs (EF1 FDR < 0.05), \u0394 FDR > 0, for GSEA-enriched terms'
       )+
  # geom_abline(intercept = 0, slope =1, lty= 2, lwd = .5)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 2, aes(color = color))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                   & delta_fdr > 0
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(~Biodomain)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

```{r fig.width=5, fig.height=7}
tmp <- kd.res %>% 
    filter(top == 1
           , ef1_fdr > -log10(0.05)
           , delta_fdr > 0
           # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
      ) %>%
  group_by(Biodomain) %>% 
  mutate(n_kd = length(unique(paste0(NODE,':',MODULE)))) %>% 
  ungroup() %>% 
  mutate(Biodomain = fct_reorder(Biodomain, n_kd)) %>% 
  arrange(Biodomain)

ggplot(tmp, aes(delta_fdr, Biodomain))+
  geom_vline(xintercept = 0)+
  geom_jitter(alpha = .2, aes(color = color))+
  geom_violin(aes(color = color), scale = 'width', alpha=.3)+
  labs(y = '', x = '\u0394 FDR, ef1 - ef0')+
  scale_color_identity()
```

```{r}
kd.res %>% 
  filter(top == 1
         , ef1_fdr > -log10(0.05)
         , delta_fdr > 0
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(Biodomain) %>% 
  summarise(n_node = length(unique(NODE)),
            n_term = length(unique(MODULE)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_term), desc(max_delta), .by_group = T) %>%
  DT::datatable(rownames = F, filter = 'top')
```


### KDs ~ CBrain phenotypes
```{r fig.width=4, fig.height=4}
# crispr brain phenotype hits (any) vs non-hits
cb.hits = simple %>% filter(`Hit Class` != 'Non-Hit') %>% 
  pull(Gene) %>% unique()
cb.nonhits = simple %>% filter( (Gene %in% cb.hits)==F ) %>% 
  pull(Gene) %>% unique()

# ID key drivers from different parameter sets
# comb = kd.res %>% select(filt, dir) %>% distinct() %>% arrange(dir,filt)
kd.hits <- kd.res %>% filter(ef1_fdr > -log10(0.05), top == 1, delta_fdr > 0) %>% pull(NODE) %>% unique()
kd.nonhits <- kd.res %>% filter((NODE %in% kd.hits)==F) %>% pull(NODE) %>% unique()

# calculate fisher stats 
fisher.stats <- tibble(
      pheno_kd = intersect(cb.hits, kd.hits) %>% length(),
      noPheno_kd = intersect(cb.nonhits, kd.hits) %>% length(),
      pheno_nokd = intersect(cb.hits, kd.nonhits) %>% length(),
      noPheno_nokd = intersect(cb.nonhits, kd.nonhits) %>% length()
    ) %>% 
  rowwise() %>% 
  mutate(
      fisher.p = matrix(c(pheno_kd, noPheno_kd, pheno_nokd, noPheno_nokd), nrow = 2) %>% 
      fisher.test( ., alt = 'g') %>% broom::tidy() %>% pull(p.value)
    )

# make plots for each comb
p <- VennDiagram::venn.diagram(
      x = list(
        CRISPRbrain = cb.hits, 
        KeyDrivers = kd.hits
      ),
      filename = NULL,
      force.unique = T,
      lty = 0, alpha = .3, fill = c('light blue','pink'),
      hyper.test = T, 
      total.population = length(intersect(simple$Gene, names(V(undir_node_edge)))),
      
      # main = kd.res$bd %>% unique,
      main = paste0(
              'Fisher p = ', fisher.stats$fisher.p[1] %>% signif(digits = 2) ),
      main.cex = .75, sub.cex = .75,
      # cat.pos = c(315,45),
      cat.cex = .8,
      ext.pos = 180,
      ext.dist = -.1
      ) 

cowplot::plot_grid(p)

```

logistic regression
```{r}
nw = read_nw(which(doms == dom))

tmp = simple %>% 
  mutate(cb_hit = if_else( `Hit Class` == 'Non-Hit', 0, 1)) %>% 
  select(cell, mode, expt, Gene, cb_hit) %>% distinct() %>% 
  mutate(kd = if_else(Gene %in% kd.hits, 1, 0)) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>% 
  filter(!is.na(node_degree)) %>% 
  group_by(cell,mode,expt) %>% 
  mutate(
    lr = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>% broom::tidy() %>% 
           filter(term == 'kd') %>% 
           mutate(nobs = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>%  
                    broom::glance() %>% pull(nobs)) %>% list()
    ) %>% 
  unnest(lr)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

tmp %>% 
  select(cell:expt, estimate:nobs) %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'cb_hit ~ kd + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('estimate', 'std.error','statistic', 'p.value'))
```


linear regression  ~ KDA FDR
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(ef1_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         ef1_fdr = scale(ef1_fdr, center = T, scale = T) #/ max(ef1_fdr),
         ) #/ max(abs(gene_score))) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale(abs(gene_score), center = T, scale = T),
         lm = lm(gs~ef1_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'ef1_fdr') %>% 
           mutate(r.squared = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ ef1_fdr + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```


linear regression ~  KDA delta FDR e1/e0
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(delta_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         delta_fdr = scale(delta_fdr, center = T, scale = T) #, / max(ef1_fdr),
         ) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale( abs(gene_score), center = T, scale = T),
         lm = lm(gs~delta_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'delta_fdr') %>% 
           mutate(r.squared = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ \u0394 fdr (ef1-ef0)', options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```

### Top KDs
```{r}
kd.summary = kd.res %>% 
  filter(
    top == 1
    , delta_fdr > 0
    , ef1_fdr > -log10(0.05)
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(NODE, node_status) %>% 
  summarise(n_bd = length(unique(Biodomain)),
            bds = list(unique(Biodomain)),
            n_term = length(unique(MODULE)),
            terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_bd), desc(max_delta)) 

DT::datatable(kd.summary %>% select(-bds, -terms), rownames = F, filter = 'top')
```

```{r}
kd.res %>% 
  filter(
        top == 1
        , delta_fdr > 0
        , ef1_fdr > -log10(0.05)
        , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>% 
  DT::datatable(., rownames = F, filter = 'top') %>% 
  DT::formatSignif(columns = c('ef0_fdr','ef1_fdr','delta_fdr'))
```
### KD subnetworks
pull NW to view subgraphs
pull NW to view subgraphs
```{r}
nw = read_nw(which(doms == dom))
snw = igraph::simplify(nw, remove.multiple = T)
```

specify nodes
```{r}
kd.nodes <- kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , top == 1
         , delta_fdr > 0
  ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>%
  group_by(NODE) %>% 
  summarise(n_biodom = length(unique(Biodomain))
         , n_term = length(unique(MODULE))
         , ef1_max = max(ef1_fdr)
         , delta_max = max(delta_fdr)) 

```

subnetwork of just KD Nodes  
```{r}
vert_num <- match(kd.nodes$NODE, V(snw)$name)

g2 <- induced_subgraph(snw, vert_num)
unlinked <- names(degree(g2)[which(degree(g2)==0)])
g2 <- delete.vertices(g2, unlinked)

# KD evidence
x = tibble( node = V(g2) %>% names ) %>%
  left_join(., kd.nodes, by = c('node'='NODE'))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g2, names(x)[i], index = igraph::V(g2)) <- x %>% pull(i)
}

# plot
ggraph(g2, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey75') +
  geom_node_point( color = "black", alpha = .5, 
                   aes(size = n_term, fill = delta_max, shape = node_status )  )+
  geom_node_text(aes(label = name), size = 2) +
  scale_shape_manual( values = c(21,23) )+
  scale_size_continuous( range = c(2,10) )+
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')

```

subnetwork of KD and neighbors
```{r}
vert_neigh <- neighbors(snw, vert_num)

g3 <- induced_subgraph(snw, c(vert_num, vert_neigh))
unlinked <- names(degree(g3)[which(degree(g3)==0)])
g3 <- delete.vertices(g3, unlinked)

# KD evidence
x = tibble( node = V(g3) %>% names ) %>% 
  left_join(., kd.nodes, by = c('node'='NODE')) %>% 
  mutate(kd = if_else(is.na(n_term), 0, 1))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g3, names(x)[i], index = igraph::V(g3)) <- x %>% pull(i)
}

ggraph(g3, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey90') +
  geom_node_point( shape = 21, color = "black", alpha = .3, fill = 'grey90', 
                   aes(filter= .N()$kd == 0)  )+
  geom_node_point( shape = 23, color = "black", alpha = .6, 
                   aes(size = delta_max, fill = ef1_max, filter = .N()$kd == 1) )+
  scale_shape_manual(name='Driver Status', breaks=c('key driver', 'non-driver'),
                     values=c('key driver'=23, 'non-driver'=21))+
  geom_node_text(aes(label = name, filter = .N()$kd == 1), size = 2) +
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')
```


<!-- ```{r fig.width=12,fig.height=8} -->
<!-- p = suppressWarnings( plot_kd_subnet(nw, kd = 'MRPL4',term = 'mitochondrial large ribosomal subunit') ) -->
<!-- p -->
<!-- ``` -->

## Autophagy {.tabset}
```{r}
dom = 'Autophagy'
```

### KDA results
```{r}
# synIDs of BD-specific wKDA results
kd.res = read_kd( which(doms == dom) ) %>% 
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    )
  ) %>% 
  left_join(
    ., biodom %>% select(MODULE = GOterm_Name, Biodomain, abbr:color)
  )

au.kd.res <- kd.res 
```

```{r}
top <- bind_rows(
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_0.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef0'),
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_1.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef1')
  ) %>%   
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    ))
```

Top KDs depend on edge factor used
```{r fig.width=6, fig.height=8}

cowplot::plot_grid(
  
  ggplot(top, aes(FOLD, -log10(FDR) )) + 
    geom_point(aes(color = node_status), alpha = .5) + 
    theme(legend.position = 'top')+
    facet_wrap(~ef),
  
  top %>% 
    mutate(FDR = -log10(FDR)) %>% 
    pivot_wider(id_cols = c(NODE, MODULE, node_status),
                names_from = ef, values_from = FDR) %>% 
    mutate(across(c(ef0,ef1), ~ if_else(is.na(.x), 0, .x))) %>% 
    ggplot(aes(ef0, ef1))+
    geom_abline(intercept = 0, slope = 1, lty = 2)+
    geom_point( aes(color = node_status), alpha = .5)+
    theme(legend.position = 'top')+
    labs(x = '-log10(FDR)\nuniform edge weights',
         y = '-log10(FDR)\nAD risk edge weights'),
  
  nrow = 2, rel_heights = c(.6,1)
  
)
```


```{r fig.width=8,fig.height=5}
# p2 = 
kd.res %>% 
  ggplot(aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = dom)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .4, size = 1.5, aes(color = color, shape = node_status) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 3, aes(color = color, shape = node_status))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, 
                   ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[which( enr.bd$padj < 0.05 
                                                # & enr.bd$Biodomain == str_replace_all(dom, '_', ' ')
                                                )]
                   & delta_fdr > 0
                   # & !duplicated(NODE)
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  # facet_wrap(dir~filt, scales = 'free', ncol = 4)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

### KD ~ Biodomains

```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_term)) %>% 
  arrange(Biodomain, desc(n_term), desc(max_delta)) %>% 
  ggplot(aes(n_term, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(dom, ' Network Key Drivers'),
       subtitle = 'Biodomain GO terms')+ 
  theme(legend.position = 'bottom')
# +
#   facet_wrap(dir~filt, ncol = 4)
```


```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_node)) %>%
  ggplot(aes(n_node, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0( dom, ' Network Key Drivers'),
       subtitle = 'Nodes')+ 
  theme(legend.position = 'bottom')
# +facet_wrap(dir~filt, ncol = 4)
```

```{r fig.width=10,fig.height=10}
tmp <- kd.res %>% 
  filter( 
    top == 1
    , ef1_fdr > -log10(0.05)
    , delta_fdr > 0 
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         )

ggplot(tmp, aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', 
       title = dom,
       subtitle = 'signif KDs (EF1 FDR < 0.05), \u0394 FDR > 0, for GSEA-enriched terms'
       )+
  # geom_abline(intercept = 0, slope =1, lty= 2, lwd = .5)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 2, aes(color = color))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                   & delta_fdr > 0
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(~Biodomain)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

```{r fig.width=5, fig.height=7}
tmp <- kd.res %>% 
    filter(top == 1
           , ef1_fdr > -log10(0.05)
           , delta_fdr > 0
           # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
      ) %>%
  group_by(Biodomain) %>% 
  mutate(n_kd = length(unique(paste0(NODE,':',MODULE)))) %>% 
  ungroup() %>% 
  mutate(Biodomain = fct_reorder(Biodomain, n_kd)) %>% 
  arrange(Biodomain)

ggplot(tmp, aes(delta_fdr, Biodomain))+
  geom_vline(xintercept = 0)+
  geom_jitter(alpha = .2, aes(color = color))+
  geom_violin(aes(color = color), scale = 'width', alpha=.3)+
  labs(y = '', x = '\u0394 FDR, ef1 - ef0')+
  scale_color_identity()
```

```{r}
kd.res %>% 
  filter(top == 1
         , ef1_fdr > -log10(0.05)
         , delta_fdr > 0
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(Biodomain) %>% 
  summarise(n_node = length(unique(NODE)),
            n_term = length(unique(MODULE)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_term), desc(max_delta), .by_group = T) %>%
  DT::datatable(rownames = F, filter = 'top')
```


### KDs ~ CBrain phenotypes
```{r fig.width=4, fig.height=4}
# crispr brain phenotype hits (any) vs non-hits
cb.hits = simple %>% filter(`Hit Class` != 'Non-Hit') %>% 
  pull(Gene) %>% unique()
cb.nonhits = simple %>% filter( (Gene %in% cb.hits)==F ) %>% 
  pull(Gene) %>% unique()

# ID key drivers from different parameter sets
# comb = kd.res %>% select(filt, dir) %>% distinct() %>% arrange(dir,filt)
kd.hits <- kd.res %>% filter(ef1_fdr > -log10(0.05), top == 1, delta_fdr > 0) %>% pull(NODE) %>% unique()
kd.nonhits <- kd.res %>% filter((NODE %in% kd.hits)==F) %>% pull(NODE) %>% unique()

# calculate fisher stats 
fisher.stats <- tibble(
      pheno_kd = intersect(cb.hits, kd.hits) %>% length(),
      noPheno_kd = intersect(cb.nonhits, kd.hits) %>% length(),
      pheno_nokd = intersect(cb.hits, kd.nonhits) %>% length(),
      noPheno_nokd = intersect(cb.nonhits, kd.nonhits) %>% length()
    ) %>% 
  rowwise() %>% 
  mutate(
      fisher.p = matrix(c(pheno_kd, noPheno_kd, pheno_nokd, noPheno_nokd), nrow = 2) %>% 
      fisher.test( ., alt = 'g') %>% broom::tidy() %>% pull(p.value)
    )

# make plots for each comb
p <- VennDiagram::venn.diagram(
      x = list(
        CRISPRbrain = cb.hits, 
        KeyDrivers = kd.hits
      ),
      filename = NULL,
      force.unique = T,
      lty = 0, alpha = .3, fill = c('light blue','pink'),
      hyper.test = T, 
      total.population = length(intersect(simple$Gene, names(V(undir_node_edge)))),
      
      # main = kd.res$bd %>% unique,
      main = paste0(
              'Fisher p = ', fisher.stats$fisher.p[1] %>% signif(digits = 2) ),
      main.cex = .75, sub.cex = .75,
      # cat.pos = c(315,45),
      cat.cex = .8,
      ext.pos = 180,
      ext.dist = -.1
      ) 

cowplot::plot_grid(p)

```

logistic regression
```{r}
nw = read_nw(which(doms == dom))

tmp = simple %>% 
  mutate(cb_hit = if_else( `Hit Class` == 'Non-Hit', 0, 1)) %>% 
  select(cell, mode, expt, Gene, cb_hit) %>% distinct() %>% 
  mutate(kd = if_else(Gene %in% kd.hits, 1, 0)) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>% 
  filter(!is.na(node_degree)) %>% 
  group_by(cell,mode,expt) %>% 
  mutate(
    lr = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>% broom::tidy() %>% 
           filter(term == 'kd') %>% 
           mutate(nobs = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>%  
                    broom::glance() %>% pull(nobs)) %>% list()
    ) %>% 
  unnest(lr)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

tmp %>% 
  select(cell:expt, estimate:nobs) %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'cb_hit ~ kd + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('estimate', 'std.error','statistic', 'p.value'))
```


linear regression  ~ KDA FDR
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(ef1_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         ef1_fdr = scale(ef1_fdr, center = T, scale = T) #/ max(ef1_fdr),
         ) #/ max(abs(gene_score))) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale(abs(gene_score), center = T, scale = T),
         lm = lm(gs~ef1_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'ef1_fdr') %>% 
           mutate(r.squared = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ ef1_fdr + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```


linear regression ~  KDA delta FDR e1/e0
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(delta_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         delta_fdr = scale(delta_fdr, center = T, scale = T) #, / max(ef1_fdr),
         ) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale( abs(gene_score), center = T, scale = T),
         lm = lm(gs~delta_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'delta_fdr') %>% 
           mutate(r.squared = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ \u0394 fdr (ef1-ef0)', options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```

### Top KDs
```{r}
kd.summary = kd.res %>% 
  filter(
    top == 1
    , delta_fdr > 0
    , ef1_fdr > -log10(0.05)
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(NODE, node_status) %>% 
  summarise(n_bd = length(unique(Biodomain)),
            bds = list(unique(Biodomain)),
            n_term = length(unique(MODULE)),
            terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_bd), desc(max_delta)) 

DT::datatable(kd.summary %>% select(-bds, -terms), rownames = F, filter = 'top')
```

```{r}
kd.res %>% 
  filter(
        top == 1
        , delta_fdr > 0
        , ef1_fdr > -log10(0.05)
        , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>% 
  DT::datatable(., rownames = F, filter = 'top') %>% 
  DT::formatSignif(columns = c('ef0_fdr','ef1_fdr','delta_fdr'))
```
### KD subnetworks
pull NW to view subgraphs
pull NW to view subgraphs
```{r}
nw = read_nw(which(doms == dom))
snw = igraph::simplify(nw, remove.multiple = T)
```

specify nodes
```{r}
kd.nodes <- kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , top == 1
         , delta_fdr > 0
  ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>%
  group_by(NODE) %>% 
  summarise(n_biodom = length(unique(Biodomain))
         , n_term = length(unique(MODULE))
         , ef1_max = max(ef1_fdr)
         , delta_max = max(delta_fdr)) 

```

subnetwork of just KD Nodes  
```{r}
vert_num <- match(kd.nodes$NODE, V(snw)$name)

g2 <- induced_subgraph(snw, vert_num)
unlinked <- names(degree(g2)[which(degree(g2)==0)])
g2 <- delete.vertices(g2, unlinked)

# KD evidence
x = tibble( node = V(g2) %>% names ) %>%
  left_join(., kd.nodes, by = c('node'='NODE'))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g2, names(x)[i], index = igraph::V(g2)) <- x %>% pull(i)
}

# plot
ggraph(g2, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey75') +
  geom_node_point( color = "black", alpha = .5, 
                   aes(size = n_term, fill = delta_max, shape = node_status )  )+
  geom_node_text(aes(label = name), size = 2) +
  scale_shape_manual( values = c(21,23) )+
  scale_size_continuous( range = c(2,10) )+
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')

```

subnetwork of KD and neighbors
```{r}
vert_neigh <- neighbors(snw, vert_num)

g3 <- induced_subgraph(snw, c(vert_num, vert_neigh))
unlinked <- names(degree(g3)[which(degree(g3)==0)])
g3 <- delete.vertices(g3, unlinked)

# KD evidence
x = tibble( node = V(g3) %>% names ) %>% 
  left_join(., kd.nodes, by = c('node'='NODE')) %>% 
  mutate(kd = if_else(is.na(n_term), 0, 1))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g3, names(x)[i], index = igraph::V(g3)) <- x %>% pull(i)
}

ggraph(g3, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey90') +
  geom_node_point( shape = 21, color = "black", alpha = .3, fill = 'grey90', 
                   aes(filter= .N()$kd == 0)  )+
  geom_node_point( shape = 23, color = "black", alpha = .6, 
                   aes(size = delta_max, fill = ef1_max, filter = .N()$kd == 1) )+
  scale_shape_manual(name='Driver Status', breaks=c('key driver', 'non-driver'),
                     values=c('key driver'=23, 'non-driver'=21))+
  geom_node_text(aes(label = name, filter = .N()$kd == 1), size = 2) +
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')
```


<!-- ```{r fig.width=12,fig.height=8} -->
<!-- p = suppressWarnings( plot_kd_subnet(nw, kd = 'MRPL4',term = 'mitochondrial large ribosomal subunit') ) -->
<!-- p -->
<!-- ``` -->

## Metal Binding and Homeostasis {.tabset}
```{r}
dom = 'Metal_Binding_and_Homeostasis'
```

### KDA results
```{r}
# synIDs of BD-specific wKDA results
kd.res = read_kd( which(doms == dom) ) %>% 
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    )
  ) %>% 
  left_join(
    ., biodom %>% select(MODULE = GOterm_Name, Biodomain, abbr:color)
  )

mb.kd.res <- kd.res 
```


```{r}
top <- bind_rows(
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_0.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef0'),
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_1.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef1')
  ) %>%   
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    ))
```

Top KDs depend on edge factor used
```{r fig.width=6, fig.height=8}

cowplot::plot_grid(
  
  ggplot(top, aes(FOLD, -log10(FDR) )) + 
    geom_point(aes(color = node_status), alpha = .5) + 
    theme(legend.position = 'top')+
    facet_wrap(~ef),
  
  top %>% 
    mutate(FDR = -log10(FDR)) %>% 
    pivot_wider(id_cols = c(NODE, MODULE, node_status),
                names_from = ef, values_from = FDR) %>% 
    mutate(across(c(ef0,ef1), ~ if_else(is.na(.x), 0, .x))) %>% 
    ggplot(aes(ef0, ef1))+
    geom_abline(intercept = 0, slope = 1, lty = 2)+
    geom_point( aes(color = node_status), alpha = .5)+
    theme(legend.position = 'top')+
    labs(x = '-log10(FDR)\nuniform edge weights',
         y = '-log10(FDR)\nAD risk edge weights'),
  
  nrow = 2, rel_heights = c(.6,1)
  
)
```


```{r fig.width=8,fig.height=5}
# p2 = 
kd.res %>% 
  ggplot(aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = dom)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .4, size = 1.5, aes(color = color, shape = node_status) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 3, aes(color = color, shape = node_status))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, 
                   ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[which( enr.bd$padj < 0.05 
                                                # & enr.bd$Biodomain == str_replace_all(dom, '_', ' ')
                                                )]
                   & delta_fdr > 0
                   # & !duplicated(NODE)
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  # facet_wrap(dir~filt, scales = 'free', ncol = 4)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

### KD ~ Biodomains

```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_term)) %>% 
  arrange(Biodomain, desc(n_term), desc(max_delta)) %>% 
  ggplot(aes(n_term, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(dom, ' Network Key Drivers'),
       subtitle = 'Biodomain GO terms')+ 
  theme(legend.position = 'bottom')
# +
#   facet_wrap(dir~filt, ncol = 4)
```


```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_node)) %>%
  ggplot(aes(n_node, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0( dom, ' Network Key Drivers'),
       subtitle = 'Nodes')+ 
  theme(legend.position = 'bottom')
# +facet_wrap(dir~filt, ncol = 4)
```

```{r fig.width=10,fig.height=10}
tmp <- kd.res %>% 
  filter( 
    top == 1
    , ef1_fdr > -log10(0.05)
    , delta_fdr > 0 
    # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         )

ggplot(tmp, aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', 
       title = dom,
       subtitle = 'signif KDs (EF1 FDR < 0.05), \u0394 FDR > 0, for GSEA-enriched terms'
       )+
  # geom_abline(intercept = 0, slope =1, lty= 2, lwd = .5)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 2, aes(color = color))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                   & delta_fdr > 0
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(~Biodomain)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

```{r fig.width=5, fig.height=7}
tmp <- kd.res %>% 
    filter(top == 1
           , ef1_fdr > -log10(0.05)
           , delta_fdr > 0
           # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
      ) %>%
  group_by(Biodomain) %>% 
  mutate(n_kd = length(unique(paste0(NODE,':',MODULE)))) %>% 
  ungroup() %>% 
  mutate(Biodomain = fct_reorder(Biodomain, n_kd)) %>% 
  arrange(Biodomain)

ggplot(tmp, aes(delta_fdr, Biodomain))+
  geom_vline(xintercept = 0)+
  geom_jitter(alpha = .2, aes(color = color))+
  geom_violin(aes(color = color), scale = 'width', alpha=.3)+
  labs(y = '', x = '\u0394 FDR, ef1 - ef0')+
  scale_color_identity()
```

```{r}
kd.res %>% 
  filter(top == 1
         , ef1_fdr > -log10(0.05)
         , delta_fdr > 0
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(Biodomain) %>% 
  summarise(n_node = length(unique(NODE)),
            n_term = length(unique(MODULE)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_term), desc(max_delta), .by_group = T) %>%
  DT::datatable(rownames = F, filter = 'top')
```


### KDs ~ CBrain phenotypes
```{r fig.width=4, fig.height=4}
# crispr brain phenotype hits (any) vs non-hits
cb.hits = simple %>% filter(`Hit Class` != 'Non-Hit') %>% 
  pull(Gene) %>% unique()
cb.nonhits = simple %>% filter( (Gene %in% cb.hits)==F ) %>% 
  pull(Gene) %>% unique()

# ID key drivers from different parameter sets
# comb = kd.res %>% select(filt, dir) %>% distinct() %>% arrange(dir,filt)
kd.hits <- kd.res %>% filter(ef1_fdr > -log10(0.05), top == 1, delta_fdr > 0) %>% pull(NODE) %>% unique()
kd.nonhits <- kd.res %>% filter((NODE %in% kd.hits)==F) %>% pull(NODE) %>% unique()

# calculate fisher stats 
fisher.stats <- tibble(
      pheno_kd = intersect(cb.hits, kd.hits) %>% length(),
      noPheno_kd = intersect(cb.nonhits, kd.hits) %>% length(),
      pheno_nokd = intersect(cb.hits, kd.nonhits) %>% length(),
      noPheno_nokd = intersect(cb.nonhits, kd.nonhits) %>% length()
    ) %>% 
  rowwise() %>% 
  mutate(
      fisher.p = matrix(c(pheno_kd, noPheno_kd, pheno_nokd, noPheno_nokd), nrow = 2) %>% 
      fisher.test( ., alt = 'g') %>% broom::tidy() %>% pull(p.value)
    )

# make plots for each comb
p <- VennDiagram::venn.diagram(
      x = list(
        CRISPRbrain = cb.hits, 
        KeyDrivers = kd.hits
      ),
      filename = NULL,
      force.unique = T,
      lty = 0, alpha = .3, fill = c('light blue','pink'),
      hyper.test = T, 
      total.population = length(intersect(simple$Gene, names(V(undir_node_edge)))),
      
      # main = kd.res$bd %>% unique,
      main = paste0(
              'Fisher p = ', fisher.stats$fisher.p[1] %>% signif(digits = 2) ),
      main.cex = .75, sub.cex = .75,
      # cat.pos = c(315,45),
      cat.cex = .8,
      ext.pos = 180,
      ext.dist = -.1
      ) 

cowplot::plot_grid(p)

```

logistic regression
```{r}
nw = read_nw(which(doms == dom))

tmp = simple %>% 
  mutate(cb_hit = if_else( `Hit Class` == 'Non-Hit', 0, 1)) %>% 
  select(cell, mode, expt, Gene, cb_hit) %>% distinct() %>% 
  mutate(kd = if_else(Gene %in% kd.hits, 1, 0)) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>% 
  filter(!is.na(node_degree)) %>% 
  group_by(cell,mode,expt) %>% 
  mutate(
    lr = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>% broom::tidy() %>% 
           filter(term == 'kd') %>% 
           mutate(nobs = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>%  
                    broom::glance() %>% pull(nobs)) %>% list()
    ) %>% 
  unnest(lr)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

tmp %>% 
  select(cell:expt, estimate:nobs) %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'cb_hit ~ kd + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('estimate', 'std.error','statistic', 'p.value'))
```


linear regression  ~ KDA FDR
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(ef1_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         ef1_fdr = scale(ef1_fdr, center = T, scale = T) #/ max(ef1_fdr),
         ) #/ max(abs(gene_score))) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale(abs(gene_score), center = T, scale = T),
         lm = lm(gs~ef1_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'ef1_fdr') %>% 
           mutate(r.squared = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ ef1_fdr + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```


linear regression ~  KDA delta FDR e1/e0
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(delta_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         delta_fdr = scale(delta_fdr, center = T, scale = T) #, / max(ef1_fdr),
         ) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale( abs(gene_score), center = T, scale = T),
         lm = lm(gs~delta_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'delta_fdr') %>% 
           mutate(r.squared = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ \u0394 fdr (ef1-ef0)', options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```

### Top KDs
```{r}
kd.summary = kd.res %>% 
  filter(
    top == 1
    , delta_fdr > 0
    , ef1_fdr > -log10(0.05)
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(NODE, node_status) %>% 
  summarise(n_bd = length(unique(Biodomain)),
            bds = list(unique(Biodomain)),
            n_term = length(unique(MODULE)),
            terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_bd), desc(max_delta)) 

DT::datatable(kd.summary %>% select(-bds, -terms), rownames = F, filter = 'top')
```

```{r}
kd.res %>% 
  filter(
        top == 1
        , delta_fdr > 0
        , ef1_fdr > -log10(0.05)
        , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>% 
  DT::datatable(., rownames = F, filter = 'top') %>% 
  DT::formatSignif(columns = c('ef0_fdr','ef1_fdr','delta_fdr'))
```
### KD subnetworks
pull NW to view subgraphs
pull NW to view subgraphs
```{r}
nw = read_nw(which(doms == dom))
snw = igraph::simplify(nw, remove.multiple = T)
```

specify nodes
```{r}
kd.nodes <- kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , top == 1
         , delta_fdr > 0
  ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>%
  group_by(NODE) %>% 
  summarise(n_biodom = length(unique(Biodomain))
         , n_term = length(unique(MODULE))
         , ef1_max = max(ef1_fdr)
         , delta_max = max(delta_fdr)) 

```

subnetwork of just KD Nodes  
```{r}
vert_num <- match(kd.nodes$NODE, V(snw)$name)

g2 <- induced_subgraph(snw, vert_num)
unlinked <- names(degree(g2)[which(degree(g2)==0)])
g2 <- delete.vertices(g2, unlinked)

# KD evidence
x = tibble( node = V(g2) %>% names ) %>%
  left_join(., kd.nodes, by = c('node'='NODE'))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g2, names(x)[i], index = igraph::V(g2)) <- x %>% pull(i)
}

# plot
ggraph(g2, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey75') +
  geom_node_point( color = "black", alpha = .5, 
                   aes(size = n_term, fill = delta_max, shape = node_status )  )+
  geom_node_text(aes(label = name), size = 2) +
  scale_shape_manual( values = c(21,23) )+
  scale_size_continuous( range = c(2,10) )+
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')

```

subnetwork of KD and neighbors
```{r}
vert_neigh <- neighbors(snw, vert_num)

g3 <- induced_subgraph(snw, c(vert_num, vert_neigh))
unlinked <- names(degree(g3)[which(degree(g3)==0)])
g3 <- delete.vertices(g3, unlinked)

# KD evidence
x = tibble( node = V(g3) %>% names ) %>% 
  left_join(., kd.nodes, by = c('node'='NODE')) %>% 
  mutate(kd = if_else(is.na(n_term), 0, 1))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g3, names(x)[i], index = igraph::V(g3)) <- x %>% pull(i)
}

ggraph(g3, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey90') +
  geom_node_point( shape = 21, color = "black", alpha = .3, fill = 'grey90', 
                   aes(filter= .N()$kd == 0)  )+
  geom_node_point( shape = 23, color = "black", alpha = .6, 
                   aes(size = delta_max, fill = ef1_max, filter = .N()$kd == 1) )+
  scale_shape_manual(name='Driver Status', breaks=c('key driver', 'non-driver'),
                     values=c('key driver'=23, 'non-driver'=21))+
  geom_node_text(aes(label = name, filter = .N()$kd == 1), size = 2) +
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')
```


<!-- ```{r fig.width=12,fig.height=8} -->
<!-- p = suppressWarnings( plot_kd_subnet(nw, kd = 'MRPL4',term = 'mitochondrial large ribosomal subunit') ) -->
<!-- p -->
<!-- ``` -->

## RNA Spliceosome {.tabset}
```{r}
dom = 'RNA_Spliceosome'
```

### KDA results
```{r}
# synIDs of BD-specific wKDA results
kd.res = read_kd( which(doms == dom) ) %>% 
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    )
  ) %>% 
  left_join(
    ., biodom %>% select(MODULE = GOterm_Name, Biodomain, abbr:color)
  )

rs.kd.res <- kd.res 
```


```{r}
top <- bind_rows(
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_0.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef0'),
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_1.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef1')
  ) %>%   
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    ))
```

Top KDs depend on edge factor used
```{r fig.width=6, fig.height=8}

cowplot::plot_grid(
  
  ggplot(top, aes(FOLD, -log10(FDR) )) + 
    geom_point(aes(color = node_status), alpha = .5) + 
    theme(legend.position = 'top')+
    facet_wrap(~ef),
  
  top %>% 
    mutate(FDR = -log10(FDR)) %>% 
    pivot_wider(id_cols = c(NODE, MODULE, node_status),
                names_from = ef, values_from = FDR) %>% 
    mutate(across(c(ef0,ef1), ~ if_else(is.na(.x), 0, .x))) %>% 
    ggplot(aes(ef0, ef1))+
    geom_abline(intercept = 0, slope = 1, lty = 2)+
    geom_point( aes(color = node_status), alpha = .5)+
    theme(legend.position = 'top')+
    labs(x = '-log10(FDR)\nuniform edge weights',
         y = '-log10(FDR)\nAD risk edge weights'),
  
  nrow = 2, rel_heights = c(.6,1)
  
)
```


```{r fig.width=8,fig.height=5}
# p2 = 
kd.res %>% 
  ggplot(aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = dom)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .4, size = 1.5, aes(color = color, shape = node_status) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 3, aes(color = color, shape = node_status))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, 
                   ef1_fdr > -log10(0.05)
                   & top == 1
                   # & MODULE %in% enr.bd$pathway[which( enr.bd$padj < 0.05 
                   #                              # & enr.bd$Biodomain == str_replace_all(dom, '_', ' ')
                   #                              )]
                   & delta_fdr > 0
                   # & !duplicated(NODE)
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  # facet_wrap(dir~filt, scales = 'free', ncol = 4)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

### KD ~ Biodomains

```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_term)) %>% 
  arrange(Biodomain, desc(n_term), desc(max_delta)) %>% 
  ggplot(aes(n_term, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(dom, ' Network Key Drivers'),
       subtitle = 'Biodomain GO terms')+ 
  theme(legend.position = 'bottom')
# +
#   facet_wrap(dir~filt, ncol = 4)
```


```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_node)) %>%
  ggplot(aes(n_node, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0( dom, ' Network Key Drivers'),
       subtitle = 'Nodes')+ 
  theme(legend.position = 'bottom')
# +facet_wrap(dir~filt, ncol = 4)
```

```{r fig.width=10,fig.height=10}
tmp <- kd.res %>% 
  filter( 
    top == 1
    , ef1_fdr > -log10(0.05)
    , delta_fdr > 0 
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         )

ggplot(tmp, aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', 
       title = dom,
       subtitle = 'signif KDs (EF1 FDR < 0.05), \u0394 FDR > 0, for GSEA-enriched terms'
       )+
  # geom_abline(intercept = 0, slope =1, lty= 2, lwd = .5)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 2, aes(color = color))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, ef1_fdr > -log10(0.05)
                   & top == 1
                   # & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                   & delta_fdr > 0
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(~Biodomain)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

```{r fig.width=5, fig.height=7}
tmp <- kd.res %>% 
    filter(top == 1
           , ef1_fdr > -log10(0.05)
           , delta_fdr > 0
           # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
      ) %>%
  group_by(Biodomain) %>% 
  mutate(n_kd = length(unique(paste0(NODE,':',MODULE)))) %>% 
  ungroup() %>% 
  mutate(Biodomain = fct_reorder(Biodomain, n_kd)) %>% 
  arrange(Biodomain)

ggplot(tmp, aes(delta_fdr, Biodomain))+
  geom_vline(xintercept = 0)+
  geom_jitter(alpha = .2, aes(color = color))+
  geom_violin(aes(color = color), scale = 'width', alpha=.3)+
  labs(y = '', x = '\u0394 FDR, ef1 - ef0')+
  scale_color_identity()
```

```{r}
kd.res %>% 
  filter(top == 1
         , ef1_fdr > -log10(0.05)
         , delta_fdr > 0
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(Biodomain) %>% 
  summarise(n_node = length(unique(NODE)),
            n_term = length(unique(MODULE)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_term), desc(max_delta), .by_group = T) %>%
  DT::datatable(rownames = F, filter = 'top')
```


### KDs ~ CBrain phenotypes
```{r fig.width=4, fig.height=4}
# crispr brain phenotype hits (any) vs non-hits
cb.hits = simple %>% filter(`Hit Class` != 'Non-Hit') %>% 
  pull(Gene) %>% unique()
cb.nonhits = simple %>% filter( (Gene %in% cb.hits)==F ) %>% 
  pull(Gene) %>% unique()

# ID key drivers from different parameter sets
# comb = kd.res %>% select(filt, dir) %>% distinct() %>% arrange(dir,filt)
kd.hits <- kd.res %>% filter(ef1_fdr > -log10(0.05), top == 1, delta_fdr > 0) %>% pull(NODE) %>% unique()
kd.nonhits <- kd.res %>% filter((NODE %in% kd.hits)==F) %>% pull(NODE) %>% unique()

# calculate fisher stats 
fisher.stats <- tibble(
      pheno_kd = intersect(cb.hits, kd.hits) %>% length(),
      noPheno_kd = intersect(cb.nonhits, kd.hits) %>% length(),
      pheno_nokd = intersect(cb.hits, kd.nonhits) %>% length(),
      noPheno_nokd = intersect(cb.nonhits, kd.nonhits) %>% length()
    ) %>% 
  rowwise() %>% 
  mutate(
      fisher.p = matrix(c(pheno_kd, noPheno_kd, pheno_nokd, noPheno_nokd), nrow = 2) %>% 
      fisher.test( ., alt = 'g') %>% broom::tidy() %>% pull(p.value)
    )

# make plots for each comb
p <- VennDiagram::venn.diagram(
      x = list(
        CRISPRbrain = cb.hits, 
        KeyDrivers = kd.hits
      ),
      filename = NULL,
      force.unique = T,
      lty = 0, alpha = .3, fill = c('light blue','pink'),
      hyper.test = T, 
      total.population = length(intersect(simple$Gene, names(V(undir_node_edge)))),
      
      # main = kd.res$bd %>% unique,
      main = paste0(
              'Fisher p = ', fisher.stats$fisher.p[1] %>% signif(digits = 2) ),
      main.cex = .75, sub.cex = .75,
      # cat.pos = c(315,45),
      cat.cex = .8,
      ext.pos = 180,
      ext.dist = -.1
      ) 

cowplot::plot_grid(p)

```

logistic regression
```{r}
nw = read_nw(which(doms == dom))

tmp = simple %>% 
  mutate(cb_hit = if_else( `Hit Class` == 'Non-Hit', 0, 1)) %>% 
  select(cell, mode, expt, Gene, cb_hit) %>% distinct() %>% 
  mutate(kd = if_else(Gene %in% kd.hits, 1, 0)) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>% 
  filter(!is.na(node_degree)) %>% 
  group_by(cell,mode,expt) %>% 
  mutate(
    lr = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>% broom::tidy() %>% 
           filter(term == 'kd') %>% 
           mutate(nobs = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>%  
                    broom::glance() %>% pull(nobs)) %>% list()
    ) %>% 
  unnest(lr)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

tmp %>% 
  select(cell:expt, estimate:nobs) %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'cb_hit ~ kd + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('estimate', 'std.error','statistic', 'p.value'))
```


linear regression  ~ KDA FDR
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(ef1_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         ef1_fdr = scale(ef1_fdr, center = T, scale = T) #/ max(ef1_fdr),
         ) #/ max(abs(gene_score))) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale(abs(gene_score), center = T, scale = T),
         lm = lm(gs~ef1_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'ef1_fdr') %>% 
           mutate(r.squared = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ ef1_fdr + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```


linear regression ~  KDA delta FDR e1/e0
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(delta_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         delta_fdr = scale(delta_fdr, center = T, scale = T) #, / max(ef1_fdr),
         ) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale( abs(gene_score), center = T, scale = T),
         lm = lm(gs~delta_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'delta_fdr') %>% 
           mutate(r.squared = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ \u0394 fdr (ef1-ef0)', options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```

### Top KDs
```{r}
kd.summary = kd.res %>% 
  filter(
    top == 1
    , delta_fdr > 0
    , ef1_fdr > -log10(0.05)
    # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(NODE, node_status) %>% 
  summarise(n_bd = length(unique(Biodomain)),
            bds = list(unique(Biodomain)),
            n_term = length(unique(MODULE)),
            terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_bd), desc(max_delta)) 

DT::datatable(kd.summary %>% select(-bds, -terms), rownames = F, filter = 'top')
```

```{r}
kd.res %>% 
  filter(
        top == 1
        , delta_fdr > 0
        , ef1_fdr > -log10(0.05)
        # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>% 
  DT::datatable(., rownames = F, filter = 'top') %>% 
  DT::formatSignif(columns = c('ef0_fdr','ef1_fdr','delta_fdr'))
```
### KD subnetworks
pull NW to view subgraphs
pull NW to view subgraphs
```{r}
nw = read_nw(which(doms == dom))
snw = igraph::simplify(nw, remove.multiple = T)
```

specify nodes
```{r}
kd.nodes <- kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , top == 1
         , delta_fdr > 0
  ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>%
  group_by(NODE) %>% 
  summarise(n_biodom = length(unique(Biodomain))
         , n_term = length(unique(MODULE))
         , ef1_max = max(ef1_fdr)
         , delta_max = max(delta_fdr)) 

```

subnetwork of just KD Nodes  
```{r}
vert_num <- match(kd.nodes$NODE, V(snw)$name)

g2 <- induced_subgraph(snw, vert_num)
unlinked <- names(degree(g2)[which(degree(g2)==0)])
g2 <- delete.vertices(g2, unlinked)

# KD evidence
x = tibble( node = V(g2) %>% names ) %>%
  left_join(., kd.nodes, by = c('node'='NODE'))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g2, names(x)[i], index = igraph::V(g2)) <- x %>% pull(i)
}

# plot
ggraph(g2, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey75') +
  geom_node_point( color = "black", alpha = .5, 
                   aes(size = n_term, fill = delta_max, shape = node_status )  )+
  geom_node_text(aes(label = name), size = 2) +
  scale_shape_manual( values = c(21,23) )+
  scale_size_continuous( range = c(2,10) )+
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')

```

subnetwork of KD and neighbors
```{r}
vert_neigh <- neighbors(snw, vert_num)

g3 <- induced_subgraph(snw, c(vert_num, vert_neigh))
unlinked <- names(degree(g3)[which(degree(g3)==0)])
g3 <- delete.vertices(g3, unlinked)

# KD evidence
x = tibble( node = V(g3) %>% names ) %>% 
  left_join(., kd.nodes, by = c('node'='NODE')) %>% 
  mutate(kd = if_else(is.na(n_term), 0, 1))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g3, names(x)[i], index = igraph::V(g3)) <- x %>% pull(i)
}

ggraph(g3, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey90') +
  geom_node_point( shape = 21, color = "black", alpha = .3, fill = 'grey90', 
                   aes(filter= .N()$kd == 0)  )+
  geom_node_point( shape = 23, color = "black", alpha = .6, 
                   aes(size = delta_max, fill = ef1_max, filter = .N()$kd == 1) )+
  scale_shape_manual(name='Driver Status', breaks=c('key driver', 'non-driver'),
                     values=c('key driver'=23, 'non-driver'=21))+
  geom_node_text(aes(label = name, filter = .N()$kd == 1), size = 2) +
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')
```


<!-- ```{r fig.width=12,fig.height=8} -->
<!-- p = suppressWarnings( plot_kd_subnet(nw, kd = 'MRPL4',term = 'mitochondrial large ribosomal subunit') ) -->
<!-- p -->
<!-- ``` -->

## Epigenetic {.tabset}
```{r}
dom = 'Epigenetic'
```

### KDA results
```{r}
# synIDs of BD-specific wKDA results
kd.res = read_kd( which(doms == dom) ) %>% 
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    )
  ) %>% 
  left_join(
    ., biodom %>% select(MODULE = GOterm_Name, Biodomain, abbr:color)
  )

ep.kd.res <- kd.res 
```


```{r}
top <- bind_rows(
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_0.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef0'),
  doms$kd.dir[[which(doms$bd == dom)]] %>% filter(grepl('edgeFactor_1.tophits',name)) %>% pull(id) %>% 
    synGet() %>% .$path %>% read_tsv(., col_types = cols()) %>% mutate(ef = 'ef1')
  ) %>%   
  rowwise() %>% 
  mutate(
    node_status = case_when(
      NODE %in% nw.dat$q_genes[[which(nw.dat$bd == dom)]] ~ 'query',
      NODE %in% nw.dat$added_genes[[which(nw.dat$bd == dom)]] ~ 'added',
      T ~ NA_character_
    ))
```

Top KDs depend on edge factor used
```{r fig.width=6, fig.height=8}

cowplot::plot_grid(
  
  ggplot(top, aes(FOLD, -log10(FDR) )) + 
    geom_point(aes(color = node_status), alpha = .5) + 
    theme(legend.position = 'top')+
    facet_wrap(~ef),
  
  top %>% 
    mutate(FDR = -log10(FDR)) %>% 
    pivot_wider(id_cols = c(NODE, MODULE, node_status),
                names_from = ef, values_from = FDR) %>% 
    mutate(across(c(ef0,ef1), ~ if_else(is.na(.x), 0, .x))) %>% 
    ggplot(aes(ef0, ef1))+
    geom_abline(intercept = 0, slope = 1, lty = 2)+
    geom_point( aes(color = node_status), alpha = .5)+
    theme(legend.position = 'top')+
    labs(x = '-log10(FDR)\nuniform edge weights',
         y = '-log10(FDR)\nAD risk edge weights'),
  
  nrow = 2, rel_heights = c(.6,1)
  
)
```


```{r fig.width=8,fig.height=5}
# p2 = 
kd.res %>% 
  ggplot(aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = dom)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .4, size = 1.5, aes(color = color, shape = node_status) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 3, aes(color = color, shape = node_status))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, 
                   ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[which( enr.bd$padj < 0.05 
                                                # & enr.bd$Biodomain == str_replace_all(dom, '_', ' ')
                                                )]
                   & delta_fdr > 0
                   # & !duplicated(NODE)
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  # facet_wrap(dir~filt, scales = 'free', ncol = 4)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

### KD ~ Biodomains

```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_term)) %>% 
  arrange(Biodomain, desc(n_term), desc(max_delta)) %>% 
  ggplot(aes(n_term, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(dom, ' Network Key Drivers'),
       subtitle = 'Biodomain GO terms')+ 
  theme(legend.position = 'bottom')
# +
#   facet_wrap(dir~filt, ncol = 4)
```


```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter( !is.na(Biodomain)
    # ,!is.na(filt), !is.na(dir)
    ) %>%
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_node)) %>%
  ggplot(aes(n_node, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0( dom, ' Network Key Drivers'),
       subtitle = 'Nodes')+ 
  theme(legend.position = 'bottom')
# +facet_wrap(dir~filt, ncol = 4)
```

```{r fig.width=10,fig.height=10}
tmp <- kd.res %>% 
  filter( 
    top == 1
    , ef1_fdr > -log10(0.05)
    , delta_fdr > 0 
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         )

ggplot(tmp, aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', 
       title = dom,
       subtitle = 'signif KDs (EF1 FDR < 0.05), \u0394 FDR > 0, for GSEA-enriched terms'
       )+
  # geom_abline(intercept = 0, slope =1, lty= 2, lwd = .5)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 2, aes(color = color))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                   & delta_fdr > 0
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(~Biodomain)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

```{r fig.width=5, fig.height=7}
tmp <- kd.res %>% 
    filter(top == 1
           , ef1_fdr > -log10(0.05)
           , delta_fdr > 0
           # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
      ) %>%
  group_by(Biodomain) %>% 
  mutate(n_kd = length(unique(paste0(NODE,':',MODULE)))) %>% 
  ungroup() %>% 
  mutate(Biodomain = fct_reorder(Biodomain, n_kd)) %>% 
  arrange(Biodomain)

ggplot(tmp, aes(delta_fdr, Biodomain))+
  geom_vline(xintercept = 0)+
  geom_jitter(alpha = .2, aes(color = color))+
  geom_violin(aes(color = color), scale = 'width', alpha=.3)+
  labs(y = '', x = '\u0394 FDR, ef1 - ef0')+
  scale_color_identity()
```

```{r}
kd.res %>% 
  filter(top == 1
         , ef1_fdr > -log10(0.05)
         , delta_fdr > 0
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(Biodomain) %>% 
  summarise(n_node = length(unique(NODE)),
            n_term = length(unique(MODULE)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_term), desc(max_delta), .by_group = T) %>%
  DT::datatable(rownames = F, filter = 'top')
```


### KDs ~ CBrain phenotypes
```{r fig.width=4, fig.height=4}
# crispr brain phenotype hits (any) vs non-hits
cb.hits = simple %>% filter(`Hit Class` != 'Non-Hit') %>% 
  pull(Gene) %>% unique()
cb.nonhits = simple %>% filter( (Gene %in% cb.hits)==F ) %>% 
  pull(Gene) %>% unique()

# ID key drivers from different parameter sets
# comb = kd.res %>% select(filt, dir) %>% distinct() %>% arrange(dir,filt)
kd.hits <- kd.res %>% filter(ef1_fdr > -log10(0.05), top == 1, delta_fdr > 0) %>% pull(NODE) %>% unique()
kd.nonhits <- kd.res %>% filter((NODE %in% kd.hits)==F) %>% pull(NODE) %>% unique()

# calculate fisher stats 
fisher.stats <- tibble(
      pheno_kd = intersect(cb.hits, kd.hits) %>% length(),
      noPheno_kd = intersect(cb.nonhits, kd.hits) %>% length(),
      pheno_nokd = intersect(cb.hits, kd.nonhits) %>% length(),
      noPheno_nokd = intersect(cb.nonhits, kd.nonhits) %>% length()
    ) %>% 
  rowwise() %>% 
  mutate(
      fisher.p = matrix(c(pheno_kd, noPheno_kd, pheno_nokd, noPheno_nokd), nrow = 2) %>% 
      fisher.test( ., alt = 'g') %>% broom::tidy() %>% pull(p.value)
    )

# make plots for each comb
p <- VennDiagram::venn.diagram(
      x = list(
        CRISPRbrain = cb.hits, 
        KeyDrivers = kd.hits
      ),
      filename = NULL,
      force.unique = T,
      lty = 0, alpha = .3, fill = c('light blue','pink'),
      hyper.test = T, 
      total.population = length(intersect(simple$Gene, names(V(undir_node_edge)))),
      
      # main = kd.res$bd %>% unique,
      main = paste0(
              'Fisher p = ', fisher.stats$fisher.p[1] %>% signif(digits = 2) ),
      main.cex = .75, sub.cex = .75,
      # cat.pos = c(315,45),
      cat.cex = .8,
      ext.pos = 180,
      ext.dist = -.1
      ) 

cowplot::plot_grid(p)

```

logistic regression
```{r}
nw = read_nw(which(doms == dom))

tmp = simple %>% 
  mutate(cb_hit = if_else( `Hit Class` == 'Non-Hit', 0, 1)) %>% 
  select(cell, mode, expt, Gene, cb_hit) %>% distinct() %>% 
  mutate(kd = if_else(Gene %in% kd.hits, 1, 0)) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>% 
  filter(!is.na(node_degree)) %>% 
  group_by(cell,mode,expt) %>% 
  mutate(
    lr = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>% broom::tidy() %>% 
           filter(term == 'kd') %>% 
           mutate(nobs = glm( cb_hit~kd+node_degree, family=binomial(link='logit')) %>%  
                    broom::glance() %>% pull(nobs)) %>% list()
    ) %>% 
  unnest(lr)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

tmp %>% 
  select(cell:expt, estimate:nobs) %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'cb_hit ~ kd + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('estimate', 'std.error','statistic', 'p.value'))
```


linear regression  ~ KDA FDR
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(ef1_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         ef1_fdr = scale(ef1_fdr, center = T, scale = T) #/ max(ef1_fdr),
         ) #/ max(abs(gene_score))) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale(abs(gene_score), center = T, scale = T),
         lm = lm(gs~ef1_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'ef1_fdr') %>% 
           mutate(r.squared = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(abs(gene_score)~ef1_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ ef1_fdr + node_degree', 
                options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```


linear regression ~  KDA delta FDR e1/e0
```{r}
nw = read_nw(which(doms == dom))

tmp <- kd.res %>% 
  group_by(NODE) %>% 
  arrange(desc(delta_fdr), .by_group = T) %>% 
  filter(!duplicated(NODE)) %>% 
  inner_join( simple,., by =c('Gene'='NODE')) %>% 
  left_join(., tibble(Gene = names(V(nw)), node_degree = degree(nw)) ) %>%
  distinct() %>% 
  mutate(node_degree = scale(node_degree, center = T, scale = T), # / max(node_degree),
         delta_fdr = scale(delta_fdr, center = T, scale = T) #, / max(ef1_fdr),
         ) 

res <- tmp %>% 
  group_by(cell,mode,expt) %>% 
  mutate(gs = scale( abs(gene_score), center = T, scale = T),
         lm = lm(gs~delta_fdr+node_degree) %>% broom::tidy() %>% 
           filter(term == 'delta_fdr') %>% 
           mutate(r.squared = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(gs~delta_fdr+node_degree) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, term:nobs) %>% distinct() %>% 
  # filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

res %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ \u0394 fdr (ef1-ef0)', options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```

### Top KDs
```{r}
kd.summary = kd.res %>% 
  filter(
    top == 1
    , delta_fdr > 0
    , ef1_fdr > -log10(0.05)
    # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  group_by(NODE, node_status) %>% 
  summarise(n_bd = length(unique(Biodomain)),
            bds = list(unique(Biodomain)),
            n_term = length(unique(MODULE)),
            terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_bd), desc(max_delta)) 

DT::datatable(kd.summary %>% select(-bds, -terms), rownames = F, filter = 'top')
```

```{r}
kd.res %>% 
  filter(
        top == 1
        , delta_fdr > 0
        , ef1_fdr > -log10(0.05)
        # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>% 
  DT::datatable(., rownames = F, filter = 'top') %>% 
  DT::formatSignif(columns = c('ef0_fdr','ef1_fdr','delta_fdr'))
```
### KD subnetworks
pull NW to view subgraphs
pull NW to view subgraphs
```{r}
nw = read_nw(which(doms == dom))
snw = igraph::simplify(nw, remove.multiple = T)
```

specify nodes
```{r}
kd.nodes <- kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , top == 1
         , delta_fdr > 0
  ) %>% 
  select(NODE, node_status, MODULE, Biodomain, MEMBER, top, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>%
  group_by(NODE) %>% 
  summarise(n_biodom = length(unique(Biodomain))
         , n_term = length(unique(MODULE))
         , ef1_max = max(ef1_fdr)
         , delta_max = max(delta_fdr)) 

```

subnetwork of just KD Nodes  
```{r}
vert_num <- match(kd.nodes$NODE, V(snw)$name)

g2 <- induced_subgraph(snw, vert_num)
unlinked <- names(degree(g2)[which(degree(g2)==0)])
g2 <- delete.vertices(g2, unlinked)

# KD evidence
x = tibble( node = V(g2) %>% names ) %>%
  left_join(., kd.nodes, by = c('node'='NODE'))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g2, names(x)[i], index = igraph::V(g2)) <- x %>% pull(i)
}

# plot
ggraph(g2, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey75') +
  geom_node_point( color = "black", alpha = .5, 
                   aes(size = n_term, fill = delta_max, shape = node_status )  )+
  geom_node_text(aes(label = name), size = 2) +
  scale_shape_manual( values = c(21,23) )+
  scale_size_continuous( range = c(2,10) )+
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')

```

subnetwork of KD and neighbors
```{r}
vert_neigh <- neighbors(snw, vert_num)

g3 <- induced_subgraph(snw, c(vert_num, vert_neigh))
unlinked <- names(degree(g3)[which(degree(g3)==0)])
g3 <- delete.vertices(g3, unlinked)

# KD evidence
x = tibble( node = V(g3) %>% names ) %>% 
  left_join(., kd.nodes, by = c('node'='NODE')) %>% 
  mutate(kd = if_else(is.na(n_term), 0, 1))
for(i in 2:ncol(x)){
  igraph::vertex_attr(g3, names(x)[i], index = igraph::V(g3)) <- x %>% pull(i)
}

ggraph(g3, layout = 'graphopt') +
  geom_edge_link(alpha = .3, color = 'grey90') +
  geom_node_point( shape = 21, color = "black", alpha = .3, fill = 'grey90', 
                   aes(filter= .N()$kd == 0)  )+
  geom_node_point( shape = 23, color = "black", alpha = .6, 
                   aes(size = delta_max, fill = ef1_max, filter = .N()$kd == 1) )+
  scale_shape_manual(name='Driver Status', breaks=c('key driver', 'non-driver'),
                     values=c('key driver'=23, 'non-driver'=21))+
  geom_node_text(aes(label = name, filter = .N()$kd == 1), size = 2) +
  viridis::scale_fill_viridis()+
  theme_graph(background = 'white')
```

<!-- ```{r fig.width=12,fig.height=8} -->
<!-- p = suppressWarnings( plot_kd_subnet(nw, kd = 'MRPL4',term = 'mitochondrial large ribosomal subunit') ) -->
<!-- p -->
<!-- ``` -->

# Session
```{r}
sessionInfo()
```

