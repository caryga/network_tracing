---
title: "Sub-domain NW Key Drivers"
author: "Greg Cary"
date: "`r Sys.Date()`"
output: 
  html_document: 
    fig_width: 5
    fig_height: 4
  html_notebook:
    code_folding: hide
    theme: readable
    css: style.css
    toc: true
    toc_float: true
---
# Setup

```{r setup}
# # Package names
# packages <- c(
#   # 'paxtoolsr','org.Hs.eg.db','HotNetvieweR','clusterProfiler', 
#   'synapser','igraph','tidygraph','ggraph','tidyverse'
#   )
# 
# # Load packages
# invisible(lapply(packages, library, character.only = TRUE))

library(synapser)
library(igraph)
library(tidygraph)
library(ggraph)
library(tidyverse)

source('../../treatAD_biodomains/scripts/biodom_tally.R')
source('../../treatAD_biodomains/scripts/annotate_enr_term_biodomains.R')
source('../../treatAD_biodomains/scripts/biodom_enr_plots.R')

theme_set(theme_bw())
```

# Data
Grab relevant data from synapse, including:
1) Target Risk Scores ([syn25575156](https://www.synapse.org/#!Synapse:syn25575156){target="_blank"}) and Omics Scores ([syn22758536](https://www.synapse.org/#!Synapse:syn22758536){target="_blank"})  
2) Biodomain Definitions ([syn25428992](https://www.synapse.org/#!Synapse:syn25428992){target="_blank"})  
2) Risk-enriched Biodomain Terms ([syn45824995](https://www.synapse.org/#!Synapse:syn45824995){target="_blank"})
3) Base Network ([syn51110930](https://www.synapse.org/#!Synapse:syn51110930){target="_blank"})  
4) Synapse IDs of path-traced NW objects  
5) Synapse IDs of wKDA results 
6) CRISPRbrain simple phenotype screen data  

```{r}
synLogin()

# target risk scores
scores <- read_csv(
  synTableQuery('select * from syn25575156', includeRowIdAndRowVersion = F)$filepath
  , col_types = cols())
omics <- read_csv(
  synTableQuery('select * from syn22758536', includeRowIdAndRowVersion = F)$filepath
  , col_types = cols())

# biological domain annotations
biodom <- full_join(
  # biodomains
  readRDS(synGet('syn25428992')$path),
  # domain labels
  read_csv(synGet('syn26856828')$path, col_types = cols()),
  by = c('Biodomain'='domain')
) %>%
  mutate(Biodomain = case_when(Biodomain == 'none' ~ NA_character_, T ~ Biodomain))

domains = biodom %>% pull(Biodomain) %>% unique() %>% sort()

# enriched biodomain terms
enr.bd <- read_csv( synGet('syn45824995')$path, col_types = cols() ) %>% 
  mutate(leadingEdge_genes = str_split(leadingEdge_genes, '\\|'))

# base network
base_net <- igraph::read_graph(synGet('syn51110930')$path, format = 'graphml') 

# specify directed edge types
directed_edge_types = c("catalysis-precedes",
                        "controls-expression-of",
                        "controls-phosphorylation-of",
                        "controls-state-change-of",
                        "controls-transport-of"
                        )
```

pre-filtered NWs    
```{r}
undir <- base_net

# filt node & edge
tmp <- igraph::delete_vertices(
  base_net,
  igraph::V(base_net)[ igraph::V(base_net)$brain_exp == 0 ]
)
undir_node_edge <- igraph::subgraph.edges(
  tmp,
  igraph::E(tmp)[ igraph::E(tmp)$n_edge_evidence > 1 ],
  delete.vertices = T 
)

# filt node
undir_node <- igraph::delete_vertices(
    base_net,
    igraph::V(base_net)[ igraph::V(base_net)$brain_exp == 0 ]
  )

# filt edge
undir_edge <- igraph::subgraph.edges(
    base_net,
    igraph::E(base_net)[ igraph::E(base_net)$n_edge_evidence > 1 ],
    delete.vertices = T 
  )

# dir
dir <- igraph::subgraph.edges( 
    base_net, 
    igraph::E(base_net)[ igraph::E(base_net)$directed == 1 ],
    delete.vertices = T 
  ) %>% 
    as.directed(mode = 'arbitrary')

# dir node edge
dir_node_edge <- igraph::subgraph.edges( 
    undir_node_edge, 
    igraph::E(undir_node_edge)[ igraph::E(undir_node_edge)$directed == 1 ],
    delete.vertices = T 
  ) %>% 
    as.directed(mode = 'arbitrary')

# dir node
dir_node <- igraph::subgraph.edges( 
    undir_node, 
    igraph::E(undir_node)[ igraph::E(undir_node)$directed == 1 ],
    delete.vertices = T 
  ) %>% 
    as.directed(mode = 'arbitrary')

# dir edge
dir_edge <- igraph::subgraph.edges( 
    undir_edge, 
    igraph::E(undir_edge)[ igraph::E(undir_edge)$directed == 1 ],
    delete.vertices = T 
  ) %>% 
    as.directed(mode = 'arbitrary')

```

Read CRISPRbrain phenotype data 
```{r warning=FALSE}
synLogin()

# CRISPRbrain data
syn.dir <- synGetChildren('syn51183357')$asList() %>% 
  tibble(f = .) %>% 
  unnest_wider(f)

# Simple Screens
simple <- map_dfr(
  syn.dir %>% with(which( !grepl('RNA|CROP',name) )),
  ~ { 
    id = syn.dir$id[.x]
    n = syn.dir$name[.x]
    synGet(id)$path %>% 
      read_csv( col_types = cols() ) %>% 
      mutate(cell = n %>% str_split_fixed(.,'-(?!M)', 2) %>% .[,1],
             mode = n %>% str_extract('CRISPR[ain]'),
             expt = n %>% str_remove_all('-CRISPR[ain].csv') %>% 
               str_split_fixed('-(?!M)',2) %>% .[,2] ) %>% 
      relocate(cell, mode, expt)
  }
  ) %>% 
  rename(pval = `P Value`, pheno = `Phenotype`, gene_score = `Gene Score`)

simple <- tibble(expt = simple$expt %>% unique() %>% sort(),
                 phenotype = c('Expansion (CD34 Staining)',
                                'Reactive Oxygen Species (CellRox Intensity)',
                                'Proliferation (CFSE Staining)',
                                'Survival (14 day)', 'Survival (21 day)', 'Survival (28 day)',
                                'Labile Iron (FeRhoNox Intensity)',
                                'Immune Activation (CD38 levels)',
                                'Lysosome Exocytosis (cell surface LAMP1), +IL1a +TNF +C1q',
                                'Lysosome Exocytosis (cell surface LAMP1), Vehicle',
                                'Peroxidized Lipids (Liperfluo intensity)',
                                'Lysosome (LysoTracker intensity)',
                                'Lysosome Mass or pH (LysoTracker staining), +IL1a +TNF +C1q',
                                'Lysosome Mass or pH (LysoTracker staining), Vehicle',
                                'Survival, no antioxidants',
                                'Phagocytosis (pHRodo-rat synaptosomes)',
                                'Phagocytosis (pHRodo-labeled synaptosomes), +IL1a +TNF +C1q',
                                'Phagocytosis (pHRodo-labeled synaptosomes), Vehicle',
                                'Survival, PSAP KO & no antioxidants',
                                'Survival, PSAP KO',
                                'Survival',
                                'Survival-Proliferation',
                                'Inflammatory activation (cell-surface VCAM1 levels), +IL1a +TNF +C1q')
                 ) %>% left_join(simple, . , by = 'expt')

# filter(cell %in% c('iAstrocyte','Glutamatergic Neuron','iTF-Microglia','iPSC')) # don't consider HSPC or T-cell
```

## NW & KDA data

read results from synapse  
```{r}
# top level biodom directory
subdoms <- synGetChildren('syn52314422')$asList() %>%
  tibble(f = .) %>% unnest_wider(f) %>%
  select(bd = name, bd_id = id) %>% 
  rowwise() %>% 
  mutate(
    subdoms = synGetChildren( parent = bd_id )$asList() %>% 
      tibble(f = .) %>% unnest_wider(f) %>% list()
    ) %>% 
  unnest(subdoms) %>% 
  select(bd, sd = name, id) %>% 
  rowwise() %>% 
  mutate(
    nw.dir = synGetChildren(  parent = id  )$asList() %>%
      tibble(f = .) %>% unnest_wider(f) %>% list()
  )
```

## functions
nw data  
```{r}
# read_nw <- function(dom_idx){
#   
#   nw = read.graph(
#     synGet(
#       doms$nw.dir[[dom_idx]] %>% filter( grepl('bdFiltered.+graphml', name) ) %>% pull(id)
#     )$path,
#     format = 'graphml'
#     )
# 
#   return(nw)
#   
# }

v_info <- function(net){
  v.attr <- tibble( na = vertex.attributes(net) ) %>%
    t() %>% 
    as_tibble(rownames = NA, .name_repair = 'unique') %>% 
    unnest(everything()) %>%
    rename_with(., ~names(vertex.attributes(net)), everything())
}

e_info <- function(net){
  e.attr <- tibble( ea = edge.attributes(net) ) %>% 
    t() %>% 
    as_tibble(rownames = NA, .name_repair = 'unique') %>% 
    unnest(everything()) %>% 
    rename_with(., ~names(edge.attributes(net)), everything())
}
```

read KDA result data  
```{r}
# remote from synase
read_kd_remote <- function(kda_dir_syn_id){
  
  synDir <- synGetChildren(kda_dir_syn_id)$asList() %>%
  tibble(f = .) %>% unnest_wider(f)
  
  kd.ef0 <- read_tsv(
    synGet( 
      synDir %>% filter( grepl('edgeFactor_0.results.txt', name) ) %>% pull(id)
      )$path, 
    col_types = cols())
  kd.ef1 <- read_tsv(
    synGet( 
      synDir %>% filter( grepl('edgeFactor_1.results.txt', name) ) %>% pull(id)
      )$path, 
    col_types = cols())
  kd.top <- read_tsv(
    synGet( 
      synDir %>% filter( grepl('edgeFactor_1.tophits.txt', name) ) %>% pull(id)
      )$path, 
    col_types = cols()) %>% 
    mutate(kd = paste0(NODE,'-',MODULE))
    
  kd = bind_rows(
    kd.ef0 %>% mutate(ef = 'ef0_fdr'),
    kd.ef1 %>% mutate(ef = 'ef1_fdr')
    ) %>% 
    mutate(FDR = -log10(FDR)) %>%
    pivot_wider(id_cols = c(MODULE, NODE, MEMBER), 
                names_from = ef, values_from = FDR, values_fill = 0) %>%
    mutate(delta_fdr = ef1_fdr - ef0_fdr) %>% arrange(desc(delta_fdr)) %>% 
    mutate(top = 0)
  
  if( any( kd.top$FDR < 0.05 ) ){
    kd$top[ which(paste0(kd$NODE,'-',kd$MODULE) %in% kd.top$kd[kd.top$FDR < 0.05]) ] <- 1
  }
  
  return(kd)
}

# local directory
read_kd_local <- function(local_path){
  
  kd.pth <- list.files(local_path, full.names = T)
  
  kd.ef0 <- read_tsv(
    kd.pth %>% str_subset('_0.results.txt'), 
    col_types = cols())
  kd.ef1 <- read_tsv(
    kd.pth %>% str_subset('_1.results.txt'),  
    col_types = cols())
  kd.top <- read_tsv(
    kd.pth %>% str_subset('_1.tophits.txt'), 
    col_types = cols()) %>% 
    mutate(kd = paste0(NODE,'-',MODULE))
    
  kd = bind_rows(
    kd.ef0 %>% mutate(ef = 'ef0_fdr'),
    kd.ef1 %>% mutate(ef = 'ef1_fdr')
    ) %>% 
    mutate(FDR = -log10(FDR)) %>%
    pivot_wider(id_cols = c(MODULE, NODE, MEMBER), 
                names_from = ef, values_from = FDR, values_fill = 0) %>%
    mutate(delta_fdr = ef1_fdr - ef0_fdr) %>% arrange(desc(delta_fdr)) %>% 
    mutate(top = 0)
  
  if( any( kd.top$FDR < 0.05 ) ){
    kd$top[ which(paste0(kd$NODE,'-',kd$MODULE) %in% kd.top$kd[kd.top$FDR < 0.05]) ] <- 1
  }
  
  return(kd)
}

```

plot subnetwork around identified KDs
```{r}
plot_kd_subnet <- function(nw, kd, term) {

  vert_num <- match(kd, V(nw)$name)

  vert_neigh <- neighbors(nw, vert_num)

  term_num <- biodom %>%
    filter(GOterm_Name == term) %>%
    pull(symbol) %>% unlist() %>%
    match(., V(nw)$name) %>% .[!is.na(.)]

  g2 <- induced_subgraph(nw, c(vert_num, intersect(term_num, vert_neigh)))
  g3 <- induced_subgraph(nw, c(vert_num, term_num))

  cowplot::plot_grid(

    ggraph(g3, layout = 'linear', circular = TRUE) +
      geom_edge_arc(alpha = .3, color = 'grey75') +
      geom_node_point( shape = 21, color = "black", alpha = .3,
        aes(size = TargetRiskScore, fill = Pro_EffectScore, filter= .N()$name != kd)  )+
      geom_node_point( shape = 23, color = "black", alpha = .3,
        aes(size = TargetRiskScore, fill = Pro_EffectScore, filter = .N()$name == kd) )+
      geom_node_text(aes(label = name), size = 2) +
      coord_fixed() +
      scale_size_continuous( range = c(.5, 10), limits = c(0, 5), trans = 'exp')+
      scale_fill_gradient2(
        low = 'purple', mid = 'grey20', high = 'green', na.value = 'grey85',
        limits = c(-2.5,2.5) )+ #approx: range(omics$Pro_TE, na.rm = T)
      labs( title = 'All term genes in NW',
            subtitle = paste0('KD: ', kd, '\nTerm: ', term) )+
      theme_graph(background = 'white')
    ,
    ggraph(g2, layout = 'linear', circular = TRUE) +
            geom_edge_arc(alpha = .3, color = 'grey75') +
      geom_node_point( shape = 21, color = "black", alpha = .3,
        aes(size = TargetRiskScore, fill = Pro_EffectScore, filter= .N()$name != kd)  )+
      geom_node_point( shape = 23, color = "black", alpha = .3,
        aes(size = TargetRiskScore, fill = Pro_EffectScore, filter = .N()$name == kd) )+
      geom_node_text(aes(label = name), size = 2) +
      coord_fixed() +
      scale_size_continuous( range = c(.5, 10), limits = c(0, 5), trans = 'exp')+
      scale_fill_gradient2(
        low = 'purple', mid = 'grey20', high = 'green', na.value = 'grey85',
        limits = c(-2.5,2.5) )+ #approx: range(omics$Pro_TE, na.rm = T)
      labs( title = 'Term genes & KD neighbors in NW',
            subtitle = paste0('KD: ', kd, '\nTerm: ', term) )+
      theme_graph(background = 'white')
    ,
    ncol = 2

  )
}
```


# Key Driver Analysis 

```{r echo=FALSE,warning=FALSE,message=FALSE,results='asis', fig.width=10, fig.height=8}
synLogin()

for(parent_dom in unique(subdoms$bd)){
  
  cat("  \n##", parent_dom, " \n")
  
  for(dom in subdoms$sd[which(subdoms$bd == parent_dom)]){
  
    # Get NW info
    nw <- subdoms %>% filter(sd == dom) %>% 
      pull(nw.dir) %>% .[[1]] %>% 
      filter(grepl('bdFilt.+graphml',name)) %>% 
      pull(id) %>% synGet(.) %>% .$path %>% 
      read_graph(., format = 'graphml')
    
    nodes <- v_info(nw)
    edges <- e_info(nw)
    
    snw <- igraph::simplify(nw, remove.multiple = T)
    
    # tabulate GO term representation across NW
    nw_terms <- biodom %>% 
      filter(!is.na(n_symbol),n_symbol > 0) %>% 
      select(Biodomain, MODULE = GOterm_Name, NODE = symbol, n_symbol) %>% 
      mutate(
        n_nw = length( intersect( NODE, names(V(snw)) ) ),
        pct_term = 100*(n_nw/n_symbol)
      ) %>% 
      distinct()
    
    # get KDA results and annotate
    kd.res <- subdoms %>% filter(sd == dom) %>% 
      pull(nw.dir) %>% .[[1]] %>% filter(name == 'kda') %>% 
      pull(id) %>% read_kd_remote(.)
    
    kd.res <- kd.res %>% 
      left_join(
        ., nodes %>% select(NODE = name, node_status)
      ) %>% 
      left_join(
        ., biodom %>% select(MODULE = GOterm_Name, Biodomain, abbr:color) 
      ) %>% 
      left_join(
        ., nw_terms %>% select(MODULE, n_symbol:pct_term) %>% distinct()
      ) 
    
    top.kd <- kd.res %>% 
      filter(ef1_fdr > -log10(0.05), delta_fdr > 0, top == 1, pct_term > 50) 
    
    kd.hits <- top.kd %>% pull(NODE) %>% unique()
    
    # tabulate top biodoms in KD results
    kd.biodoms <- top.kd %>% 
      mutate(pair = paste0(NODE,':',MODULE)) %>% 
      group_by(Biodomain) %>% 
      summarise(n_term = length(unique(MODULE)),
                n_node = length(unique(NODE)),
                n_kd = length(unique(pair)),
                # terms = list(unique(MODULE)),
                min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
                max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
      full_join(., 
                biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
                  select(Biodomain, n_go, abbr:color) %>% distinct(), 
                by = 'Biodomain') %>% 
      ungroup() %>%
      mutate(fxn_bd_term = n_term / n_go) %>% 
      filter( !is.na(Biodomain) ) %>% 
      mutate(across(.cols = c(n_term:n_kd), ~if_else(is.na(.x), as.integer(0), .x))) 
    
    ##
    # CBrain phenotype associations with KDs
    if( length(kd.hits) > 0){
      
      cbrain_lr <- simple %>%
        mutate(cb_hit = if_else( `Hit Class` == 'Non-Hit', 0, 1)) %>%
        select(cell, mode, expt, Gene, cb_hit) %>% distinct() %>%
        mutate(kd = if_else(Gene %in% kd.hits, 1, 0)) %>%
        left_join(., tibble(Gene = names(V(snw)), node_degree = degree(snw)) ) %>%
        filter(!is.na(node_degree)) %>%
        group_by(cell,mode,expt) %>%
        mutate(
          lr = glm( cb_hit~kd+node_degree,
                    family=binomial(link='logit')) %>% broom::tidy() %>%
                 filter(term == 'kd') %>%
                 mutate(nobs = glm( cb_hit~kd+node_degree,
                                    family=binomial(link='logit')) %>%
                          broom::glance() %>% pull(nobs)) %>% list()
          ) %>%
        unnest(lr)  %>%
        select(cell, mode, expt, p.value, nobs, estimate, statistic ) %>% distinct() %>%
        arrange(p.value)
    
    } else { cbrain_lr = data.frame() } 
    
    #  CRISPRbrain -- linear regression
    tmp <- top.kd %>% inner_join( simple,., by =c('Gene'='NODE')) %>%
      left_join(., tibble(Gene = names(V(snw)), node_degree = degree(snw)) ) %>%
      mutate(node_degree = scale(node_degree, center = T, scale = T) %>% c(),
             ef1_fdr = scale(ef1_fdr, center = T, scale = T) %>% c(),
             delta_fdr = scale(delta_fdr, center = T, scale = T) %>% c(),
             gs = scale(abs(gene_score), center = T, scale = T) %>% c()
             ) %>% 
      select(Gene, MODULE, cell, mode, expt, gs, ef1_fdr, delta_fdr, node_degree) %>% 
      distinct()
  
    if( nrow(tmp) > 0 & !all(is.nan(tmp$ef1_fdr)) ){
      cbrain_lm_ef1 <- tmp %>%
        group_by(cell,mode,expt) %>%
        mutate(
          lm = if_else(
            length(unique(Gene)) <= 2 ,
            tibble(estimate = NA, statistic = NA, p.value = NA, r.squared = NA, nobs = NA) %>% list(),
            lm(gs~ef1_fdr+node_degree) %>% broom::tidy() %>% filter(term == 'ef1_fdr') %>%
              mutate(r.squared = lm(gs~ef1_fdr+node_degree) %>% broom::glance() %>% pull(r.squared),
                     nobs = lm(gs~ef1_fdr+node_degree) %>% broom::glance() %>% pull(nobs)) %>% list()
          , )
            ) %>%
        unnest(lm)  %>%
        select(cell, mode, expt, p.value, r.squared, nobs, estimate, statistic ) %>% distinct() %>%
        arrange(p.value) 
    
      cbrain_lm_delta <- tmp %>%
        group_by(cell,mode,expt) %>%
        mutate(
          lm = if_else(
            length(unique(Gene)) <= 2 ,
            tibble(estimate = NA, statistic = NA, p.value = NA, r.squared = NA, nobs = NA) %>% list(),
            lm(gs~delta_fdr+node_degree) %>% broom::tidy() %>% filter(term == 'delta_fdr') %>%
              mutate(r.squared = lm(gs~delta_fdr+node_degree) %>% broom::glance() %>% pull(r.squared),
                     nobs = lm(gs~delta_fdr+node_degree) %>% broom::glance() %>% pull(nobs)) %>% list()
          )
            ) %>%
        unnest(lm)  %>%
        select(cell, mode, expt, p.value, r.squared, nobs, estimate, statistic ) %>% distinct() %>%
        arrange(p.value)
    } else {
      
    cbrain_lm_ef1 <- data.frame()
    cbrain_lm_delta <- data.frame()
    
    }

    ##
    # PLOTS
    biodoms_plot <- kd.biodoms %>% 
      pivot_longer(n_kd) %>% 
      mutate(Biodomain = fct_reorder(Biodomain, value)) %>% 
      ggplot(aes(value, Biodomain))+
      geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
      geom_point(aes(size = max_delta, color = color))+
      scale_color_identity()+
      labs(y='', 
           x = '# KDs\n(NODE-MODULE pair)',
           #title = paste0(dom, ' Network Key Drivers'),
           subtitle = 'Biodomain GO terms')+ 
      theme(legend.position = 'right')
      # +facet_wrap(~name)
  
    if(nrow(top.kd) > 0){
      
      all_res <- kd.res %>% 
        ggplot(aes( ef1_fdr, delta_fdr ))+
        labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = dom)+
        geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
        geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
        geom_point(alpha = .2, size = 1, aes(color = color, shape = node_status) )+
        geom_point(data = subset(kd.res, top == 1 & ef1_fdr > -log10(0.05) 
                                 & delta_fdr > 0 & pct_term > 50)
                   , alpha = .6, size = 3, aes(color = color, shape = node_status))+
        scale_color_identity(guide = 'none')+
        ggrepel::geom_label_repel(
          data = subset( kd.res, top == 1 & ef1_fdr > -log10(0.05)
                         & delta_fdr > 0 & pct_term >50
                         # & MODULE %in% enr.bd$pathway[which( enr.bd$padj < 0.05
                         #    # & enr.bd$Biodomain == str_replace_all(dom, '_', ' ')
                         #                              )]
                         ),
          aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
          size = 2, alpha = .7, min.segment.length = 0)
  
      top_res <- top.kd %>% 
        ggplot(aes( ef1_fdr, delta_fdr ))+
        labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', 
             title = dom,
             subtitle = 'signif KDs (EF1 FDR < 0.05), \u0394 FDR > -1'
             )+
        # geom_abline(intercept = 0, slope =1, lty= 2, lwd = .5)+
        geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
        geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
        geom_point(alpha = .6, size = 2, shape = 21, color = 'grey20', aes(fill = color))+
        # ggrepel::geom_label_repel(
        #   data = subset( top.kd, MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]),
        #   aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
        #   size = 2, alpha = .7, min.segment.length = 0)+
        facet_wrap(~Biodomain)+ #, scales = 'free'
        scale_fill_identity(guide = 'none') #; plotly::ggplotly(p)
      
      top_dt <- top.kd %>% 
        filter(MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]) %>% 
        select(NODE, node_status, MODULE, pct_term, Biodomain, MEMBER, ef1_fdr, delta_fdr) %>% 
        mutate(MODULE = str_trunc(MODULE, 25, 'right'),
               #ef0_fdr = signif(ef0_fdr, digits = 3),
               ef1_fdr = signif(ef1_fdr, digits = 3),
               delta_fdr = signif(delta_fdr, digits = 3)) %>% 
        arrange(desc(delta_fdr), desc(ef1_fdr)) %>% 
        slice_head(n = 25)
  
      kd.nodes <- top.kd %>% 
        select(NODE, node_status, MODULE, Biodomain, 
               MEMBER, top, contains('fdr')) %>% 
        arrange(desc(delta_fdr), desc(ef1_fdr)) %>%
        group_by(NODE) %>% 
        summarise(n_biodom = length(unique(Biodomain))
               , n_term = length(unique(MODULE))
               , ef1_max = max(ef1_fdr)
               , delta_max = max(delta_fdr)) 
      
      vert_num <- match(kd.nodes$NODE, V(snw)$name)
      vert_neigh <- neighbors(snw, vert_num)
      
      g3 <- induced_subgraph(snw, c(vert_num, vert_neigh))
      unlinked <- names(degree(g3)[which(degree(g3)==0)])
      g3 <- delete.vertices(g3, unlinked)
      
      # KD evidence
      x = tibble( node = V(g3) %>% names ) %>% 
        left_join(., kd.nodes, by = c('node'='NODE')) %>% 
        mutate(kd = if_else(is.na(n_term), 0, 1))
      for(i in 2:ncol(x)){
        igraph::vertex_attr(g3, names(x)[i], index = igraph::V(g3)) <- x %>% pull(i)
      }
      
      kd_nw <- ggraph(g3, layout = 'graphopt') +
        geom_edge_link(alpha = .3, color = 'grey90') +
        geom_node_point( shape = 21, color = "black", alpha = .3, fill = 'grey90', 
                         aes(filter= .N()$kd == 0)  )+
        geom_node_point( color = "black", alpha = .6, 
                         aes(size = delta_max, fill = ef1_max, shape=node_status, 
                             filter = .N()$kd == 1) )+
        scale_shape_manual(name='Node Source', breaks=c('added', 'query'),
                           values=c('added'=23, 'query'=21))+
        scale_size_continuous(range = c(3,12))+
        geom_node_text(aes(label = name, filter = .N()$kd == 1), size = 2) +
        viridis::scale_fill_viridis()+
        theme_graph(background = 'white')
    
    } else {
      
      all_res <- kd.res %>% 
        ggplot(aes( ef1_fdr, delta_fdr ))+
        labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = dom)+
        geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
        geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
        geom_point(alpha = .2, size = 1, aes(color = color, shape = node_status) )+
        geom_point(data = subset(kd.res, top == 1 & ef1_fdr > -log10(0.05) 
                                 & delta_fdr > 0 & pct_term > 50)
                   , alpha = .6, size = 3, aes(color = color, shape = node_status))+
        scale_color_identity(guide = 'none')
      
      df <- data.frame()
  
      top_res <- ggplot(df) + geom_point() + xlim(0, 10) + ylim(0, 100)
      top_dt <- ggplot(df) + geom_point() + xlim(0, 10) + ylim(0, 100)
      kd_nw <- ggplot(df) + geom_point() + xlim(0, 10) + ylim(0, 100)
    }
    
    cat("  \n###", dom, " {.tabset}  \n")
    
    cat("  \n#### All KD results  \n")
    
    res = cowplot::plot_grid(all_res, biodoms_plot, rel_widths = c(1,.7), nrow = 1)
    plot(res)
    
    plot.new()
    dev.off()
    cat("  \n  \n")  
    
    cat('\n#### Top Key Drivers: \n')
    plot(top_res)
    if(nrow(top.kd) > 0){ print(top_dt) }
    
    plot.new()
    dev.off()
    cat("  \n  \n")  
    
    cat('\n#### Key Driver Nodes: \n')
    plot(kd_nw)
    
    plot.new()
    dev.off()
    cat("  \n  \n")  
    
    cat('\n#### CRISPRbrain overlap \n')
    cat('\n logit: cbrain hit ~ key driver + node degree \n')
    print( cbrain_lr )
    cat('\n lm: abs(gene_score) ~ ef1_fdr + node_degree \n')
    print( cbrain_lm_ef1 )
    cat('\n lm: abs(gene_score) ~ delta_fdr + node_degree \n')
    print( cbrain_lm_delta )
    plot.new()
    dev.off()
    cat("  \n  \n")  

  }

}
```


```{r}
  # # CRISPRbrain -- logistic regression
  # cbrain_lr <- simple %>%
  #   mutate(cb_hit = if_else( `Hit Class` == 'Non-Hit', 0, 1)) %>%
  #   select(cell, mode, expt, Gene, cb_hit) %>% distinct() %>%
  #   mutate(kd = if_else(Gene %in% kd.hits, 1, 0)) %>%
  #   left_join(., tibble(Gene = names(V(snw)), node_degree = degree(nw)) ) %>%
  #   filter(!is.na(node_degree)) %>%
  #   group_by(cell,mode,expt) %>%
  #   mutate(
  #     lr = glm( cb_hit~kd+node_degree,
  #               family=binomial(link='logit')) %>% broom::tidy() %>%
  #            filter(term == 'kd') %>%
  #            mutate(nobs = glm( cb_hit~kd+node_degree,
  #                               family=binomial(link='logit')) %>%
  #                     broom::glance() %>% pull(nobs)) %>% list()
  #     ) %>%
  #   unnest(lr)  %>%
  #   select(cell, mode, expt, estimate, statistic, p.value, nobs) %>% distinct() %>%
  #   # filter(p.value < 0.05) %>%
  #   arrange(p.value)
  # 
  # # cbrain_lr_dt <- cbrain_lr %>%
  # #   select(cell:expt, estimate:p.value) %>%
  # #   DT::datatable(rownames = F, filter = 'top', caption = 'cb_hit ~ kd + node_degree',
  # #                 options = list(pageLength = 6)) %>% #
  # #   DT::formatSignif(columns = c('estimate', 'std.error','statistic', 'p.value'))
  # 
  # #  CRISPRbrain -- linear regression
  # tmp <- top.kd %>% inner_join( simple,., by =c('Gene'='NODE')) %>%
  #   left_join(., tibble(Gene = names(V(snw)), node_degree = degree(snw)) ) %>%
  #   mutate(node_degree = scale(node_degree, center = T, scale = T),
  #          ef1_fdr = scale(ef1_fdr, center = T, scale = T),
  #          delta_fdr = scale(delta_fdr, center = T, scale = T)
  #          )
  # 
  # cbrain_lm_ef1 <- tmp %>%
  #   group_by(cell,mode,expt) %>%
  #   mutate(gs = scale(abs(gene_score), center = T, scale = T),
  #          lm = lm(gs~ef1_fdr+node_degree) %>% broom::tidy() %>%
  #            filter(term == 'ef1_fdr') %>%
  #            mutate(r.squared = lm(abs(gene_score)~ef1_fdr+node_degree) %>%
  #                     broom::glance() %>% pull(r.squared),
  #                   nobs = lm(abs(gene_score)~ef1_fdr+node_degree) %>%
  #                     broom::glance() %>% pull(nobs)) %>% list()) %>%
  #   unnest(lm)  %>%
  #   select(cell, mode, expt,  estimate, statistic, p.value, r.squared, nobs) %>% distinct() %>%
  #   arrange(p.value) 
  # # %>%
  # #   DT::datatable(rownames = F, filter = 'top',
  # #                 caption = 'abs(gene_score) ~ ef1_fdr + node_degree',
  # #                 options = list(pageLength = 6)) %>% #
  # #   DT::formatSignif(columns = c('statistic', 'std.error',
  # #                                'r.squared', 'p.value', 'estimate'))
  # 
  # cbrain_lm_delta <- tmp %>%
  #   group_by(cell,mode,expt) %>%
  #   mutate(gs = scale( abs(gene_score), center = T, scale = T),
  #          lm = lm(gs~delta_fdr+node_degree) %>% broom::tidy() %>%
  #            filter(term == 'delta_fdr') %>%
  #            mutate(r.squared = lm(gs~delta_fdr+node_degree) %>%
  #                     broom::glance() %>% pull(r.squared),
  #                   nobs = lm(gs~delta_fdr+node_degree) %>%
  #                     broom::glance() %>% pull(nobs)) %>% list()) %>%
  #   unnest(lm)  %>%
  #   select(cell, mode, expt, estimate, statistic, p.value, r.squared, nobs) %>% distinct() %>%
  #   # filter(p.value < 0.05) %>%
  #   arrange(p.value)
  # # %>%
  # #   DT::datatable(rownames = F, filter = 'top',
  # #                 caption = 'abs(gene_score) ~ \u0394 fdr (ef1-ef0) + node_degree',
  # #                 options = list(pageLength = 6)) %>% #
  # #   DT::formatSignif(columns = c('statistic', 'std.error',
  # #                                'r.squared', 'p.value', 'estimate'))
```

# Session
```{r}
sessionInfo()  
```

