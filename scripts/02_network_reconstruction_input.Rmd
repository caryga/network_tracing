---
title: "Enriched Biodomain Terms & Pathtrace Input"
author: "Greg Cary"
date: "`r Sys.Date()`"
output: 
  html_document: 
    fig_width: 5
    fig_height: 4
  html_notebook:
    code_folding: hide
    theme: readable
    css: style.css
    toc: true
    toc_float: true
---
# Setup

```{r setup}
# # Package names
# packages <- c(
#   # 'paxtoolsr','org.Hs.eg.db','HotNetvieweR','clusterProfiler', 
#   'synapser','igraph','tidygraph','ggraph','tidyverse'
#   )
# 
# # Load packages
# invisible(lapply(packages, library, character.only = TRUE))

library(synapser)
library(googlesheets4)
library(igraph)
library(tidygraph)
library(ggraph)
library(tidyverse)

source('/projects/carter-lab/caryg/treatAD_biodomains/scripts/biodom_tally.R')
source('/projects/carter-lab/caryg/treatAD_biodomains/scripts/annotate_enr_term_biodomains.R')
source('/projects/carter-lab/caryg/treatAD_biodomains/scripts/biodom_enr_plots.R')

theme_set(theme_bw())
```

# Data
Grab relevant data from synapse, including:
1) Target Risk Scores ([syn25575156](https://www.synapse.org/#!Synapse:syn25575156){target="_blank"}) and Omics Scores ([syn22758536](https://www.synapse.org/#!Synapse:syn22758536){target="_blank"})   
2) Biodomain and Sub-domain Definitions ([syn25428992](https://www.synapse.org/#!Synapse:syn25428992){target="_blank"})   
3) Biodomain Term Annotation Kappa scores ([syn51163744](https://www.synapse.org/#!Synapse:syn51163744){target="_blank"}) & Network ([syn51497240](https://www.synapse.org/#!Synapse:syn51497240){target="_blank"})   
3) Risk-enriched Biodomain Terms ([syn45824995](https://www.synapse.org/#!Synapse:syn45824995){target="_blank"})  
4) Risk-enriched Biodomain Term Network ([syn51387897](https://www.synapse.org/#!Synapse:syn51387897){target="_blank"})  
5) Base Network ([syn51110930](https://www.synapse.org/#!Synapse:syn51110930){target="_blank"})  

```{r}
synLogin()

# target risk scores
scores <- read_csv(
  synTableQuery('select * from syn25575156', includeRowIdAndRowVersion = F)$filepath
  , col_types = cols())

omics <- read_csv(
  synTableQuery('select * from syn22758536', includeRowIdAndRowVersion = F)$filepath
  , col_types = cols())

# biological domain annotations
biodom <- full_join(
  
  # biodomains
  readRDS(synGet('syn25428992')$path),
  
  # domain labels
  read_csv(synGet('syn26856828')$path, col_types = cols()),  
  
  by = c('Biodomain'='domain')
  ) %>% mutate(Biodomain = if_else(Biodomain == 'none', NA_character_, Biodomain))

domains = biodom %>% pull(Biodomain) %>% unique() %>% sort()

subdomains <- biodom %>% select(Biodomain, subdomain_idx, Subdomain) %>% 
  distinct() %>% filter(subdomain_idx != 0)

# # biodomain term annotation kappa scores
# biodom.kappa <- read_csv(synapser::synGet('syn51163744')$path) %>% 
#   left_join(., biodom %>% select(goid_1 = GO_ID, n_gene1 = n_symbol), by = 'goid_1') %>%
#   left_join(., biodom %>% select(goid_2 = GO_ID, n_gene2 = n_symbol), by = 'goid_2') %>%
#   distinct() %>%
#   filter(goid_1 != goid_2,
#          kappa > 0.1,
#          n_gene1 > 3,
#          n_gene2 > 3)

# biodomain term annotation network
biodom.nw <- igraph::read_graph(synGet('syn51497240')$path, format = 'graphml') 

# enriched biodomain terms
# enr.bd <- read_csv( synGet('syn45824995')$path, col_types = cols() ) %>% 
#   mutate(leadingEdge_genes = str_split(leadingEdge_genes, '\\|'))

enr.scores <- readRDS(
  '/projects/carter-lab/caryg/treatAD_biodomains/results/risk_score_biodom_enrichments.rds'
  )
enr.bd <- enr.scores$anno[[3]] %>% 
  rename(padj = p.adjust, size = setSize, pathway = Description) %>% 
  mutate(leadingEdge_genes = str_split(core_enrichment, '\\/'))  

# enriched biodomain term network
# enr.nw <- igraph::read_graph(synGet('syn51387897')$path, format = 'graphml') 

# base network
base.net <- igraph::read_graph(synGet('syn51110930')$path, format = 'graphml') 

# filt node & edge
tmp <- igraph::delete_vertices(
  base_net,
  igraph::V(base_net)[ igraph::V(base_net)$brain_exp == 0 ]
)
undir_node_edge <- igraph::subgraph.edges(
  tmp,
  igraph::E(tmp)[ igraph::E(tmp)$n_edge_evidence > 1 ],
  delete.vertices = T 
)

# specify directed edge types
directed_edge_types = c("catalysis-precedes",
                        "controls-expression-of",
                        "controls-phosphorylation-of",
                        "controls-state-change-of",
                        "controls-transport-of"
                        )

```

# Enriched terms

## Enriched terms by biodomain {.tabset}

### All
```{r fig.width=15, fig.height=12}

tmp <- enr.bd %>% mutate(Biodomain = fct_relevel(
  Biodomain, 
  levels = unique(Biodomain) %>% str_subset(.,'none', negate = T) %>% c(.,'none')))

ggplot(data = tmp, aes(NES, -log10(padj)))+
  geom_vline(xintercept = 1.66, lty = 2, lwd = .2, color = 'grey30')+
  geom_hline(yintercept = -log10(0.01), lty = 2, lwd = .2, color = 'grey30')+
  # geom_smooth(method = "lm", formula = y ~ poly(x, 2), lwd = .2)+
  geom_point(
    data = subset(tmp, padj > 0.05 ),
    shape = 21, size = .2, alpha = .3, color = 'grey20')+
  geom_point(
    data = subset(tmp, padj <= 0.05 ),
    shape = 21, color = 'grey50', alpha = .3, 
    aes(fill = color, size = size ))+
  scale_fill_identity()+
  theme(legend.position = 'top')+
  ggrepel::geom_label_repel(
    data = subset(tmp, padj < 0.01 & NES > 1.66 ),
    aes(label = str_trunc(pathway, 40, 'right',)),
    size = 3, alpha = .7, min.segment.length = 0, max.overlaps = 10
  )+
  facet_wrap(~Biodomain)

```

```{r echo=FALSE,warning=FALSE,message=FALSE,results='asis', fig.width=15, fig.height=12}

bd = unique(enr.bd$Biodomain) %>% sort() %>% str_subset(., 'none', negate = T) %>% c(., 'none')

for(i in 1:length(bd)) {
  cat("  \n###",  bd[i], "  \n")
  
  tmp = enr.bd %>% filter(Biodomain == bd[i])
  
  p = ggplot(data = tmp, aes(NES, -log10(padj)))+
  geom_vline(xintercept = 1.66, lty = 2, lwd = .2, color = 'grey30')+
  geom_hline(yintercept = -log10(0.01), lty = 2, lwd = .2, color = 'grey30')+
  # geom_smooth(method = "lm", formula = y ~ poly(x, 2), lwd = .2)+
  geom_point(
    data = subset(tmp, padj > 0.05 ),
    shape = 21, size = .2, alpha = .3, color = 'grey20')+
  geom_point(
    data = subset(tmp, padj <= 0.05),
    shape = 21, color = 'grey50', alpha = .3, 
    aes(fill = color, size = size ))+
  scale_fill_identity()+
  theme(legend.position = 'top')+
  ggrepel::geom_label_repel(
    data = subset(tmp, padj < 0.01 & NES > 1.66),
    aes(label = str_trunc(pathway, 40, 'right',)),
    size = 3, alpha = .7, min.segment.length = 0, max.overlaps = 10
  )+
  facet_wrap(~Biodomain, drop = T)
  
  plot(p)
  plot.new()
  dev.off()
  cat("  \n  \n")  
  
}

```

## Enriched terms by subdomain {.tabset}
```{r echo=FALSE,warning=FALSE,message=FALSE,results='asis', fig.width=15, fig.height=12}

bd = enr.bd %>% filter(subdomain_idx > 0) %>% pull(Biodomain) %>% unique() %>% sort()

for(i in 1:length(bd)) {
  cat("  \n###",  bd[i], "  \n")
  
  tmp <- enr.bd %>% filter(Biodomain == bd[i])
  
  p = ggplot(data = tmp, aes(NES, -log10(padj)))+
    geom_vline(xintercept = 1.66, lty = 2, lwd = .2, color = 'grey30')+
    geom_hline(yintercept = -log10(0.01), lty = 2, lwd = .2, color = 'grey30')+
    # geom_smooth(method = "lm", formula = y ~ poly(x, 2), lwd = .2)+
    geom_point(
      data = subset(tmp, padj > 0.05 ),
      shape = 21, size = .2, alpha = .3, color = 'grey20')+
    geom_point(
      data = subset(tmp, padj <= 0.05 ),
      shape = 21, color = 'grey50', alpha = .3, 
      aes(fill = color, size = size ))+
    scale_fill_identity()+
    theme(legend.position = 'top')+
    ggrepel::geom_label_repel(
      data = subset(tmp, padj < 0.01 & NES > 1.66 ),
      aes(label = str_trunc(pathway, 40, 'right',)),
      size = 2.5, alpha = .7, min.segment.length = 0, max.overlaps = 10
    )+
    facet_wrap(~Subdomain, scales = 'free')
  
  plot(p)
  plot.new()
  dev.off()
  cat("  \n  \n")  
  
}

```
 

## Examine p-value & NES thresholding
```{r}
thresh = crossing(
  p = c(0.05, 0.01, 0.001, 1e-4, 1e-5, 1e-6),
  nes = quantile( enr.bd$NES, c(.2,.3,.4,.5,.6,.7,.8,.9), na.rm = T)
)

x = tibble()

for( bd in unique(enr.bd$Biodomain) ){
  n_GO = map_dbl(
    1:nrow(thresh), 
    ~ enr.bd %>% filter(Biodomain == bd, NES > thresh$nes[.x], padj <= thresh$p[.x]) %>% pull(GO_ID) %>% unique() %>% length()
      )
  n_LE_genes = map_dbl(
    1:nrow(thresh), 
    ~ enr.bd %>% filter(Biodomain == bd, NES > thresh$nes[.x], padj <= thresh$p[.x]) %>% pull(leadingEdge_genes) %>% unlist() %>% unique() %>% length()
  )
  
  x <- tibble(
    bd = bd,
    n_GO = n_GO,
    n_LE_genes = n_LE_genes
  ) %>% 
    bind_cols( thresh, .) %>% 
    bind_rows( x, .)
}

thresh <- x %>% 
  left_join(., biodom %>% select(bd = Biodomain, abbr:color) %>% distinct(), by = 'bd') %>% 
  group_by(bd) %>% 
  mutate(
    pct_max_GO = n_GO / max(n_GO),
    pct_max_LE = n_LE_genes / max(n_LE_genes)
  ) 

```

Number of GO terms enriched at various thresholds  
```{r fig.width=10, fig.height=8}
ggplot(data = subset(thresh, bd!='none'), 
       aes( as.factor(signif(nes, 2)) , as.factor(signif(p, 2)) ))+
  geom_point(aes(size = n_GO, fill = color), shape = 21, color = 'grey30', alpha = .9)+
  labs(y = 'p-adjust threshold', x = 'NES threshold')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+
  scale_size_continuous( limits = c(1,max(thresh$n_GO[thresh$bd!='none'])) )+
  scale_fill_identity()+ 
  facet_wrap(~bd)
```

Number of leading edge genes (i.e. input to path trace) at various thresholds  
```{r fig.width=10, fig.height=8}
ggplot(data = subset(thresh, bd!='none'), 
       aes( as.factor(signif(nes, 2)) , as.factor(signif(p, 2)) ))+
  geom_point(aes(size = n_LE_genes, fill = color), shape = 21, color = 'grey30', alpha = .9)+
  labs(y = 'p-adjust threshold', x = 'NES threshold')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+
  scale_size_continuous( limits = c(1,max(thresh$n_LE_genes[thresh$bd!='none'])) )+
  scale_fill_identity()+ 
  facet_wrap(~bd)
```

Percent of maximum number of leading edge genes (i.e. input to path trace) at various thresholds  
```{r fig.width=10, fig.height=8}
ggplot(data = subset(thresh, bd!='none'), 
       aes( as.factor(signif(nes, 2)), as.factor(signif(p, 2)) ))+
  geom_point(aes(size = pct_max_LE*100, fill = color), shape = 21, color = 'grey30', alpha = .9)+
  labs(x = 'p-adjust threshold', y = 'NES threshold')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+
  scale_size_continuous( limits = c(0,100), range = c(.05,5) )+
  scale_fill_identity()+ 
  facet_wrap(~bd)
```

## Top LE genes per domain
```{r fig.width=15, fig.height=12}

tmp <- enr.bd %>% filter(padj <= 0.01) %>% group_by(Biodomain) %>% arrange(desc(NES), padj, .by_group = T)

bd <- unique(tmp$Biodomain) %>% str_subset(., 'none', negate = T)

x <- tibble(dom = NULL, n_sig_term = NULL, max_LE_genes = NULL, n_terms_to_500_LE_genes = NULL)
for(i in 1:length(bd)){
    x1 = NULL
    z = tmp %>% filter(Biodomain == bd[i])
    y = map_dbl(1:nrow(z), ~ z %>% slice(1:.x) %>% pull(leadingEdge_genes) %>% unlist() %>% unique() %>% length())
    if(any(y>500)){ 
        x1 = which(y > 500) %>% min()
    } else { x1 = nrow(z) }
    x <- bind_rows(x,
                   tibble(
                     dom = bd[i], 
                     n_sig_term = nrow(z), 
                     max_LE_genes = unlist(z$leadingEdge_genes) %>% unique() %>% length(),
                     n_terms_to_500_LE_genes = x1))
}


x %>% mutate(term_fxn = n_terms_to_500_LE_genes / n_sig_term, 
             fxn = 500/max_LE_genes, 
             fxn = if_else(fxn >1, 1, fxn)) %>% 
  arrange(fxn) %>% 
  DT::datatable() %>% 
  DT::formatSignif(columns = c('fxn','term_fxn'))
```

# Path trace input

## Biodomain NW

```{r}

# signif domains
doms = enr.bd %>% filter(padj < 0.01, NES > 1.66, Biodomain != 'none') %>% pull(Biodomain) %>% unique() %>% sort()

for( bd in doms ){
  
  # filter and pull gene list from biodom leading edge genes
  gl <- enr.bd %>% 
    filter(
      Biodomain == bd,
      padj < 0.01,
      NES > 1.66
    ) %>% 
    pull(leadingEdge_genes) %>% 
    unlist() %>% 
    unique()
  
  # how many genes and graph nodes for each biodomain
  cat(paste0(bd, '  >>  ', 
             length(gl), ' leading edge genes  >>  ', 
             length(intersect(gl, V(undir_node_edge) %>% names())),' nodes in filt graph\n'))
  
  # specify biodom file name and create directory
  bd_filename <- bd %>% str_replace_all(.,' ','_')
  if(!dir.exists( here::here('results','biodomain',bd_filename) )){ 
    dir.create( here::here('results','biodomain',bd_filename) ) }
  
  # write query list to file
  write_tsv(tibble(x = gl), 
            paste0(here::here('results','biodomain',bd_filename), 
                   '/queryList_', bd_filename, '.tsv'), 
            col_names = F)
}

```

_dijkstra## Sub-domain NW

```{r}

# create directory
if(!dir.exists( here::here('results','subdomain_dijkstra') )){ 
      dir.create( here::here('results','subdomain_dijkstra') ) }

# signif domains with sub-domains
doms <- enr.bd %>% filter(padj < 0.01, NES > 1.66, subdomain_idx > 0) %>% 
  pull(Biodomain) %>% unique() %>% sort()

for( bd in doms ){
  
  # full domain gene list
  gl1 <- enr.bd %>% 
    filter(
      Biodomain == bd,
      padj < 0.01,
      NES > 1.66
    ) %>% 
    pull(leadingEdge_genes) %>% 
    unlist() %>% 
    unique()
  

  cat('\n\nfull domain: \n', 
      paste0(bd, '  >>  ', 
             length(gl1), ' leading edge genes  >>  ', 
             length(intersect(gl1, V(undir_node_edge) %>% names())),' nodes in filt graph\n'))
  
  # list sub-domains with signif terms
  sds <- enr.bd %>% 
    filter(Biodomain == bd, padj < 0.01, NES > 1.66, subdomain_idx > 0) %>% 
    pull(Subdomain) %>% unique() %>% sort()
  
  for( sd in sds ){
    
    # pull gene list from leading edge genes
    gl <- enr.bd %>% 
      filter(
        Biodomain == bd, 
        Subdomain == sd,
        padj < 0.01,
        NES > 1.66
      ) %>% 
      pull(leadingEdge_genes) %>% 
      unlist() %>% 
      unique()
    
    cat(paste0(sd, '  >>  ', 
              length(gl), ' leading edge genes  >>  ', 
              length(intersect(gl, V(undir_node_edge) %>% names())),' nodes in filt graph\n'))
    
    if(length(gl) == 0){next}
    
    # specify biodom file name and create directory
    bd_filename <- bd %>% str_replace_all(.,' ','_')
    if(!dir.exists( here::here('results','subdomain_dijkstra',bd_filename) )){ 
      dir.create( here::here('results','subdomain_dijkstra',bd_filename) ) }
    
    sd_filename <- sd %>% str_replace_all(.,' ','_')
    if(!dir.exists( here::here('results','subdomain_dijkstra',bd_filename, sd_filename) )){ 
      dir.create( here::here('results','subdomain_dijkstra',bd_filename, sd_filename) ) }

    # write query list to file
    write_tsv(tibble(x = gl),
              here::here('results','subdomain_dijkstra',bd_filename, sd_filename, paste0('queryList_', sd_filename, '.tsv')),
              col_names = F)
    
  }
  
}
```


## Pseudotime NW

```{r}
# synapser::synLogin()
# 
# # ROSMAP txomic PT
# rna.f.de <- read_csv( synapser::synGet('syn39989123')$path, col_types = cols() ) %>% rename(gene = gene_names)
# rna.f.enr <- read_tsv( synapser::synGet('syn47728345')$path, col_types = cols() )
# rna.m.de <- read_csv( synapser::synGet('syn39990047')$path, col_types = cols() ) %>% rename(gene = gene_names)
# rna.m.enr <- read_tsv( synapser::synGet('syn47728065')$path, col_types = cols() )
# 
# # ROSMAP proteomic PT
# prot.f.de <- read_csv( synapser::synGet('syn40616521')$path, col_types = cols() ) %>% rename(gene = gene_short_name)
# prot.f.enr <- read_csv( synapser::synGet('syn50881293')$path, col_types = cols() )
# prot.m.de <- read_csv( synapser::synGet('syn40621972')$path, col_types = cols() ) %>% rename(gene = gene_short_name)
# prot.m.enr <- read_csv( synapser::synGet('syn50881295')$path, col_types = cols() )
# 
# # pull gene list from leading edge genes
# input.gene.list <- 
#   bind_rows( prot.f.de %>% mutate(s = 'f'), 
#              prot.m.de %>% mutate(s = 'm')
#     ) %>% 
#   pivot_wider(id_cols = c(gene_names, gene, state), 
#               values_from = c(pvalue, effect), 
#               names_from = s) %>% 
#   mutate(
#     pvalue_f = if_else( !is.finite(pvalue_f), 0, pvalue_f ),
#     pvalue_f = if_else( pvalue_f == 0 , min(pvalue_f[pvalue_f>0], na.rm =T), pvalue_f),
#     pvalue_m = if_else( !is.finite(pvalue_m), 0, pvalue_m ),
#     pvalue_m = if_else( pvalue_m == 0 , min(pvalue_m[pvalue_m>0], na.rm =T), pvalue_m)
#   ) %>% 
#   rowwise() %>% 
#   mutate(
#     sig = case_when( 
#       (pvalue_f <= 0.01 & pvalue_m > 0.01) ~ 'f_only',
#       (pvalue_m <= 0.01 & pvalue_f > 0.01) ~ 'm_only',
#       (pvalue_f > 0.01 & pvalue_m > 0.01) ~ 'neither',
#       (pvalue_f <= 0.01 & pvalue_m <= 0.01) ~ 'both'),
#     mn = mean(-log10(pvalue_f), -log10(pvalue_m), na.rm = T)
#   ) %>%
#   mutate( state = case_when(
#     state %in% c(2,3,4) ~ 'early', 
#     state %in% c(5,6) ~ 'mid',
#     state %in% c(7) ~ 'late',
#     T ~ as.character(state)) ) 
#   
# 
# for( s in unique(input.gene.list$state) ){
#   input.gene.list %>% 
#     filter(state == s
#            , sig == 'both'
#            , sign(effect_f) == sign(effect_m) ) %>% 
#     select(gene) %>% 
#     distinct() %>% 
#     write_tsv(., paste0('results/pseudotime/',s,'/queryList_',s,'.tsv'), col_names = F)
# }
```


## Co-expression Modules
```{r}
# 
# system('wget -q --output-document=tmt_modules_supplement.xlsx https://www.biorxiv.org/content/biorxiv/early/2021/08/13/2021.04.05.438450/DC2/embed/media-2.xlsx ')
# tmt.modules <- readxl::read_xlsx('tmt_modules_supplement.xlsx', sheet = 4, skip = 2)
# tmt.modules <- tmt.modules %>%
#   mutate(prot = str_split_fixed(UniqueID, '\\|',2)[,1],
#          mod = str_split_fixed(kMEtableSortVector, '\\|',2)[,1]) %>% 
#   relocate(prot, mod, .after = UniqueID)
# 
# gl = tmt.modules %>% filter(grepl('M42', mod)) %>% pull(prot) %>% unique()
# write_tsv(tibble(x = gl), 'results/modules/m42/queryList_M42.tsv', col_names = F)

```

# Session
```{r}
sessionInfo()
```

