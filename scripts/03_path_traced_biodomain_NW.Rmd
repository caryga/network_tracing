---
title: "Biodomain NW & Key Drivers"
author: "Greg Cary"
date: "`r Sys.Date()`"
output: 
  html_document: 
    fig_width: 5
    fig_height: 4
  html_notebook:
    code_folding: hide
    theme: readable
    css: style.css
    toc: true
    toc_float: true
---
# Setup

## packages  
```{r setup}
# # Package names
# packages <- c(
#   # 'paxtoolsr','org.Hs.eg.db','HotNetvieweR','clusterProfiler', 
#   'synapser','igraph','tidygraph','ggraph','tidyverse'
#   )
# 
# # Load packages
# invisible(lapply(packages, library, character.only = TRUE))

library(synapser)
library(igraph)
library(tidygraph)
library(ggraph)
library(tidyverse)

source('../../treatAD_biodomains/scripts/biodom_tally.R')
source('../../treatAD_biodomains/scripts/annotate_enr_term_biodomains.R')
source('../../treatAD_biodomains/scripts/biodom_enr_plots.R')

theme_set(theme_bw())
```

## functions

<!-- read nw data (synapse)   -->
<!-- ```{r} -->
<!-- read_nw <- function(dom_idx){ -->

<!--   nw = read.graph( -->
<!--     synGet( -->
<!--       doms$nw.dir[[dom_idx]] %>% filter( grepl('bdFiltered.+graphml', name) ) %>% pull(id) -->
<!--     )$path, -->
<!--     format = 'graphml' -->
<!--     ) -->

<!--   return(nw) -->

<!-- } -->

<!-- # read_nw <- function(dom_idx){ -->
<!-- #   nw = read.graph( -->
<!-- #     paste0(here::here(), '/results/biodomain/', doms[dom_idx], '/', -->
<!-- #            nw.dirs$f[[match(doms[dom_idx], nw.dirs$bd)]] %>% -->
<!-- #              str_subset(., 'bdFiltered') %>% str_subset('graphml')), -->
<!-- #     format = 'graphml') -->
<!-- #  -->
<!-- #   return(nw) -->
<!-- # } -->
<!-- ``` -->
 
read synapse directories into a dataframe
```{r}
read_syn_dir <- function(parent_id){
  synapser::synGetChildren(parent_id)$asList() %>%
    tibble(f = .) %>% unnest_wider(f)
}
```
 
NW info 
```{r}
v_info <- function(net){
  v.attr <- tibble( na = vertex.attributes(net) ) %>% t() %>% 
    as_tibble(rownames = NA, .name_repair = ~vertex_attr_names(net) ) %>% 
    unnest(everything()) 
}

e_info <- function(net){
  e.attr <- tibble( ea = edge.attributes(net) ) %>% t() %>% 
    as_tibble(rownames = NA, .name_repair = ~edge_attr_names(net) ) %>% 
    unnest(everything()) 
}
```

read KDA result data  
```{r}
# remote from synase
read_kd_remote <- function(kda_dir_syn_id){
  
  synDir <- synGetChildren(kda_dir_syn_id)$asList() %>%
  tibble(f = .) %>% unnest_wider(f)
  
  
  kd.ef0 <- read_tsv(
    synGet( 
      synDir %>% filter( grepl('edgeFactor_0.results.txt', name) ) %>% pull(id)
      )$path, 
    col_types = cols())
  kd.ef1 <- read_tsv(
    synGet( 
      synDir %>% filter( grepl('edgeFactor_1.results.txt', name) ) %>% pull(id)
      )$path, 
    col_types = cols())
  kd.top <- read_tsv(
    synGet( 
      synDir %>% filter( grepl('edgeFactor_1.tophits.txt', name) ) %>% pull(id)
      )$path, 
    col_types = cols()) %>% 
    mutate(kd = paste0(NODE,'-',MODULE))
    
  kd = bind_rows(
    kd.ef0 %>% mutate(ef = 'ef0_fdr'),
    kd.ef1 %>% mutate(ef = 'ef1_fdr')
    ) %>% 
    mutate(FDR = -log10(FDR)) %>%
    pivot_wider(id_cols = c(MODULE, NODE, MEMBER), 
                names_from = ef, values_from = FDR, values_fill = 0) %>%
    mutate(delta_fdr = ef1_fdr - ef0_fdr) %>% arrange(desc(delta_fdr)) %>% 
    mutate(top = 0)
  
  if( any( kd.top$FDR < 0.05 ) ){
    kd$top[ which(paste0(kd$NODE,'-',kd$MODULE) %in% kd.top$kd[kd.top$FDR < 0.05]) ] <- 1
  }
  
  return(kd)
}

# local directory
read_kd_local <- function(local_path){
  
  kd.pth <- list.files(local_path, full.names = T)
  
  kd.ef0 <- read_tsv(
    kd.pth %>% str_subset('edgeFactor_0.results.txt'), 
    col_types = cols())
  kd.ef1 <- read_tsv(
    kd.pth %>% str_subset('edgeFactor_1.results.txt'),  
    col_types = cols())
  kd.top <- read_tsv(
    kd.pth %>% str_subset('edgeFactor_1.tophits.txt'), 
    col_types = cols()) %>% 
    mutate(kd = paste0(NODE,'-',MODULE))
    
  kd = bind_rows(
    kd.ef0 %>% mutate(ef = 'ef0_fdr'),
    kd.ef1 %>% mutate(ef = 'ef1_fdr')
    ) %>% 
    mutate(FDR = -log10(FDR)) %>%
    pivot_wider(id_cols = c(MODULE, NODE, MEMBER), 
                names_from = ef, values_from = FDR, values_fill = 0) %>%
    mutate(delta_fdr = ef1_fdr - ef0_fdr) %>% arrange(desc(delta_fdr)) %>% 
    mutate(top = 0)
  
  if( any( kd.top$FDR < 0.05 ) ){
    kd$top[ which(paste0(kd$NODE,'-',kd$MODULE) %in% kd.top$kd[kd.top$FDR < 0.05]) ] <- 1
  }
  
  return(kd)
}

```

plot subnetwork around identified KDs  
```{r}
plot_kd_subnet <- function(nw, kd, term) {
  
  vert_num <- match(kd, V(nw)$name)
  
  vert_neigh <- neighbors(nw, vert_num)
  
  term_num <- biodom %>%
    filter(GOterm_Name == term) %>%
    pull(symbol) %>% unlist() %>%
    match(., V(nw)$name) %>% .[!is.na(.)]
  
  g2 <- induced_subgraph(nw, c(vert_num, intersect(term_num, vert_neigh)))
  g3 <- induced_subgraph(nw, c(vert_num, term_num))
  
  cowplot::plot_grid(
    
    ggraph(g3, layout = 'linear', circular = TRUE) +
      geom_edge_arc(alpha = .3, color = 'grey75') +
      geom_node_point( shape = 21, color = "black", alpha = .3,
        aes(size = TargetRiskScore, fill = Pro_EffectScore, filter= .N()$name != kd)  )+
      geom_node_point( shape = 23, color = "black", alpha = .3,
        aes(size = TargetRiskScore, fill = Pro_EffectScore, filter = .N()$name == kd) )+
      geom_node_text(aes(label = name), size = 2) +
      coord_fixed() +
      scale_size_continuous( range = c(.5, 10), limits = c(0, 5), trans = 'exp')+
      scale_fill_gradient2(
        low = 'purple', mid = 'grey20', high = 'green', na.value = 'grey85',
        limits = c(-2.5,2.5) )+ #approx: range(omics$Pro_TE, na.rm = T)
      labs( title = 'All term genes in NW',
            subtitle = paste0('KD: ', kd, '\nTerm: ', term) )+
      theme_graph(background = 'white')
    ,
    ggraph(g2, layout = 'linear', circular = TRUE) +
            geom_edge_arc(alpha = .3, color = 'grey75') +
      geom_node_point( shape = 21, color = "black", alpha = .3,
        aes(size = TargetRiskScore, fill = Pro_EffectScore, filter= .N()$name != kd)  )+
      geom_node_point( shape = 23, color = "black", alpha = .3,
        aes(size = TargetRiskScore, fill = Pro_EffectScore, filter = .N()$name == kd) )+
      geom_node_text(aes(label = name), size = 2) +
      coord_fixed() +
      scale_size_continuous( range = c(.5, 10), limits = c(0, 5), trans = 'exp')+
      scale_fill_gradient2(
        low = 'purple', mid = 'grey20', high = 'green', na.value = 'grey85',
        limits = c(-2.5,2.5) )+ #approx: range(omics$Pro_TE, na.rm = T)
      labs( title = 'Term genes & KD neighbors in NW',
            subtitle = paste0('KD: ', kd, '\nTerm: ', term) )+
      theme_graph(background = 'white')
    ,
    ncol = 2
    
  )
}
```


## TREAT-AD data
Grab relevant data from synapse, including:
1) Target Risk Scores ([syn25575156](https://www.synapse.org/#!Synapse:syn25575156){target="_blank"}) and Omics Scores ([syn22758536](https://www.synapse.org/#!Synapse:syn22758536){target="_blank"})  
2) Biodomain Definitions ([syn25428992](https://www.synapse.org/#!Synapse:syn25428992){target="_blank"})  
2) Risk-enriched Biodomain Terms ([syn45824995](https://www.synapse.org/#!Synapse:syn45824995){target="_blank"})
3) Base Network ([syn51110930](https://www.synapse.org/#!Synapse:syn51110930){target="_blank"})  
4) Synapse IDs of path-traced NW objects  
5) Synapse IDs of wKDA results 
6) CRISPRbrain simple phenotype screen data  

```{r}
synLogin()

# target risk scores
scores <- read_csv(
  synTableQuery('select * from syn25575156', includeRowIdAndRowVersion = F)$filepath
  , col_types = cols())
omics <- read_csv(
  synTableQuery('select * from syn22758536', includeRowIdAndRowVersion = F)$filepath
  , col_types = cols())
npath <- read_csv(
  synTableQuery('select * from syn32288310', includeRowIdAndRowVersion = F)$filepath
  , col_types = cols())

agora <- read_csv(synGet('syn12540368')$path, quote = '"')

# biological domain annotations
biodom <- full_join(
  # biodomains
  readRDS(synGet('syn25428992')$path),
  # domain labels
  read_csv(synGet('syn26856828')$path, col_types = cols()),
  by = c('Biodomain'='domain')
) %>%
  mutate(Biodomain = case_when(Biodomain == 'none' ~ NA_character_, T ~ Biodomain))

domains = biodom %>% pull(Biodomain) %>% unique() %>% sort()

# enriched biodomain terms
enr.bd <- read_csv( synGet('syn45824995')$path, col_types = cols() ) %>% 
  mutate(leadingEdge_genes = str_split(leadingEdge_genes, '\\|'))

# base network
base_net <- igraph::read_graph(synGet('syn51110930')$path, format = 'graphml') 

# filt node & edge
tmp <- igraph::delete_vertices(
  base_net,
  igraph::V(base_net)[ igraph::V(base_net)$brain_exp == 0 ]
)
undir_node_edge <- igraph::subgraph.edges(
  tmp,
  igraph::E(tmp)[ igraph::E(tmp)$n_edge_evidence > 1 ],
  delete.vertices = T 
)

# specify directed edge types
directed_edge_types = c("catalysis-precedes",
                        "controls-expression-of",
                        "controls-phosphorylation-of",
                        "controls-state-change-of",
                        "controls-transport-of"
                        )
```


## NW & KDA data
read results from synapse  
```{r}
synLogin()

doms  <-  read_syn_dir('syn51739831') %>%  # biodomain
  filter(grepl('Folder', type)) %>% 
  select(bd = name, id) %>% 
  rowwise() %>% 
  mutate(
    nw.dir = synGetChildren(  parent = id  )$asList() %>% 
      tibble(f = .) %>% unnest_wider(f) %>% list(),
    kd.dir = synGetChildren(  parent = nw.dir$id[grepl('kda',nw.dir$name)]  )$asList() %>% 
      tibble(f = .) %>% unnest_wider(f) %>% list()
    )
```
# Biodom NW analysis

## Calculate NW stats

```{r}
nw.dat = doms %>% 
  ungroup() %>% 
  mutate(i = 1:nrow(doms)) %>% 
  select(bd:i) 

future::plan('multisession')
x = furrr::future_map_dfr(
  nw.dat$i,
  ~{synLogin()
    nw = doms$nw.dir[[.x]] %>% 
      filter( grepl('bdFiltered.+graphml', name) ) %>% 
      pull(id) %>% synGet(.) %>% .$path %>% 
      read_graph(., format = 'graphml')
    snw = igraph::simplify(nw, remove.multiple = T)
    tibble(
      avg_node_degree = degree(snw, V(snw)) %>% mean(),
      avg_path_length = snw %>% average.path.length,
      assortativity_coef = snw %>% assortativity(., types1 = V(.)),
      connected_components = snw %>% no.clusters,
      edge_t = e_info(nw) %>% list(),
      node_t = v_info(nw) %>% list(),
    )
  }
)
future::plan('sequential')

nw.dat = bind_cols(nw.dat, x); rm(x)

nw.dat$q_genes <- map(
  1:nrow(nw.dat),
  ~ doms$nw.dir[[.x]] %>% filter( grepl('queryList', name) ) %>% 
    pull(id) %>% synGet(.) %>% .$path %>% 
    read_tsv(., col_names = F, col_types = cols()) %>% 
    pull(X1) 
)

nw.dat$input = map(
  1:nrow(nw.dat),
  ~ nw.dat$node_t[[.x]] %>% filter(node_status == 'query') %>% pull(name) %>% unique() %>% list()
)

nw.dat$added = map(
  1:nrow(nw.dat),
  ~ nw.dat$node_t[[.x]] %>% filter(node_status == 'added') %>% pull(name) %>% unique() %>% list()
)

nw.dat$nodes = map(
  1:nrow(nw.dat),
  ~ nw.dat$node_t[[.x]] %>% pull(name) %>% unique() %>% list()
)

nw.dat$edges = map(
  1:nrow(nw.dat),
  ~ nw.dat$edge_t[[.x]] %>% pull(edge) %>% unique() %>% list()
)
```

## NW size
```{r}
nw.summary <- nw.dat %>% 
  group_by(bd) %>% rowwise() %>% 
  summarise(
    q_genes = length(unique(unlist(q_genes))),
    input = length(unique(unlist(input))),
    added = length(unique(unlist(added))),
    nodes = length(unique(unlist(nodes))),
    edges = length(unique(unlist(edges))),
  ) %>% 
  mutate(
    total_possible_edge = (nodes * (nodes-1))/2,
    fxn_possible_edge = edges/total_possible_edge,
    fxn_added = added/nodes,
  )
```

```{r fig.width=8, fig.height=4}
nw.summary %>% 
  mutate(bd = str_replace_all(bd, '_' ,' ')) %>% 
  left_join(., biodom %>% select(bd = Biodomain, color, abbr ) %>% distinct() ) %>% 
  pivot_longer(cols = c(nodes, edges)) %>% 
  mutate( 
    max = case_when(
      name == 'nodes' ~ V(undir_node_edge) %>% length(),
      name == 'edges' ~ E(undir_node_edge) %>% length(),
      name == 'fxn_possible_edge' ~ integer(1)),
    name = fct_relevel(name, c('nodes','edges'))
    ) %>% 
  ggplot(aes(input, value))+
  geom_smooth(method = 'lm', color = 'grey60', fill = 'grey85', 
              lwd = .5, lty = 2)+
  geom_point(aes(fill = color), size = 3, alpha = .5, shape = 21)+
  ggrepel::geom_text_repel(aes(label = abbr), size = 2.5)+
  geom_hline(aes(yintercept = max), lty = 2)+
  scale_y_log10()+
  scale_x_log10()+
  scale_fill_identity()+
  labs(x = '# input genes\nquery genes overlap with filtered base graph nodes', 
       y = '# graph features')+
  # geom_smooth()+
  facet_wrap(~name, scales = 'free')
```

## NW properties ~ Biodomains
Global properties of biodomain-filtered path traced networks
```{r fig.width=12, fig.height=4}
full_join( nw.dat %>% select(-nodes, -edges, -q_genes, -input, -added) , 
           nw.summary %>% select(-q_genes), by = 'bd' ) %>% 
  mutate(bd = str_replace_all(bd, '_' ,' ')) %>% 
  left_join(., biodom %>% select(bd = Biodomain, color, abbr ) %>% distinct() ) %>% 
  pivot_longer(cols = c(avg_node_degree:fxn_added), names_to = 'properties', values_to = 'val') %>% 
  mutate(properties = factor(properties,
                             levels = c('input',
                                        'nodes',
                                        'added',
                                        'fxn_added',
                                        
                                        'edges',
                                        'fxn_possible_edge',
                                        
                                        'connected_components',
                                        'avg_node_degree',
                                        'assortativity_coef',
                                        'avg_path_length'
                                        )),
         bd = factor(bd, levels = nw.summary %>% arrange(input) %>% pull(bd) %>% str_replace_all(., '_' ,' ') )
         ) %>% 
  filter(properties %in% c('input', 'nodes', 'added', 'edges', 
                           'connected_components','avg_node_degree','avg_path_length')) %>% 
  ggplot(aes(val, bd)) +
  geom_bar(stat = 'identity', position = 'dodge', aes(fill = color), 
           alpha = .8, color = 'grey30', width = .7)+
  theme(legend.position = 'top', 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+
  labs(y = '',x = '')+
  scale_fill_identity()+
  # scale_y_log10()+
  facet_wrap(~properties, scales = 'free_x', nrow = 1)

```

```{r fig.width=4, fig.height=5}
tmp <- full_join( nw.dat %>% select(-nodes, -edges, -q_genes, -input, -added) , 
           nw.summary %>% select(-q_genes), by = 'bd' ) %>% 
  mutate(bd = str_replace_all(bd, '_' ,' ')) %>% 
  left_join(., biodom %>% select(bd = Biodomain, color, abbr ) %>% distinct(), by = 'bd' ) %>% 
  select(bd, input, added, nodes, color:abbr ) %>%
  mutate( input1 = input ) %>% 
  pivot_longer( cols = c(added, input), names_to = 'properties', values_to = 'val' ) %>% 
  mutate( properties = factor(properties, levels = c('added', 'input')),
          bd = fct_reorder(bd, nodes) ) 

ggplot(tmp, aes(val, bd, group = properties)) +
  geom_bar(stat = 'identity', 
           aes(fill = color, alpha = properties), #scales = 'free_x',alpha = .8, 
           color = 'grey30', width = .7)+
  theme(legend.position = 'top', 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+
  labs(y = '',x = '# nodes')+
  scale_fill_identity()+
  # scale_x_log10()+
  scale_alpha_discrete('',range = c(.8,.3), limits = rev)
```

## Overlapping NW elements
### Inputs
Query genes
```{r fig.width=7, fig.height=6}

olap <- crossing(nw1 = nw.dat$bd, nw2 = nw.dat$bd) %>% 
  group_by(nw1,nw2) %>% 
  mutate(.keep = 'all', 
         intersect = length(intersect(
           nw.dat %>% filter(bd == nw1) %>% pull(q_genes) %>% unlist(),
           nw.dat %>% filter(bd == nw2) %>% pull(q_genes) %>% unlist()
           ))
         ) %>% 
  ungroup() %>% group_by(nw1) %>% 
  mutate(.keep = 'all', pct_overlap = intersect / intersect[which(nw2 == nw1)]) %>% 
  ungroup() %>%
  mutate(
    nw1 = fct_relevel(
      nw1, 
      nw.dat %>% select(bd, q_genes) %>% distinct() %>% 
        mutate(len = length(unlist(q_genes))) %>% arrange(len) %>% pull(bd)
                      ),
    nw2 = fct_relevel(
      nw2, 
      nw.dat %>% select(bd, q_genes) %>% distinct() %>% 
        mutate(len = length(unlist(q_genes))) %>% arrange(desc(len)) %>% pull(bd)
                      )
  ) 

ggplot(olap, aes(x = nw2, y = nw1)) +
  geom_tile(aes(fill=pct_overlap), alpha = .8) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  # theme(axis.text.x = element_blank(), legend.position = 'bottom') +
  # scale_fill_gradient2('% Total', low = 'white', high = '4a66ac', na.value = 'grey90') +
  viridis::scale_fill_viridis("% Total", option = "A", direction = -1)+
  # scale_x_discrete(position = "top") +
  geom_text(aes(label = intersect ), color = 'grey66', size = 2) +
  labs(x='',y='', title = 'Query Genes') 

```

input genes (overlap with base net)
```{r fig.width=4, fig.height=3.5}

olap <- crossing(nw1 = nw.dat$bd, nw2 = nw.dat$bd) %>% 
    group_by(nw1,nw2) %>% 
    mutate(.keep = 'all', 
           intersect = length(intersect(
             nw.dat %>% filter(bd == nw1) %>% pull(input) %>% unlist(),
             nw.dat %>% filter(bd == nw2) %>% pull(input) %>% unlist()
             )),
             len_nw1 = nw.dat %>% filter(bd == nw1) %>% pull(input) %>% unlist() %>% length(),
             len_nw2 = nw.dat %>% filter(bd == nw2) %>% pull(input) %>% unlist() %>% length()
           ) %>% 
    ungroup() %>% group_by(nw1) %>% 
    mutate(.keep = 'all', pct_overlap = 100*(intersect / intersect[which(nw2 == nw1)])) %>% 
    ungroup()

olap <- olap %>% 
    mutate(
      nw1 = fct_relevel(nw1, olap %>% select(nw1, len_nw1) %>% distinct() %>% arrange(len_nw1) %>% pull(nw1)),
      nw2 = fct_relevel(nw2, olap %>% select(nw1, len_nw1) %>% distinct() %>% arrange(desc(len_nw1)) %>% pull(nw1))
    ) 

olap %>% 
  ggplot(., aes(x = nw2, y = nw1)) +
  geom_tile(aes(fill=pct_overlap), alpha = .8) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  # theme(axis.text.x = element_blank(), legend.position = 'bottom') +
  # scale_fill_gradient2('% Total', low = 'white', high = '4a66ac', na.value = 'grey90') +
  viridis::scale_fill_viridis("% Total", option = "A", direction = -1)+
  # scale_x_discrete(position = "top") +
  geom_text(aes(label = intersect ), color = 'lightblue', size = 2) +
  labs(x='',y='', title = 'input genes', subtitle = 'query overlap with filtered base network nodes') 

```

### Nodes
undirected
```{r fig.width=7, fig.height=6}
olap <- crossing(nw1 = nw.dat$bd, nw2 = nw.dat$bd) %>% 
    group_by(nw1,nw2) %>% 
    mutate(.keep = 'all', 
           intersect = length(intersect(
             nw.dat %>% filter(bd == nw1) %>% pull(nodes) %>% unlist(),
             nw.dat %>% filter(bd == nw2) %>% pull(nodes) %>% unlist()
             )),
             len_nw1 = nw.dat %>% filter(bd == nw1) %>% pull(nodes) %>% unlist() %>% length(),
             len_nw2 = nw.dat %>% filter(bd == nw2) %>% pull(nodes) %>% unlist() %>% length()
           ) %>% 
    ungroup() %>% group_by(nw1) %>% 
    mutate(.keep = 'all', pct_overlap = intersect / intersect[which(nw2 == nw1)]) %>% 
    ungroup()

olap <- olap %>% 
    mutate(
      nw1 = fct_relevel(nw1, olap %>% select(nw1, len_nw1) %>% distinct() %>% arrange(len_nw1) %>% pull(nw1)),
      nw2 = fct_relevel(nw2, olap %>% select(nw1, len_nw1) %>% distinct() %>% arrange(desc(len_nw1)) %>% pull(nw1))
    ) 

olap %>% 
  ggplot(., aes(x = nw2, y = nw1)) +
  geom_tile(aes(fill=pct_overlap), alpha = .8) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  # theme(axis.text.x = element_blank(), legend.position = 'bottom') +
  # scale_fill_gradient2('% Total', low = 'white', high = '4a66ac', na.value = 'grey90') +
  viridis::scale_fill_viridis("% Total", option = "A", direction = -1)+
  # scale_x_discrete(position = "top") +
  geom_text(aes(label = intersect ), color = 'grey66', size = 2) +
  labs(x='',y='', title = 'common nodes') 

```

### Added Nodes
```{r fig.width=7, fig.height=6}
olap <- crossing(nw1 = nw.dat$bd, nw2 = nw.dat$bd) %>% 
    group_by(nw1,nw2) %>% 
    mutate(.keep = 'all', 
           intersect = length(intersect(
             setdiff(
               nw.dat %>% filter(bd == nw1) %>% pull(nodes) %>% unlist(),
               nw.dat %>% filter(bd == nw1) %>% pull(q_genes) %>% unlist()),
             setdiff(               
               nw.dat %>% filter(bd == nw2) %>% pull(nodes) %>% unlist(),
               nw.dat %>% filter(bd == nw2) %>% pull(q_genes) %>% unlist())
             )),
             len_nw1 = setdiff(
               nw.dat %>% filter(bd == nw1) %>% pull(nodes) %>% unlist(),
               nw.dat %>% filter(bd == nw1) %>% pull(q_genes) %>% unlist()) %>% length(),
             len_nw2 = setdiff(
               nw.dat %>% filter(bd == nw2) %>% pull(nodes) %>% unlist(),
               nw.dat %>% filter(bd == nw2) %>% pull(q_genes) %>% unlist()) %>% length()
           ) %>% 
    ungroup() %>% group_by(nw1) %>% 
    mutate(.keep = 'all', pct_overlap = intersect / intersect[which(nw2 == nw1)]) %>% 
    ungroup()

olap <- olap %>% 
    mutate(
      nw1 = fct_relevel(nw1, olap %>% select(nw1, len_nw1) %>% distinct() %>% arrange(len_nw1) %>% pull(nw1)),
      nw2 = fct_relevel(nw2, olap %>% select(nw1, len_nw1) %>% distinct() %>% arrange(desc(len_nw1)) %>% pull(nw1))
    ) 

olap %>% 
  ggplot(., aes(x = nw2, y = nw1)) +
  geom_tile(aes(fill=pct_overlap), alpha = .8) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  # theme(axis.text.x = element_blank(), legend.position = 'bottom') +
  # scale_fill_gradient2('% Total', low = 'white', high = '4a66ac', na.value = 'grey90') +
  viridis::scale_fill_viridis("% Total", option = "A", direction = -1)+
  # scale_x_discrete(position = "top") +
  geom_text(aes(label = intersect ), color = 'grey66', size = 2) +
  labs(x='',y='', title = 'added nodes') 

```


### Edges
common edges
```{r fig.width=7, fig.height=6}

olap <- crossing(nw1 = nw.dat$bd, nw2 = nw.dat$bd) %>% 
    group_by(nw1,nw2) %>% 
    mutate(.keep = 'all', 
           intersect = length(intersect(
             nw.dat %>% filter(bd == nw1) %>% pull(edges) %>% unlist(),
             nw.dat %>% filter(bd == nw2) %>% pull(edges) %>% unlist()
             )),
             len_nw1 = nw.dat %>% filter(bd == nw1) %>% pull(edges) %>% unlist() %>% length(),
             len_nw2 = nw.dat %>% filter(bd == nw2) %>% pull(edges) %>% unlist() %>% length()
           ) %>% 
    ungroup() %>% group_by(nw1) %>% 
    mutate(.keep = 'all', pct_overlap = intersect / intersect[which(nw2 == nw1)]) %>% 
    ungroup()

olap <- olap %>% 
    mutate(
      nw1 = fct_relevel(nw1, olap %>% select(nw1, len_nw1) %>% distinct() %>% arrange(len_nw1) %>% pull(nw1)),
      nw2 = fct_relevel(nw2, olap %>% select(nw1, len_nw1) %>% distinct() %>% arrange(desc(len_nw1)) %>% pull(nw1))
    ) 

olap %>% 
  ggplot(., aes(x = nw2, y = nw1)) +
  geom_tile(aes(fill=pct_overlap), alpha = .8) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  # theme(axis.text.x = element_blank(), legend.position = 'bottom') +
  # scale_fill_gradient2('% Total', low = 'white', high = '4a66ac', na.value = 'grey90') +
  viridis::scale_fill_viridis("% Total", option = "A", direction = -1)+
  # scale_x_discrete(position = "top") +
  geom_text(aes(label = intersect ), color = 'grey66', size = 1.5) +
  labs(x='',y='', title = 'common edges') 

```

### input, added, total nodes in common

```{r}
olap <- crossing(nw1 = nw.dat$bd, nw2 = nw.dat$bd) %>% 
  group_by(nw1,nw2) %>% 
  mutate(.keep = 'all', 
         
         input = length(intersect(
           nw.dat %>% filter(bd == nw1) %>% pull(input) %>% unlist(),
           nw.dat %>% filter(bd == nw2) %>% pull(input) %>% unlist() 
           )),
         
         added = length(intersect(
           nw.dat %>% filter(bd == nw1) %>% pull(added) %>% unlist(),
           nw.dat %>% filter(bd == nw2) %>% pull(added) %>% unlist()
             )),
         
         total = length(intersect(
             nw.dat %>% filter(bd == nw1) %>% pull(nodes) %>% unlist(),
             nw.dat %>% filter(bd == nw2) %>% pull(nodes) %>% unlist()
             )),
         
         len_nw1 = nw.dat %>% filter(bd == nw1) %>% pull(nodes) %>% unlist() %>% unique() %>% length(),
         len_nw2 = nw.dat %>% filter(bd == nw2) %>% pull(nodes) %>% unlist() %>% unique() %>% length()
         
         ) %>% 
  ungroup() %>% group_by(nw1) %>% 
  mutate(.keep = 'all', 
         input_overlap = input / input[which(nw2 == nw1)],
         added_overlap = added / added[which(nw2 == nw1)],
         total_overlap = total / total[which(nw2 == nw1)],
         ) %>% 
  ungroup() 

olap <- olap %>% 
  pivot_longer(input:total, names_to = 'set', values_to = 'n') %>% 
  # pivot_longer(ends_with('_overlap')) %>% distinct() %>% 
  mutate(
    set = fct_relevel(set, c('total','input','added')), 
    pct = 100*(n / len_nw1),
    nw1 = fct_relevel(nw1, olap %>% select(nw1, len_nw1) %>% distinct() %>% arrange(len_nw1) %>% pull(nw1)),
    nw2 = fct_relevel(nw2, olap %>% select(nw1, len_nw1) %>% distinct() %>% arrange(desc(len_nw1)) %>% pull(nw1))
    ) 
```


```{r fig.width=9, fig.height=3}

olap %>% 
  ggplot(., aes(x = nw2, y = nw1)) +
  geom_tile(aes(fill=pct), alpha = .8) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  # theme(axis.text.x = element_blank(), legend.position = 'bottom') +
  # scale_fill_gradient2('% Total', low = 'white', high = '4a66ac', na.value = 'grey90') +
  viridis::scale_fill_viridis("% Total Nodes", option = "A", direction = -1)+
  # scale_x_discrete(position = "top") +
  geom_text(aes(label = round(pct,2) ), color = 'grey66', size = 2) +
  facet_wrap(~set, nrow = 1)+
  labs(x='',y='') 

```
```{r fig.width=6, fig.height=3}

olap %>%
  filter(set != 'total') %>% 
  ggplot(., aes(x = nw2, y = nw1)) +
  geom_tile(aes(fill=pct), alpha = .8) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  viridis::scale_fill_viridis("% Total Nodes", option = "A", direction = -1)+
  geom_text(aes(label = round(pct,1) ), color = 'lightblue', size = 2) +
  facet_wrap(~set, nrow = 1)+
  labs(x='',y='') 

```

## Query vs Added gene scores  
```{r}
tmp <- nw.dat %>% 
  select(bd, input, added) %>% 
  pivot_longer(cols = c(input, added)) %>% 
  unnest(value) %>% unnest(value) %>% 
  left_join(
    .,
    scores %>% select(value = GeneName, Overall, 
                      GeneticsScore, OmicsScore, LiteratureScore),
    by = 'value', na_matches = 'never'
  ) %>% 
  bind_rows(
    scores %>% select(value = GeneName, Overall, 
                      GeneticsScore, OmicsScore, LiteratureScore) %>% 
      mutate(name = 'all_scores')
  ) %>% 
  mutate(
    name = factor(name, levels = c('input','added','all_scores'))
  )
```


```{r fig.width=5, fig.height=4}
tmp %>% 
  select(-bd) %>% distinct() %>% 
  rename(set = name, gene = value) %>% 
  group_by(set) %>% 
  mutate(set = paste0(set, '\n(', length(unique(gene)), ' genes)'),
         set = fct_relevel(set, unique(set)[c(2,3,1)])) %>% 
  ggplot(aes(Overall))+
  theme(legend.position = 'top') + 
  geom_density(aes(fill = set, color = set), alpha = .3)
  # geom_histogram(aes(fill = set), alpha = .8, position='dodge')
```

```{r fig.width=6, fig.height=3}
tmp %>% 
  select(-bd) %>% distinct() %>% 
  rename(set = name, gene = value) %>% 
  pivot_longer(Overall:OmicsScore) %>% 
  filter(value >0) %>% 
  ggplot(aes(value))+
  theme(legend.position = 'top') + 
  geom_density(aes(fill = set), color = 'grey70', alpha = .3)+
  # geom_histogram(aes(fill = set),  alpha = .8, position='dodge')+
  labs(x='score')+
  facet_grid(~name, scales = 'free')
```

```{r fig.width=5, fig.height=15}
tmp %>% 
  rename(set = name, gene = value) %>% 
  filter(set!='all_scores') %>% 
  pivot_longer(Overall:OmicsScore) %>% 
  filter(value > 0) %>% 
  mutate(bd = str_replace_all(bd, '_','\n')) %>% 
  ggplot(aes(value))+
  theme(legend.position = 'top') + 
  # geom_density(aes(fill = set, color = set), alpha = .3)+
  geom_histogram(aes(fill = set), alpha = .8, position='dodge')+
  facet_grid(bd~name, scales = 'free')
```

```{r fig.width=12, fig.height=6}
tmp %>% 
  filter( name != 'all_scores' ) %>% 
  rename(set = name, gene = value) %>% 
  mutate(bd = str_replace_all(bd, '_','\n')) %>% 
  ggplot(aes(Overall))+
  theme(legend.position = 'top') + 
  # geom_density(aes(fill = set), color = 'grey70', alpha = .3)+
  geom_histogram(aes(fill = set), alpha = .8, position='dodge')+
  labs(x = 'TREAT-AD Target Risk Score')+
  facet_wrap(~bd, scales = 'free', ncol = 6)
```

## Biodom Enrichment - NW nodes {.tabset}

```{r}
univ <-as.data.frame(org.Hs.eg.db::org.Hs.egGO) %>%
  pull(gene_id) %>%
  unique() %>%
  gprofiler2::gconvert(., organism = 'hsapiens', target = 'HGNC', numeric_ns = 'ENTREZGENE_ACC') %>% 
  as_tibble() %>% 
  pull('name') %>%
  intersect(., names(V(base_net)) )

gl <- nw.dat %>%
  select(bd, nodes, input, added) %>%
  pivot_longer(nodes:added) %>%
  rowwise() %>%
  mutate(
    enr = gprofiler2::gost( query = unlist(unlist(value)),
                            organism = 'hsapiens',
                            # domain_scope = 'custom',
                            # custom_bg = univ,
                            sources = 'GO'
                            ,correction_method = 'bonferroni'
                            ) %>%
      .$result %>%
      list(),
    enr = anno.enr(enr,
                   GO_ID_column = 'term_id',
                   biodomain_table = biodom,
                   domain_colors = biodom %>% select(domain = Biodomain, abbr:color) %>% distinct()) %>%
      list()
  ) %>% select(bd, name, value, enr) %>%
  unnest(enr)
```

```{r warning=FALSE, fig.width=8, fig.height=4}
thresh = 1e-15
  
tmp <- gl %>% filter(name == 'input', Biodomain != 'none') %>% 
  rowwise() %>% 
  mutate(
    nw.label = paste0(bd,'\n', length(unique(unlist(value))), ' input nodes')
  )

nw.ord <- tmp %>% select(nw.label, value) %>% distinct() %>% 
  rowwise() %>% 
  mutate(n = length(unique(unlist(value)))) %>% 
  arrange(desc(n)) %>% pull(nw.label)

bdt <- bd.tally(tmp %>% filter(p_value <= thresh) %>% pull(term_name), biodom)

tmp = tmp %>%
  rowwise() %>% 
  mutate(
    nw.label = factor(nw.label, levels = nw.ord),
    Biodomain = factor(Biodomain, levels = bdt$domain %>% str_subset('none', negate = T) %>% c('none',.)) 
    ) 
  
tmp %>%
  ggplot(aes(-log10(p_value), Biodomain))+
  geom_violin(data = subset(tmp, p_value <= thresh), aes(color = color), scale = 'width')+
  geom_jitter(data = subset(tmp, p_value <= thresh), aes(color = color), alpha = .7)+
  scale_color_identity()+
  # xlim(c(0,30))+
  labs(y = '', title = 'Input Genes', subtitle = paste0('enrichment threshold: ', thresh))+
  facet_wrap(~nw.label, ncol = 9) # , scales = 'free_x'
```

```{r warning=FALSE, fig.width=8, fig.height=4}
thresh = 1e-15

tmp <- gl %>% filter(name == 'nodes', Biodomain != 'none') %>% 
  rowwise() %>% 
  mutate(
    nw.label = paste0(bd,'\n', length(unique(unlist(value))), ' nodes')
  )

nw.ord <- tmp %>% select(nw.label, value) %>% distinct() %>% 
  rowwise() %>% 
  mutate(n = length(unique(unlist(value)))) %>% 
  arrange(desc(n)) %>% pull(nw.label)

bdt <- bd.tally(tmp %>% filter(p_value <= thresh) %>% pull(term_name), biodom)

tmp = tmp %>%
  rowwise() %>% 
  mutate(
    nw.label = factor(nw.label, levels = nw.ord),
    Biodomain = factor(Biodomain, levels = bdt$domain %>% str_subset('none', negate = T) %>% c('none',.)) 
    ) 
  
tmp %>%
  ggplot(aes(-log10(p_value), Biodomain))+
  geom_violin(data = subset(tmp, p_value <= thresh), aes(color = color), scale = 'width')+
  geom_jitter(data = subset(tmp, p_value <= thresh), aes(color = color), alpha = .7)+
  scale_color_identity()+
  # xlim(c(0,30))+
  labs(y = '', title = 'Graph Nodes', subtitle = paste0('enrichment threshold: ', thresh))+
  facet_wrap(~nw.label, ncol = 9) # , scales = 'free_x'
```

```{r warning=FALSE, fig.width=8, fig.height=4}
thresh = 1e-15

tmp <- gl %>% filter(name == 'added', Biodomain != 'none') %>% 
  rowwise() %>% 
  mutate(
    nw.label = paste0(bd,'\n', length(unique(unlist(value))), ' nodes added')
  )

nw.ord <- tmp %>% select(nw.label, value) %>% distinct() %>% 
  rowwise() %>% 
  mutate(n = length(unique(unlist(value)))) %>% 
  arrange(desc(n)) %>% pull(nw.label)

bdt <- bd.tally(tmp %>% filter(p_value <= thresh) %>% pull(term_name), biodom)

tmp = tmp %>%
  rowwise() %>% 
  mutate(
    nw.label = factor(nw.label, levels = nw.ord),
    Biodomain = factor(Biodomain, levels = bdt$domain %>% str_subset('none', negate = T) %>% c('none',.)) 
    ) 
  
tmp %>%
  ggplot(aes(-log10(p_value), Biodomain))+
  geom_violin(data = subset(tmp, p_value <= thresh), aes(color = color), scale = 'width')+
  geom_jitter(data = subset(tmp, p_value <= thresh), aes(color = color), alpha = .7)+
  scale_color_identity()+
  # xlim(c(0,30))+
  labs(y = '', title = 'Nodes Added by Pathway Tracing', subtitle = paste0('enrichment threshold: ', thresh))+
  facet_wrap(~nw.label, ncol = 9) #, scales = 'free_x'
```

<!-- ```{r warning=FALSE} -->
<!-- thresh = 1e-15 -->

<!-- tmp <- gl %>% filter(Biodomain != 'none') -->

<!-- bdt <- bd.tally(tmp %>% filter(p_value <= thresh) %>% pull(term_name), biodom) -->

<!-- tmp = tmp %>% -->
<!--   rowwise() %>% -->
<!--   # mutate(bd = paste0(bd,'\n', length(unique(unlist(value))), ' nodes added') ) %>% -->
<!--   mutate( -->
<!--     Biodomain = factor( Biodomain, levels = bdt$domain %>% str_subset('none', negate = T) %>% c('none',.)), -->
<!--     name = factor( name, levels = c('q_genes','added_genes','nodes') ) -->
<!--          ) -->

<!-- ``` -->

<!-- ```{r fig.width=20, fig.height=8} -->
<!-- tmp %>% -->
<!--   ggplot(aes( -log10(p_value) , Biodomain ))+ -->
<!--   geom_violin(data = subset(tmp, p_value <= thresh), aes(color = color), scale = 'width')+ -->
<!--   geom_jitter(data = subset(tmp, p_value <= thresh), aes(color = color), alpha = .7)+ -->
<!--   scale_color_identity()+ -->
<!--   # xlim(c(0,30))+ -->
<!--   theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+ -->
<!--   labs(y = '', subtitle = paste0('enrichment threshold: ', thresh))+ -->
<!--   facet_grid(name~bd, scales = 'free_x') #, scales = 'free_x' -->

<!-- ``` -->

```{r echo=FALSE,warning=FALSE,message=FALSE,results='asis', fig.width=4, fig.height=2.5}
thresh = 1e-15
plot.new();dev.off()
for(i in unique(gl$bd)){
  tmp <- gl %>% filter(bd == i, Biodomain != 'none')
  
  bdt <- bd.tally(tmp %>% filter(p_value <= thresh) %>% pull(term_name), biodom)
  
  tmp = tmp %>%
    group_by(name) %>% 
    mutate(Biodomain = factor(Biodomain, levels = bdt$domain %>% str_subset('none', negate = T) %>%c('none',.)),
           ord = case_when(name == 'input' ~ 1, name == 'added' ~ 2, name == 'nodes' ~ 3),
           name = paste0(name,'\nN = ', length(unique(unlist(value))) )
           ) %>% 
    ungroup() %>%
    mutate(name = fct_reorder(name, ord)) %>% 
    arrange(name)
  
  p <- tmp %>%
    ggplot(aes(-log10(p_value), Biodomain))+
    geom_violin(data = subset(tmp, p_value <= thresh), aes(color = color), scale = 'width')+
    geom_jitter(data = subset(tmp, p_value <= thresh), aes(color = color), alpha = .7)+
    scale_color_identity()+
    # xlim(c(0,30))+
    labs(y = '', title = unique(tmp$bd), subtitle = paste0('enrichment threshold: ', thresh))+
    facet_wrap(~name, ncol = 3) #, scales = 'free_x'
  
  cat("  \n###",  i, "  \n")
  
  plot(p)
  plot.new()
  dev.off()
  cat("  \n  \n")  
  
}

```


## Module representation across NW

```{r}

modules <- biodom %>% 
  select(Biodomain, GO_ID, GOterm_Name, symbol, n_symbol) %>% 
  mutate(
    path_commons = length( intersect( names(V(base_net)), symbol ) ),
    node_filt = length( intersect( names(V(undir_node)), symbol ) ),
    edge_filt = length( intersect( names(V(undir_edge)), symbol ) ),
    node_edge_filt = length( intersect( names(V(undir_node_edge)), symbol ) )
  )


for(i in 1:nrow(nw.dat)){
  x <- c()
  for(j in 1:nrow(modules)){
    x <- c(x,
           length(intersect( nw.dat$nodes[[i]], modules$symbol[[j]] )) )
  
  }
  modules <- tibble(x) %>% setNames( nw.dat$bd[i] ) %>% bind_cols(modules, .)
}

write_tsv(modules %>% select(-symbol), paste0(here::here(), '/results/biodomain/module_representation_across_networks.tsv'))

modules <- modules %>% mutate(across(.cols = path_commons:Vasculature, ~ (.x / n_symbol)*100 ))
```

Looking at full pathway commons network, most terms across biodomains are well represented
```{r fig.width=7, fig.height=4}
ggplot( data = subset(modules, !is.na(Biodomain)), 
        aes(path_commons))+
  geom_histogram(color = 'grey20',fill = 'grey80')+
  #geom_density(color = 'grey20', fill = 'grey80')+
  labs(x = '% GO term genes in NW', y = '# GO terms',
       title = 'Pathway Commons network')+
  facet_wrap(~Biodomain, scales = 'free_y')
```

Filtering for Node & Edge representation reduces the percent of term genes present, but for most terms it is still >50%  
```{r fig.width=7, fig.height=4}
ggplot( data = subset(modules, !is.na(Biodomain)), 
        aes(node_edge_filt))+
  geom_histogram(color = 'grey20',fill = 'grey80')+
  #geom_density(color = 'grey20', fill = 'grey80')+
  labs(x = '% GO term genes in NW', y = '# GO terms',
       title = 'Node + Edge filtered network')+
  facet_wrap(~Biodomain, scales = 'free_y')
```

Looking at traced biodomain networks, filtered for biodomain annotation post-trace, the representation of terms from *other* domains is drastically decreased, e.g. for Synapse:  
```{r fig.width=7, fig.height=4}
ggplot( data = subset(modules, !is.na(Biodomain)), 
        aes(Synapse))+
  geom_histogram(color = 'grey20',fill = 'grey80')+
  #geom_density(color = 'grey20', fill = 'grey80')+
  labs(x = '% GO term genes in NW', y = '# GO terms',
       title = 'Synapse biodomain network')+
  facet_wrap(~Biodomain, scales = 'free_y')
```

Endolysosome:  
```{r fig.width=7, fig.height=4}
ggplot( data = subset(modules, !is.na(Biodomain)), 
        aes(Endolysosome))+
  geom_histogram(color = 'grey20',fill = 'grey80')+
  #geom_density(color = 'grey20', fill = 'grey80')+
  labs(x = '% GO term genes in NW', y = '# GO terms',
       title = 'Endolysosome biodomain network')+
  facet_wrap(~Biodomain, scales = 'free_y')
```

or APP Metabolism:  
```{r fig.width=7, fig.height=4}
ggplot( data = subset(modules, !is.na(Biodomain)), 
        aes(APP_Metabolism))+
  geom_histogram(color = 'grey20',fill = 'grey80')+
  #geom_density(color = 'grey20', fill = 'grey80')+
  labs(x = '% GO term genes in NW', y = '# GO terms',
       title = 'APP Metabolism biodomain network')+
  facet_wrap(~Biodomain, scales = 'free_y')
```

Trouble is, most KDs from the APP Metab network are for GO terms from the Synapse biodomain, which are in general poorly represented in this network.  

Compare the distributions between filtered base network and traced network  
```{r}
modules <- biodom %>% 
  select(Biodomain, GO_ID, GOterm_Name, symbol, n_symbol) %>% 
  mutate(
    path_commons = length( intersect( names(V(base_net)), symbol ) ),
    node_filt = length( intersect( names(V(undir_node)), symbol ) ),
    edge_filt = length( intersect( names(V(undir_edge)), symbol ) ),
    node_edge_filt = length( intersect( names(V(undir_node_edge)), symbol ) )
  )

for(i in 1:nrow(nw.dat)){
  x <- c()
  for(j in 1:nrow(modules)){
    x <- c(x,
           length(intersect( nw.dat$nodes[[i]], modules$symbol[[j]] )) )
  
  }
  modules <- tibble(x) %>% setNames( nw.dat$bd[i] ) %>% bind_cols(modules, .)
}


tmp <- modules %>% 
  pivot_longer(cols = 10:ncol(modules)) %>% 
  mutate( biodom_nw = 100*(value / n_symbol),
          base_nw = 100*(node_edge_filt / n_symbol) ) %>%
  # left_join(., subdoms %>% select(bd, name = sd)) %>% 
  rename(bd = name, n_nw = value) %>% 
  pivot_longer(cols = c(biodom_nw, base_nw)) %>% 
  rename(pct = value) %>% 
  filter(n_nw >= 3, pct > 0) 

```

```{r}
ggplot(tmp, aes(pct) )+
  geom_density(aes(fill = name), alpha = .5)+
  labs(x = '% GO term genes in NW', 
       subtitle = 'distribution of all terms >0% and >=3 genes in each NW class')
```


# Session
```{r}
sessionInfo()
```

