---
title: "Tracing New Filtered NWs"
author: "Greg Cary"
date: "`r Sys.Date()`"
output: 
  html_document: 
    fig_width: 5
    fig_height: 4
  html_notebook:
    code_folding: hide
    theme: spacelab
    css: style.css
    toc: true
    toc_float: true
---
# Setup

```{r setup}
# # Package names
# packages <- c(
#   # 'paxtoolsr','org.Hs.eg.db','HotNetvieweR','clusterProfiler', 
#   'synapser','igraph','tidygraph','ggraph','tidyverse'
#   )
# 
# # Load packages
# invisible(lapply(packages, library, character.only = TRUE))

library(synapser)
library(igraph)
library(tidygraph)
library(ggraph)
library(tidyverse)

source('../../treatAD_biodomains/scripts/biodom_tally.R')
source('../../treatAD_biodomains/scripts/annotate_enr_term_biodomains.R')
source('../../treatAD_biodomains/scripts/biodom_enr_plots.R')

theme_set(theme_bw())
```

# Data
Grab relevant data from synapse, including:
1) Target Risk Scores ([syn25575156](https://www.synapse.org/#!Synapse:syn25575156){target="_blank"}) and Omics Scores ([syn22758536](https://www.synapse.org/#!Synapse:syn22758536){target="_blank"})  
2) Biodomain Definitions ([syn25428992](https://www.synapse.org/#!Synapse:syn25428992){target="_blank"})  
2) Risk-enriched Biodomain Terms ([syn45824995](https://www.synapse.org/#!Synapse:syn45824995){target="_blank"})
3) Base Network ([syn51110930](https://www.synapse.org/#!Synapse:syn51110930){target="_blank"})  
4) Synapse IDs of path-traced NW objects  
5) Synapse IDs of wKDA results 
6) CRISPRbrain simple phenotype screen data  

```{r}
synLogin()

# target risk scores
scores <- read_csv(
  synTableQuery('select * from syn25575156', includeRowIdAndRowVersion = F)$filepath
  , col_types = cols())
omics <- read_csv(
  synTableQuery('select * from syn22758536', includeRowIdAndRowVersion = F)$filepath
  , col_types = cols())

# biological domain annotations
biodom <- full_join(
  # biodomains
  readRDS(synGet('syn25428992')$path),
  # domain labels
  read_csv(synGet('syn26856828')$path, col_types = cols()),
  by = c('Biodomain'='domain')
) %>%
  mutate(Biodomain = case_when(Biodomain == 'none' ~ NA_character_, T ~ Biodomain))

domains = biodom %>% pull(Biodomain) %>% unique() %>% sort()

# enriched biodomain terms
enr.bd <- read_csv( synGet('syn45824995')$path, col_types = cols() ) %>% 
  mutate(leadingEdge_genes = str_split(leadingEdge_genes, '\\|'))

# base network
base_net <- igraph::read_graph(synGet('syn51110930')$path, format = 'graphml') 

# specify directed edge types
directed_edge_types = c("catalysis-precedes",
                        "controls-expression-of",
                        "controls-phosphorylation-of",
                        "controls-state-change-of",
                        "controls-transport-of"
                        )

# read NW results dir on Synapse
nw.dirs <- map_dfr(
  synGetChildren('syn51117833')$asList() %>% 
    tibble(f = .) %>% unnest_wider(f) %>% 
    filter(
      !(name %in% c('pseudotime','nanostring_induced_subgraph.graphml'))
      ) %>% 
    pull(id),
  ~{ synGetChildren(  parent = .x  )$asList() %>% 
      tibble(f = .) %>% unnest_wider(f) %>% 
      filter(grepl('graphml', name)) %>% 
      mutate(
        bd = str_extract(name, '^(?<=[bdFiltered_]{0,1}).+(?=_[un]*directed)') %>% 
          str_remove_all('bdFiltered_') %>% str_replace_all('_',' '),
        bd.filt = if_else(grepl('bdFiltered',name),T,F),
        filt = str_extract(name, '(?<=_filt_).+(?=\\.graphml)'),
        dir = str_extract(name, '[un]*directed') 
        ) %>% 
      relocate(bd, bd.filt, filt, dir)
    }
) %>% 
  filter(!grepl('Astro|Micro', filt))

# read KDA results dir on Synapse
kda.dirs <- map_dfr(
  synGetChildren('syn51117833')$asList() %>% 
    tibble(f = .) %>% unnest_wider(f) %>% 
    filter(
      !(name %in% c('pseudotime','nanostring_induced_subgraph.graphml'))
      ) %>%  
    pull(id),
  ~{ id = synGetChildren( parent = .x )$asList() %>% 
      tibble(f = .) %>% unnest_wider(f) %>% 
      filter(grepl('kda', name)) %>% pull(id)
  
     bd = synGet(.x)$properties$name

     synGetChildren(id)$asList() %>% 
       tibble(f = .) %>% unnest_wider(f) %>% 
       filter(grepl('results|top',name)) %>% 
       mutate(
          bd = bd %>% str_replace_all('_' ,' '),
          filt = str_extract(name, '(?<=_filt_).+(?=_addWeights)'),
          dir = str_extract(name, '[un]*directed'), 
          ef = str_extract(name, '(?<=_edgeFactor_)[0|1]')
          ) %>% 
        relocate(bd, filt, dir, ef)
    }
) %>% 
  mutate(set = case_when(grepl('results', name) ~ 'full', grepl('top',name) ~ 'top', T ~ NA_character_)) %>% 
  relocate(set) %>% 
  filter(!grepl('Astro|Micro', filt))
```

pre-filtered NWs    
```{r}
undir <- base_net

# filt node & edge
tmp <- igraph::delete_vertices(
  base_net,
  igraph::V(base_net)[ igraph::V(base_net)$brain_exp == 0 ]
)
undir_node_edge <- igraph::subgraph.edges(
  tmp,
  igraph::E(tmp)[ igraph::E(tmp)$n_edge_evidence > 1 ],
  delete.vertices = T 
)

# filt node
undir_node <- igraph::delete_vertices(
    base_net,
    igraph::V(base_net)[ igraph::V(base_net)$brain_exp == 0 ]
  )

# filt edge
undir_edge <- igraph::subgraph.edges(
    base_net,
    igraph::E(base_net)[ igraph::E(base_net)$n_edge_evidence > 1 ],
    delete.vertices = T 
  )

# dir
dir <- igraph::subgraph.edges( 
    base_net, 
    igraph::E(base_net)[ igraph::E(base_net)$directed == 1 ],
    delete.vertices = T 
  ) %>% 
    as.directed(mode = 'arbitrary')

# dir node edge
dir_node_edge <- igraph::subgraph.edges( 
    undir_node_edge, 
    igraph::E(undir_node_edge)[ igraph::E(undir_node_edge)$directed == 1 ],
    delete.vertices = T 
  ) %>% 
    as.directed(mode = 'arbitrary')

# dir node
dir_node <- igraph::subgraph.edges( 
    undir_node, 
    igraph::E(undir_node)[ igraph::E(undir_node)$directed == 1 ],
    delete.vertices = T 
  ) %>% 
    as.directed(mode = 'arbitrary')

# dir edge
dir_edge <- igraph::subgraph.edges( 
    undir_edge, 
    igraph::E(undir_edge)[ igraph::E(undir_edge)$directed == 1 ],
    delete.vertices = T 
  ) %>% 
    as.directed(mode = 'arbitrary')

```

## cbrain data
CRISPRbrain phenotype data
```{r}
synLogin()

# CRISPRbrain data
syn.dir <- synGetChildren('syn51183357')$asList() %>% 
  tibble(f = .) %>% 
  unnest_wider(f)

# Simple Screens
simple <- map_dfr(
  syn.dir %>% with(which( !grepl('RNA|CROP',name) )),
  ~ { 
    id = syn.dir$id[.x]
    n = syn.dir$name[.x]
    synGet(id)$path %>% 
      read_csv( col_types = cols() ) %>% 
      mutate(cell = n %>% str_split_fixed(.,'-(?!M)', 2) %>% .[,1],
             mode = n %>% str_extract('CRISPR[ain]'),
             expt = n %>% str_remove_all('-CRISPR[ain].csv') %>% 
               str_split_fixed('-(?!M)',2) %>% .[,2] ) %>% 
      relocate(cell, mode, expt)
  }
  ) %>% 
  rename(pval = `P Value`, pheno = `Phenotype`, gene_score = `Gene Score`)

simple <- tibble(expt = simple$expt %>% unique() %>% sort(),
                 phenotype = c('Expansion (CD34 Staining)',
                                'Reactive Oxygen Species (CellRox Intensity)',
                                'Proliferation (CFSE Staining)',
                                'Survival (14 day)', 'Survival (21 day)', 'Survival (28 day)',
                                'Labile Iron (FeRhoNox Intensity)',
                                'Immune Activation (CD38 levels)',
                                'Lysosome Exocytosis (cell surface LAMP1), +IL1a +TNF +C1q',
                                'Lysosome Exocytosis (cell surface LAMP1), Vehicle',
                                'Peroxidized Lipids (Liperfluo intensity)',
                                'Lysosome (LysoTracker intensity)',
                                'Lysosome Mass or pH (LysoTracker staining), +IL1a +TNF +C1q',
                                'Lysosome Mass or pH (LysoTracker staining), Vehicle',
                                'Survival, no antioxidants',
                                'Phagocytosis (pHRodo-rat synaptosomes)',
                                'Phagocytosis (pHRodo-labeled synaptosomes), +IL1a +TNF +C1q',
                                'Phagocytosis (pHRodo-labeled synaptosomes), Vehicle',
                                'Survival, PSAP KO & no antioxidants',
                                'Survival, PSAP KO',
                                'Survival',
                                'Survival-Proliferation',
                                'Inflammatory activation (cell-surface VCAM1 levels), +IL1a +TNF +C1q')
                 ) %>% left_join(simple, . , by = 'expt')

# filter(cell %in% c('iAstrocyte','Glutamatergic Neuron','iTF-Microglia','iPSC')) # don't consider HSPC or T-cell
```
## kda data
functions to read KDA results and plot sub-networks from identified key drivers
```{r}
read_kda_res <- function(ef0_synID, ef1_synID, ef1_top){
  
  res = bind_rows(
    read_tsv(synGet(ef0_synID)$path, col_types = cols()) %>% mutate(ef = 'ef0_fdr'),
    read_tsv(synGet(ef1_synID)$path, col_types = cols()) %>% mutate(ef = 'ef1_fdr')
  ) %>%
  mutate(FDR = -log10(FDR)) %>%
  pivot_wider(id_cols = c(MODULE, NODE, MEMBER), names_from = ef, values_from = FDR) %>%
  mutate(across(contains('_fdr'), ~ if_else(is.na(.x), 0, .x))) %>% 
  mutate(delta_fdr = ef1_fdr - ef0_fdr) %>% arrange(desc(delta_fdr)) %>% 
  mutate(top = 0)
  
  top = read_tsv(synGet(ef1_top)$path, col_types = cols()) %>% 
    mutate(kd = paste0(NODE,'-',MODULE))
  
  if( any( top$FDR < 0.05 ) ){
    res$top[ which(paste0(res$NODE,'-',res$MODULE) %in% top$kd[top$FDR < 0.05]) ] <- 1
  }
  
  return(res)
  
}


plot_kd_subnet <- function(nw, kd, term) {
  
  vert_num <- match(kd, V(nw)$name)
  
  vert_neigh <- neighbors(nw, vert_num)
  
  term_num <- biodom %>%
    filter(GOterm_Name == term) %>%
    pull(symbol) %>% unlist() %>%
    match(., V(nw)$name) %>% .[!is.na(.)]
  
  g2 <- induced_subgraph(nw, c(vert_num, intersect(term_num, vert_neigh)))
  g3 <- induced_subgraph(nw, c(vert_num, term_num))
  
  cowplot::plot_grid(
    
    ggraph(g3, layout = 'linear', circular = TRUE) +
      geom_edge_arc(alpha = .3, color = 'grey75') +
      geom_node_point( shape = 21, color = "black", alpha = .3,
        aes(size = TargetRiskScore, fill = Pro_EffectScore, filter= .N()$name != kd)  )+
      geom_node_point( shape = 23, color = "black", alpha = .3,
        aes(size = TargetRiskScore, fill = Pro_EffectScore, filter = .N()$name == kd) )+
      geom_node_text(aes(label = name), size = 2) +
      coord_fixed() +
      scale_size_continuous( range = c(.5, 10), limits = c(0, 5), trans = 'exp')+
      scale_fill_gradient2(
        low = 'purple', mid = 'grey20', high = 'green', na.value = 'grey85',
        limits = c(-2.5,2.5) )+ #approx: range(omics$Pro_TE, na.rm = T)
      labs( title = 'All term genes in NW',
            subtitle = paste0('KD: ', kd, '\nTerm: ', term) )+
      theme_graph(background = 'white')
    ,
    ggraph(g2, layout = 'linear', circular = TRUE) +
            geom_edge_arc(alpha = .3, color = 'grey75') +
      geom_node_point( shape = 21, color = "black", alpha = .3,
        aes(size = TargetRiskScore, fill = Pro_EffectScore, filter= .N()$name != kd)  )+
      geom_node_point( shape = 23, color = "black", alpha = .3,
        aes(size = TargetRiskScore, fill = Pro_EffectScore, filter = .N()$name == kd) )+
      geom_node_text(aes(label = name), size = 2) +
      coord_fixed() +
      scale_size_continuous( range = c(.5, 10), limits = c(0, 5), trans = 'exp')+
      scale_fill_gradient2(
        low = 'purple', mid = 'grey20', high = 'green', na.value = 'grey85',
        limits = c(-2.5,2.5) )+ #approx: range(omics$Pro_TE, na.rm = T)
      labs( title = 'Term genes & KD neighbors in NW',
            subtitle = paste0('KD: ', kd, '\nTerm: ', term) )+
      theme_graph(background = 'white')
    ,
    ncol = 2
    
  )
}
```


The Biodomains with traced NW analyzed by wKDA include:  
1) APP Metabolism  [2]
2) Endolysosome [6] 
3) Tau Homeostasis [18]
== vv KDA results not yet complete vv ==
•) Immune Response [8] 
•) Lipid Metabolism [9]  
•) Synapse [17] 
•) Mitochondrial Metabolism [11]

Explore the effects of NW filters on traces & KDs for these sets:
• node & edge filtering effects
• direct edge filter before vs after trace
• nodes added by trace
• common vs unique nodes across BD
• KDA on full (i.e. not BD filtered) NW objects

# Biodom NW analyses
## Cross NW comparisions

```{r}
nw.dat = nw.dirs %>% 
  # filter(bd.filt) %>% 
  select(bd:id) 

future::plan('multisession')
x = furrr::future_map_dfr(
  nw.dat$id,
  ~{synLogin()
    nw = synGet(.x) %>% .$path %>% read_graph(., format = 'graphml' )
    snw = igraph::simplify(nw, remove.multiple = T)
    tibble(
      avg_node_degree = degree(snw, V(snw)) %>% mean(),
      avg_path_length = snw %>% average.path.length,
      assortativity_coef = snw %>% assortativity(., types1 = V(.)),
      connected_components = snw %>% no.clusters,
      edges = E(nw)$edge %>% unique() %>% list(),
      s.edges = E(snw)$edge %>% unique() %>% list(),
      nodes = V(nw) %>% names() %>% unique() %>% list(),
      s.nodes = V(snw) %>% names() %>% unique() %>% list()
    )
  }
)
future::plan('sequential')

nw.dat = bind_cols(nw.dat, x)

nw.dat$le_genes <- map(
  1:nrow(nw.dat),
  ~ enr.bd %>% 
  filter(
    Biodomain == nw.dat$bd[.x],
    padj < 0.01,
    NES > 1.7
  ) %>% 
  pull(leadingEdge_genes) %>% 
  unlist() %>% 
  unique()
)

nw.dat <- nw.dat %>% 
  rowwise() %>% 
  mutate(
    input_genes = case_when(
      (dir == 'undirected' & filt == 'none') ~ 
        intersect( unlist(le_genes), names(V(undir)) ) %>% list(),
      (dir == 'undirected' & filt == 'node') ~ 
        intersect( unlist(le_genes), names(V(undir_node)) ) %>% list(),
      (dir == 'undirected' & filt == 'edge') ~ 
        intersect( unlist(le_genes), names(V(undir_edge)) ) %>% list(),
      (dir == 'undirected' & filt == 'node_edge') ~ 
        intersect( unlist(le_genes), names(V(undir_node_edge)) ) %>% list(),
      
      (dir == 'directed' & filt == 'none') ~ 
        intersect( unlist(le_genes), names(V(!! dir)) ) %>% list(),
      (dir == 'directed' & filt == 'node') ~ 
        intersect( unlist(le_genes), names(V(dir_node)) ) %>% list(),
      (dir == 'directed' & filt == 'edge') ~ 
        intersect( unlist(le_genes), names(V(dir_edge)) ) %>% list(),
      (dir == 'directed' & filt == 'node_edge') ~ 
        intersect( unlist(le_genes), names(V(dir_node_edge)) ) %>% list(),
      T ~ list(NA_character_)
    )
  )

nw.dat$added_genes <- map(
  1:nrow(nw.dat),
  ~ setdiff( nw.dat$nodes[[.x]], nw.dat$input_genes[[.x]] ) 
)

# -common nodes
# V(nw) %>% names() %>% unique() %>% length()
# -common edges
# E(nw)$edge %>% head()
#  by filt, direction
```

### NW size
```{r}
nw.summary <- nw.dat %>% 
  group_by(bd, bd.filt, dir, filt) %>% 
  summarise(
    le_genes = length(unique(unlist(le_genes))),
    n_nodes = length(unique(unlist(nodes))),
    n_edges = length(unique(unlist(edges)))
  )
```

```{r fig.width=7, fig.height=3}
nw.summary %>% 
  filter(dir == 'undirected', filt == 'node_edge') %>% 
  pivot_longer(cols = c(n_nodes, n_edges)) %>% 
  mutate( max = case_when(
    name == 'n_nodes' ~ V(undir_node_edge) %>% length(),
    name == 'n_edges' ~ E(undir_node_edge) %>% length())) %>% 
  ggplot(aes(le_genes, value))+
  geom_point(aes(color = bd.filt), alpha = .5)+
  geom_hline(aes(yintercept = max), lty = 2)+
  scale_y_log10()+
  facet_wrap(~name, scales = 'free')
```

### Input Overlap
LE genes
```{r fig.width=6, fig.height=5}
olap = map_dfr(
  unique('none'),
  ~{
    tmp <- nw.dat %>% 
      filter(bd.filt,
             dir == 'undirected', 
             filt == .x)
    
    olap <- crossing(nw1 = tmp$bd, nw2 = tmp$bd) %>% 
      group_by(nw1,nw2) %>% 
      mutate(.keep = 'all', 
             intersect = length(intersect(
               tmp %>% filter(bd == nw1) %>% pull(le_genes) %>% unlist(),
               tmp %>% filter(bd == nw2) %>% pull(le_genes) %>% unlist()
               ))
             ) %>% 
      ungroup() %>% group_by(nw1) %>% 
      mutate(.keep = 'all', pct_overlap = intersect / intersect[which(nw2 == nw1)]) %>% 
      ungroup() %>% 
      mutate(filt = .x)
  }
) %>%
  mutate(
    # filt = fct_relevel(filt, c('none','node','edge','node_edge')),
    nw1 = fct_relevel(
      nw1, 
      nw.dat %>% select(bd, le_genes) %>% distinct() %>% 
        mutate(len = length(unlist(le_genes))) %>% arrange(len) %>% pull(bd)
                      ),
    nw2 = fct_relevel(
      nw2, 
      nw.dat %>% select(bd, le_genes) %>% distinct() %>% 
        mutate(len = length(unlist(le_genes))) %>% arrange(desc(len)) %>% pull(bd)
                      )
  ) 


ggplot(olap, aes(x = nw2, y = nw1)) +
  geom_tile(aes(fill=pct_overlap), alpha = .8) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  # theme(axis.text.x = element_blank(), legend.position = 'bottom') +
  # scale_fill_gradient2('% Total', low = 'white', high = '4a66ac', na.value = 'grey90') +
  viridis::scale_fill_viridis("% Total", option = "C", direction = -1)+
  # scale_x_discrete(position = "top") +
  geom_text(aes(label = intersect ), size = 2.5) +
  facet_wrap(~filt)+
  labs(x='',y='', title = 'Leading Edge Genes') 



```

input genes (overlap with base net)
```{r fig.width=9, fig.height=7}

olap = map_dfr(
  unique(nw.dat$filt),
  ~{
    tmp <- nw.dat %>% 
      filter(bd.filt,
             dir == 'undirected', 
             filt == .x)
    
    olap <- crossing(nw1 = tmp$bd, nw2 = tmp$bd) %>% 
      group_by(nw1,nw2) %>% 
      mutate(.keep = 'all', 
             intersect = length(intersect(
               tmp %>% filter(bd == nw1) %>% pull(input_genes) %>% unlist(),
               tmp %>% filter(bd == nw2) %>% pull(input_genes) %>% unlist()
               )),
               len_nw1 = tmp %>% filter(bd == nw1) %>% pull(input_genes) %>% unlist() %>% length(),
               len_nw2 = tmp %>% filter(bd == nw1) %>% pull(input_genes) %>% unlist() %>% length()
             ) %>% 
      ungroup() %>% group_by(nw1) %>% 
      mutate(.keep = 'all', pct_overlap = intersect / intersect[which(nw2 == nw1)]) %>% 
      ungroup() %>% 
      mutate(filt = .x)
  }
) 

olap <- olap %>% 
  mutate(
    filt = fct_relevel(filt, c('none','node','edge','node_edge')),
    nw1 = fct_relevel(nw1, olap %>% filter(filt == 'none') %>% select(nw1, len_nw1) %>% distinct() %>% arrange(len_nw1) %>% pull(nw1)),
    nw2 = fct_relevel(nw2, olap %>% filter(filt == 'none') %>% select(nw1, len_nw1) %>% distinct() %>% arrange(desc(len_nw1)) %>% pull(nw1))
  ) 

olap %>% 
  ggplot(., aes(x = nw2, y = nw1)) +
  geom_tile(aes(fill=pct_overlap), alpha = .8) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  # theme(axis.text.x = element_blank(), legend.position = 'bottom') +
  # scale_fill_gradient2('% Total', low = 'white', high = '4a66ac', na.value = 'grey90') +
  viridis::scale_fill_viridis("% Total", option = "C", direction = -1)+
  # scale_x_discrete(position = "top") +
  geom_text(aes(label = intersect ), size = 2.5) +
  labs(x='',y='', title = 'input genes', subtitle = 'leading edge overlap with filtered base network nodes') + 
  facet_wrap(~filt)

```

input genes (overlap with base net)
```{r fig.width=9, fig.height=7}

olap = map_dfr(
  unique(nw.dat$filt),
  ~{
    tmp <- nw.dat %>% 
      filter(bd.filt,
             dir == 'directed', 
             filt == .x)
    
    olap <- crossing(nw1 = tmp$bd, nw2 = tmp$bd) %>% 
      group_by(nw1,nw2) %>% 
      mutate(.keep = 'all', 
             intersect = length(intersect(
               tmp %>% filter(bd == nw1) %>% pull(input_genes) %>% unlist(),
               tmp %>% filter(bd == nw2) %>% pull(input_genes) %>% unlist()
               )),
               len_nw1 = tmp %>% filter(bd == nw1) %>% pull(input_genes) %>% unlist() %>% length(),
               len_nw2 = tmp %>% filter(bd == nw1) %>% pull(input_genes) %>% unlist() %>% length()
             ) %>% 
      ungroup() %>% group_by(nw1) %>% 
      mutate(.keep = 'all', pct_overlap = intersect / intersect[which(nw2 == nw1)]) %>% 
      ungroup() %>% 
      mutate(filt = .x)
  }
)

olap <- olap %>%
  mutate(
    filt = fct_relevel(filt, c('none','node','edge','node_edge')),
    nw1 = fct_relevel(nw1, olap %>% filter(filt == 'none') %>% select(nw1, len_nw1) %>% distinct() %>% arrange(len_nw1) %>% pull(nw1)),
    nw2 = fct_relevel(nw2, olap %>% filter(filt == 'none') %>% select(nw1, len_nw1) %>% distinct() %>% arrange(desc(len_nw1)) %>% pull(nw1))
  ) 

olap %>% 
  ggplot(., aes(x = nw2, y = nw1)) +
  geom_tile(aes(fill=pct_overlap), alpha = .8) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  theme(axis.text.x = element_blank(), legend.position = 'bottom') +
  viridis::scale_fill_viridis("% Total", option = "C", direction = -1)+
  # scale_fill_gradient2('% Total', low = 'white', high = '4a66ac', na.value = 'grey90') +
  # scale_x_discrete(position = "top") +
  geom_text(aes(label = intersect ), size = 2.5) +
  labs(x='',y='', title = 'input genes', subtitle = 'leading edge overlap with *DIRECTED* 
       filtered base network nodes') + 
  facet_wrap(~filt)

```

### Common Nodes
undirected
```{r fig.width=9, fig.height=7}

olap = map_dfr(
  unique(nw.dat$filt),
  ~{
    tmp <- nw.dat %>% 
      filter(bd.filt,
             dir == 'undirected', 
             filt == .x)
    
    olap <- crossing(nw1 = tmp$bd, nw2 = tmp$bd) %>% 
      group_by(nw1,nw2) %>% 
      mutate(.keep = 'all', 
             intersect = length(intersect(
               tmp %>% filter(bd == nw1) %>% pull(nodes) %>% unlist(),
               tmp %>% filter(bd == nw2) %>% pull(nodes) %>% unlist()
               ))
             ) %>% 
      ungroup() %>% group_by(nw1) %>% 
      mutate(.keep = 'all', pct_overlap = intersect / intersect[which(nw2 == nw1)]) %>% 
      ungroup() %>% 
      mutate(filt = .x)
  }
)


olap <- olap %>%
  mutate(
    filt = fct_relevel(filt, c('none','node','edge','node_edge')),
    nw1 = fct_relevel(nw1, c('Tau Homeostasis','APP Metabolism', 'Endolysosome',
                             'Immune Response','Lipid Metabolism','Synapse',
                             'Mitochondrial Metabolism')),
    nw2 = fct_relevel(nw2, c('Mitochondrial Metabolism',
                             'Synapse','Lipid Metabolism','Immune Response',
                             'Endolysosome', 'APP Metabolism', 'Tau Homeostasis'
                             ))
  ) 

olap %>% 
  ggplot(., aes(x = nw2, y = nw1)) +
  geom_tile(aes(fill=pct_overlap), alpha = .8) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  # theme(axis.text.x = element_blank(), legend.position = 'bottom') +
  # scale_fill_gradient2('% Total', low = 'white', high = '4a66ac', na.value = 'grey90') +
  viridis::scale_fill_viridis("% Total", option = "C", direction = -1)+
  # scale_x_discrete(position = "top") +
  geom_text(aes(label = intersect ), size = 2.5) +
  labs(x='',y='', title = 'common nodes, undirected NWs') + 
  facet_wrap(~filt)

```

common nodes, directed
```{r fig.width=9, fig.height=6}

olap = map_dfr(
  unique(nw.dat$filt),
  ~{
    tmp <- nw.dat %>% 
      filter(bd.filt,
             dir == 'directed', 
             filt == .x)
    
    olap <- crossing(nw1 = tmp$bd, nw2 = tmp$bd) %>% 
      group_by(nw1,nw2) %>% 
      mutate(.keep = 'all', 
             intersect = length(intersect(
               tmp %>% filter(bd == nw1) %>% pull(nodes) %>% unlist(),
               tmp %>% filter(bd == nw2) %>% pull(nodes) %>% unlist()
               ))
             ) %>% 
      ungroup() %>% group_by(nw1) %>% 
      mutate(.keep = 'all', pct_overlap = intersect / intersect[which(nw2 == nw1)]) %>% 
      ungroup() %>% 
      mutate(filt = .x)
  }
)

olap <- olap %>%
  mutate(
    filt = fct_relevel(filt, c('none','node','edge','node_edge')),
    nw1 = fct_relevel(nw1, c('Tau Homeostasis','APP Metabolism', 'Endolysosome',
                             'Immune Response','Lipid Metabolism','Synapse',
                             'Mitochondrial Metabolism')),
    nw2 = fct_relevel(nw2, c('Mitochondrial Metabolism',
                             'Synapse','Lipid Metabolism','Immune Response',
                             'Endolysosome', 'APP Metabolism', 'Tau Homeostasis'
                             ))
  ) 

olap %>% 
  ggplot(., aes(x = nw2, y = nw1)) +
  geom_tile(aes(fill=pct_overlap), alpha = .8) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  # theme(axis.text.x = element_blank(), legend.position = 'bottom') +
  # scale_fill_gradient2('% Total', low = 'white', high = '4a66ac', na.value = 'grey90') +
  viridis::scale_fill_viridis("% Total", option = "C", direction = -1)+
  # scale_x_discrete(position = "top") +
  geom_text(aes(label = intersect ), size = 2.5) +
  labs(x='',y='', title = 'common nodes, undirected NWs') + 
  facet_wrap(~filt)

```

### Common Edges
common edges, undirected
```{r fig.width=9, fig.height=7}

olap = map_dfr(
  unique(nw.dat$filt),
  ~{
    tmp <- nw.dat %>% 
      filter(bd.filt,
             dir == 'undirected', 
             filt == .x)
    
    olap <- crossing(nw1 = tmp$bd, nw2 = tmp$bd) %>% 
      group_by(nw1,nw2) %>% 
      mutate(.keep = 'all', 
             intersect = length(intersect(
               tmp %>% filter(bd == nw1) %>% pull(edges) %>% unlist(),
               tmp %>% filter(bd == nw2) %>% pull(edges) %>% unlist()
               ))
             ) %>% 
      ungroup() %>% group_by(nw1) %>% 
      mutate(.keep = 'all', pct_overlap = intersect / intersect[which(nw2 == nw1)]) %>% 
      ungroup() %>% 
      mutate(filt = .x)
  }
)

olap <- olap %>%
  mutate(
    filt = fct_relevel(filt, c('none','node','edge','node_edge')),
    nw1 = fct_relevel(nw1, c('Tau Homeostasis','APP Metabolism', 'Endolysosome',
                             'Immune Response','Lipid Metabolism','Synapse',
                             'Mitochondrial Metabolism')),
    nw2 = fct_relevel(nw2, c('Mitochondrial Metabolism',
                             'Synapse','Lipid Metabolism','Immune Response',
                             'Endolysosome', 'APP Metabolism', 'Tau Homeostasis'
                             ))
  ) 

olap %>% 
  ggplot(., aes(x = nw2, y = nw1)) +
  geom_tile(aes(fill=pct_overlap), alpha = .8) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  # theme(axis.text.x = element_blank(), legend.position = 'bottom') +
  # scale_fill_gradient2('% Total', low = 'white', high = '4a66ac', na.value = 'grey90') +
  viridis::scale_fill_viridis("% Total", option = "C", direction = -1)+
  # scale_x_discrete(position = "top") +
  geom_text(aes(label = intersect ), size = 2.5) +
  labs(x='',y='', title = 'common edges, undirected NWs') + 
  facet_wrap(~filt)

```

common edges, directed
```{r fig.width=9, fig.height=7}

olap = map_dfr(
  unique(nw.dat$filt),
  ~{
    tmp <- nw.dat %>% 
      filter(bd.filt,
             dir == 'directed', 
             filt == .x)
    
    olap <- crossing(nw1 = tmp$bd, nw2 = tmp$bd) %>% 
      group_by(nw1,nw2) %>% 
      mutate(.keep = 'all', 
             intersect = length(intersect(
               tmp %>% filter(bd == nw1) %>% pull(edges) %>% unlist(),
               tmp %>% filter(bd == nw2) %>% pull(edges) %>% unlist()
               ))
             ) %>% 
      ungroup() %>% group_by(nw1) %>% 
      mutate(.keep = 'all', pct_overlap = intersect / intersect[which(nw2 == nw1)]) %>% 
      ungroup() %>% 
      mutate(filt = .x)
  }
)

olap <- olap %>%
  mutate(
    filt = fct_relevel(filt, c('none','node','edge','node_edge')),
    nw1 = fct_relevel(nw1, c('Tau Homeostasis','APP Metabolism', 'Endolysosome',
                             'Immune Response','Lipid Metabolism','Synapse',
                             'Mitochondrial Metabolism')),
    nw2 = fct_relevel(nw2, c('Mitochondrial Metabolism',
                             'Synapse','Lipid Metabolism','Immune Response',
                             'Endolysosome', 'APP Metabolism', 'Tau Homeostasis'
                             ))
  ) 

olap %>% 
  ggplot(., aes(x = nw2, y = nw1)) +
  geom_tile(aes(fill=pct_overlap), alpha = .8) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  # theme(axis.text.x = element_blank(), legend.position = 'bottom') +
  # scale_fill_gradient2('% Total', low = 'white', high = '4a66ac', na.value = 'grey90') +
  viridis::scale_fill_viridis("% Total", option = "C", direction = -1)+
  # scale_x_discrete(position = "top") +
  geom_text(aes(label = intersect ), size = 2.5) +
  labs(x='',y='', title = 'common edges, directed NWs') + 
  facet_wrap(~filt)
```

### Added Nodes
```{r fig.width=9, fig.height=7}

olap = map_dfr(
  unique(nw.dat$filt),
  ~{
    tmp <- nw.dat %>% 
      filter(bd.filt,
             dir == 'undirected', 
             filt == .x)
    
    olap <- crossing(nw1 = tmp$bd, nw2 = tmp$bd) %>% 
      group_by(nw1,nw2) %>% 
      mutate(.keep = 'all', 
             intersect = length(intersect(
             setdiff( tmp %>% filter(bd == nw1) %>% pull(nodes) %>% unlist(), 
                        tmp %>% filter(bd == nw1) %>% pull(le_genes) %>% unlist() ),
             setdiff( tmp %>% filter(bd == nw2) %>% pull(nodes) %>% unlist(), 
                        tmp %>% filter(bd == nw2) %>% pull(le_genes) %>% unlist() )
               ))
             ) %>% 
      ungroup() %>% group_by(nw1) %>% 
      mutate(.keep = 'all', pct_overlap = intersect / intersect[which(nw2 == nw1)]) %>% 
      ungroup() %>% 
      mutate(filt = .x)
  }
)

olap <- olap %>%
  mutate(
    filt = fct_relevel(filt, c('none','node','edge','node_edge')),
    nw1 = fct_relevel(nw1, c('Tau Homeostasis','APP Metabolism', 'Endolysosome',
                             'Immune Response','Lipid Metabolism','Synapse',
                             'Mitochondrial Metabolism')),
    nw2 = fct_relevel(nw2, c('Mitochondrial Metabolism',
                             'Synapse','Lipid Metabolism','Immune Response',
                             'Endolysosome', 'APP Metabolism', 'Tau Homeostasis'
                             ))
  ) 

olap %>% 
  ggplot(., aes(x = nw2, y = nw1)) +
  geom_tile(aes(fill=pct_overlap), alpha = .8) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  # theme(axis.text.x = element_blank(), legend.position = 'bottom') +
  # scale_fill_gradient2('% Total', low = 'white', high = '4a66ac', na.value = 'grey90') +
  viridis::scale_fill_viridis("% Total", option = "C", direction = -1)+
  # scale_x_discrete(position = "top") +
  geom_text(aes(label = intersect ), size = 2.5) +
  labs(x='',y='', title = 'nodes added by path trace, undirected NW') + 
  facet_wrap(~filt)
```

nodes added by trace, directed NWs
```{r fig.width=9, fig.height=7}

olap = map_dfr(
  unique(nw.dat$filt),
  ~{
    tmp <- nw.dat %>% 
      filter(bd.filt,
             dir == 'directed', 
             filt == .x)
    
    olap <- crossing(nw1 = tmp$bd, nw2 = tmp$bd) %>% 
      group_by(nw1,nw2) %>% 
      mutate(.keep = 'all', 
             intersect = length(intersect(
             setdiff( tmp %>% filter(bd == nw1) %>% pull(nodes) %>% unlist(), 
                        tmp %>% filter(bd == nw1) %>% pull(le_genes) %>% unlist() ),
             setdiff( tmp %>% filter(bd == nw2) %>% pull(nodes) %>% unlist(), 
                        tmp %>% filter(bd == nw2) %>% pull(le_genes) %>% unlist() )
               ))
             ) %>% 
      ungroup() %>% group_by(nw1) %>% 
      mutate(.keep = 'all', pct_overlap = intersect / intersect[which(nw2 == nw1)]) %>% 
      ungroup() %>% 
      mutate(filt = .x)
  }
)

olap <- olap %>%
  mutate(
    filt = fct_relevel(filt, c('none','node','edge','node_edge')),
    nw1 = fct_relevel(nw1, c('Tau Homeostasis','APP Metabolism', 'Endolysosome',
                             'Immune Response','Lipid Metabolism','Synapse',
                             'Mitochondrial Metabolism')),
    nw2 = fct_relevel(nw2, c('Mitochondrial Metabolism',
                             'Synapse','Lipid Metabolism','Immune Response',
                             'Endolysosome', 'APP Metabolism', 'Tau Homeostasis'
                             ))
  ) 

olap %>% 
  ggplot(., aes(x = nw2, y = nw1)) +
  geom_tile(aes(fill=pct_overlap), alpha = .8) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  # theme(axis.text.x = element_blank(), legend.position = 'bottom') +
  # scale_fill_gradient2('% Total', low = 'white', high = '4a66ac', na.value = 'grey90') +
  viridis::scale_fill_viridis("% Total", option = "C", direction = -1)+
  # scale_x_discrete(position = "top") +
  geom_text(aes(label = intersect ), size = 2.5) +
  labs(x='',y='', title = 'nodes added by path trace, directed NW') + 
  facet_wrap(~filt)
```

### Score Comparisons (LE genes vs Added genes)
```{r}
tmp <- nw.dat %>% 
  filter(bd.filt) %>% 
  select(bd, filt, dir, input_genes, added_genes) %>% 
  pivot_longer(cols = c(input_genes, added_genes)) %>% 
  unnest(value) %>% 
  left_join(
    .,
    scores %>% select(value = GeneName, Overall, 
                      GeneticsScore, OmicsScore, LiteratureScore),
    by = 'value', na_matches = 'never'
  )
```


```{r fig.width=8, fig.height=4}
tmp %>% 
  rename(set = name, gene = value) %>% 
  mutate(filt = fct_relevel(filt, c('none','node','edge','node_edge'))) %>%
  ggplot(aes(Overall))+
  theme(legend.position = 'top') + 
  # geom_density(aes(fill = set, color = set), alpha = .3)+
  geom_histogram(aes(fill = set), alpha = .8, position='dodge')+
  facet_grid(dir~filt, scales = 'free')
```

```{r fig.width=7, fig.height=7}
tmp %>% 
  rename(set = name, gene = value) %>% 
  pivot_longer(Overall:OmicsScore) %>% 
  mutate(filt = fct_relevel(filt, c('none','node','edge','node_edge'))) %>%
  filter(value >0) %>% 
  ggplot(aes(value))+
  theme(legend.position = 'top') + 
  # geom_density(aes(fill = set, color = set), alpha = .3)+
  geom_histogram(aes(fill = set), alpha = .8, position='dodge')+
  facet_grid(filt~name, scales = 'free')
```

```{r fig.width=6, fig.height=10}
tmp %>% 
  rename(set = name, gene = value) %>% 
  pivot_longer(Overall:OmicsScore) %>% 
  mutate(filt = fct_relevel(filt, c('none','node','edge','node_edge'))) %>%
  filter(value > 0) %>% 
  ggplot(aes(value))+
  theme(legend.position = 'top') + 
  # geom_density(aes(fill = set, color = set), alpha = .3)+
  geom_histogram(aes(fill = set), alpha = .8, position='dodge')+
  facet_grid(bd~name, scales = 'free')
```

```{r fig.width=6, fig.height=7}
tmp %>% 
  filter( !(bd %in% c('APP Metabolism','Tau Homeostasis')) ) %>% 
  rename(set = name, gene = value) %>% 
  # pivot_longer(Overall:OmicsScore) %>% 
  mutate(filt = fct_relevel(filt, c('none','node','edge','node_edge'))) %>%
  # filter(value > 0) %>% 
  ggplot(aes(Overall))+
  theme(legend.position = 'top') + 
  # geom_density(aes(fill = set, color = set), alpha = .3)+
  geom_histogram(aes(fill = set), alpha = .8, position='dodge')+
  facet_grid(bd~filt, scales = 'free')
```

```{r fig.width=5, fig.height=6}
tmp %>% 
  filter( !(bd %in% c('Tau Homeostasis')),
          filt == 'node_edge' ) %>% 
  rename(set = name, gene = value) %>% 
  ggplot(aes(Overall))+
  theme(legend.position = 'top') + 
  geom_histogram(aes(fill = set), alpha = .8, position='dodge')+
  facet_wrap(~bd, scales = 'free', nrow = 3)
```

### Biodom Enrichment - NW nodes

```{r}
gl <- nw.dat %>% 
  filter(bd.filt) %>% 
  select(-name) %>%
  relocate(nodes, .after = le_genes) %>% 
  pivot_longer(nodes:added_genes) %>% 
  rowwise() %>% 
  mutate(
    enr = gprofiler2::gost( query = unlist(value), 
                            organism = 'hsapiens',
                            domain_scope = 'custom',
                            custom_bg = names(V(base_net)), 
                            sources = 'GO'
                            ) %>% 
      .$result %>% 
      list(),
    enr = anno.enr(enr,
                   GO_ID_column = 'term_id',
                   biodomain_table = biodom,
                   domain_colors = biodom %>% select(domain = Biodomain, abbr:color) %>% distinct()) %>%
      list()
  ) %>% select(bd:dir, name, value, enr) %>% 
  unnest(enr)
```

```{r warning=FALSE, fig.width=9, fig.height=7}
tmp <- gl %>% 
  filter(name == 'input_genes',
         filt == 'node',
         dir == 'undirected', 
         Biodomain != 'none')

bdt <- bd.tally(tmp %>% filter(p_value <= 0.05) %>% pull(term_name), biodom)
 
tmp = tmp %>% 
  rowwise() %>% 
  mutate(bd = paste0(bd,'\n', length(unique(unlist(value))), ' input genes') ) %>% 
  mutate(Biodomain = factor(Biodomain, 
                            levels = bdt$domain %>% 
                              str_subset('none', negate = T) %>%
                              c('none',.))
         ) 

tmp %>% 
  ggplot(aes(-log10(p_value), Biodomain))+
  geom_violin(data = subset(tmp, p_value <= 0.05), aes(color = color), scale = 'width')+
  geom_jitter(data = subset(tmp, p_value <= 0.05), aes(color = color), alpha = .7)+
  scale_color_identity()+
  # xlim(c(0,30))+
  labs(y = '', title = 'Input Genes')+
  facet_wrap(~bd, scales = 'free_x', ncol = 4)
```

```{r warning=FALSE, fig.width=9, fig.height=7}
tmp <- gl %>% 
  filter(name == 'nodes',
         filt == 'node',
         dir == 'undirected', 
         Biodomain != 'none')

bdt <- bd.tally(tmp %>% filter(p_value <= 0.05) %>% pull(term_name), biodom)
 
tmp = tmp %>% 
  rowwise() %>% 
  mutate(bd = paste0(bd,'\n', length(unique(unlist(value))), ' total nodes') ) %>% 
  mutate(Biodomain = factor(Biodomain, 
                            levels = bdt$domain %>% 
                              str_subset('none', negate = T) %>%
                              c('none',.))
         ) 

tmp %>% 
  ggplot(aes(-log10(p_value), Biodomain))+
  geom_violin(data = subset(tmp, p_value <= 0.05), aes(color = color), scale = 'width')+
  geom_jitter(data = subset(tmp, p_value <= 0.05), aes(color = color), alpha = .7)+
  scale_color_identity()+
  # xlim(c(0,30))+
  labs(y = '', title = 'Network Nodes')+
  facet_wrap(~bd, scales = 'free_x', ncol = 4)
```

```{r warning=FALSE, fig.width=9, fig.height=7}
tmp <- gl %>% 
  filter(name == 'added_genes',
         filt == 'node',
         dir == 'undirected', 
         Biodomain != 'none')

bdt <- bd.tally(tmp %>% filter(p_value <= 0.05) %>% pull(term_name), biodom)
 
tmp = tmp %>% 
  rowwise() %>% 
  mutate(bd = paste0(bd,'\n', length(unique(unlist(value))), ' nodes added') ) %>% 
  mutate(Biodomain = factor(Biodomain, 
                            levels = bdt$domain %>% 
                              str_subset('none', negate = T) %>%
                              c('none',.)),
         ) 

tmp %>% 
  ggplot(aes(-log10(p_value), Biodomain))+
  geom_violin(data = subset(tmp, p_value <= 0.05), aes(color = color), scale = 'width')+
  geom_jitter(data = subset(tmp, p_value <= 0.05), aes(color = color), alpha = .7)+
  scale_color_identity()+
  # xlim(c(0,30))+
  labs(y = '', title = 'Nodes Added by Pathway Tracing')+
  facet_wrap(~bd, scales = 'free_x', ncol = 4)
```


```{r warning=FALSE, fig.width=7, fig.height=10}
tmp <- gl %>% 
  filter(bd == 'Mitochondrial Metabolism', 
         dir == 'undirected',
         Biodomain != 'none')

bdt <- bd.tally(tmp %>% filter(p_value <= 0.05) %>% pull(term_name), biodom)
 
tmp = tmp %>% 
  mutate(Biodomain = factor(Biodomain, 
                            levels = bdt$domain %>% 
                              str_subset('none', negate = T) %>%
                              c('none',.))
         ) 

tmp %>% 
  ggplot(aes(-log10(p_value), Biodomain))+
  geom_violin(data = subset(tmp, p_value <= 0.05), aes(color = color), scale = 'width')+
  geom_jitter(data = subset(tmp, p_value <= 0.05), aes(color = color), alpha = .7)+
  scale_color_identity()+
  # xlim(c(0,30))+
  labs(y = '', title = unique(tmp$bd))+
  facet_grid(filt+dir~name, scales = 'free_x')
```

```{r warning=FALSE, fig.width=7, fig.height=10}
tmp <- gl %>% 
  filter(bd == 'APP Metabolism', 
         dir == 'undirected',
         Biodomain != 'none')

bdt <- bd.tally(tmp %>% filter(p_value <= 0.05) %>% pull(term_name), biodom)
 
tmp = tmp %>% 
  mutate(Biodomain = factor(Biodomain, 
                            levels = bdt$domain %>% 
                              str_subset('none', negate = T) %>%
                              c('none',.))
         ) 

tmp %>% 
  ggplot(aes(-log10(p_value), Biodomain))+
  geom_violin(data = subset(tmp, p_value <= 0.05), aes(color = color), scale = 'width')+
  geom_jitter(data = subset(tmp, p_value <= 0.05), aes(color = color), alpha = .7)+
  scale_color_identity()+
  # xlim(c(0,30))+
  labs(y = '', title = unique(tmp$bd))+
  facet_grid(filt+dir~name, scales = 'free_x')
```

```{r warning=FALSE, fig.width=7, fig.height=10}
tmp <- gl %>% 
  filter(bd == 'Immune Response', 
         dir == 'undirected',
         Biodomain != 'none')

bdt <- bd.tally(tmp %>% filter(p_value <= 0.05) %>% pull(term_name), biodom)
 
tmp = tmp %>% 
  mutate(Biodomain = factor(Biodomain, 
                            levels = bdt$domain %>% 
                              str_subset('none', negate = T) %>%
                              c('none',.))
         ) 

tmp %>% 
  ggplot(aes(-log10(p_value), Biodomain))+
  geom_violin(data = subset(tmp, p_value <= 0.05), aes(color = color), scale = 'width')+
  geom_jitter(data = subset(tmp, p_value <= 0.05), aes(color = color), alpha = .7)+
  scale_color_identity()+
  # xlim(c(0,30))+
  labs(y = '', title = unique(tmp$bd))+
  facet_grid(filt+dir~name, scales = 'free_x')
```

```{r warning=FALSE, fig.width=7, fig.height=10}
tmp <- gl %>% 
  filter(bd == 'Endolysosome', 
         dir == 'undirected',
         Biodomain != 'none')

bdt <- bd.tally(tmp %>% filter(p_value <= 0.05) %>% pull(term_name), biodom)
 
tmp = tmp %>% 
  mutate(Biodomain = factor(Biodomain, 
                            levels = bdt$domain %>% 
                              str_subset('none', negate = T) %>%
                              c('none',.))
         ) 

tmp %>% 
  ggplot(aes(-log10(p_value), Biodomain))+
  geom_violin(data = subset(tmp, p_value <= 0.05), aes(color = color), scale = 'width')+
  geom_jitter(data = subset(tmp, p_value <= 0.05), aes(color = color), alpha = .7)+
  scale_color_identity()+
  # xlim(c(0,30))+
  labs(y = '', title = unique(tmp$bd))+
  facet_grid(filt+dir~name, scales = 'free_x')
```

```{r warning=FALSE, fig.width=7, fig.height=10}
tmp <- gl %>% 
  filter(bd == 'Synapse', 
         dir == 'undirected',
         Biodomain != 'none')

bdt <- bd.tally(tmp %>% filter(p_value <= 0.05) %>% pull(term_name), biodom)
 
tmp = tmp %>% 
  mutate(Biodomain = factor(Biodomain, 
                            levels = bdt$domain %>% 
                              str_subset('none', negate = T) %>%
                              c('none',.))
         ) 

tmp %>% 
  ggplot(aes(-log10(p_value), Biodomain))+
  geom_violin(data = subset(tmp, p_value <= 0.05), aes(color = color), scale = 'width')+
  geom_jitter(data = subset(tmp, p_value <= 0.05), aes(color = color), alpha = .7)+
  scale_color_identity()+
  # xlim(c(0,30))+
  labs(y = '', title = unique(tmp$bd))+
  facet_grid(filt+dir~name, scales = 'free_x')
```

## APP Metabolism
```{r}
dom = 'APP Metabolism'
```

### NW properties
Global properties of biodomain-filtered path traced networks
```{r fig.width=5, fig.height=7}
nw.dat %>%
  filter(bd == dom, bd.filt) %>%
  select(-s.edges, -le_genes, -s.nodes) %>% 
  mutate(
    network = paste( dir, filt, sep = '_') # bd.filt,
  ) %>% 
  rowwise() %>%
  mutate( across( edges:added_genes, ~ length(unique(unlist(.x))) ) ) %>% 
  pivot_longer(cols = c(avg_node_degree:added_genes), names_to = 'properties', values_to = 'val') %>% 
  mutate(network = factor(network, 
                       levels = rev(c('undirected_none',
                                  'undirected_node',
                                  'undirected_edge',
                                  'undirected_node_edge',
                                  'directed_none',
                                  'directed_node',
                                  'directed_edge',
                                  'directed_node_edge'))) ,
         properties = factor(properties,
                             levels = c('nodes',
                                        'edges',
                                        'input_genes',
                                        'added_genes',
                                        'avg_node_degree',
                                        'avg_path_length',
                                        'assortativity_coef',
                                        'connected_components'
                                        ))
         ) %>% 
  ggplot(aes(val, network)) +
  geom_bar(stat = 'identity', position = 'dodge', aes(fill = dir))+
  theme(legend.position = 'top')+
  labs(y = '',x = '')+
  # scale_y_log10()+
  facet_wrap(~properties, scales = 'free_x', ncol = 2)

```
### KDA results
```{r}
# synIDs of BD-specific wKDA results
kd.res = kda.dirs %>% 
  filter(bd == dom) %>% 
  select(set, bd, filt, dir, ef, id) %>%  
  # filter(dir == 'undirected') %>% 
  group_by(bd,filt,dir) %>%
  summarise( kd = list(read_kda_res(id[ef == 0 & set == 'full'],
                                    id[ef == 1 & set == 'full'],
                                    id[ef == 1 & set == 'top'])) ) %>% 
  unnest(kd) %>%  
  left_join(., 
            biodom %>% select(MODULE = GOterm_Name, Biodomain, color, abbr, label), 
            by = 'MODULE') %>% 
  ungroup() %>% 
  group_by(bd, filt, dir) %>% 
  arrange(MODULE, desc(ef1_fdr)) %>% 
  ungroup()

am.kd.res <- kd.res
```

```{r}
top <- bind_rows(
  read_tsv(synGet('syn51195712')$path, col_types = cols()) %>% mutate(ef = 'ef0'),
  read_tsv(synGet('syn51195717')$path, col_types = cols()) %>% mutate(ef = 'ef1')
)
```

```{r fig.width=6, fig.height=3}
ggplot(top, aes(FOLD, -log10(FDR) )) + 
  geom_point(alpha = .5) + 
  facet_wrap(~ef)
```

```{r}
top %>% 
  mutate(FDR = -log10(FDR)) %>% 
  pivot_wider(id_cols = c(NODE, MODULE),
              names_from = ef, values_from = FDR) %>% 
  mutate(across(c(ef0,ef1), ~ if_else(is.na(.x), 0, .x))) %>% 
  ggplot(aes(ef0, ef1))+
  geom_abline(intercept = 0, slope = 1, lty = 2)+
  geom_point(alpha = .5)+
  labs(x = '-log10(FDR)\nuniform edge weights',
       y = '-log10(FDR)\nAD risk edge weights')
```


```{r fig.width=10,fig.height=5}
# p2 = 
kd.res %>% 
  mutate(dir = fct_relevel(dir, c('undirected','directed')),
         filt = fct_relevel(filt, c('none','node','edge','node_edge'))) %>% 
  ggplot(aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = unique(kd.res$bd))+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 2, aes(color = color))+
  # ggrepel::geom_label_repel(
  #   data = subset( kd.res, ef1_fdr > -log10(0.05)
  #                  & top == 1
  #                  & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
  #                  & delta_fdr > 0
  #                  ),
  #   aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
  #   size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(dir~filt, scales = 'free', ncol = 4)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

```{r fig.width=6,fig.height=6}
# p2 = 
tmp <- kd.res %>% filter(dir == 'undirected', filt=='edge') %>% 
  mutate(dir = fct_relevel(dir, c('undirected','directed')),
         filt = fct_relevel(filt, c('none','node','edge','node_edge'))) 
  
ggplot(tmp, aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = unique(kd.res$bd))+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(tmp, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0 )
             , alpha = .6, size = 2, aes(color = color))+
  ggrepel::geom_label_repel(
    data = subset( tmp, ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                   & delta_fdr > 0
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(dir~filt, scales = 'free', ncol = 4)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

```{r fig.width=6,fig.height=6}
# p2 = 
tmp <- kd.res %>% filter(dir == 'undirected', filt=='node') %>% 
  mutate(dir = fct_relevel(dir, c('undirected','directed')),
         filt = fct_relevel(filt, c('none','node','edge','node_edge'))) 
  
ggplot(tmp, aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = unique(kd.res$bd))+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(tmp, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0 )
             , alpha = .6, size = 2, aes(color = color))+
  ggrepel::geom_label_repel(
    data = subset( tmp, ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                   & delta_fdr > 0
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(dir~filt, scales = 'free', ncol = 4)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

### KD ~ Biodomains

```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(filt, dir, Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter(!is.na(filt), !is.na(dir)) %>% 
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_term)) %>% 
  arrange(Biodomain, desc(n_term), desc(max_delta)) %>% 
  ggplot(aes(n_term, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(unique(kd.res$bd), ' Network Key Drivers'),
       subtitle = 'Biodomain GO terms')+ 
  theme(legend.position = 'bottom')+
  facet_wrap(dir~filt, ncol = 4)
```


```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(filt, dir, Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% select(Biodomain, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  arrange(desc(n_node), desc(max_delta), .by_group = T) %>% 
  ungroup() %>% 
  filter(!is.na(filt), !is.na(dir)) %>% 
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_node)) %>%
  ggplot(aes(n_node, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(unique(kd.res$bd), ' Network Key Drivers'),
       subtitle = 'Nodes')+ 
  theme(legend.position = 'bottom')+
  facet_wrap(dir~filt, ncol = 4)
```

```{r fig.width=10,fig.height=10}
tmp <- kd.res %>% 
  filter( 
    ef1_fdr > -log10(0.05)
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
    , delta_fdr > 0 ,
    dir == 'undirected'
    , filt == 'node'
         )

ggplot(tmp, aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', 
       title = paste0(unique(tmp$bd), ': ', unique(tmp$dir),', ',unique(tmp$filt)),
       subtitle = 'signif KDs (EF1 FDR < 0.05), \u0394 FDR > 0, for GSEA-enriched terms'
       )+
  # geom_abline(intercept = 0, slope =1, lty= 2, lwd = .5)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 2, aes(color = color))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                   & delta_fdr > 0
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(~Biodomain)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

```{r}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>% 
  group_by(filt, dir, Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_term), desc(max_delta), .by_group = T) %>%
  DT::datatable(rownames = F, filter = 'top')
```

### Top KDs
```{r}
kd.summary = kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         ) %>% 
  group_by(NODE, filt, dir) %>% 
  summarise(n_bd = length(unique(Biodomain)),
            bds = list(unique(Biodomain)),
            n_term = length(unique(MODULE)),
            terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_bd), desc(max_delta)) %>% 
  mutate(LE_gene = if_else(NODE %in% input.gene.list, 'Y', 'N')) %>% 
  relocate(LE_gene, .after = 'NODE')

DT::datatable(kd.summary %>% select(-bds, -terms), rownames = F, filter = 'top')
```

```{r}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , top == 1
         , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         ) %>% 
  select(bd, dir, filt, NODE, MODULE, MEMBER, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>% 
  mutate(LE_gene = if_else(NODE %in% input.gene.list, 'Y', 'N')) %>% 
  relocate(LE_gene, .after = 'NODE') %>% 
  DT::datatable(., rownames = F, filter = 'top') %>% 
  DT::formatSignif(columns = c('ef0_fdr','ef1_fdr','delta_fdr'))
```

### KDs ~ CBrain phenotypes
```{r fig.width=10, fig.height=5}
# crispr brain phenotype hits (any) vs non-hits
cb.hits = simple %>% filter(`Hit Class` != 'Non-Hit') %>% 
  pull(Gene) %>% unique()
cb.nonhits = simple %>% filter( (Gene %in% cb.hits)==F ) %>% 
  pull(Gene) %>% unique()

# ID key drivers from different parameter sets
comb = kd.res %>% select(filt, dir) %>% distinct() %>% arrange(dir,filt)
comb$kd.hits = map(
  1:nrow(comb),
  ~ kd.res %>% filter(ef1_fdr > -log10(0.05), 
                      filt == comb$filt[.x],
                      dir == comb$dir[.x]) %>% pull(NODE) %>% unique()
)
comb$kd.nonhits = map(
  1:nrow(comb),
  ~ kd.res %>% filter( (NODE %in% comb$kd.hits[[.x]])==F ) %>% 
    pull(NODE) %>% unique()
)

# calculate fisher stats 
comb = map_dfr(
  1:nrow(comb),
  ~ bind_cols(
      pheno_kd = intersect(cb.hits, comb$kd.hits[[.x]]) %>% length(),
      noPheno_kd = intersect(cb.nonhits, comb$kd.hits[[.x]]) %>% length(),
      pheno_nokd = intersect(cb.hits, comb$kd.nonhits[[.x]]) %>% length(),
      noPheno_nokd = intersect(cb.nonhits, comb$kd.nonhits[[.x]]) %>% length()
    ) %>% 
    rowwise() %>% mutate(
      fisher.p = matrix(c(pheno_kd, noPheno_kd, pheno_nokd, noPheno_nokd), 
                        nrow = 2) %>% 
      fisher.test( ., alt = 'g') %>% broom::tidy() %>% pull(p.value)
    )
) %>% 
  bind_cols(comb, .)

# make plots for each comb
plist = purrr::map(
  1:nrow(comb),
  ~ {
    # grid::grid.newpage()
    VennDiagram::venn.diagram(
      x = list(
        CRISPRbrain = cb.hits, 
        KeyDrivers = comb$kd.hits[[.x]]
      ),
      filename = NULL,
      force.unique = T,
      lty = 0, alpha = .3, fill = c('light blue','pink'),
      hyper.test = T, 
      total.population = length(intersect(simple$Gene, names(V(base_net)))),
      
      # main = kd.res$bd %>% unique,
      main = paste0(
              comb$dir[.x],' | filt: ', comb$filt[.x],
              ' | Fisher p = ', comb$fisher.p[.x] %>% signif(digits = 2) ),
      main.cex = .75, sub.cex = .75,
      # cat.pos = c(315,45),
      cat.cex = .8,
      ext.pos = 180,
      ext.dist = -.1
      ) }
)

cowplot::plot_grid(plotlist = plist, ncol = 4)

```

linear regression  ~ KDA FDR
```{r}
tmp <- kd.res %>% inner_join( simple,., by =c('Gene'='NODE')) %>% 
  group_by(cell,mode,expt, bd, filt, dir) %>% 
  mutate(lm = lm(abs(gene_score)~ef1_fdr) %>% broom::tidy() %>% 
           filter(term != '(Intercept)') %>% 
           mutate(r.squared = lm(abs(gene_score)~ef1_fdr) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(abs(gene_score)~delta_fdr) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, bd.nw = bd, nw.filt = filt, nw.dir=dir, term:nobs) %>% distinct() %>% 
  filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

tmp %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ ef1_fdr', options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```

```{r fig.width=10, fig.height=8}
c = 'Glutamatergic Neuron'
m = 'CRISPRi'
e = 'PSAP KO-Survival'

kd.res %>% inner_join( simple,., by =c('Gene'='NODE')) %>%
  filter(
    cell == c,
    mode == m,
    expt == e,
    # ef1_fdr > -log10(0.2)
    ) %>% 
  ggplot( aes( ef1_fdr, abs(gene_score) )) +
  geom_point(#data = subset(tmp, d > 0),
             aes(color = color,  size = delta_fdr), alpha = .5) +
  geom_hline(yintercept = 0, lwd = 0.5)+
  geom_vline(xintercept = 0, lwd = 0.5)+
  scale_size_continuous(name = 'KDA \u0394 FDR\nef1-ef0', range = c(.5,3))+ 
  # ggrepel::geom_label_repel(
  #   data = subset(tmp, d > 0), aes(label = paste0(Gene,'\n', go)),
  #   min.segment.length = 0, size = 2.5, max.overlaps = 12)+
  scale_color_identity(guide = 'none')+
  geom_smooth(method = 'lm', color = 'grey20',lty=2)+
  labs(y = 'CRISPRbrain phenotype score, absolute value',
       x = 'KDA FDR, -log10',
       title = paste0(c,', ',m,', ',e)) + 
  facet_wrap(dir~filt, scales = 'free_x')
```

linear regression ~  KDA delta FDR e1/e0
```{r}
tmp <- kd.res %>% inner_join( simple,., by =c('Gene'='NODE')) %>% 
  group_by(cell,mode,expt, bd, filt, dir) %>% 
  mutate(lm = lm(abs(gene_score)~delta_fdr) %>% broom::tidy() %>% 
           filter(term != '(Intercept)') %>% 
           mutate(r.squared = lm(abs(gene_score)~delta_fdr) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(abs(gene_score)~delta_fdr) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm) %>% 
  select(cell, mode, expt, bd, filt, dir, term:nobs) %>% distinct() %>% 
  filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value) 

tmp %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ \u0394 fdr (ef1-ef0)', options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```

```{r fig.width=10, fig.height=5}
c = 'iAstrocyte'
m = 'CRISPRi'
e = 'Phagocytosis-Veh'

kd.res %>% inner_join( simple,., by =c('Gene'='NODE')) %>%
  filter(
    cell == c,
    mode == m,
    expt == e,
    ef1_fdr > -log10(0.2)
    ) %>% 
  ggplot( aes( delta_fdr, abs(gene_score) )) +
  geom_point(#data = subset(tmp, d > 0),
             aes(color = color,  size = ef1_fdr), alpha = .5) +
  geom_hline(yintercept = 0, lwd = 0.5)+
  geom_vline(xintercept = 0, lwd = 0.5)+
  scale_size_continuous(name = 'KDA \u0394 FDR\nef1-ef0', range = c(.5,3))+ 
  # ggrepel::geom_label_repel(
  #   data = subset(tmp, d > 0), aes(label = paste0(Gene,'\n', go)),
  #   min.segment.length = 0, size = 2.5, max.overlaps = 12)+
  scale_color_identity(guide = 'none')+
  geom_smooth(method = 'lm', color = 'grey20',lty=2)+
  labs(y = 'CRISPRbrain phenotype score, absolute value',
       x = 'KDA FDR, -log10',
       title = paste0(c,', ',m,', ',e)) + 
  facet_grid(dir~filt, scales = 'free_x')
```

### KD subnetworks
pull NW to view subgraphs
```{r}
nw = nw.tbl %>% 
  filter(
    dir == 'undirected', 
    filt == 'node_edge', 
    bd.filt == T
    ) %>% 
  pull(id) %>% 
  synGet(.) %>% 
  .$path %>% 
  read_graph(., format = 'graphml' )
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'GRIN2B',term = 'postsynaptic density') )
p
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'APP', term = 'regulation of apoptotic process') )
p
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'MAPT', term = 'positive regulation of neuron death') )
p
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'DLG1', term = 'neuron to neuron synapse') )
p
```

<!-- ```{r} -->
<!-- kd = 'DLG1' -->
<!-- term = 'neuron to neuron synapse' -->

<!-- vert_num <- match(kd, V(nw)$name) -->
<!-- vert_neigh <- neighbors(nw, vert_num) %>% names() -->
<!-- vert_neigh_num <- match(vert_neigh, V(nw)$name) -->

<!-- term_num <- biodom %>% -->
<!--   filter(GOterm_Name == term) %>% -->
<!--   pull(symbol) %>% unlist() %>% -->
<!--   match(., V(nw)$name) %>% .[!is.na(.)] -->

<!-- term_neigh <- map_chr(1:length(term_num), -->
<!--                       ~ neighbors(nw, term_num[.x]) %>% names()) -->
<!-- term_neigh_num <- match(term_neigh, V(nw)$name) -->

<!-- g2 <- induced_subgraph(nw, c(vert_num, intersect(term_neigh, vert_neigh))) -->
<!-- g3 <- induced_subgraph(nw, c(vert_num, term_neigh)) -->

<!-- cowplot::plot_grid( -->

<!--   ggraph(g3, layout = 'linear', circular = TRUE) + -->
<!--     geom_edge_arc(alpha = .3, color = 'grey75') + -->
<!--     geom_node_point( shape = 21, color = "black", alpha = .3, -->
<!--       aes(size = TargetRiskScore, fill = Pro_EffectScore, filter= .N()$name != kd)  )+ -->
<!--     geom_node_point( shape = 23, color = "black", alpha = .3, -->
<!--       aes(size = TargetRiskScore, fill = Pro_EffectScore, filter = .N()$name == kd) )+ -->
<!--     geom_node_text(aes(label = name), size = 2) + -->
<!--     coord_fixed() + -->
<!--     scale_size_continuous( range = c(.5, 10), limits = c(0, 5), trans = 'exp')+ -->
<!--     scale_fill_gradient2( -->
<!--       low = 'purple', mid = 'black', high = 'green', na.value = 'grey85', -->
<!--       limits = c(-2.5,2.5) )+ #approx: range(omics$Pro_TE, na.rm = T) -->
<!--     labs( title = 'All term genes in NW', -->
<!--           subtitle = paste0('KD: ', kd, '\nTerm: ', term) )+ -->
<!--     theme_graph(background = 'white') -->
<!--   , -->
<!--   ggraph(g2, layout = 'linear', circular = TRUE) + -->
<!--           geom_edge_arc(alpha = .3, color = 'grey75') + -->
<!--     geom_node_point( shape = 21, color = "black", alpha = .3, -->
<!--       aes(size = TargetRiskScore, fill = Pro_EffectScore, filter= .N()$name != kd)  )+ -->
<!--     geom_node_point( shape = 23, color = "black", alpha = .3, -->
<!--       aes(size = TargetRiskScore, fill = Pro_EffectScore, filter = .N()$name == kd) )+ -->
<!--     geom_node_text(aes(label = name), size = 2) + -->
<!--     coord_fixed() + -->
<!--     scale_size_continuous( range = c(.5, 10), limits = c(0, 5), trans = 'exp')+ -->
<!--     scale_fill_gradient2( -->
<!--       low = 'purple', mid = 'black', high = 'green', na.value = 'grey85', -->
<!--       limits = c(-2.5,2.5) )+ #approx: range(omics$Pro_TE, na.rm = T) -->
<!--     labs( title = 'Term genes & KD neighbors in NW', -->
<!--           subtitle = paste0('KD: ', kd, '\nTerm: ', term) )+ -->
<!--     theme_graph(background = 'white') -->
<!--   , -->
<!--   ncol = 2 -->

<!-- ) -->

<!-- ``` -->


## Tau Homeostasis
```{r}
dom = 'Tau Homeostasis'
```


### NW properties
Global properties of biodomain-filtered path traced networks
```{r fig.width=5, fig.height=7}
nw.dat %>%
  filter(bd == dom, bd.filt) %>%
  select(-s.edges, -le_genes, -s.nodes) %>% 
  mutate(
    network = paste( dir, filt, sep = '_') # bd.filt,
  ) %>% 
  rowwise() %>%
  mutate( across( edges:added_genes, ~ length(unique(unlist(.x))) ) ) %>% 
  pivot_longer(cols = c(avg_node_degree:added_genes), names_to = 'properties', values_to = 'val') %>% 
  mutate(network = factor(network, 
                       levels = rev(c('undirected_none',
                                  'undirected_node',
                                  'undirected_edge',
                                  'undirected_node_edge',
                                  'directed_none',
                                  'directed_node',
                                  'directed_edge',
                                  'directed_node_edge'))) ,
         properties = factor(properties,
                             levels = c('nodes',
                                        'edges',
                                        'input_genes',
                                        'added_genes',
                                        'avg_node_degree',
                                        'avg_path_length',
                                        'assortativity_coef',
                                        'connected_components'
                                        ))
         ) %>% 
  ggplot(aes(val, network)) +
  geom_bar(stat = 'identity', position = 'dodge', aes(fill = dir))+
  theme(legend.position = 'top')+
  labs(y = '',x = '')+
  # scale_y_log10()+
  facet_wrap(~properties, scales = 'free_x', ncol = 2)

```
### KDA results
```{r}
# synIDs of BD-specific wKDA results
kd.res = kda.dirs %>% 
  filter(bd == dom) %>% 
  select(set, bd, filt, dir, ef, id) %>%  
  # filter(dir == 'undirected') %>% 
  group_by(bd,filt,dir) %>%
  summarise( kd = list(read_kda_res(id[ef == 0 & set == 'full'],
                                    id[ef == 1 & set == 'full'],
                                    id[ef == 1 & set == 'top'])) ) %>% 
  unnest(kd) %>%  
  left_join(., 
            biodom %>% select(MODULE = GOterm_Name, Biodomain, color, abbr, label), 
            by = 'MODULE') %>% 
  ungroup() %>% 
  group_by(bd, filt, dir) %>% 
  arrange(MODULE, desc(ef1_fdr)) %>% 
  ungroup()

th.kd.res <- kd.res
```

```{r fig.width=10,fig.height=5}
# p2 = 
kd.res %>% 
  mutate(dir = fct_relevel(dir, c('undirected','directed')),
         filt = fct_relevel(filt, c('none','node','edge','node_edge'))) %>% 
  ggplot(aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = unique(kd.res$bd))+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 2, aes(color = color))+
  # ggrepel::geom_label_repel(
  #   data = subset( kd.res, ef1_fdr > -log10(0.05)
  #                  & top == 1
  #                  & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
  #                  & delta_fdr > 0
  #                  ),
  #   aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
  #   size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(dir~filt, scales = 'free', ncol = 4)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

```{r fig.width=6,fig.height=6}
# p2 = 
tmp <- kd.res %>% filter(dir == 'undirected', filt=='edge') %>% 
  mutate(dir = fct_relevel(dir, c('undirected','directed')),
         filt = fct_relevel(filt, c('none','node','edge','node_edge'))) 
  
ggplot(tmp, aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = unique(kd.res$bd))+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(tmp, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0 )
             , alpha = .6, size = 2, aes(color = color))+
  ggrepel::geom_label_repel(
    data = subset( tmp, ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                   & delta_fdr > 0
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(dir~filt, scales = 'free', ncol = 4)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

```{r fig.width=6,fig.height=6}
# p2 = 
tmp <- kd.res %>% filter(dir == 'undirected', filt=='node') %>% 
  mutate(dir = fct_relevel(dir, c('undirected','directed')),
         filt = fct_relevel(filt, c('none','node','edge','node_edge'))) 
  
ggplot(tmp, aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = unique(kd.res$bd))+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(tmp, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0 )
             , alpha = .6, size = 2, aes(color = color))+
  ggrepel::geom_label_repel(
    data = subset( tmp, ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                   & delta_fdr > 0
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(dir~filt, scales = 'free', ncol = 4)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

### KD ~ Biodomains

```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(filt, dir, Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter(!is.na(filt), !is.na(dir)) %>% 
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_term)) %>% 
  arrange(Biodomain, desc(n_term), desc(max_delta)) %>% 
  ggplot(aes(n_term, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(unique(kd.res$bd), ' Network Key Drivers'),
       subtitle = 'Biodomain GO terms')+ 
  theme(legend.position = 'bottom')+
  facet_wrap(dir~filt, ncol = 4)
```


```{r, fig.width=8}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(filt, dir, Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% select(Biodomain, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  arrange(desc(n_node), desc(max_delta), .by_group = T) %>% 
  ungroup() %>% 
  filter(!is.na(filt), !is.na(dir)) %>% 
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_node)) %>%
  ggplot(aes(n_node, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(unique(kd.res$bd), ' Network Key Drivers'),
       subtitle = 'Nodes')+ 
  theme(legend.position = 'bottom')+
  facet_wrap(dir~filt, ncol = 4)
```

```{r fig.width=10,fig.height=10}
tmp <- kd.res %>% 
  filter( 
    ef1_fdr > -log10(0.05)
    , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
    , delta_fdr > 0 ,
    dir == 'undirected'
    , filt == 'node'
         )

ggplot(tmp, aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', 
       title = paste0(unique(tmp$bd), ': ', unique(tmp$dir),', ',unique(tmp$filt)),
       subtitle = 'signif KDs (EF1 FDR < 0.05), \u0394 FDR > 0, for GSEA-enriched terms'
       )+
  # geom_abline(intercept = 0, slope =1, lty= 2, lwd = .5)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0)
             , alpha = .6, size = 2, aes(color = color))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, ef1_fdr > -log10(0.05)
                   & top == 1
                   & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                   & delta_fdr > 0
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(~Biodomain)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

```{r}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top == 1
         ) %>% 
  group_by(filt, dir, Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_term), desc(max_delta), .by_group = T) %>%
  DT::datatable(rownames = F, filter = 'top')
```

### Top KDs
```{r}
kd.summary = kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         ) %>% 
  group_by(NODE, filt, dir) %>% 
  summarise(n_bd = length(unique(Biodomain)),
            bds = list(unique(Biodomain)),
            n_term = length(unique(MODULE)),
            terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_bd), desc(max_delta)) %>% 
  mutate(LE_gene = if_else(NODE %in% input.gene.list, 'Y', 'N')) %>% 
  relocate(LE_gene, .after = 'NODE')

DT::datatable(kd.summary %>% select(-bds, -terms), rownames = F, filter = 'top')
```

```{r}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , top == 1
         , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         ) %>% 
  select(bd, dir, filt, NODE, MODULE, MEMBER, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>% 
  mutate(LE_gene = if_else(NODE %in% input.gene.list, 'Y', 'N')) %>% 
  relocate(LE_gene, .after = 'NODE') %>% 
  DT::datatable(., rownames = F, filter = 'top') %>% 
  DT::formatSignif(columns = c('ef0_fdr','ef1_fdr','delta_fdr'))
```

### KDs ~ CBrain phenotypes
```{r fig.width=10, fig.height=3}
# crispr brain phenotype hits (any) vs non-hits
cb.hits = simple %>% filter(`Hit Class` != 'Non-Hit') %>% 
  pull(Gene) %>% unique()
cb.nonhits = simple %>% filter( (Gene %in% cb.hits)==F ) %>% 
  pull(Gene) %>% unique()

# ID key drivers from different parameter sets
comb = kd.res %>% select(filt, dir) %>% distinct() %>% arrange(dir,filt)
comb$kd.hits = map(
  1:nrow(comb),
  ~ kd.res %>% filter(ef1_fdr > -log10(0.05), 
                      filt == comb$filt[.x],
                      dir == comb$dir[.x]) %>% pull(NODE) %>% unique()
)
comb$kd.nonhits = map(
  1:nrow(comb),
  ~ kd.res %>% filter( (NODE %in% comb$kd.hits[[.x]])==F ) %>% 
    pull(NODE) %>% unique()
)

# calculate fisher stats 
comb = map_dfr(
  1:nrow(comb),
  ~ bind_cols(
      pheno_kd = intersect(cb.hits, comb$kd.hits[[.x]]) %>% length(),
      noPheno_kd = intersect(cb.nonhits, comb$kd.hits[[.x]]) %>% length(),
      pheno_nokd = intersect(cb.hits, comb$kd.nonhits[[.x]]) %>% length(),
      noPheno_nokd = intersect(cb.nonhits, comb$kd.nonhits[[.x]]) %>% length()
    ) %>% 
    rowwise() %>% mutate(
      fisher.p = matrix(c(pheno_kd, noPheno_kd, pheno_nokd, noPheno_nokd), 
                        nrow = 2) %>% 
      fisher.test( ., alt = 'g') %>% broom::tidy() %>% pull(p.value)
    )
) %>% 
  bind_cols(comb, .)

# make plots for each comb
plist = purrr::map(
  1:nrow(comb),
  ~ {
    # grid::grid.newpage()
    VennDiagram::venn.diagram(
      x = list(
        CRISPRbrain = cb.hits, 
        KeyDrivers = comb$kd.hits[[.x]]
      ),
      filename = NULL,
      force.unique = T,
      lty = 0, alpha = .3, fill = c('light blue','pink'),
      hyper.test = T, 
      total.population = length(intersect(simple$Gene, names(V(base_net)))),
      
      # main = kd.res$bd %>% unique,
      main = paste0(
              comb$dir[.x],' | filt: ', comb$filt[.x],
              ' | Fisher p = ', comb$fisher.p[.x] %>% signif(digits = 2) ),
      main.cex = .75, sub.cex = .75,
      # cat.pos = c(315,45),
      cat.cex = .8,
      ext.pos = 180,
      ext.dist = -.1
      ) }
)

cowplot::plot_grid(plotlist = plist, ncol = 4)

```

linear regression  ~ KDA FDR
```{r}
tmp <- kd.res %>% inner_join( simple,., by =c('Gene'='NODE')) %>% 
  group_by(cell,mode,expt, bd, filt, dir) %>% 
  mutate(lm = lm(abs(gene_score)~ef1_fdr) %>% broom::tidy() %>% 
           filter(term != '(Intercept)') %>% 
           mutate(r.squared = lm(abs(gene_score)~ef1_fdr) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(abs(gene_score)~delta_fdr) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, bd.nw = bd, nw.filt = filt, nw.dir=dir, term:r.squared) %>% distinct() %>% 
  filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

tmp %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ ef1_fdr', options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```

<!-- ```{r fig.width=10, fig.height=5} -->
<!-- c = 'Glutamatergic Neuron' -->
<!-- m = 'CRISPRi' -->
<!-- e = 'FeRhoNox' -->

<!-- kd.res %>% inner_join( simple,., by =c('Gene'='NODE')) %>% -->
<!--   filter( -->
<!--     cell == c, -->
<!--     mode == m, -->
<!--     expt == e, -->
<!--     ef1_fdr > -log10(0.2) -->
<!--     ) %>%  -->
<!--   ggplot( aes( ef1_fdr, abs(gene_score) )) + -->
<!--   geom_point(#data = subset(tmp, d > 0), -->
<!--              aes(color = color,  size = delta_fdr), alpha = .5) + -->
<!--   geom_hline(yintercept = 0, lwd = 0.5)+ -->
<!--   geom_vline(xintercept = 0, lwd = 0.5)+ -->
<!--   scale_size_continuous(name = 'KDA \u0394 FDR\nef1-ef0', range = c(.5,3))+  -->
<!--   # ggrepel::geom_label_repel( -->
<!--   #   data = subset(tmp, d > 0), aes(label = paste0(Gene,'\n', go)), -->
<!--   #   min.segment.length = 0, size = 2.5, max.overlaps = 12)+ -->
<!--   scale_color_identity(guide = 'none')+ -->
<!--   geom_smooth(method = 'lm', color = 'grey20',lty=2)+ -->
<!--   labs(y = 'CRISPRbrain phenotype score, absolute value', -->
<!--        x = 'KDA FDR, -log10', -->
<!--        title = paste0(c,', ',m,', ',e)) +  -->
<!--   facet_grid(dir~filt, scales = 'free_x') -->
<!-- ``` -->
<!-- ```{r fig.width=10, fig.height=5} -->
<!-- c = 'Glutamatergic Neuron' -->
<!-- m = 'CRISPRi' -->
<!-- e = 'Lysotracker' -->

<!-- kd.res %>% inner_join( simple,., by =c('Gene'='NODE')) %>% -->
<!--   filter( -->
<!--     cell == c, -->
<!--     mode == m, -->
<!--     expt == e, -->
<!--     ef1_fdr > -log10(0.2) -->
<!--     ) %>%  -->
<!--   ggplot( aes( ef1_fdr, abs(gene_score) )) + -->
<!--   geom_point(#data = subset(tmp, d > 0), -->
<!--              aes(color = color,  size = delta_fdr), alpha = .5) + -->
<!--   geom_hline(yintercept = 0, lwd = 0.5)+ -->
<!--   geom_vline(xintercept = 0, lwd = 0.5)+ -->
<!--   scale_size_continuous(name = 'KDA \u0394 FDR\nef1-ef0', range = c(.5,3))+  -->
<!--   # ggrepel::geom_label_repel( -->
<!--   #   data = subset(tmp, d > 0), aes(label = paste0(Gene,'\n', go)), -->
<!--   #   min.segment.length = 0, size = 2.5, max.overlaps = 12)+ -->
<!--   scale_color_identity(guide = 'none')+ -->
<!--   geom_smooth(method = 'lm', color = 'grey20',lty=2)+ -->
<!--   labs(y = 'CRISPRbrain phenotype score, absolute value', -->
<!--        x = 'KDA FDR, -log10', -->
<!--        title = paste0(c,', ',m,', ',e)) +  -->
<!--   facet_grid(dir~filt, scales = 'free_x') -->
<!-- ``` -->

linear regression ~  KDA delta FDR e1/e0
```{r}
tmp <- kd.res %>% inner_join( simple,., by =c('Gene'='NODE')) %>% 
  group_by(cell,mode,expt, bd, filt, dir) %>% 
  mutate(lm = lm(abs(gene_score)~delta_fdr) %>% broom::tidy() %>% 
           filter(term != '(Intercept)') %>% 
           mutate(r.squared = lm(abs(gene_score)~delta_fdr) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(abs(gene_score)~delta_fdr) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm) %>% 
  select(cell, mode, expt, bd, filt, dir, term:nobs) %>% distinct() %>% 
  filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value) 

tmp %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ \u0394 fdr (ef1-ef0)', options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```


### KD subnetworks
pull NW to view subgraphs
```{r}
nw = nw.tbl %>% 
  filter(
    dir == 'undirected', 
    filt == 'none', 
    bd.filt == T
    ) %>% 
  pull(id) %>% 
  synGet(.) %>% 
  .$path %>% 
  read_graph(., format = 'graphml' )
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'MAPT',term = 'somatodendritic compartment') )
p
```


## Endolysosome
```{r}
dom = 'Endolysosome'
```

### NW properties
Global properties of biodomain-filtered path traced networks
```{r fig.width=5, fig.height=7}
nw.tbl %>%
  filter(bd.filt) %>%
  select(-s.edges, -le_genes, -s.nodes) %>% 
  mutate(
    network = paste( dir, filt, sep = '_') # bd.filt,
  ) %>% 
  rowwise() %>%
  mutate( across( edges:added_genes, ~ length(unique(unlist(.x))) ) ) %>% 
  pivot_longer(cols = c(avg_node_degree:added_genes), names_to = 'properties', values_to = 'val') %>% 
  mutate(network = factor(network, 
                       levels = rev(c('undirected_none',
                                  'undirected_node',
                                  'undirected_edge',
                                  'undirected_node_edge',
                                  'directed_none',
                                  'directed_node',
                                  'directed_edge',
                                  'directed_node_edge'))) ,
         properties = factor(properties,
                             levels = c('nodes',
                                        'edges',
                                        'input_genes',
                                        'added_genes',
                                        'avg_node_degree',
                                        'avg_path_length',
                                        'assortativity_coef',
                                        'connected_components'
                                        ))
         ) %>% 
  ggplot(aes(val, network)) +
  geom_bar(stat = 'identity', position = 'dodge', aes(fill = dir))+
  theme(legend.position = 'top')+
  labs(y = '',x = '')+
  # scale_y_log10()+
  facet_wrap(~properties, scales = 'free_x', ncol = 2)

```

### KDA results
```{r}
# synIDs of BD-specific wKDA results
kd.res = kda.dirs %>% 
  filter(bd == dom) %>% 
  select(set, bd, filt, dir, ef, id) %>%  
  # filter(dir == 'undirected') %>% 
  group_by(bd,filt,dir) %>%
  summarise( kd = list(read_kda_res(id[ef == 0 & set == 'full'],
                                    id[ef == 1 & set == 'full'],
                                    id[ef == 1 & set == 'top'])) ) %>% 
  unnest(kd) %>%  
  left_join(., 
            biodom %>% select(MODULE = GOterm_Name, Biodomain, color, abbr, label), 
            by = 'MODULE') %>% 
  ungroup() %>% 
  group_by(bd, filt, dir) %>% 
  arrange(MODULE, desc(ef1_fdr)) %>% 
  ungroup()

en.kd.res <- kd.res
```

```{r fig.width=16,fig.height=8}
# p2 = 
kd.res %>% 
  # filter( ef1_fdr > -log10(0.05)
  #        # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
  #        , delta_fdr > 0
  #        ) %>%
  mutate(dir = fct_relevel(dir, c('undirected','directed')),
         filt = fct_relevel(filt, c('none','node','edge','node_edge'))) %>% 
  ggplot(aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = unique(kd.res$bd))+
  # geom_abline(intercept = 0, slope =1, lty= 2, lwd = .5)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top_kd == 1 & delta_fdr > 0)
             , alpha = .6, size = 2, aes(color = color))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, ef1_fdr > -log10(0.05)
                   & top_kd == 1
                   & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                   & delta_fdr > 0
                   ), 
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(dir~filt, scales = 'free', ncol = 4)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

### KD ~ Biodomains

```{r, fig.width=10}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top_kd == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(filt, dir, Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter(!is.na(filt), !is.na(dir)) %>% 
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_term)) %>% 
  arrange(Biodomain, desc(n_term), desc(max_delta)) %>% 
  ggplot(aes(n_term, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(unique(kd.res$bd), ' Network Key Drivers'),
       subtitle = 'Biodomain GO terms')+ 
  theme(legend.position = 'bottom')+
  facet_wrap(dir~filt, ncol = 4)
```


```{r, fig.width=10}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top_kd == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(filt, dir, Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% select(Biodomain, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  arrange(desc(n_node), desc(max_delta), .by_group = T) %>% 
  ungroup() %>% 
  filter(!is.na(filt), !is.na(dir)) %>% 
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_node)) %>%
  ggplot(aes(n_node, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(unique(kd.res$bd), ' Network Key Drivers'),
       subtitle = 'Nodes')+ 
  theme(legend.position = 'bottom')+
  facet_wrap(dir~filt, ncol = 4)
```

```{r fig.width=10,fig.height=10}
tmp <- kd.res %>% 
  filter( 
    ef1_fdr > -log10(0.05)
    # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
    , delta_fdr > 0 ,
    dir == 'undirected'
    , filt == 'node'
         )

ggplot(tmp, aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', 
       title = paste0(unique(tmp$bd), ': ', unique(tmp$dir),', ',unique(tmp$filt)),
       subtitle = 'signif KDs (EF1 FDR < 0.05), \u0394 FDR > 0, for GSEA-enriched terms'
       )+
  # geom_abline(intercept = 0, slope =1, lty= 2, lwd = .5)+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top_kd == 1 & delta_fdr > 0)
             , alpha = .6, size = 2, aes(color = color))+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  ggrepel::geom_label_repel(
    data = subset( kd.res, ef1_fdr > -log10(0.05)
                   & top_kd == 1
                   & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                   & delta_fdr > 0
                   ),
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(~Biodomain, scales = 'free')+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

```{r}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top_kd == 1
         ) %>% 
  group_by(filt, dir, Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_term), desc(max_delta), .by_group = T) %>%
  DT::datatable(rownames = F, filter = 'top')
```

### Top KDs
```{r}
kd.summary = kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         ) %>% 
  group_by(NODE, filt, dir) %>% 
  summarise(n_bd = length(unique(Biodomain)),
            bds = list(unique(Biodomain)),
            n_term = length(unique(MODULE)),
            terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_bd), desc(max_delta)) %>% 
  mutate(LE_gene = if_else(NODE %in% input.gene.list, 'Y', 'N')) %>% 
  relocate(LE_gene, .after = 'NODE')

DT::datatable(kd.summary %>% select(-bds, -terms), rownames = F, filter = 'top')
```

```{r}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , top_kd == 1
         , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         ) %>% 
  select(bd, dir, filt, NODE, MODULE, MEMBER, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>% 
  mutate(LE_gene = if_else(NODE %in% input.gene.list, 'Y', 'N')) %>% 
  relocate(LE_gene, .after = 'NODE') %>% 
  DT::datatable(., rownames = F, filter = 'top') %>% 
  DT::formatSignif(columns = c('ef0_fdr','ef1_fdr','delta_fdr'))
```

### KDs ~ CBrain phenotypes
```{r fig.width=10, fig.height=5}
# crispr brain phenotype hits (any) vs non-hits
cb.hits = simple %>% filter(`Hit Class` != 'Non-Hit') %>% 
  pull(Gene) %>% unique()
cb.nonhits = simple %>% filter( (Gene %in% cb.hits)==F ) %>% 
  pull(Gene) %>% unique()

# ID key drivers from different parameter sets
comb = kd.res %>% select(filt, dir) %>% distinct() %>% arrange(dir,filt)
comb$kd.hits = map(
  1:nrow(comb),
  ~ kd.res %>% filter(ef1_fdr > -log10(0.05), 
                      filt == comb$filt[.x],
                      dir == comb$dir[.x]) %>% pull(NODE) %>% unique()
)
comb$kd.nonhits = map(
  1:nrow(comb),
  ~ kd.res %>% filter( (NODE %in% comb$kd.hits[[.x]])==F ) %>% 
    pull(NODE) %>% unique()
)

# calculate fisher stats 
comb = map_dfr(
  1:nrow(comb),
  ~ bind_cols(
      pheno_kd = intersect(cb.hits, comb$kd.hits[[.x]]) %>% length(),
      noPheno_kd = intersect(cb.nonhits, comb$kd.hits[[.x]]) %>% length(),
      pheno_nokd = intersect(cb.hits, comb$kd.nonhits[[.x]]) %>% length(),
      noPheno_nokd = intersect(cb.nonhits, comb$kd.nonhits[[.x]]) %>% length()
    ) %>% 
    rowwise() %>% mutate(
      fisher.p = matrix(c(pheno_kd, noPheno_kd, pheno_nokd, noPheno_nokd), 
                        nrow = 2) %>% 
      fisher.test( ., alt = 'g') %>% broom::tidy() %>% pull(p.value)
    )
) %>% 
  bind_cols(comb, .)


# make plots for each comb
plist = purrr::map(
  1:nrow(comb),
  ~ {
    # grid::grid.newpage()
    VennDiagram::venn.diagram(
      x = list(
        CRISPRbrain = cb.hits, 
        KeyDrivers = comb$kd.hits[[.x]]
      ),
      filename = NULL,
      force.unique = T,
      lty = 0, alpha = .3, fill = c('light blue','pink'),
      hyper.test = T, 
      total.population = length(intersect(simple$Gene, names(V(base_net)))),
      lower.tail = F,
      
      # main = kd.res$bd %>% unique,
      main = paste0(
              comb$dir[.x],' | filt: ', comb$filt[.x],
              ' | Fisher p = ', comb$fisher.p[.x] %>% signif(digits = 2) ),
      main.cex = .75, sub.cex = .75,
      # cat.pos = c(315,45),
      cat.cex = .8,
      ext.pos = 180,
      ext.dist = -.1
      ) }
)

cowplot::plot_grid(plotlist = plist, ncol = 4)
```

Lysotracker phenotypes only
```{r fig.width=10, fig.height=5}
# crispr brain phenotype hits (any) vs non-hits
cb.hits = simple %>% 
  filter( expt %in% c('Lysotracker','LysoTracker-ITC','LysoTracker-Veh'), `Hit Class` != 'Non-Hit') %>% 
  pull(Gene) %>% unique()
cb.nonhits = simple %>% 
  filter( expt %in% c('Lysotracker','LysoTracker-ITC','LysoTracker-Veh'),  (Gene %in% cb.hits)==F ) %>% 
  pull(Gene) %>% unique()

# ID key drivers from different parameter sets
comb = kd.res %>% select(filt, dir) %>% distinct() %>% arrange(dir,filt)
comb$kd.hits = map(
  1:nrow(comb),
  ~ kd.res %>% filter(ef1_fdr > -log10(0.05), 
                      filt == comb$filt[.x],
                      dir == comb$dir[.x]) %>% pull(NODE) %>% unique()
)
comb$kd.nonhits = map(
  1:nrow(comb),
  ~ kd.res %>% filter( (NODE %in% comb$kd.hits[[.x]])==F ) %>% 
    pull(NODE) %>% unique()
)

# calculate fisher stats 
comb = map_dfr(
  1:nrow(comb),
  ~ bind_cols(
      pheno_kd = intersect(cb.hits, comb$kd.hits[[.x]]) %>% length(),
      noPheno_kd = intersect(cb.nonhits, comb$kd.hits[[.x]]) %>% length(),
      pheno_nokd = intersect(cb.hits, comb$kd.nonhits[[.x]]) %>% length(),
      noPheno_nokd = intersect(cb.nonhits, comb$kd.nonhits[[.x]]) %>% length()
    ) %>% 
    rowwise() %>% mutate(
      fisher.p = matrix(c(pheno_kd, noPheno_kd, pheno_nokd, noPheno_nokd), 
                        nrow = 2) %>% 
      fisher.test( ., alt = 'g') %>% broom::tidy() %>% pull(p.value)
    )
) %>% 
  bind_cols(comb, .)

# make plots for each comb
plist = purrr::map(
  1:nrow(comb),
  ~ {
    # grid::grid.newpage()
    VennDiagram::venn.diagram(
      x = list(
        CRISPRbrain = cb.hits, 
        KeyDrivers = comb$kd.hits[[.x]]
      ),
      filename = NULL,
      force.unique = T,
      lty = 0, alpha = .3, fill = c('light blue','pink'),
      hyper.test = T, 
      total.population = length(intersect(simple$Gene, names(V(base_net)))),
      lower.tail = F,
      
      # main = kd.res$bd %>% unique,
      main = paste0(
              comb$dir[.x],' | filt: ', comb$filt[.x],
              ' | Fisher p = ', comb$fisher.p[.x] %>% signif(digits = 2) ),
      main.cex = .75, sub.cex = .75,
      # cat.pos = c(315,45),
      cat.cex = .8,
      ext.pos = 180,
      ext.dist = -.1
      ) }
)

cowplot::plot_grid(plotlist = plist, ncol = 4)
```


linear regression  ~ KDA FDR
```{r}
tmp <- kd.res %>% inner_join( simple,., by =c('Gene'='NODE')) %>% 
  group_by(cell,mode,expt, bd, filt, dir) %>% 
  mutate(lm = lm(abs(gene_score)~ef1_fdr) %>% broom::tidy() %>% 
           filter(term != '(Intercept)') %>% 
           mutate(r.squared = lm(abs(gene_score)~ef1_fdr) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(abs(gene_score)~delta_fdr) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, bd.nw = bd, nw.filt = filt, nw.dir=dir, term:nobs) %>% distinct() %>% 
  filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

tmp %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ ef1_fdr', options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```

```{r fig.width=10, fig.height=5}
c = 'Glutamatergic Neuron'
m = 'CRISPRi'
e = 'FeRhoNox'

kd.res %>% inner_join( simple,., by =c('Gene'='NODE')) %>%
  filter(
    cell == c,
    mode == m,
    expt == e,
    ef1_fdr > -log10(0.2)
    ) %>% 
  ggplot( aes( ef1_fdr, abs(gene_score) )) +
  geom_point(#data = subset(tmp, d > 0),
             aes(color = color,  size = delta_fdr), alpha = .5) +
  geom_hline(yintercept = 0, lwd = 0.5)+
  geom_vline(xintercept = 0, lwd = 0.5)+
  scale_size_continuous(name = 'KDA \u0394 FDR\nef1-ef0', range = c(.5,3))+ 
  # ggrepel::geom_label_repel(
  #   data = subset(tmp, d > 0), aes(label = paste0(Gene,'\n', go)),
  #   min.segment.length = 0, size = 2.5, max.overlaps = 12)+
  scale_color_identity(guide = 'none')+
  geom_smooth(method = 'lm', color = 'grey20',lty=2)+
  labs(y = 'CRISPRbrain phenotype score, absolute value',
       x = 'KDA FDR, -log10',
       title = paste0(c,', ',m,', ',e)) + 
  facet_grid(dir~filt, scales = 'free_x')
```
```{r fig.width=10, fig.height=5}
c = 'Glutamatergic Neuron'
m = 'CRISPRi'
e = 'Lysotracker'

kd.res %>% inner_join( simple,., by =c('Gene'='NODE')) %>%
  filter(
    cell == c,
    mode == m,
    expt == e,
    ef1_fdr > -log10(0.2)
    ) %>% 
  ggplot( aes( ef1_fdr, abs(gene_score) )) +
  geom_point(#data = subset(tmp, d > 0),
             aes(color = color,  size = delta_fdr), alpha = .5) +
  geom_hline(yintercept = 0, lwd = 0.5)+
  geom_vline(xintercept = 0, lwd = 0.5)+
  scale_size_continuous(name = 'KDA \u0394 FDR\nef1-ef0', range = c(.5,3))+ 
  # ggrepel::geom_label_repel(
  #   data = subset(tmp, d > 0), aes(label = paste0(Gene,'\n', go)),
  #   min.segment.length = 0, size = 2.5, max.overlaps = 12)+
  scale_color_identity(guide = 'none')+
  geom_smooth(method = 'lm', color = 'grey20',lty=2)+
  labs(y = 'CRISPRbrain phenotype score, absolute value',
       x = 'KDA FDR, -log10',
       title = paste0(c,', ',m,', ',e)) + 
  facet_grid(dir~filt, scales = 'free_x')
```
linear regression ~  KDA delta FDR e1/e0
```{r}
tmp <- kd.res %>% inner_join( simple,., by =c('Gene'='NODE')) %>% 
  group_by(cell,mode,expt, bd, filt, dir) %>% 
  mutate(lm = lm(abs(gene_score)~delta_fdr) %>% broom::tidy() %>% 
           filter(term != '(Intercept)') %>% 
           mutate(r.squared = lm(abs(gene_score)~delta_fdr) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(abs(gene_score)~delta_fdr) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm) %>% 
  select(cell, mode, expt, bd, filt, dir, term:nobs) %>% distinct() %>% 
  filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value) 

tmp %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ \u0394 fdr (ef1-ef0)', options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```


```{r fig.width=10, fig.height=5}
c = 'Glutamatergic Neuron'
m = 'CRISPRi'
e = 'Lysotracker'

kd.res %>% inner_join( simple,., by =c('Gene'='NODE')) %>%
  filter(
    cell == c,
    mode == m,
    expt == e,
    ef1_fdr > -log10(0.2)
    ) %>% 
  ggplot( aes( delta_fdr, abs(gene_score) )) +
  geom_point(#data = subset(tmp, d > 0),
             aes(color = color,  size = ef1_fdr), alpha = .5) +
  geom_hline(yintercept = 0, lwd = 0.5)+
  geom_vline(xintercept = 0, lwd = 0.5)+
  scale_size_continuous(name = 'KDA \u0394 FDR\nef1-ef0', range = c(.5,3))+ 
  # ggrepel::geom_label_repel(
  #   data = subset(tmp, d > 0), aes(label = paste0(Gene,'\n', go)),
  #   min.segment.length = 0, size = 2.5, max.overlaps = 12)+
  scale_color_identity(guide = 'none')+
  geom_smooth(method = 'lm', color = 'grey20',lty=2)+
  labs(y = 'CRISPRbrain phenotype score, absolute value',
       x = 'KDA FDR, -log10',
       title = paste0(c,', ',m,', ',e)) + 
  facet_grid(dir~filt, scales = 'free_x')
```


### KD subnetworks
pull NW to view subgraphs
```{r}
nw = nw.tbl %>% 
  filter(
    dir == 'undirected', 
    filt == 'node_edge', 
    bd.filt == T
    ) %>% 
  pull(id) %>% 
  synGet(.) %>% 
  .$path %>% 
  read_graph(., format = 'graphml' )
```


```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'IL1B', term = 'positive regulation of leukocyte migration') )
p
```


```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'CAT', term = 'response to interleukin-1') )
p
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'CXCL8', term = 'positive regulation of inflammatory response') )
p
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'SNX9',term = 'clathrin-coated endocytic vesicle membrane') )
p
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'VCP', term = 'ubiquitin protein ligase binding') )
p
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'HIP1R', term = 'clathrin-coated endocytic vesicle') )
p
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'RAB3A', term = 'regulation of synaptic plasticity') )
p
```

## Immune Response
```{r}
dom = 'Immune Response'
```

### NW properties
Global properties of biodomain-filtered path traced networks
```{r fig.width=5, fig.height=7}
nw.tbl %>%
  filter(bd.filt) %>%
  select(-s.edges, -le_genes, -s.nodes) %>% 
  mutate(
    network = paste( dir, filt, sep = '_') # bd.filt,
  ) %>% 
  rowwise() %>%
  mutate( across( edges:added_genes, ~ length(unique(unlist(.x))) ) ) %>% 
  pivot_longer(cols = c(avg_node_degree:added_genes), names_to = 'properties', values_to = 'val') %>% 
  mutate(network = factor(network, 
                       levels = rev(c('undirected_none',
                                  'undirected_node',
                                  'undirected_edge',
                                  'undirected_node_edge',
                                  'directed_none',
                                  'directed_node',
                                  'directed_edge',
                                  'directed_node_edge'))) ,
         properties = factor(properties,
                             levels = c('nodes',
                                        'edges',
                                        'input_genes',
                                        'added_genes',
                                        'avg_node_degree',
                                        'avg_path_length',
                                        'assortativity_coef',
                                        'connected_components'
                                        ))
         ) %>% 
  ggplot(aes(val, network)) +
  geom_bar(stat = 'identity', position = 'dodge', aes(fill = dir))+
  theme(legend.position = 'top')+
  labs(y = '',x = '')+
  # scale_y_log10()+
  facet_wrap(~properties, scales = 'free_x', ncol = 2)

```

### KDA results
```{r}
# synIDs of BD-specific wKDA results
kd.res = kda.dirs %>% 
  filter(bd == dom) %>% 
  select(set, bd, filt, dir, ef, id) %>%  
  # filter(dir == 'undirected') %>% 
  group_by(bd,filt,dir) %>%
  summarise( kd = list(read_kda_res(id[ef == 0 & set == 'full'],
                                    id[ef == 1 & set == 'full'],
                                    id[ef == 1 & set == 'top'])) ) %>% 
  unnest(kd) %>%  
  left_join(., 
            biodom %>% select(MODULE = GOterm_Name, Biodomain, color, abbr, label), 
            by = 'MODULE') %>% 
  ungroup() %>% 
  group_by(bd, filt, dir) %>% 
  arrange(MODULE, desc(ef1_fdr)) %>% 
  ungroup()

ir.kd.res <- kd.res
```

```{r}
top <- bind_rows(
  read_tsv(synGet('syn51195990')$path, col_types = cols()) %>% mutate(ef = 'ef0'),
  read_tsv(synGet('syn51195995')$path, col_types = cols()) %>% mutate(ef = 'ef1')
)
```

```{r fig.width=6, fig.height=3}
ggplot(top, aes(FOLD, -log10(FDR) )) + 
  geom_point(alpha = .5) + 
  facet_wrap(~ef)
```

```{r fig.width=5, fig.height=4}
kd.res %>%
  ggplot(aes(ef0_fdr, ef1_fdr))+
  geom_abline(intercept = 0, slope = 1, lty = 2)+
  geom_point(data = subset(kd.res, top == 0), 
             alpha = .2, size = 1)+
  geom_point(data = subset(kd.res, top == 1), 
                           alpha = .6, size = 2)+
  labs(x = '-log10(FDR)\nuniform edge weights (ef0)',
       y = '-log10(FDR)\nAD risk edge weights (ef1)')
```

```{r}
kd.res %>% 
  arrange(ef1_fdr) %>% 
  ggplot(aes(ef0_fdr, ef1_fdr))+
  geom_abline(intercept = 0, slope = 1, lty = 2)+
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, 
                           ef1_fdr > -log10(0.05) & top == 1 )
             , alpha = .6, size = 2, aes(color = color))+
  scale_color_identity()+
  labs(x = '-log10(FDR)\nuniform edge weights',
       y = '-log10(FDR)\nAD risk edge weights')
```

```{r fig.width=5, fig.height=4}
kd.res %>% 
  arrange((delta_fdr)) %>% 
  ggplot(aes(ef1_fdr, delta_fdr))+
  # geom_abline(intercept = 0, slope = 1, lty = 2)+
  geom_hline(yintercept = 0, lty = 2)+
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, 
                           ef1_fdr > -log10(0.05) & top == 1 )
             , alpha = .6, size = 2, aes(color = color))+
  # ggrepel::geom_label_repel(
  #   data = subset(
  #     kd.res, 
  #     ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0
  #     & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]), 
  #   aes(label = paste0(NODE, '\n', MODULE), color = color),
  #   size = 2, alpha = .7, min.segment.length = 0)+
  scale_color_identity()+
  labs(x = '-log10(FDR)\nAD risk edge weights (ef1)',
       y = '\u0394 FDR, ef1 - ef0')
```

```{r fig.width=8, fig.height=8}
tmp <- kd.res 
# %>% 
#   filter(Biodomain %in% c("Immune Response", "Structural Stabilization"))

ggplot(tmp, aes(ef1_fdr, delta_fdr))+
  # geom_abline(intercept = 0, slope = 1, lty = 2)+
  geom_hline(yintercept = 0, lty = 2)+
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(tmp, 
                           ef1_fdr > -log10(0.05) & top == 1 )
             , alpha = .6, size = 2, aes(color = color))+
  # ggrepel::geom_label_repel(
  #   data = subset(
  #     tmp,
  #     ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0
  #     & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]),
  #   aes(label = paste0(NODE, '\n', MODULE), fill = color),
  #   size = 2, alpha = .7, min.segment.length = 0, max.overlaps = 20)+
  scale_color_identity()+scale_fill_identity()+
  facet_wrap(~Biodomain)+
  labs(x = '-log10(FDR)\nAD risk edge weights (ef1)',
       y = '\u0394 FDR, ef1 - ef0')
```

```{r fig.width=8, fig.height=8}
tmp <- kd.res  %>% 
  filter(ef1_fdr > -log10(0.05), delta_fdr > 0, top == 1,
           MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]) 

ggplot(tmp, aes(ef1_fdr, delta_fdr))+
  # geom_abline(intercept = 0, slope = 1, lty = 2)+
  # geom_hline(yintercept = 0)+
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(tmp, 
                           ef1_fdr > -log10(0.05) & top == 1 )
             , alpha = .6, size = 2, aes(color = color))+
  # ggrepel::geom_label_repel(
  #   data = subset(
  #     tmp,
  #     ef1_fdr > -log10(0.05) & top == 1 & delta_fdr > 0
  #     & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]),
  #   aes(label = paste0(NODE, '\n', MODULE), fill = color),
  #   size = 2, alpha = .7, min.segment.length = 0, max.overlaps = 20)+
  scale_color_identity()+scale_fill_identity()+
  geom_smooth(method = 'lm', lty = 2, color = 'grey50')+
  facet_wrap(~Biodomain)+
  labs(x = '-log10(FDR)\nAD risk edge weights (ef1)',
       y = '\u0394 FDR, ef1 - ef0')
```

```{r fig.width=5, fig.height=7}
tmp <- kd.res %>% 
    filter(ef1_fdr > -log10(0.05), delta_fdr > 0, top == 1,
           MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]) %>% 
  group_by(Biodomain) %>% 
  mutate(n_kd = length(unique(paste0(NODE,':',MODULE)))) %>% 
  ungroup() %>% 
  mutate(Biodomain = fct_reorder(Biodomain, n_kd)) %>% 
  arrange(Biodomain)

ggplot(tmp, aes(delta_fdr, Biodomain))+
  geom_jitter(alpha = .2, aes(color = color))+
  geom_violin(aes(color = color), scale = 'width', alpha=.3)+
  labs(y = '', x = '\u0394 FDR, ef1 - ef0')+
  scale_color_identity()
```

```{r fig.width=16,fig.height=8}
# p2 = 
kd.res %>% 
  # filter( ef1_fdr > -log10(0.05)
  #        # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
  #        , delta_fdr > 0
  #        ) %>%
  mutate(dir = fct_relevel(dir, c('undirected','directed')),
         filt = fct_relevel(filt, c('none','node','edge','node_edge'))) %>% 
  ggplot(aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = unique(kd.res$bd))+
  # geom_abline(intercept = 0, slope =1, lty= 2, lwd = .5)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top_kd == 1 & delta_fdr > 0)
             , alpha = .6, size = 2, aes(color = color))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, ef1_fdr > -log10(0.05)
                   & top_kd == 1
                   & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                   & delta_fdr > 0
                   ), 
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(dir~filt, scales = 'free', ncol = 4)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

### KD ~ Biodomains

```{r, fig.width=10}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top_kd == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(filt, dir, Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter(!is.na(filt), !is.na(dir)) %>% 
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_term)) %>% 
  arrange(Biodomain, desc(n_term), desc(max_delta)) %>% 
  ggplot(aes(n_term, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(unique(kd.res$bd), ' Network Key Drivers'),
       subtitle = 'Biodomain GO terms')+ 
  theme(legend.position = 'bottom')+
  facet_wrap(dir~filt, ncol = 4)
```


```{r, fig.width=10}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top_kd == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(filt, dir, Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% select(Biodomain, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  arrange(desc(n_node), desc(max_delta), .by_group = T) %>% 
  ungroup() %>% 
  filter(!is.na(filt), !is.na(dir)) %>% 
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_node)) %>%
  ggplot(aes(n_node, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(unique(kd.res$bd), ' Network Key Drivers'),
       subtitle = 'Nodes')+ 
  theme(legend.position = 'bottom')+
  facet_wrap(dir~filt, ncol = 4)
```

```{r fig.width=10,fig.height=10}
tmp <- kd.res %>% 
  filter( 
    ef1_fdr > -log10(0.05)
    # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
    , delta_fdr > 0 ,
    dir == 'undirected'
    , filt == 'node'
         )

ggplot(tmp, aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', 
       title = paste0(unique(tmp$bd), ': ', unique(tmp$dir),', ',unique(tmp$filt)),
       subtitle = 'signif KDs (EF1 FDR < 0.05), \u0394 FDR > 0, for GSEA-enriched terms'
       )+
  # geom_abline(intercept = 0, slope =1, lty= 2, lwd = .5)+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top_kd == 1 & delta_fdr > 0)
             , alpha = .6, size = 2, aes(color = color))+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  # ggrepel::geom_label_repel(
  #   data = subset( kd.res, ef1_fdr > -log10(0.05)
  #                  & top_kd == 1
  #                  & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
  #                  & delta_fdr > 0
  #                  ),
  #   aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
  #   size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(~Biodomain)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

```{r}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top_kd == 1
         ) %>% 
  group_by(filt, dir, Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_term), desc(max_delta), .by_group = T) %>%
  DT::datatable(rownames = F, filter = 'top')
```
### Top KDs
```{r}
kd.summary = kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         ) %>% 
  group_by(NODE, filt, dir) %>% 
  summarise(n_bd = length(unique(Biodomain)),
            bds = list(unique(Biodomain)),
            n_term = length(unique(MODULE)),
            terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_bd), desc(max_delta)) %>% 
  mutate(LE_gene = if_else(NODE %in% input.gene.list, 'Y', 'N')) %>% 
  relocate(LE_gene, .after = 'NODE')

DT::datatable(kd.summary %>% select(-bds, -terms), rownames = F, filter = 'top')
```

```{r}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , top_kd == 1
         , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         ) %>% 
  select(bd, dir, filt, NODE, MODULE, Biodomain, MEMBER, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>% 
  mutate(LE_gene = if_else(NODE %in% input.gene.list, 'Y', 'N')) %>% 
  relocate(LE_gene, .after = 'NODE') %>% 
  DT::datatable(., rownames = F, filter = 'top') %>% 
  DT::formatSignif(columns = c('ef0_fdr','ef1_fdr','delta_fdr'))
```



### KDs ~ CBrain phenotypes
```{r fig.width=10, fig.height=5}
# crispr brain phenotype hits (any) vs non-hits
cb.hits = simple %>% filter(`Hit Class` != 'Non-Hit') %>% 
  pull(Gene) %>% unique()
cb.nonhits = simple %>% filter( (Gene %in% cb.hits)==F ) %>% 
  pull(Gene) %>% unique()

# ID key drivers from different parameter sets
comb = kd.res %>% select(filt, dir) %>% distinct() %>% arrange(dir,filt)
comb$kd.hits = map(
  1:nrow(comb),
  ~ kd.res %>% filter(ef1_fdr > -log10(0.05), 
                      filt == comb$filt[.x],
                      dir == comb$dir[.x]) %>% pull(NODE) %>% unique()
)
comb$kd.nonhits = map(
  1:nrow(comb),
  ~ kd.res %>% filter( (NODE %in% comb$kd.hits[[.x]])==F ) %>% 
    pull(NODE) %>% unique()
)

# calculate fisher stats 
comb = map_dfr(
  1:nrow(comb),
  ~ bind_cols(
      pheno_kd = intersect(cb.hits, comb$kd.hits[[.x]]) %>% length(),
      noPheno_kd = intersect(cb.nonhits, comb$kd.hits[[.x]]) %>% length(),
      pheno_nokd = intersect(cb.hits, comb$kd.nonhits[[.x]]) %>% length(),
      noPheno_nokd = intersect(cb.nonhits, comb$kd.nonhits[[.x]]) %>% length()
    ) %>% 
    rowwise() %>% mutate(
      fisher.p = matrix(c(pheno_kd, noPheno_kd, pheno_nokd, noPheno_nokd), 
                        nrow = 2) %>% 
      fisher.test( ., alt = 'g') %>% broom::tidy() %>% pull(p.value)
    )
) %>% 
  bind_cols(comb, .)

# make plots for each comb
plist = purrr::map(
  c(5,6,8),
  ~ {
    # grid::grid.newpage()
    VennDiagram::venn.diagram(
      x = list(
        CRISPRbrain = cb.hits, 
        KeyDrivers = comb$kd.hits[[.x]]
      ),
      filename = NULL,
      force.unique = T,
      lty = 0, alpha = .3, fill = c('light blue','pink'),
      hyper.test = T, 
      total.population = length(intersect(simple$Gene, names(V(base_net)))),
      lower.tail = F,
      
      # main = kd.res$bd %>% unique,
      main = paste0(
              'filt: ', comb$filt[.x],
              ' | Fisher p = ', comb$fisher.p[.x] %>% signif(digits = 2) ),
      main.cex = .75, sub.cex = .75,
      # cat.pos = c(315,45),
      cat.cex = .8,
      ext.pos = 180,
      # ext.dist = -.1
      ) }
)

cowplot::plot_grid(plotlist = plist, ncol = 4)
```


linear regression  ~ KDA FDR
```{r}
tmp <- kd.res %>% inner_join( simple,., by =c('Gene'='NODE')) %>% 
  group_by(cell,expt, bd, filt, dir) %>% #mode
  mutate(lm = lm(abs(gene_score)~ef1_fdr) %>% broom::tidy() %>% 
           filter(term != '(Intercept)') %>% 
           mutate(r.squared = lm(abs(gene_score)~ef1_fdr) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(abs(gene_score)~delta_fdr) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, expt, bd.nw = bd, nw.filt = filt, nw.dir=dir, term:nobs) %>% distinct() %>% #mode, 
  filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

tmp %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ ef1_fdr', options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```

```{r fig.width=6, fig.height=5}
c = 'Glutamatergic Neuron'
# m = 'CRISPRi'
e = 'Lysotracker'

kd.res %>% inner_join( simple,., by =c('Gene'='NODE')) %>%
  filter(
    cell == c,
    # mode == m,
    expt == e,
    dir == 'undirected',
    filt == 'node'
    , ef1_fdr > -log10(0.05)
    ) %>% 
  ggplot( aes( ef1_fdr, abs(gene_score) )) +
  geom_point(#data = subset(tmp, d > 0),
             aes(color = color,  size = delta_fdr), alpha = .5) +
  geom_hline(yintercept = 0, lwd = 0.5)+
  geom_vline(xintercept = 0, lwd = 0.5)+
  scale_size_continuous(name = 'KDA \u0394 FDR\nef1-ef0', range = c(.5,3))+ 
  # ggrepel::geom_label_repel(
  #   data = subset(tmp, d > 0), aes(label = paste0(Gene,'\n', go)),
  #   min.segment.length = 0, size = 2.5, max.overlaps = 12)+
  scale_color_identity(guide = 'none')+
  geom_smooth(method = 'lm', color = 'grey20',lty=2)+
  labs(y = 'CRISPRbrain phenotype score, absolute value',
       x = 'KDA FDR, -log10',
       title = paste0(c,', ',m,', ',e)) 
# + 
  # facet_grid(dir~filt, scales = 'free_x')
```

linear regression ~  KDA delta FDR e1/e0
```{r}
tmp <- kd.res %>% inner_join( simple,., by =c('Gene'='NODE')) %>% 
  group_by(cell, expt, bd, filt, dir) %>% #mode,
  mutate(lm = lm(abs(gene_score)~delta_fdr) %>% broom::tidy() %>% 
           filter(term != '(Intercept)') %>% 
           mutate(r.squared = lm(abs(gene_score)~delta_fdr) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(abs(gene_score)~delta_fdr) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm) %>% 
  select(cell, expt, bd, filt, dir, term:nobs) %>% distinct() %>% #mode, 
  filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value) 

tmp %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ \u0394 fdr (ef1-ef0)', options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```

```{r fig.width=6, fig.height=5}
c = 'iAstrocyte'
# m = 'CRISPRi'
e = 'VCAM1-ITC'

kd.res %>% inner_join( simple,., by =c('Gene'='NODE')) %>%
  filter(
    cell == c,
    # mode == m,
    expt == e,
    filt == 'node_edge',
    dir == 'undirected',
    ef1_fdr > -log10(0.05),
    
    ) %>% 
  ggplot( aes( delta_fdr, abs(gene_score) )) +
  geom_point(#data = subset(tmp, d > 0),
             aes(color = color,  size = ef1_fdr), alpha = .5) +
  geom_hline(yintercept = 0, lwd = 0.5)+
  geom_vline(xintercept = 0, lwd = 0.5)+
  scale_size_continuous(name = 'KDA \u0394 FDR\nef1-ef0', range = c(.5,3))+ 
  # ggrepel::geom_label_repel(
  #   data = subset(tmp, d > 0), aes(label = paste0(Gene,'\n', go)),
  #   min.segment.length = 0, size = 2.5, max.overlaps = 12)+
  scale_color_identity(guide = 'none')+
  geom_smooth(method = 'lm', color = 'grey20',lty=2)+
  labs(y = 'CRISPRbrain phenotype score, absolute value',
       x = '\u0394 FDR, ef1 - ef0',
       title = paste0(c,', ',e)) + 
  facet_grid(dir~filt, scales = 'free_x')
```

### KD subnetworks
pull NW to view subgraphs
```{r}
nw = nw.tbl %>% 
  filter(
    dir == 'undirected', 
    filt == 'node', 
    bd.filt == T
    ) %>% 
  pull(id) %>% 
  synGet(.) %>% 
  .$path %>% 
  read_graph(., format = 'graphml' )
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'ALOX5',term = 'regulation of oxidative stress-induced cell death') )
p
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'IKBKG', term = 'I-kappaB kinase/NF-kappaB signaling') )
p
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'PRKCA', term = 'extrinsic component of cytoplasmic side of plasma membrane') )
p
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'TRAF2', term = 'tumor necrosis factor-mediated signaling pathway') )
p
```


## Lipid Metabolism
```{r}
dom = 'Lipid Metabolism'
```

### NW properties
Global properties of biodomain-filtered path traced networks
```{r fig.width=5, fig.height=7}
nw.tbl %>%
  filter(bd.filt) %>%
  select(-s.edges, -le_genes, -s.nodes) %>% 
  mutate(
    network = paste( dir, filt, sep = '_') # bd.filt,
  ) %>% 
  rowwise() %>%
  mutate( across( edges:added_genes, ~ length(unique(unlist(.x))) ) ) %>% 
  pivot_longer(cols = c(avg_node_degree:added_genes), names_to = 'properties', values_to = 'val') %>% 
  mutate(network = factor(network, 
                       levels = rev(c('undirected_none',
                                  'undirected_node',
                                  'undirected_edge',
                                  'undirected_node_edge',
                                  'directed_none',
                                  'directed_node',
                                  'directed_edge',
                                  'directed_node_edge'))) ,
         properties = factor(properties,
                             levels = c('nodes',
                                        'edges',
                                        'input_genes',
                                        'added_genes',
                                        'avg_node_degree',
                                        'avg_path_length',
                                        'assortativity_coef',
                                        'connected_components'
                                        ))
         ) %>% 
  ggplot(aes(val, network)) +
  geom_bar(stat = 'identity', position = 'dodge', aes(fill = dir))+
  theme(legend.position = 'top')+
  labs(y = '',x = '')+
  # scale_y_log10()+
  facet_wrap(~properties, scales = 'free_x', ncol = 2)

```

### KDA results
```{r}

# synIDs of BD-specific wKDA results
kd.res = kda.dirs %>% 
  filter(bd == dom) %>% 
  select(set, bd, filt, dir, ef, id) %>%  
  # filter(dir == 'undirected') %>% 
  group_by(bd,filt,dir) %>%
  summarise( kd = list(read_kda_res(id[ef == 0 & set == 'full'],
                                    id[ef == 1 & set == 'full'],
                                    id[ef == 1 & set == 'top'])) ) %>% 
  unnest(kd) %>%  
  left_join(., 
            biodom %>% select(MODULE = GOterm_Name, Biodomain, color, abbr, label), 
            by = 'MODULE') %>% 
  ungroup() %>% 
  group_by(bd, filt, dir) %>% 
  arrange(MODULE, desc(ef1_fdr)) %>% 
  ungroup()

lm.kd.res <- kd.res
```

```{r fig.width=16,fig.height=8}
# p2 = 
kd.res %>% 
  # filter( ef1_fdr > -log10(0.05)
  #        # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
  #        , delta_fdr > 0
  #        ) %>%
  mutate(dir = fct_relevel(dir, c('undirected','directed')),
         filt = fct_relevel(filt, c('none','node','edge','node_edge'))) %>% 
  ggplot(aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', title = unique(kd.res$bd))+
  # geom_abline(intercept = 0, slope =1, lty= 2, lwd = .5)+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top_kd == 1 & delta_fdr > 0)
             , alpha = .6, size = 2, aes(color = color))+
  ggrepel::geom_label_repel(
    data = subset( kd.res, ef1_fdr > -log10(0.05)
                   & top_kd == 1
                   & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                   & delta_fdr > 0
                   ), 
    aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
    size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(dir~filt, scales = 'free', ncol = 4)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

### KD ~ Biodomains

```{r, fig.width=10}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top_kd == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(filt, dir, Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter(!is.na(filt), !is.na(dir)) %>% 
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_term)) %>% 
  arrange(Biodomain, desc(n_term), desc(max_delta)) %>% 
  ggplot(aes(n_term, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(unique(kd.res$bd), ' Network Key Drivers'),
       subtitle = 'Biodomain GO terms')+ 
  theme(legend.position = 'bottom')+
  facet_wrap(dir~filt, ncol = 4)
```

```{r, fig.width=10}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top_kd == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(filt, dir, Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3),
            mean_delta = signif( mean(delta_fdr), digits = 3)) %>% 
  full_join(., 
            biodom %>% group_by(Biodomain) %>% mutate(n_go = length(unique(GO_ID))) %>% 
              select(Biodomain, n_go, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  ungroup() %>%
  mutate(fxn_bd_term = n_term / n_go) %>% 
  filter(!is.na(filt), !is.na(dir)) %>% 
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, mean_delta)) %>% 
  arrange(Biodomain, desc(mean_delta), desc(max_delta)) %>% 
  ggplot(aes(mean_delta, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = n_term, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(unique(kd.res$bd), ' Network Key Drivers'),
       subtitle = 'Biodomain GO terms')+ 
  theme(legend.position = 'bottom')+
  facet_wrap(dir~filt, ncol = 4)
```

```{r, fig.width=10}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top_kd == 1
         ) %>%
  mutate(pair = paste0(NODE,':',MODULE)) %>% 
  group_by(filt, dir, Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            n_node = length(unique(NODE)),
            n_kd = length(unique(pair)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  full_join(., 
            biodom %>% select(Biodomain, abbr:color) %>% distinct(), 
            by = 'Biodomain') %>% 
  arrange(desc(n_node), desc(max_delta), .by_group = T) %>% 
  ungroup() %>% 
  filter(!is.na(filt), !is.na(dir)) %>% 
  mutate(#dir = fct_relevel(dir, c('undirected','directed')),
         filt = fct_relevel(filt, c('none','node','edge','node_edge')),
         Biodomain = fct_reorder(Biodomain, n_node)) %>%
  ggplot(aes(n_node, Biodomain))+
  geom_segment(aes(yend=Biodomain, xend=0), color = 'grey50')+
  geom_point(aes(size = max_delta, color = color))+
  scale_color_identity()+
  labs(y='', 
       title = paste0(unique(kd.res$bd), ' Network Key Drivers'),
       subtitle = 'Nodes')+ 
  theme(legend.position = 'bottom')+
  facet_wrap(dir~filt, ncol = 4)
```

```{r fig.width=10,fig.height=10}
tmp <- kd.res %>% 
  filter( 
    ef1_fdr > -log10(0.05)
    # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
    , delta_fdr > 0 ,
    dir == 'undirected'
    , filt == 'node'
         )

ggplot(tmp, aes( ef1_fdr, delta_fdr ))+
  labs(x = 'wKDA FDR ef1, -log10', y = '\u0394 FDR, ef1 - ef0', 
       title = paste0(unique(tmp$bd), ': ', unique(tmp$dir),', ',unique(tmp$filt)),
       subtitle = 'signif KDs (EF1 FDR < 0.05), \u0394 FDR > 0, for GSEA-enriched terms'
       )+
  # geom_abline(intercept = 0, slope =1, lty= 2, lwd = .5)+
  geom_vline(xintercept = 0, lwd = .5)+ geom_hline(yintercept = 0, lwd = .5) +
  geom_point(alpha = .2, size = 1, aes(color = color) )+
  geom_point(data = subset(kd.res, ef1_fdr > -log10(0.05) & top_kd == 1 & delta_fdr > 0)
             , alpha = .6, size = 2, aes(color = color))+
  geom_smooth(method = 'glm', lty = 2, lwd = .5, color = 'grey20')+
  # ggrepel::geom_label_repel(
  #   data = subset( kd.res, ef1_fdr > -log10(0.05)
  #                  & top_kd == 1
  #                  & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
  #                  & delta_fdr > 0
  #                  ),
  #   aes(label = paste0(NODE, '\n', MODULE, '\n', Biodomain)),
  #   size = 2, alpha = .7, min.segment.length = 0)+
  facet_wrap(~Biodomain)+ #, scales = 'free'
  scale_color_identity(guide = 'none') #; plotly::ggplotly(p)

# plotly::ggplotly(p2)
```

```{r}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         # , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         , top_kd == 1
         ) %>% 
  group_by(filt, dir, Biodomain) %>% 
  summarise(n_term = length(unique(MODULE)),
            # terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_term), desc(max_delta), .by_group = T) %>%
  DT::datatable(rownames = F, filter = 'top')
```
### Top KDs
```{r}
kd.summary = kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         ) %>% 
  group_by(NODE, filt, dir) %>% 
  summarise(n_bd = length(unique(Biodomain)),
            bds = list(unique(Biodomain)),
            n_term = length(unique(MODULE)),
            terms = list(unique(MODULE)),
            min_fdr = signif( 10^-max(ef1_fdr), digits = 3),
            max_delta = signif( max(delta_fdr), digits = 3) ) %>% 
  arrange(desc(n_bd), desc(max_delta)) %>% 
  mutate(LE_gene = if_else(NODE %in% input.gene.list, 'Y', 'N')) %>% 
  relocate(LE_gene, .after = 'NODE')

DT::datatable(kd.summary %>% select(-bds, -terms), rownames = F, filter = 'top')
```

```{r}
kd.res %>% 
  filter(ef1_fdr > -log10(0.05)
         , top_kd == 1
         , MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , delta_fdr > 0
         ) %>% 
  select(bd, dir, filt, NODE, MODULE, MEMBER, contains('fdr')) %>% 
  arrange(desc(delta_fdr), desc(ef1_fdr)) %>% 
  mutate(LE_gene = if_else(NODE %in% input.gene.list, 'Y', 'N')) %>% 
  relocate(LE_gene, .after = 'NODE') %>% 
  DT::datatable(., rownames = F, filter = 'top') %>% 
  DT::formatSignif(columns = c('ef0_fdr','ef1_fdr','delta_fdr'))
```


### KDs ~ CBrain phenotypes
```{r fig.width=10, fig.height=5}
# crispr brain phenotype hits (any) vs non-hits
cb.hits = simple %>% filter(`Hit Class` != 'Non-Hit') %>% 
  pull(Gene) %>% unique()
cb.nonhits = simple %>% filter( (Gene %in% cb.hits)==F ) %>% 
  pull(Gene) %>% unique()

# ID key drivers from different parameter sets
comb = kd.res %>% select(filt, dir) %>% distinct() %>% arrange(dir,filt)
comb$kd.hits = map(
  1:nrow(comb),
  ~ kd.res %>% filter(ef1_fdr > -log10(0.05), 
                      filt == comb$filt[.x],
                      dir == comb$dir[.x]) %>% pull(NODE) %>% unique()
)
comb$kd.nonhits = map(
  1:nrow(comb),
  ~ kd.res %>% filter( (NODE %in% comb$kd.hits[[.x]])==F ) %>% 
    pull(NODE) %>% unique()
)

# calculate fisher stats 
comb = map_dfr(
  1:nrow(comb),
  ~ bind_cols(
      pheno_kd = intersect(cb.hits, comb$kd.hits[[.x]]) %>% length(),
      noPheno_kd = intersect(cb.nonhits, comb$kd.hits[[.x]]) %>% length(),
      pheno_nokd = intersect(cb.hits, comb$kd.nonhits[[.x]]) %>% length(),
      noPheno_nokd = intersect(cb.nonhits, comb$kd.nonhits[[.x]]) %>% length()
    ) %>% 
    rowwise() %>% mutate(
      fisher.p = matrix(c(pheno_kd, noPheno_kd, pheno_nokd, noPheno_nokd), 
                        nrow = 2) %>% 
      fisher.test( ., alt = 'g') %>% broom::tidy() %>% pull(p.value)
    )
) %>% 
  bind_cols(comb, .)

# make plots for each comb
plist = purrr::map(
  1:nrow(comb),
  ~ {
    # grid::grid.newpage()
    VennDiagram::venn.diagram(
      x = list(
        CRISPRbrain = cb.hits, 
        KeyDrivers = comb$kd.hits[[.x]]
      ),
      filename = NULL,
      force.unique = T,
      lty = 0, alpha = .3, fill = c('light blue','pink'),
      hyper.test = T, 
      total.population = length(intersect(simple$Gene, names(V(base_net)))),
      lower.tail = F,
      
      # main = kd.res$bd %>% unique,
      main = paste0(
              comb$dir[.x],' | filt: ', comb$filt[.x],
              ' | Fisher p = ', comb$fisher.p[.x] %>% signif(digits = 2) ),
      main.cex = .75, sub.cex = .75,
      # cat.pos = c(315,45),
      cat.cex = .8,
      ext.pos = 180,
      ext.dist = -.1
      ) }
)

cowplot::plot_grid(plotlist = plist, ncol = 4)
```

linear regression  ~ KDA FDR
```{r}
tmp <- kd.res %>% inner_join( simple,., by =c('Gene'='NODE')) %>% 
  group_by(cell,mode,expt, bd, filt, dir) %>% 
  mutate(lm = lm(abs(gene_score)~ef1_fdr) %>% broom::tidy() %>% 
           filter(term != '(Intercept)') %>% 
           mutate(r.squared = lm(abs(gene_score)~ef1_fdr) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(abs(gene_score)~delta_fdr) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm)  %>% 
  select(cell, mode, expt, bd.nw = bd, nw.filt = filt, nw.dir=dir, term:nobs) %>% distinct() %>% 
  filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value)

tmp %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ ef1_fdr', options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```

```{r fig.width=10, fig.height=5}
c = 'iAstrocyte'
m = 'CRISPRi'
e = 'LAMP1-ITC'

kd.res %>% inner_join( simple,., by =c('Gene'='NODE')) %>%
  filter(
    cell == c,
    mode == m,
    expt == e,
    ef1_fdr > -log10(0.2)
    ) %>% 
  ggplot( aes( ef1_fdr, abs(gene_score) )) +
  geom_point(#data = subset(tmp, d > 0),
             aes(color = color,  size = delta_fdr), alpha = .5) +
  geom_hline(yintercept = 0, lwd = 0.5)+
  geom_vline(xintercept = 0, lwd = 0.5)+
  scale_size_continuous(name = 'KDA \u0394 FDR\nef1-ef0', range = c(.5,3))+ 
  # ggrepel::geom_label_repel(
  #   data = subset(tmp, d > 0), aes(label = paste0(Gene,'\n', go)),
  #   min.segment.length = 0, size = 2.5, max.overlaps = 12)+
  scale_color_identity(guide = 'none')+
  geom_smooth(method = 'lm', color = 'grey20',lty=2)+
  labs(y = 'CRISPRbrain phenotype score, absolute value',
       x = 'KDA FDR, -log10',
       title = paste0(c,', ',m,', ',e)) + 
  facet_grid(dir~filt, scales = 'free_x')
```

linear regression ~  KDA delta FDR e1/e0
```{r}
tmp <- kd.res %>% inner_join( simple,., by =c('Gene'='NODE')) %>% 
  group_by(cell,mode,expt, bd, filt, dir) %>% 
  mutate(lm = lm(abs(gene_score)~delta_fdr) %>% broom::tidy() %>% 
           filter(term != '(Intercept)') %>% 
           mutate(r.squared = lm(abs(gene_score)~delta_fdr) %>% 
                    broom::glance() %>% pull(r.squared),
                  nobs = lm(abs(gene_score)~delta_fdr) %>% 
                    broom::glance() %>% pull(nobs)) %>% list()) %>% 
  unnest(lm) %>% 
  select(cell, mode, expt, bd, filt, dir, term:nobs) %>% distinct() %>% 
  filter(p.value < 0.05) %>% 
  arrange(desc(statistic),p.value) 

tmp %>% 
  DT::datatable(rownames = F, filter = 'top', caption = 'abs(gene_score) ~ \u0394 fdr (ef1-ef0)', options = list(pageLength = 6)) %>% #
  DT::formatSignif(columns = c('statistic', 'std.error','r.squared', 'p.value', 'estimate'))
```

### KD subnetworks
pull NW to view subgraphs
```{r}
nw = nw.tbl %>% 
  filter(
    dir == 'undirected', 
    filt == 'node', 
    bd.filt == T
    ) %>% 
  pull(id) %>% 
  synGet(.) %>% 
  .$path %>% 
  read_graph(., format = 'graphml' )
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'RAB5C',term = 'clathrin-coated vesicle membrane') )
p
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'ACOX1', term = 'fatty acid oxidation') )
p
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'ITGB2', term = 'cell-substrate adhesion') )
p
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'SYT1', term = 'synaptic vesicle recycling') )
p
```

```{r fig.width=12,fig.height=8}
p = suppressWarnings( plot_kd_subnet(nw, kd = 'TLN1', term = 'cell-matrix adhesion') )
p
```

## Synapse
```{r}
dom = 'Synapse'
```

```{r}
# synIDs of BD-specific wKDA results
kd.res = kda.dirs %>% 
  filter(bd == dom) %>% 
  select(set, bd, filt, dir, ef, id) %>%  
  # filter(dir == 'undirected') %>% 
  group_by(bd,filt,dir) %>%
  summarise( kd = list(read_kda_res(id[ef == 0 & set == 'full'],
                                    id[ef == 1 & set == 'full'],
                                    id[ef == 1 & set == 'top'])) ) %>% 
  unnest(kd) %>%  
  left_join(., 
            biodom %>% select(MODULE = GOterm_Name, Biodomain, color, abbr, label), 
            by = 'MODULE') %>% 
  ungroup() %>% 
  group_by(bd, filt, dir) %>% 
  arrange(MODULE, desc(ef1_fdr)) %>% 
  ungroup()

sy.kd.res <- kd.res
```
<WIP>

## Mitochondrial Metabolism
```{r}
dom = 'Mitochondrial Metabolism'
```

```{r}
# synIDs of BD-specific wKDA results
kd.res = kda.dirs %>% 
  filter(bd == dom) %>% 
  filter((filt != 'node' & dir != 'undirected')) %>% 
  select(set, bd, filt, dir, ef, id) %>%  
  # filter(dir == 'undirected') %>% 
  group_by(bd,filt,dir) %>%
  summarise( kd = list(read_kda_res(id[ef == 0 & set == 'full'],
                                    id[ef == 1 & set == 'full'],
                                    id[ef == 1 & set == 'top'])) ) %>% 
  unnest(kd) %>%  
  left_join(., 
            biodom %>% select(MODULE = GOterm_Name, Biodomain, color, abbr, label), 
            by = 'MODULE') %>% 
  ungroup() %>% 
  group_by(bd, filt, dir) %>% 
  arrange(MODULE, desc(ef1_fdr)) %>% 
  ungroup()

mm.kd.res <- kd.res
```
<WIP>


# all kd
```{r}
kd = bind_rows(
  am.kd.res,
  th.kd.res,
  en.kd.res,
  ir.kd.res,
  lm.kd.res,
  sy.kd.res,
  mm.kd.res
) %>% 
  filter(dir == 'undirected')
```

```{r fig.width=10, fig.height=5}
tmp <- kd %>% 
  filter(ef1_fdr > -log10(0.05), delta_fdr > 0, top == 1,
           MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , filt == 'node') %>% 
  group_by(bd,filt,Biodomain) %>% 
  mutate(n_kd = length(unique(paste0(NODE,':',MODULE)))) %>% 
  ungroup() %>% 
  mutate(Biodomain = fct_reorder(Biodomain, n_kd)) %>% 
  arrange(Biodomain)

ggplot(tmp, aes(delta_fdr, Biodomain))+
  geom_jitter(alpha = .2, aes(color = color))+
  geom_violin(aes(color = color), scale = 'width', alpha=.3)+
  labs(y = '', x = '\u0394 FDR, ef1 - ef0')+
  # ggrepel::geom_label_repel(
  #   data = subset(tmp, Biodomain == 'Structural Stabilization'),
  #   aes(label = paste0(NODE, '\n', MODULE)), size = 2, alpha = .7,
  #   max.overlaps = 100)+
  facet_wrap(~bd, scale = 'free_x', nrow = 1)+ #
  scale_color_identity()
```

```{r fig.width=10, fig.height=5}
tmp <- kd %>% 
  filter(ef1_fdr > -log10(0.05), delta_fdr > 0, top == 1,
           MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , filt == 'node') %>% 
  filter(Biodomain == 'Structural Stabilization',
         bd %in% c('Immune Response','Synapse')) 

ggplot(tmp, aes(ef1_fdr, delta_fdr))+
  geom_point(alpha = .2, aes(color = color))+
  labs(x = '-log10(FDR)\nAD risk edge weights', 
       y = '\u0394 FDR, ef1 - ef0')+
  ggrepel::geom_label_repel(
    aes(label = paste0(NODE, '\n', MODULE)), size = 2, alpha = .7,
    max.overlaps = 20)+
  facet_wrap(~bd, scale = 'free', nrow = 1)+ #
  scale_color_identity()
```

```{r fig.width=10, fig.height=4}
tmp <- kd %>% 
  filter(ef1_fdr > -log10(0.05), delta_fdr > 0, top == 1,
           MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , filt == 'node') %>% 
  filter(Biodomain == 'Endolysosome',
         bd %in% c('Immune Response','Synapse', 'Endolysosome')) 

ggplot(tmp, aes(ef1_fdr, delta_fdr))+
  geom_point(alpha = .2, aes(color = color))+
  labs(x = '-log10(FDR)\nAD risk edge weights', 
       y = '\u0394 FDR, ef1 - ef0')+
  ggrepel::geom_label_repel(
    aes(label = paste0(NODE, '\n', MODULE), fill = color), 
    size = 2, alpha = .6,   max.overlaps = 5)+
  facet_wrap(~bd, scale = 'free', nrow = 1)+ #
  scale_color_identity() + scale_fill_identity()
```
```{r fig.width=10, fig.height=4}
tmp <- kd %>% 
  filter(ef1_fdr > -log10(0.05), delta_fdr > 0, top == 1,
           MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , filt == 'node') %>% 
  filter(Biodomain == 'Structural Stabilization',
         bd %in% c('Immune Response','Synapse', 'Endolysosome')) 

ggplot(tmp, aes(ef1_fdr, delta_fdr))+
  geom_point(alpha = .2, aes(color = color))+
  labs(x = '-log10(FDR)\nAD risk edge weights', 
       y = '\u0394 FDR, ef1 - ef0')+
  ggrepel::geom_label_repel(
    aes(label = paste0(NODE, '\n', MODULE), fill = color), 
    size = 2, alpha = .6,   max.overlaps = 5)+
  facet_wrap(~bd, scale = 'free', nrow = 1)+ #
  scale_color_identity() + scale_fill_identity()
```

```{r fig.width=10, fig.height=5}
tmp <- kd %>% 
  filter(ef1_fdr > -log10(0.05), delta_fdr > 0, top == 1,
           MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
         , filt == 'node_edge') %>% 
  group_by(bd,filt,Biodomain) %>% 
  mutate(n_kd = length(unique(paste0(NODE,':',MODULE)))) %>% 
  ungroup() %>% 
  mutate(Biodomain = fct_reorder(Biodomain, n_kd)) %>% 
  arrange(Biodomain)

ggplot(tmp, aes(delta_fdr, Biodomain))+
  geom_jitter(alpha = .2, aes(color = color))+
  geom_violin(aes(color = color), scale = 'width', alpha=.3)+
  labs(y = '', x = '\u0394 FDR, ef1 - ef0')+
  facet_wrap(~bd, scale = 'free_x', nrow = 1)+
  scale_color_identity()
```

# Session
```{r}
sessionInfo()
```

