---
title: "KDs across sub-domain NW"
author: "Greg Cary"
date: "`r Sys.Date()`"
output: 
  html_document: 
    fig_width: 5
    fig_height: 4
  html_notebook:
    code_folding: hide
    theme: readable
    css: style.css
    toc: true
    toc_float: true
---
# Setup
## packages 
```{r setup}
# # Package names
# packages <- c(
#   # 'paxtoolsr','org.Hs.eg.db','HotNetvieweR','clusterProfiler', 
#   'synapser','igraph','tidygraph','ggraph','tidyverse'
#   )
# 
# # Load packages
# invisible(lapply(packages, library, character.only = TRUE))

library(synapser)
library(igraph)
library(tidygraph)
library(ggraph)
library(tidyverse)

source('../../treatAD_biodomains/scripts/biodom_tally.R')
source('../../treatAD_biodomains/scripts/annotate_enr_term_biodomains.R')
source('../../treatAD_biodomains/scripts/biodom_enr_plots.R')

theme_set(theme_bw())
```

## functions
read synapse directories into a dataframe
```{r}
read_syn_dir <- function(parent_id){
  synapser::synGetChildren(parent_id)$asList() %>%
    tibble(f = .) %>% unnest_wider(f)
}
```

NW data  
```{r}
v_info <- function(net){
  v.attr <- tibble( na = vertex.attributes(net) ) %>% t() %>% 
    as_tibble(rownames = NA, .name_repair = ~vertex_attr_names(net) ) %>% 
    unnest(everything()) 
}

e_info <- function(net){
  e.attr <- tibble( ea = edge.attributes(net) ) %>% t() %>% 
    as_tibble(rownames = NA, .name_repair = ~edge_attr_names(net) ) %>% 
    unnest(everything()) 
}

```

read KDA result data  
```{r}
read_kd <- function(path){
  
  # detect if KDA dir path is on synapse
  if(substr(path,1,3) == 'syn'){
        
    synDir <- synGetChildren(path)$asList() %>%
      tibble(f = .) %>% unnest_wider(f)
    
    res <- synDir %>% filter(grepl('edgeFactor', name)) %>% pull(name)
    
    if( length(res) < 10 ){ 
      simpleError('Not a full KD results set')
      return(NULL)
      }
    
    kd.ef0 <- read_tsv(
      synGet( 
        synDir %>% filter( grepl('edgeFactor_0.results.txt', name) ) %>% pull(id)
        )$path, 
        col_types = cols())
    ef0.top <- read_tsv(
      synGet( 
        synDir %>% filter( grepl('edgeFactor_0.tophits.txt', name) ) %>% pull(id)
        )$path, 
      col_types = cols()) %>% 
      mutate(kd = paste0(NODE,'-',MODULE))
    
    kd.ef1 <- read_tsv(
      synGet( 
        synDir %>% filter( grepl('edgeFactor_1.results.txt', name) ) %>% pull(id)
        )$path, 
      col_types = cols())
    ef1.top <- read_tsv(
      synGet( 
        synDir %>% filter( grepl('edgeFactor_1.tophits.txt', name) ) %>% pull(id)
        )$path, 
      col_types = cols()) %>% 
      mutate(kd = paste0(NODE,'-',MODULE))
  
  # or read from a local path
  } else {
    
    kd.pth <- list.files(path, full.names = T)
  
    kd.ef0 <- read_tsv(
      kd.pth %>% str_subset('edgeFactor_0.results.txt'), 
      col_types = cols())
    kd.top <- read_tsv(
      kd.pth %>% str_subset('edgeFactor_1.tophits.txt'), 
      col_types = cols()) %>% 
      mutate(kd = paste0(NODE,'-',MODULE))
    kd.ef1 <- read_tsv(
      kd.pth %>% str_subset('edgeFactor_1.results.txt'),  
      col_types = cols())
    kd.top <- read_tsv(
      kd.pth %>% str_subset('edgeFactor_1.tophits.txt'), 
      col_types = cols()) %>% 
      mutate(kd = paste0(NODE,'-',MODULE))
  }
    
  # Join up the results
  kd = bind_rows(
    kd.ef0 %>% mutate(ef = 'ef0_fdr'),
    kd.ef1 %>% mutate(ef = 'ef1_fdr')
    ) %>% 
    mutate(FDR = -log10(FDR)) %>%
    pivot_wider(id_cols = c(MODULE, NODE, MEMBER), 
                names_from = ef, values_from = FDR, values_fill = 0) %>%
    mutate(delta_fdr = ef1_fdr - ef0_fdr) %>% arrange(desc(delta_fdr)) %>% 
    mutate(top = 0, top_ef0 = 0)
  
  # Indicate which driver-module pairs are top for each analysis
  if( any( ef1.top$FDR < 0.05 ) ){
    kd$top[ which(paste0(kd$NODE,'-',kd$MODULE) %in% ef1.top$kd[ef1.top$FDR < 0.05]) ] <- 1
  }
  if( any( ef0.top$FDR < 0.05 ) ){
    kd$top_ef0[ which(paste0(kd$NODE,'-',kd$MODULE) %in% ef0.top$kd[ef0.top$FDR < 0.05]) ] <- 1
  }
  
  return(kd)
}

```

plot all CRISPRbrain phenotypes & cells per gene
```{r}
cbrain_pheno_plot_by_gene = function( table ){
  theme_set(theme_bw())
  if( nrow(table)==0 ) {return(NULL)}
  ggplot(table, aes(phenotype,Gene)) + facet_grid(~cell+mode, scales = 'free_x')+
    theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
          legend.position = 'top', legend.box = 'vertical')+
    geom_point( aes(fill = gene_score, size = -log10(pval), shape = `Hit Class`))+
    scale_size_continuous(guide = 'none')+ scale_y_discrete(limits = rev)+ 
    scale_shape_manual(values = c(24,25), #22
                       breaks = c('Positive Hit','Negative Hit') )+ #'Non-Hit',
    guides(size =guide_legend( override.aes=list(pch = 22))) +
    scale_fill_gradient2(low = 'purple', mid = 'white', high = 'green', midpoint = 0)+
    labs(y='Perturbagen', x = 'Screen Phenotype')
}
```

plot subnetwork around identified KDs  
```{r}
plot_kd_subnet <- function(nw, kd, term) {
  
  vert_num <- match(kd, V(nw)$name)
  
  vert_neigh <- neighbors(nw, vert_num)
  
  term_num <- biodom %>%
    filter(GOterm_Name == term) %>%
    pull(symbol) %>% unlist() %>%
    match(., V(nw)$name) %>% .[!is.na(.)]
  
  g2 <- induced_subgraph(nw, c(vert_num, intersect(term_num, vert_neigh)))
  g3 <- induced_subgraph(nw, c(vert_num, term_num))
  
  cowplot::plot_grid(
    
    ggraph(g3, layout = 'linear', circular = TRUE) +
      geom_edge_arc(alpha = .3, color = 'grey75') +
      geom_node_point( shape = 21, color = "black", alpha = .3,
        aes(size = TargetRiskScore, fill = Pro_EffectScore, filter= .N()$name != kd)  )+
      geom_node_point( shape = 23, color = "black", alpha = .3,
        aes(size = TargetRiskScore, fill = Pro_EffectScore, filter = .N()$name == kd) )+
      geom_node_text(aes(label = name), size = 2) +
      coord_fixed() +
      scale_size_continuous( range = c(.5, 10), limits = c(0, 5), trans = 'exp')+
      scale_fill_gradient2(
        low = 'purple', mid = 'grey20', high = 'green', na.value = 'grey85',
        limits = c(-2.5,2.5) )+ #approx: range(omics$Pro_TE, na.rm = T)
      labs( title = 'All term genes in NW',
            subtitle = paste0('KD: ', kd, '\nTerm: ', term) )+
      theme_graph(background = 'white')
    ,
    ggraph(g2, layout = 'linear', circular = TRUE) +
            geom_edge_arc(alpha = .3, color = 'grey75') +
      geom_node_point( shape = 21, color = "black", alpha = .3,
        aes(size = TargetRiskScore, fill = Pro_EffectScore, filter= .N()$name != kd)  )+
      geom_node_point( shape = 23, color = "black", alpha = .3,
        aes(size = TargetRiskScore, fill = Pro_EffectScore, filter = .N()$name == kd) )+
      geom_node_text(aes(label = name), size = 2) +
      coord_fixed() +
      scale_size_continuous( range = c(.5, 10), limits = c(0, 5), trans = 'exp')+
      scale_fill_gradient2(
        low = 'purple', mid = 'grey20', high = 'green', na.value = 'grey85',
        limits = c(-2.5,2.5) )+ #approx: range(omics$Pro_TE, na.rm = T)
      labs( title = 'Term genes & KD neighbors in NW',
            subtitle = paste0('KD: ', kd, '\nTerm: ', term) )+
      theme_graph(background = 'white')
    ,
    ncol = 2
    
  )
}
```

## TREAT-AD data
Grab relevant data from synapse, including:
1) Target Risk Scores ([syn25575156](https://www.synapse.org/#!Synapse:syn25575156){target="_blank"}) and Omics Scores ([syn22758536](https://www.synapse.org/#!Synapse:syn22758536){target="_blank"})  
2) Biodomain Definitions ([syn25428992](https://www.synapse.org/#!Synapse:syn25428992){target="_blank"})  
3) Risk-enriched Biodomain Terms ([syn45824995](https://www.synapse.org/#!Synapse:syn45824995){target="_blank"})
4) Base Network ([syn51110930](https://www.synapse.org/#!Synapse:syn51110930){target="_blank"})  
```{r}
synLogin()

# target risk scores
scores <- read_csv(
  synTableQuery('select * from syn25575156', includeRowIdAndRowVersion = F)$filepath
  , col_types = cols())
omics <- read_csv(
  synTableQuery('select * from syn22758536', includeRowIdAndRowVersion = F)$filepath
  , col_types = cols())
npath <- read_csv(
  synTableQuery('select * from syn32288310', includeRowIdAndRowVersion = F)$filepath
  , col_types = cols())

agora <- read_csv(synGet('syn12540368')$path, quote = '"', col_types = cols())

# biological domain annotations
biodom <- full_join(
  # biodomains
  readRDS(synGet('syn25428992')$path),
  # domain labels
  read_csv(synGet('syn26856828')$path, col_types = cols()),
  by = c('Biodomain'='domain')
) %>%
  mutate(Biodomain = case_when(Biodomain == 'none' ~ NA_character_, T ~ Biodomain))

domains = biodom %>% pull(Biodomain) %>% unique() %>% sort()

# enriched biodomain terms
enr.bd <- synGet('syn52749187') %>% .$path %>% readRDS() %>% 
  filter(score == 'Overall') %>% select(anno) %>% unnest(anno) %>% 
  mutate(leadingEdge_genes = str_split(core_enrichment, '\\|'))

# base network
base_net <- igraph::read_graph(synGet('syn51110930')$path, format = 'graphml') 

# filt node & edge
tmp <- igraph::delete_vertices(
  base_net,
  igraph::V(base_net)[ igraph::V(base_net)$brain_exp == 0 ]
)
undir_node_edge <- igraph::subgraph.edges(
  tmp,
  igraph::E(tmp)[ igraph::E(tmp)$n_edge_evidence > 1 ],
  delete.vertices = T 
)

# specify directed edge types
directed_edge_types = c("catalysis-precedes",
                        "controls-expression-of",
                        "controls-phosphorylation-of",
                        "controls-state-change-of",
                        "controls-transport-of"
                        )
```

## CRISPRbrain data
Read CRISPRbrain phenotype data 
```{r warning=FALSE}
synLogin()

# CRISPRbrain data
syn.dir <- synGetChildren('syn51183357')$asList() %>% 
  tibble(f = .) %>% unnest_wider(f)

# Simple Screens
simple <- map_dfr(
  syn.dir %>% with(which( !grepl('RNA|CROP',name) )),
  ~ { 
    id = syn.dir$id[.x]
    n = syn.dir$name[.x]
    synGet(id)$path %>% 
      read_csv( col_types = cols() ) %>% 
      mutate(cell = n %>% str_split_fixed(.,'-(?!M)', 2) %>% .[,1],
             mode = n %>% str_extract('CRISPR[ain]'),
             expt = n %>% str_remove_all('-CRISPR[ain].csv') %>% 
               str_split_fixed('-(?!M)',2) %>% .[,2] ) %>% 
      relocate(cell, mode, expt)
  }
  ) %>% 
  rename(pval = `P Value`, pheno = `Phenotype`, gene_score = `Gene Score`)

simple <- tibble(expt = simple$expt %>% unique() %>% sort(),
                 phenotype = c('Expansion (CD34 Staining)',
                                'Reactive Oxygen Species (CellRox Intensity)',
                                'Proliferation (CFSE Staining)',
                                'Survival (14 day)', 'Survival (21 day)', 'Survival (28 day)',
                                'Labile Iron (FeRhoNox Intensity)',
                                'Immune Activation (CD38 levels)',
                                'Lysosome Exocytosis (cell surface LAMP1), +IL1a +TNF +C1q',
                                'Lysosome Exocytosis (cell surface LAMP1), Vehicle',
                                'Peroxidized Lipids (Liperfluo intensity)',
                                'Lysosome (LysoTracker intensity)',
                                'Lysosome Mass or pH (LysoTracker staining), +IL1a +TNF +C1q',
                                'Lysosome Mass or pH (LysoTracker staining), Vehicle',
                                'Survival, no antioxidants',
                                'Phagocytosis (pHRodo-rat synaptosomes)',
                                'Phagocytosis (pHRodo-labeled synaptosomes), +IL1a +TNF +C1q',
                                'Phagocytosis (pHRodo-labeled synaptosomes), Vehicle',
                                'Survival, PSAP KO & no antioxidants',
                                'Survival, PSAP KO',
                                'Survival',
                                'Survival-Proliferation',
                                'Inflammatory activation (cell-surface VCAM1 levels), +IL1a +TNF +C1q')
                 ) %>% left_join(simple, . , by = 'expt')

# filter(cell %in% c('iAstrocyte','Glutamatergic Neuron','iTF-Microglia','iPSC')) # don't consider HSPC or T-cell
```

## NW & KDA data

read results from synapse  
```{r}
synLogin()

subdoms  <-  read_syn_dir('syn52314422') %>%  # biodomain
  filter(grepl('Folder', type)) %>% 
  select(bd = name, bd_id = id) %>% 
  rowwise() %>% 
  mutate( sd = read_syn_dir(bd_id) %>% list() ) %>% 
  unnest(sd) %>% 
  select(bd, bd_id, sd = name, sd_id = id) %>% 
  rowwise() %>% 
  mutate(
    nw.dir = read_syn_dir(sd_id) %>% list()
    )
```

```{r}
nw.dat = subdoms %>% select(bd, sd, nw.dir) %>% 
  unnest(nw.dir) %>% filter(grepl('graphml',name)) %>%
  mutate(filt = if_else(grepl('bdFilt',name), 'bd.filt','full')) %>% 
  select(bd,sd,id,filt) %>% 
  pivot_wider(names_from=filt, values_from = id)

# query genes
nw.dat$q_genes <- map(
  1:nrow(nw.dat),
  ~ subdoms$nw.dir[[.x]] %>% filter( grepl('queryList', name) ) %>% 
    pull(id) %>% synGet(.) %>% .$path %>% 
    read_tsv(., col_names = F, col_types = cols()) %>% 
    pull(X1) 
)

# BD filtered NW stats
# future::plan('multisession')
x = furrr::future_map_dfr(
  1:nrow(nw.dat),
  ~{synLogin()
    nw = synGet(nw.dat$bd.filt[.x]) %>% .$path %>% 
      read_graph(., format = 'graphml')
    snw = igraph::simplify(nw, remove.multiple = T)
    tibble(
      avg_node_degree = degree(snw, V(snw)) %>% mean(),
      avg_path_length = snw %>% average.path.length,
      assortativity_coef = snw %>% assortativity(., types1 = V(.)),
      connected_components = snw %>% no.clusters,
      edge_t = e_info(nw) %>% list(),
      node_t = v_info(nw) %>% list()
    )
  }
)
# future::plan('sequential')

nw.dat = bind_rows(
  bind_cols(nw.dat, x) %>% mutate(filt = 'bd.filt')
  # , bind_cols(nw.dat, y) %>% mutate(filt = 'full')
); #rm(x,y)

nw.dat$input = map(
  1:nrow(nw.dat),
  ~ nw.dat$node_t[[.x]] %>% filter(node_status == 'query') %>% pull(name) %>% unique() %>% list()
)

nw.dat$added = map(
  1:nrow(nw.dat),
  ~ nw.dat$node_t[[.x]] %>% filter(node_status == 'added') %>% pull(name) %>% unique() %>% list()
)

nw.dat$nodes = map(
  1:nrow(nw.dat),
  ~ nw.dat$node_t[[.x]] %>% pull(name) %>% unique() %>% list()
)

nw.dat$edges = map(
  1:nrow(nw.dat),
  ~ nw.dat$edge_t[[.x]] %>% pull(edge) %>% unique() %>% list()
)

nw.dat <- relocate(nw.dat, filt, .after = 'bd.filt')
nw.dat <- relocate(nw.dat, q_genes, .after = 'node_t')
```

# KD Modules in Graphs
Compare the distributions between filtered base network and traced subdomain networks  
```{r}
modules <- read_tsv(
  here::here('results','subdomain',
             'module_representation_across_networks.tsv'),
  col_types = cols()
  )

tmp <- modules %>% 
  pivot_longer(cols = 7:ncol(modules)) %>% 
  mutate( 
    # biodom_nw = value
    # , n_nw = (biodom_nw/100)*n_symbol
    # , base_nw = node_edge_filt
    
    subdom_nw = 100*(value / n_symbol)
    , base_nw = 100*(node_edge_filt / n_symbol)
          ) %>%
  # left_join(., subdoms %>% select(bd, name = sd)) %>% 
  rename(sd = name, n_nw = value) %>% 
  pivot_longer(cols = c(subdom_nw, base_nw)) %>% 
  rename(pct = value) %>% 
  filter(n_nw >= 3, pct > 0)

```

```{r}
ggplot(tmp, aes(pct) )+
  geom_density(aes(fill = name), alpha = .5)+
  labs(x = '% GO term genes in NW', 
       subtitle = 'distribution of all terms >0% and >=3 genes in each NW class')
```


# Key Drivers
read & process KDs across biodomain NWs  
```{r warning=FALSE, message=FALSE}
synLogin()

kd <- map2_dfr(
  subdoms$bd, subdoms$sd,
  ~{
  # Get NW info
  nodes <- subdoms %>% 
    filter(bd == .x, sd == .y) %>% 
    pull(nw.dir) %>% .[[1]] %>% 
    filter(grepl('bdFilt.+graphml',name)) %>% 
    pull(id) %>% synGet(.) %>% .$path %>% 
    read_graph(., format = 'graphml') %>% 
    v_info(.) %>% 
    mutate(n_nodes = nrow(.))
  
  # tabulate GO term representation across NW
  nw_terms <- biodom %>% 
    filter(!is.na(n_symbol),n_symbol > 0) %>% 
    select(Biodomain, MODULE = GOterm_Name, NODE = symbol, n_symbol) %>% 
    rowwise() %>% 
    mutate(
      n_nw = length( intersect( NODE, nodes$name ) ),
      pct_term = 100*(n_nw/n_symbol)
    ) %>% 
    distinct()
  
  # get KDA results and annotate
  kd.res <- subdoms %>% 
    filter(bd == .x, sd == .y) %>% 
    pull(nw.dir) %>% .[[1]] %>% filter(name == 'kda') %>% 
    pull(id) %>% read_kd(.)
  
  if( is.null(kd.res) ){
    
    kd.res <- tibble(bd = .x, sd = .y)

  } else {
    
    kd.res <- kd.res %>% 
      left_join(
        ., nodes %>% select(NODE = name, n_nodes, node_status)
      ) %>% 
      left_join(
        ., biodom %>% select(MODULE = GOterm_Name, Biodomain, abbr:color) 
      ) %>% 
      left_join(
        ., nw_terms %>% select(MODULE, n_symbol:pct_term) %>% distinct()
      ) %>% 
      mutate(bd = .x, sd = .y)

    }
  
  return(kd.res)

  }
) %>% rowwise() %>% 
  mutate(top_kd = case_when(
    (top == 1 & top_ef0 == 1)~'both',
    (top == 1 & top_ef0 == 0)~'ef1',
    (top == 0 & top_ef0 == 1)~'ef0',
    (top == 0 & top_ef0 == 0)~'neither',
    )) 

top.kd <- kd %>%
  select(bd, sd, #network = nw,
         n_nodes, kd_biodom = Biodomain,
         MODULE:MEMBER, pct_term, n_symbol, n_nw,
         node_status, top_kd, contains('fdr'), color ) %>%
  filter(ef1_fdr > -log10(0.05), delta_fdr > 0, !(top_kd %in% c('ef0','neither')), pct_term > 50)

# kd %>%
#   select(network = nw, n_nodes, kd_biodom = Biodomain,
#          MODULE:MEMBER, pct_term, n_symbol, n_nw,
#          node_status, top_kd = top, contains('fdr'),
#          color, abbr, label ) %>%
#   write_csv('key_drivers_all_subdom_nw.csv')

# foo <- synStore(File('results/biodomain/key_drivers_all_nw.csv', parent = 'syn51739831'))
# write_csv(kd, paste0(here::here(), '/results/biodomain/key_drivers_all_nw.csv'))

```

## KD results per SD {.tabset}
```{r echo=FALSE,warning=FALSE,message=FALSE,results='asis', fig.width=12, fig.height=15}
bd = kd$bd %>% unique()
plot.new();dev.off()

for(i in bd){
  
  tmp <- kd %>% 
    filter(bd == i) %>% 
    rename(nw = sd) %>% 
    left_join(., subdoms %>% select(nw=sd, bd)) %>% 
    group_by(nw,Biodomain) %>% 
    mutate(n_kd = length(unique(paste0(NODE,':',MODULE)))) %>% 
    ungroup() %>% 
    mutate(Biodomain = fct_reorder(Biodomain, n_kd),
           nw = paste0(nw, '\n', n_nodes, ' nodes'), #str_replace_all(nw,'_','\n')
           nw = fct_reorder(nw, desc(n_nodes) )) %>% 
    arrange(Biodomain)
  
  p = ggplot(tmp, aes(delta_fdr, Biodomain))+
    geom_vline(xintercept = 0, lwd = 0.3)+
    geom_jitter(data = subset(tmp, (top_kd %in% c('ef1','both') & 
                                      ef1_fdr > -log10(0.05) & 
                                      delta_fdr > 0 & 
                                      pct_term > 50)==F ), 
                color = 'grey90', alpha = .1, size = .5, shape = 21)+
    geom_jitter(data = subset(tmp, (top_kd %in% c('ef1','both') & 
                                      ef1_fdr > -log10(0.05) & 
                                      delta_fdr > 0 & 
                                      pct_term > 50)==T ), 
                alpha = .5, shape = 21, color = 'grey30', aes(fill = color, size = ef1_fdr))+
    geom_violin(data = subset(tmp, (top_kd %in% c('ef1','both') & 
                                      ef1_fdr > -log10(0.05) & 
                                      delta_fdr > 0 & 
                                      pct_term > 50)==T ),
                aes(color = color), scale = 'width', alpha=.3, trim = T)+
    labs(y = '', x = '\u0394 FDR, ef1 - ef0')+
    # ggrepel::geom_label_repel(
    #   data = subset(tmp, Biodomain == 'Structural Stabilization'),
    #   aes(label = paste0(NODE, '\n', MODULE)), size = 2, alpha = .7,
    #   max.overlaps = 100)+
    facet_wrap(~nw, scale = 'free_x')+ 
    theme(legend.position = 'top')+
    scale_size_continuous('KDA FDR, -log10',  range = c(.5,3))+
    scale_color_identity()+scale_fill_identity()
  
  cat("  \n###",  i, "  \n")
  plot(p)
  plot.new()
  dev.off()
  cat("  \n  \n")  
  
}
```

## Top KD per SD {.tabset}
```{r echo=FALSE,warning=FALSE,message=FALSE,results='asis', fig.width=12, fig.height=15}
bd = top.kd$bd %>% unique()
plot.new();dev.off()

for(i in bd){
  
  tmp <- top.kd %>% 
    filter(bd == i) %>% 
    rename(nw = sd) %>% 
    left_join(., subdoms %>% select(nw=sd, bd)) %>% 
    group_by(nw,kd_biodom) %>% 
    mutate(n_kd = length(unique(paste0(NODE,':',MODULE)))) %>% 
    ungroup() %>% 
    mutate(kd_biodom = fct_reorder(kd_biodom, n_kd),
           nw = paste0(nw, '\n', n_nodes, ' nodes'),
           nw = fct_reorder(nw, desc(n_nodes) )) %>% 
    arrange(kd_biodom)

  p = ggplot(tmp, aes(ef1_fdr, kd_biodom))+
    geom_jitter(alpha = .2, shape = 21, color = 'grey30', aes(fill = color))+
    geom_violin(aes(color = color), scale = 'width', alpha=.3)+
    labs(y = '', x = '\u0394 FDR, ef1 - ef0')+
    facet_wrap(~nw, scales = 'free_x')+ # 
    scale_fill_identity()+scale_color_identity()
  
  cat("  \n###",  i, "  \n")
  plot(p)
  plot.new()
  dev.off()
  cat("  \n  \n")  
  
}  

```

## KD for each biodom across networks {.tabset}  
```{r echo=FALSE,warning=FALSE,message=FALSE,results='asis', fig.width=10, fig.height=7}
bd = top.kd$kd_biodom %>% unique %>% sort
plot.new();dev.off()
for(i in 1:length(bd)) {
  cat("  \n###",  bd[i], "  \n")
  
  tmp <- top.kd %>% 
    rename(nw = sd) %>% 
    group_by(bd,nw) %>%
    mutate(
      fdr_rank = rank(ef1_fdr) / length(ef1_fdr),
      delta_rank = rank(delta_fdr) / length(delta_fdr)
      ) %>%
    group_by(nw,kd_biodom) %>% 
    mutate(n_kd = length(unique(paste0(NODE,':',MODULE)))) %>% 
    ungroup() %>% 
    mutate(kd_biodom = fct_reorder(kd_biodom, n_kd),
         nw = paste0(bd,'\n', nw, '\n', n_nodes, ' nodes'),
         nw = fct_reorder(nw, desc(n_nodes) )) %>% 
    filter(kd_biodom == bd[i]) %>% 
    arrange(kd_biodom)
  
  if(nrow(tmp)==0){next}
  
  if(tmp %>% filter(fdr_rank > .25 & delta_rank > .25) %>% nrow == 0){
    p = ggplot(tmp, aes(ef1_fdr, delta_fdr))+
      geom_hline(yintercept = 0, lwd = 0.3)+
      geom_abline(intercept = 0, slope = 1, lty =2, lwd = 0.3)+
      geom_jitter(size = 2, alpha = .5, color = 'grey30',
                  aes(fill = color, shape = MEMBER))+
      labs(x = 'ef1 FDR', y = '\u0394 FDR, ef1 - ef0')+
      ggrepel::geom_label_repel(
        # data = subset(tmp, fdr_rank > .25 & delta_rank > .25 ),
        aes(label = paste0(NODE, '\n', MODULE)), 
        size = 2, alpha = .7, min.segment.length = 0, max.overlaps = 7)+
      facet_wrap(~nw, scales = 'free', nrow = 3)+ 
      scale_shape_manual(values = c(23,21))+scale_color_identity()+scale_fill_identity()
  } else {
    p = ggplot(tmp, aes(ef1_fdr, delta_fdr))+
      geom_hline(yintercept = 0, lwd = 0.3)+
      geom_abline(intercept = 0, slope = 1, lty =2, lwd = 0.3)+
      geom_jitter(size = 2, alpha = .5, color = 'grey30', 
                  aes(fill = color, shape = MEMBER))+
      labs(x = 'ef1 FDR', y = '\u0394 FDR, ef1 - ef0')+
      ggrepel::geom_label_repel(
        data = subset(tmp, fdr_rank > .25 & delta_rank > .25 ),
        aes(label = paste0(NODE, '\n', MODULE)), 
        size = 2, alpha = .7, min.segment.length = 0, max.overlaps = 7)+
      facet_wrap(~nw, scales = 'free', nrow = 3)+ 
      scale_shape_manual(values = c(23,21))+scale_color_identity()+scale_fill_identity()
  }

  plot(p)
  plot.new()
  dev.off()
  cat("  \n  \n")  
  
}

```

## KD subnetwork from each network {.tabset}

```{r echo=FALSE,warning=FALSE,message=FALSE,results='asis', fig.width=10, fig.height=10}
plot.new();dev.off()
for(j in 1:nrow(subdoms)){
  
  cat("  \n###",  subdoms$bd[j], ' ', subdoms$sd[j], "  \n")
  
  # specify nodes
  kd.nodes <- top.kd %>%
    filter(bd == subdoms$bd[j], sd == subdoms$sd[j]) %>% 
    mutate(
      fdr_rank = rank(ef1_fdr) / length(ef1_fdr),
      delta_rank = rank(delta_fdr) / length(delta_fdr)
    ) %>%
    select(NODE, node_status, MODULE, kd_biodom, MEMBER, color, top_kd, contains(c('fdr', 'rank'))) %>% 
    arrange(desc(delta_fdr), desc(ef1_fdr)) %>%
    # group_by(Biodomain, NODE, MODULE, MEMBER, color) %>% 
    group_by( NODE ) %>% 
    summarise(n_biodom = length(unique(kd_biodom))
           , n_term = length(unique(MODULE))
           , ef1_max = max(ef1_fdr)
           , delta_max = max(delta_fdr)
           , sum_delta_rank = sum(delta_rank)
           , sum_fdr_rank = sum(fdr_rank)
           , mean_delta_rank = mean(delta_rank)
           , mean_fdr_rank = mean(fdr_rank)
               ) 
  
  if(nrow(kd.nodes)==0){ 
    plot.new()
    dev.off()
    cat("  \n  \n")  
    next 
    }

  # pull NW to view subgraphs
  nw = subdoms %>% 
    filter(bd == subdoms$bd[j], sd == subdoms$sd[j]) %>% 
    pull(nw.dir) %>% .[[1]] %>% 
    filter(grepl('bdFilt.+graphml',name)) %>% 
    pull(id) %>% synGet(.) %>% .$path %>% 
    read_graph(., format = 'graphml')
  snw = igraph::simplify(nw, remove.multiple = T)
  
  # subnetwork of just KD Nodes  
  vert_num <- match(kd.nodes$NODE, V(snw)$name)
  vert_neigh <- neighbors(snw, vert_num)

  g3 <- induced_subgraph(snw, c(vert_num, vert_neigh))
  unlinked <- names(degree(g3)[which(degree(g3)==0)])
  g3 <- delete.vertices(g3, unlinked)
  
  # KD evidence
  x = tibble( node = V(g3) %>% names ) %>% 
    left_join(., kd.nodes, by = c('node'='NODE')) %>% 
    mutate(kd = if_else(is.na(n_term), 0, 1))
  
  for(i in 2:ncol(x)){
    igraph::vertex_attr(g3, names(x)[i], index = igraph::V(g3)) <- x %>% pull(i)
  }
  
  kd_nw <- ggraph(g3, layout = 'graphopt') +
    geom_edge_link(alpha = .3, color = 'grey90') +
    geom_node_point( shape = 21, color = "grey50", alpha = .2
                     , fill = 'grey90', 
                     aes(filter= .N()$kd == 0)  )+
    geom_node_point( color = "grey50", alpha = .4, 
                     aes(fill = ef1_max, 
                         size = delta_max, 
                         shape=node_status, 
                         filter = .N()$kd == 1) )+
    scale_shape_manual(name='Node Source', breaks=c('added', 'query'),
                       values=c('added'=23, 'query'=21))+
    scale_size_continuous(range = c(3,12))+
    geom_node_text(aes(label = name, filter = .N()$kd == 1), size = 3) +
    viridis::scale_fill_viridis()+
    labs(subtitle = paste0(subdoms$sd[j], ' network KDs'))+
    theme_graph(background = 'white')
  
  plot(kd_nw)
  plot.new()
  dev.off()
  cat("  \n  \n")  
  
}


```


# Top KDs across networks  

```{r fig.width=5, fig.height=5}
tmp <- top.kd %>% 
  mutate(network = paste0(bd,':',sd)) %>% 
  group_by(network) %>% 
  mutate(
    fdr_rank = rank(ef1_fdr) / length(ef1_fdr),
    delta_rank = rank(delta_fdr) / length(delta_fdr)
  ) %>% 
  group_by(NODE) %>% 
  summarise(
    n_nw = length(unique(network)),
    n_terms = length(unique(MODULE)),
    n_biodom = length(unique(kd_biodom)),
    mean_delta_rank = mean(delta_rank),
    mean_fdr_rank = mean(fdr_rank),
    sum_delta_rank = sum(delta_rank),
    sum_fdr_rank = sum(fdr_rank)
    ) %>% 
  ungroup() %>% 
  mutate(AgoraNom = if_else(NODE %in% agora$hgnc_symbol, T, F)) %>% 
  relocate(AgoraNom, .after = NODE) %>%   arrange( desc(n_nw), desc(sum_delta_rank) ) #, desc(n_biodom)

DT::datatable(tmp, rownames = F, filter = 'top') %>% 
  DT::formatSignif(columns = c('sum_delta_rank','sum_fdr_rank', 'mean_delta_rank','mean_fdr_rank'), digits = 2)
```

```{r fig.width=8, fig.height=6}
ggplot(tmp, aes(sum_fdr_rank, sum_delta_rank))+ 
  geom_abline(intercept = 0, slope = 1, lty = 2, lwd = .5)+
  geom_point(alpha = .3, shape = 21, color = 'grey30', aes(size = n_nw, fill = AgoraNom))+
  scale_fill_manual(values=c('grey80','blue'))+
  ggrepel::geom_label_repel(
    data = subset(tmp, n_nw >= 4), aes(label = NODE)
    , size = 2, min.segment.length = 0, max.overlaps = 20)
```

## Top MODULES across networks {.tabset}   
```{r }
tmp <- top.kd %>% 
  mutate(network = paste0(bd,':',sd)) %>% 
  group_by(network) %>% 
  mutate(
    fdr_rank = rank(ef1_fdr) / length(ef1_fdr),
    delta_rank = rank(delta_fdr) / length(delta_fdr)
  ) %>% 
  group_by(kd_biodom, MODULE, color) %>% 
  summarise(
    n_nw = length(unique(network)),
    n_nodes = length(unique(NODE)),
    # n_biodom = length(unique(Biodomain)),
    mean_delta_rank = mean(delta_rank),
    mean_fdr_rank = mean(fdr_rank),
    sum_delta_rank = sum(delta_rank),
    sum_fdr_rank = sum(fdr_rank)
    ) %>% 
  ungroup() %>% 
  arrange( desc(n_nw), desc(mean_delta_rank) )

DT::datatable(tmp %>% select(-color), rownames = F, filter = 'top') %>% 
  DT::formatSignif(columns = c('mean_delta_rank','mean_fdr_rank','sum_delta_rank','sum_fdr_rank'), digits = 2)
```
 
```{r fig.width=10, fig.height=8}
ggplot(tmp, aes(sum_fdr_rank, sum_delta_rank))+ 
  geom_abline(intercept = 0, slope = 1, lty = 2, lwd = .5)+
  # geom_smooth(method = 'lm')+
  geom_point(shape = 21, color = 'black', alpha = .3, aes(size = n_nw, fill = color))+
  scale_fill_identity()+ 
  ggrepel::geom_label_repel(
    data = subset(tmp, n_nw >= 5 
                  & MODULE %in% enr.bd$Description[which(enr.bd$p.adjust < 0.05)] 
                  ),
    aes(label = paste0(str_trunc(MODULE, width = 30, side = 'right')) )
    , size = 2.5, min.segment.length = 0, max.overlaps = 20)
# +
#   facet_wrap(~kd_biodom)
```

```{r echo=FALSE,warning=FALSE,message=FALSE,results='asis', fig.width=8, fig.height=6}
bd = tmp$kd_biodom %>% unique %>% sort
plot.new();dev.off()
for(i in 1:length(bd)) {
  cat("  \n###",  bd[i], "  \n")
  # if(bd[i] %in% c('Tau Homeostasis','RNA Spliceosome') ){
  #   p <- ggplot(
  #     data = subset(tmp, Biodomain == bd[i]),
  #     aes(mean_fdr_rank, mean_delta_rank)
  #     )+
  #     coord_cartesian(xlim = c(0,1), ylim = c(0,1))+
  #     geom_abline(intercept = 0, slope = 1, lty = 2, lwd = .5)+
  #     geom_point(color = 'black', alpha = .5, aes(size = n_nw, fill = color, shape = MEMBER))+
  #     scale_fill_identity()+ scale_shape_manual('KD in term',values = c(23, 21))+
  #     facet_wrap(~Biodomain, scales = 'free')
  # } else {
    p <- ggplot(
      data = subset(tmp, kd_biodom == bd[i]),
      aes(sum_fdr_rank, sum_delta_rank)
      )+ 
      # coord_cartesian(xlim = c(0,1), ylim = c(0,1))+
      geom_abline(intercept = 0, slope = 1, lty = 2, lwd = .5)+
      geom_point(shape = 21, color = 'black', alpha = .5, aes(size = n_nw, fill = color))+
      scale_fill_identity()+ 
      ggrepel::geom_label_repel(
        data = subset(tmp, n_nw >= 3 & kd_biodom == bd[i]
                      # & mean_delta_rank > mean_fdr_rank
                      # & MODULE %in% enr.bd$pathway[enr.bd$padj < 0.05]
                      ), 
        aes(label = str_trunc(MODULE, width = 25,side = 'right') ) 
        , size = 2.5, min.segment.length = 0, max.overlaps = 20, alpha = .6)+
      facet_wrap(~kd_biodom, scales = 'free')
  # }
  plot(p)
  plot.new()
  dev.off()
  cat("  \n  \n")  
}

```
 

## Top NODE-MODULE combinations across networks 
```{r }
tmp <- top.kd %>% 
  mutate(network = paste0(bd,':',sd)) %>% 
  group_by(network) %>% 
  mutate(
    fdr_rank = rank(ef1_fdr) / length(ef1_fdr),
    delta_rank = rank(delta_fdr) / length(delta_fdr)
  ) %>% 
  group_by(kd_biodom, NODE, MODULE, MEMBER, color) %>% 
  summarise(
    n_nw = length(unique(network)),
    # n_nodes = length(unique(NODE)),
    # n_biodom = length(unique(Biodomain)),
    sum_delta_rank = sum(delta_rank),
    sum_fdr_rank = sum(fdr_rank),
    mean_delta_rank = mean(delta_rank),
    mean_fdr_rank = mean(fdr_rank)
    ) %>% 
  ungroup() %>% 
  mutate(AgoraNom = if_else(NODE %in% agora$hgnc_symbol, T, F)) %>% 
  relocate(AgoraNom, .after = NODE) %>% 
  arrange(desc(n_nw), desc(mean_delta_rank))

DT::datatable(tmp %>% select(-color, -contains('mean')), rownames = F, filter = 'top') %>% 
  DT::formatSignif(columns = c(#'mean_delta_rank','mean_fdr_rank'
                                # , 
                                'sum_delta_rank', 'sum_fdr_rank'
                               ), digits = 2)
```

### mean {.tabset}

```{r fig.width=10, fig.height=8}
ggplot(tmp, aes(mean_fdr_rank, mean_delta_rank))+ 
  geom_abline(intercept = 0, slope = 1, lty = 2, lwd = .5)+
  # geom_smooth(method = 'lm')+
  geom_point(color = 'black', alpha = .3, aes(size = n_nw, fill = color, shape = MEMBER))+
  scale_fill_identity()+ scale_shape_manual('KD in term',values = c(23, 21))+
  ggrepel::geom_label_repel(
    data = subset(tmp, n_nw >= 4),
    aes(label = paste0(NODE,'\n',str_trunc(MODULE, width = 20, side = 'right')) )
    , size = 3, min.segment.length = 0, max.overlaps = 20)
  # +
  # facet_wrap(~kd_biodom)
```

```{r echo=FALSE,warning=FALSE,message=FALSE,results='asis', fig.width=8, fig.height=6}
bd = tmp$kd_biodom %>% unique %>% sort
plot.new();dev.off()
for(i in 1:length(bd)) {
  cat("  \n####",  bd[i], "  \n")
  if( (tmp %>% filter(kd_biodom == bd[i], n_nw  >= 2, 
                      MODULE %in% enr.bd$Description[enr.bd$p.adjust < 0.05]) %>% nrow())==0 ){
    p <- ggplot(
      data = subset(tmp, kd_biodom == bd[i]),
      aes(mean_fdr_rank, mean_delta_rank)
      )+
      coord_cartesian(xlim = c(0,1), ylim = c(0,1))+
      geom_abline(intercept = 0, slope = 1, lty = 2, lwd = .5)+
      geom_point(color = 'black', alpha = .5, aes(size = n_nw, fill = color, shape = MEMBER))+
      scale_fill_identity()+ scale_shape_manual('KD in term',values = c(23, 21))+
      facet_wrap(~kd_biodom) #, scales = 'free'
  } else {
    p <- ggplot(
      data = subset(tmp, kd_biodom == bd[i]),
      aes(mean_fdr_rank, mean_delta_rank)
      )+ 
      coord_cartesian(xlim = c(0,1), ylim = c(0,1))+
      geom_abline(intercept = 0, slope = 1, lty = 2, lwd = .5)+
      geom_point(color = 'black', alpha = .5, aes(size = n_nw, fill = color, shape = MEMBER))+
      scale_fill_identity()+ scale_shape_manual('KD in term',values = c(23, 21))+
      ggrepel::geom_label_repel(
        data = subset(tmp, n_nw >= 2 & kd_biodom == bd[i]
                      & MODULE %in% enr.bd$Description[enr.bd$p.adjust < 0.05]
                      ), 
        aes(label = paste0(NODE,'\n',str_trunc(MODULE, width = 40, side = 'right')) )
        , size = 2, min.segment.length = 0, max.overlaps = 20, alpha = .6)+
      facet_wrap(~kd_biodom)#, scales = 'free'
  }
  plot(p)
  plot.new()
  dev.off()
  cat("  \n  \n")  
}

```


### sum {.tabset}

```{r fig.width=10, fig.height=8}
ggplot(tmp, aes(sum_fdr_rank, sum_delta_rank))+ 
  geom_abline(intercept = 0, slope = 1, lty = 2, lwd = .5)+
  # geom_smooth(method = 'lm')+
  geom_point(color = 'black', alpha = .3, aes(size = n_nw, fill = color, shape = MEMBER))+
  geom_point(data = subset(tmp, AgoraNom), shape = 8, color = 'black', alpha = .3, aes(size = n_nw))+
  scale_fill_identity()+ scale_shape_manual('KD in term',values = c(23, 21))+
  ggrepel::geom_label_repel(
    data = subset(tmp, n_nw >= 4 | (AgoraNom & n_nw >= 2)),
    aes(label = paste0(NODE,'\n',str_trunc(MODULE, width = 45, side = 'right')) )
    , size = 2.5, min.segment.length = 0, max.overlaps = 20)
  # +
  # facet_wrap(~kd_biodom)
```

```{r echo=FALSE,warning=FALSE,message=FALSE,results='asis', fig.width=8, fig.height=6}
bd = tmp$kd_biodom %>% unique %>% sort
plot.new();dev.off()
for(i in 1:length(bd)) {
  cat("  \n####",  bd[i], "  \n")
  if( (tmp %>% filter(kd_biodom == bd[i], n_nw  >= 3, !duplicated(NODE) ,
                      MODULE %in% enr.bd$Description[enr.bd$p.adjust < 0.05]) %>% nrow())==0 ){
    p <- ggplot(
      data = subset(tmp, kd_biodom == bd[i]),
      aes(sum_fdr_rank, sum_delta_rank)
      )+
      coord_cartesian(xlim = c(0,1), ylim = c(0,1))+
      geom_abline(intercept = 0, slope = 1, lty = 2, lwd = .5)+
      geom_point(color = 'black', alpha = .5, aes(size = n_nw, fill = color, shape = MEMBER))+
      scale_fill_identity()+ scale_shape_manual('KD in term',values = c(23, 21))+
      facet_wrap(~kd_biodom) #, scales = 'free'
  } else {
    p <- ggplot(
      data = subset(tmp, kd_biodom == bd[i]),
      aes(sum_fdr_rank, sum_delta_rank)
      )+ 
      # coord_cartesian(xlim = c(0,1), ylim = c(0,1))+
      geom_abline(intercept = 0, slope = 1, lty = 2, lwd = .5)+
      geom_point(color = 'black', alpha = .5, aes(size = n_nw, fill = color, shape = MEMBER))+
      scale_fill_identity()+ scale_shape_manual('KD in term',values = c(23, 21))+
      ggrepel::geom_label_repel(
        data = subset(tmp, n_nw >= 3 & kd_biodom == bd[i] 
                      & MODULE %in% enr.bd$Description[enr.bd$p.adjust < 0.05]
                      # & !duplicated(NODE)
                      ), 
        aes(label = paste0(NODE,'\n',str_trunc(MODULE, width = 40, side = 'right')) )
        , size = 2, min.segment.length = 0, max.overlaps = 20, alpha = .6)+
      facet_wrap(~kd_biodom)#, scales = 'free'
  }
  plot(p)
  plot.new()
  dev.off()
  cat("  \n  \n")  
}

```


# Session
```{r}
sessionInfo()  
```

