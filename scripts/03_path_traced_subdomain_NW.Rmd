---
title: "Sub-domain NWs"
author: "Greg Cary"
date: "`r Sys.Date()`"
output: 
  html_document: 
    fig_width: 5
    fig_height: 4
  html_notebook:
    code_folding: hide
    theme: readable
    css: style.css
    toc: true
    toc_float: true
---
# Setup

## packages  
```{r setup}
# # Package names
# packages <- c(
#   # 'paxtoolsr','org.Hs.eg.db','HotNetvieweR','clusterProfiler', 
#   'synapser','igraph','tidygraph','ggraph','tidyverse'
#   )
# 
# # Load packages
# invisible(lapply(packages, library, character.only = TRUE))

library(synapser)
library(igraph)
library(tidygraph)
library(ggraph)
library(tidyverse)

source('../../treatAD_biodomains/scripts/biodom_tally.R')
source('../../treatAD_biodomains/scripts/annotate_enr_term_biodomains.R')
source('../../treatAD_biodomains/scripts/biodom_enr_plots.R')

theme_set(theme_bw())
```

## TREAT-AD data
Grab relevant data from synapse, including:
1) Target Risk Scores ([syn25575156](https://www.synapse.org/#!Synapse:syn25575156){target="_blank"}) and Omics Scores ([syn22758536](https://www.synapse.org/#!Synapse:syn22758536){target="_blank"})  
2) Biodomain Definitions ([syn25428992](https://www.synapse.org/#!Synapse:syn25428992){target="_blank"})  
2) Risk-enriched Biodomain Terms ([syn45824995](https://www.synapse.org/#!Synapse:syn45824995){target="_blank"})
3) Base Network ([syn51110930](https://www.synapse.org/#!Synapse:syn51110930){target="_blank"})  
4) Synapse IDs of path-traced NW objects  
5) Synapse IDs of wKDA results 
6) CRISPRbrain simple phenotype screen data  

```{r}
synLogin()

# target risk scores
scores <- read_csv(
  synTableQuery('select * from syn25575156', includeRowIdAndRowVersion = F)$filepath
  , col_types = cols())
omics <- read_csv(
  synTableQuery('select * from syn22758536', includeRowIdAndRowVersion = F)$filepath
  , col_types = cols())

# biological domain annotations
biodom <- full_join(
  # biodomains
  readRDS(synGet('syn25428992')$path),
  # domain labels
  read_csv(synGet('syn26856828')$path, col_types = cols()),
  by = c('Biodomain'='domain')
) %>%
  mutate(Biodomain = case_when(Biodomain == 'none' ~ NA_character_, T ~ Biodomain))

domains = biodom %>% pull(Biodomain) %>% unique() %>% sort()

# enriched biodomain terms
enr.bd <- read_csv( synGet('syn45824995')$path, col_types = cols() ) %>% 
  mutate(leadingEdge_genes = str_split(leadingEdge_genes, '\\|'))

# base network
base_net <- igraph::read_graph(synGet('syn51110930')$path, format = 'graphml') 

# specify directed edge types
directed_edge_types = c("catalysis-precedes",
                        "controls-expression-of",
                        "controls-phosphorylation-of",
                        "controls-state-change-of",
                        "controls-transport-of"
                        )
```

pre-filtered NWs    
```{r}
undir <- base_net

# filt node & edge
tmp <- igraph::delete_vertices(
  base_net,
  igraph::V(base_net)[ igraph::V(base_net)$brain_exp == 0 ]
)
undir_node_edge <- igraph::subgraph.edges(
  tmp,
  igraph::E(tmp)[ igraph::E(tmp)$n_edge_evidence > 1 ],
  delete.vertices = T 
)

# filt node
undir_node <- igraph::delete_vertices(
    base_net,
    igraph::V(base_net)[ igraph::V(base_net)$brain_exp == 0 ]
  )

# filt edge
undir_edge <- igraph::subgraph.edges(
    base_net,
    igraph::E(base_net)[ igraph::E(base_net)$n_edge_evidence > 1 ],
    delete.vertices = T 
  )

# dir
dir <- igraph::subgraph.edges( 
    base_net, 
    igraph::E(base_net)[ igraph::E(base_net)$directed == 1 ],
    delete.vertices = T 
  ) %>% 
    as.directed(mode = 'arbitrary')

# dir node edge
dir_node_edge <- igraph::subgraph.edges( 
    undir_node_edge, 
    igraph::E(undir_node_edge)[ igraph::E(undir_node_edge)$directed == 1 ],
    delete.vertices = T 
  ) %>% 
    as.directed(mode = 'arbitrary')

# dir node
dir_node <- igraph::subgraph.edges( 
    undir_node, 
    igraph::E(undir_node)[ igraph::E(undir_node)$directed == 1 ],
    delete.vertices = T 
  ) %>% 
    as.directed(mode = 'arbitrary')

# dir edge
dir_edge <- igraph::subgraph.edges( 
    undir_edge, 
    igraph::E(undir_edge)[ igraph::E(undir_edge)$directed == 1 ],
    delete.vertices = T 
  ) %>% 
    as.directed(mode = 'arbitrary')

```

## cbrain data
Read CRISPRbrain phenotype data 
```{r warning=FALSE}
synLogin()

# CRISPRbrain data
syn.dir <- synGetChildren('syn51183357')$asList() %>% 
  tibble(f = .) %>% 
  unnest_wider(f)

# Simple Screens
simple <- map_dfr(
  syn.dir %>% with(which( !grepl('RNA|CROP',name) )),
  ~ { 
    id = syn.dir$id[.x]
    n = syn.dir$name[.x]
    synGet(id)$path %>% 
      read_csv( col_types = cols() ) %>% 
      mutate(cell = n %>% str_split_fixed(.,'-(?!M)', 2) %>% .[,1],
             mode = n %>% str_extract('CRISPR[ain]'),
             expt = n %>% str_remove_all('-CRISPR[ain].csv') %>% 
               str_split_fixed('-(?!M)',2) %>% .[,2] ) %>% 
      relocate(cell, mode, expt)
  }
  ) %>% 
  rename(pval = `P Value`, pheno = `Phenotype`, gene_score = `Gene Score`)

simple <- tibble(expt = simple$expt %>% unique() %>% sort(),
                 phenotype = c('Expansion (CD34 Staining)',
                                'Reactive Oxygen Species (CellRox Intensity)',
                                'Proliferation (CFSE Staining)',
                                'Survival (14 day)', 'Survival (21 day)', 'Survival (28 day)',
                                'Labile Iron (FeRhoNox Intensity)',
                                'Immune Activation (CD38 levels)',
                                'Lysosome Exocytosis (cell surface LAMP1), +IL1a +TNF +C1q',
                                'Lysosome Exocytosis (cell surface LAMP1), Vehicle',
                                'Peroxidized Lipids (Liperfluo intensity)',
                                'Lysosome (LysoTracker intensity)',
                                'Lysosome Mass or pH (LysoTracker staining), +IL1a +TNF +C1q',
                                'Lysosome Mass or pH (LysoTracker staining), Vehicle',
                                'Survival, no antioxidants',
                                'Phagocytosis (pHRodo-rat synaptosomes)',
                                'Phagocytosis (pHRodo-labeled synaptosomes), +IL1a +TNF +C1q',
                                'Phagocytosis (pHRodo-labeled synaptosomes), Vehicle',
                                'Survival, PSAP KO & no antioxidants',
                                'Survival, PSAP KO',
                                'Survival',
                                'Survival-Proliferation',
                                'Inflammatory activation (cell-surface VCAM1 levels), +IL1a +TNF +C1q')
                 ) %>% left_join(simple, . , by = 'expt')

# filter(cell %in% c('iAstrocyte','Glutamatergic Neuron','iTF-Microglia','iPSC')) # don't consider HSPC or T-cell
```

## NW & KDA data



<!-- ```{r} -->

<!-- # read NW results dir on Synapse -->
<!-- nw.dirs <- map_dfr( -->
<!--   synGetChildren('syn51739831')$asList() %>% -->
<!--     tibble(f = .) %>% unnest_wider(f) %>% -->
<!--     filter( -->
<!--       !(name %in% c('pseudotime','nanostring_induced_subgraph.graphml', 'key_drivers_all_nw.csv')) -->
<!--       ) %>% -->
<!--     pull(id), -->
<!--   ~{ synGetChildren(  parent = .x  )$asList() %>% -->
<!--       tibble(f = .) %>% unnest_wider(f) %>% -->
<!--       filter(grepl('graphml', name)) %>% -->
<!--       mutate( -->
<!--         bd = str_extract(name, '^(?<=[bdFiltered_]{0,1}).+(?=_[un]*directed)') %>% -->
<!--           str_remove_all('bdFiltered_') %>% str_replace_all('_',' '), -->
<!--         bd.filt = if_else(grepl('bdFiltered',name),T,F), -->
<!--         filt = str_extract(name, '(?<=_filt_).+(?=\\.graphml)'), -->
<!--         dir = str_extract(name, '[un]*directed') -->
<!--         ) %>% -->
<!--       relocate(bd, bd.filt, filt, dir) -->
<!--     } -->
<!-- ) %>% -->
<!--   filter(!grepl('Astro|Micro', filt)) -->

<!-- # read KDA results dir on Synapse -->
<!-- kda.dirs <- map_dfr( -->
<!--   synGetChildren('syn51739831')$asList() %>% -->
<!--     tibble(f = .) %>% unnest_wider(f) %>% -->
<!--     filter( -->
<!--       !(name %in% c('pseudotime','nanostring_induced_subgraph.graphml', 'key_drivers_all_nw.csv')) -->
<!--       ) %>% -->
<!--     pull(id), -->
<!--   ~{ id = synGetChildren( parent = .x )$asList() %>% -->
<!--       tibble(f = .) %>% unnest_wider(f) %>% -->
<!--       filter(grepl('kda', name)) %>% pull(id) -->

<!--      bd = synGet(.x)$properties$name -->

<!--      synGetChildren(id)$asList() %>% -->
<!--        tibble(f = .) %>% unnest_wider(f) %>% -->
<!--        filter(grepl('results|tophits',name)) %>% -->
<!--        mutate( -->
<!--           bd = bd %>% str_replace_all('_' ,' '), -->
<!--           filt = str_extract(name, '(?<=_filt_).+(?=_addWeights)'), -->
<!--           dir = str_extract(name, '[un]*directed'), -->
<!--           ef = str_extract(name, '(?<=_edgeFactor_)[0|1]') -->
<!--           ) %>% -->
<!--         relocate(bd, filt, dir, ef) -->
<!--     } -->
<!-- ) %>% -->
<!--   mutate(set = case_when(grepl('results', name) ~ 'full', grepl('top',name) ~ 'top', T ~ NA_character_)) %>% -->
<!--   relocate(set) %>% -->
<!--   filter(!grepl('Astro|Micro', filt)) -->
<!-- ``` -->

read local results directories
```{r}
# # read local results dir
# doms = list.files('../results/biodomain')
# nw.dirs <- tibble(bd = doms, i = 1:length(doms)) %>% 
#   rowwise() %>% 
#   mutate(
#     f = list.files( paste0('../results/biodomain/',bd) ) %>% list(),
#     kd = list.files( paste0('../results/biodomain/',bd,'/kda') ) %>% list()
#   )
# nw.dirs$kd[[ match('APP_Metabolism', nw.dirs$bd) ]]

# i = which(doms == 'Immune_Response')

# # check which trace / KDA jobs have completed
# nw.dirs %>% rowwise() %>% mutate(n = length(unlist(kd))) %>% arrange(desc(n))
```

## functions

NW properties  
```{r}
v_info <- function(net){
  v.attr <- tibble( na = vertex.attributes(net) ) %>%
    t() %>% 
    as_tibble(rownames = NA, .name_repair = 'unique') %>% 
    unnest(everything()) %>%
    rename_with(., ~names(vertex.attributes(net)), everything())
}

e_info <- function(net){
  e.attr <- tibble( ea = edge.attributes(net) ) %>% 
    t() %>% 
    as_tibble(rownames = NA, .name_repair = 'unique') %>% 
    unnest(everything()) %>% 
    rename_with(., ~names(edge.attributes(net)), everything())
}
```

# Sub-domain NW analysis

Explore the effects of NW filters on traces & KDs for these sets:
• node & edge filtering effects
• direct edge filter before vs after trace
• nodes added by trace
• common vs unique nodes across BD
<!-- • KDA on full (i.e. not BD filtered) NW objects -->

read results from synapse  
```{r}
# top level biodom directory
subdoms <- synGetChildren('syn52314422')$asList() %>%
  tibble(f = .) %>% unnest_wider(f) %>%
  select(bd = name, bd_id = id) %>% 
  rowwise() %>% 
  mutate(
    subdoms = synGetChildren( parent = bd_id )$asList() %>% 
      tibble(f = .) %>% unnest_wider(f) %>% list()
    ) %>% 
  unnest(subdoms) %>% 
  select(bd, sd = name, id) %>% 
  rowwise() %>% 
  mutate(
    nw.dir = synGetChildren(  parent = id  )$asList() %>%
      tibble(f = .) %>% unnest_wider(f) %>% list(),
    kd.dir = synGetChildren(  parent = nw.dir$id[grepl('kda',nw.dir$name)]  )$asList() %>%
      tibble(f = .) %>% unnest_wider(f) %>% list()
  )

```

## Calculate NW stats

```{r}
nw.dat = subdoms %>% select(bd, sd, nw.dir) %>% 
  unnest(nw.dir) %>% filter(grepl('bdFiltered.+graphml',name)) %>%
  select(bd,sd,id)

future::plan('multisession')
x = furrr::future_map_dfr(
  nw.dat$id,
  ~{synLogin()
    nw = synGet(.x) %>% .$path %>% read_graph(., format = 'graphml')
    snw = igraph::simplify(nw, remove.multiple = T)
    tibble(
      avg_node_degree = degree(snw, V(snw)) %>% mean(),
      avg_path_length = snw %>% average.path.length,
      assortativity_coef = snw %>% assortativity(., types1 = V(.)),
      connected_components = snw %>% no.clusters,
      edges = E(nw)$edge %>% unique() %>% list(),
      s.edges = E(snw)$edge %>% unique() %>% list(),
      nodes = V(nw) %>% names() %>% unique() %>% list(),
      s.nodes = V(snw) %>% names() %>% unique() %>% list()
    )
  }
)
future::plan('sequential')

nw.dat = bind_cols(nw.dat, x)

nw.dat$q_genes <- map(
  1:nrow(subdoms),
  ~ subdoms$nw.dir[[.x]] %>% filter( grepl('queryList', name) ) %>% 
    pull(id) %>% synGet(.) %>% .$path %>% 
    read_tsv(., col_names = F, col_types = cols()) %>% 
    pull(X1) 
)

nw.dat$input_genes <- map(
  1:nrow(nw.dat),
  ~ intersect( unlist(nw.dat$q_genes[.x]), names(V(undir_node_edge)) )
)

nw.dat$added_genes <- map(
  1:nrow(nw.dat),
  ~ setdiff( nw.dat$nodes[[.x]], nw.dat$input_genes[[.x]] ) 
)

nw.dat <- nw.dat %>% 
  mutate(bd = str_replace_all(bd, '_' ,' ')) %>% 
  left_join(., biodom %>% select(bd = Biodomain, color, abbr ) %>% distinct() ) 
  
# -common nodes
# V(nw) %>% names() %>% unique() %>% length()
# -common edges
# E(nw)$edge %>% head()
#  by filt, direction
```

## NW size
```{r}
nw.summary <- bind_rows(
  nw.dat, 
  # nw.dat_bd %>% 
  #   mutate(bd = str_replace_all(bd, '_' ,' ')) %>% 
  #   filter(bd %in% nw.dat$bd) %>% 
  #   left_join(., biodom %>% select(bd = Biodomain, color, abbr ) %>% distinct() )
  ) %>% 
  mutate(sd = paste0(abbr,':',sd)) %>% 
  group_by(bd, sd, abbr, color) %>% 
  summarise(
    q_genes = length(unique(unlist(q_genes))),
    input = length(unique(unlist(input))),
    added = length(unique(unlist(added))),
    nodes = length(unique(unlist(nodes))),
    edges = length(unique(unlist(edges))),
  ) %>% 
  mutate(
    n_possible_edge = (n_nodes * (n_nodes-1))/2,
    fxn_possible = n_edges/n_possible_edge
  )

# to calculate the number of possible edges in a graph with N nodes
# directed graph: N*(N-1)
# undriected graph: (N * (N-1)) / 2
nw.summary$n_possible_edge = map_dbl(1:nrow(nw.summary), ~ ( nw.summary$n_nodes[.x] * (nw.summary$n_nodes[.x]-1)) / 2)
nw.summary$fxn_possible = map_dbl(1:nrow(nw.summary), ~ nw.summary$n_edges[.x] / nw.summary$n_possible_edge[.x] )
```

```{r fig.width=8, fig.height=4}
tmp <- nw.summary %>% 
  pivot_longer(cols = c(n_nodes, n_edges, fxn_possible)) %>% 
  mutate( 
    max = case_when(
      name == 'n_nodes' ~ V(undir_node_edge) %>% length(),
      name == 'n_edges' ~ E(undir_node_edge) %>% length(),
      name == 'fxn_possible' ~ integer(1)),
    name = fct_relevel(name, c('n_nodes','n_edges', 'fxn_possible'))
    ) %>% 
  filter(name!='fxn_possible')

ggplot(tmp, aes(q_genes, value))+
  geom_point(data = subset(tmp,grepl(':NA',sd)),
             aes(fill = color), size = 5, alpha = .5, shape = 23)+
  geom_point(data = subset(tmp,!grepl(':NA',sd)),
               aes(fill = color), size = 3, alpha = .5, shape = 21)+
  ggrepel::geom_text_repel(aes(label = abbr), size = 2.5)+
  geom_hline(aes(yintercept = max), lty = 2)+
  scale_y_log10()+
  scale_fill_identity()+
  labs(x = '# query genes', y = '# NW features')+
  # geom_smooth()+
  facet_wrap(~name, scales = 'free')
```

## NW properties ~ Biodomains
Global properties of biodomain-filtered path traced networks
```{r fig.width=12, fig.height=5}
tmp <- bind_rows(
  nw.dat, 
  nw.dat_bd %>% 
    mutate(bd = str_replace_all(bd, '_' ,' ')) %>% 
    filter(bd %in% nw.dat$bd) %>% 
    left_join(., biodom %>% select(bd = Biodomain, color, abbr ) %>% distinct() )
  ) %>% 
  # nw.dat %>% 
  # mutate(sd = paste0(abbr,':',sd)) %>% 
  # filter(bd == dom) %>%
  select(-s.edges, -q_genes, -s.nodes) %>% 
  rowwise() %>%
  mutate( sd = if_else(is.na(sd), bd, sd),
          across( edges:added_genes, ~ length(unique(unlist(.x))) ),
          fxn_added = added_genes/nodes,
          total_possible_edge = (nodes*(nodes-1))/2,
          fxn_possible_edge = edges/total_possible_edge) %>% 
  rename(added_nodes = added_genes) 

tmp %>% 
  pivot_longer(cols = c(avg_node_degree:added_nodes, fxn_added, fxn_possible_edge), 
               names_to = 'properties', values_to = 'val') %>% 
  mutate(properties = factor(properties,
                             levels = c('input_genes',
                                        'nodes',
                                        'added_nodes',
                                        'fxn_added',
                                        
                                        'edges',
                                        'fxn_possible_edge',
                                        'connected_components',
                                        
                                        'avg_node_degree',
                                        'assortativity_coef',
                                        'avg_path_length'
                                        
                                        )),
         sd = factor(sd,
                     levels = tmp %>% group_by(bd) %>% 
                       arrange(input_genes, .by_group = T) %>% pull(sd)
                     ),
         val = signif(val, digits = 2)
         ) %>% 
  filter(properties %in% c('input_genes', 'nodes', 'added_nodes', 'edges', 
                           'connected_components','avg_node_degree','avg_path_length')) %>% 
  ggplot(aes(val, sd)) +
  geom_bar(stat = 'identity', position = 'dodge', aes(fill = color), 
           alpha = .8, color = 'grey30', width = .7)+
  theme(legend.position = 'top')+
  labs(y = '',x = '')+
  scale_fill_identity()+
  # scale_y_log10()+
  facet_wrap(~properties, scales = 'free_x', nrow = 1)

```

## Overlapping NW elements
### Inputs
Query genes
```{r fig.width=11, fig.height=9}

olap <- crossing(nw1 = nw.dat$sd, nw2 = nw.dat$sd) %>% 
  group_by(nw1,nw2) %>% 
  mutate(.keep = 'all', 
         intersect = length(intersect(
           nw.dat %>% filter(sd == nw1) %>% pull(q_genes) %>% unlist(),
           nw.dat %>% filter(sd == nw2) %>% pull(q_genes) %>% unlist()
           ))
         ) %>% 
  ungroup() %>% group_by(nw1) %>% 
  mutate(.keep = 'all', pct_overlap = intersect / intersect[which(nw2 == nw1)]) %>% 
  ungroup() %>%
  mutate(
    nw1 = fct_relevel(
      nw1, 
      nw.dat %>% select(sd, q_genes) %>% distinct() %>% 
        mutate(len = length(unlist(q_genes))) %>% arrange(len) %>% pull(sd)
                      ),
    nw2 = fct_relevel(
      nw2, 
      nw.dat %>% select(sd, q_genes) %>% distinct() %>% 
        mutate(len = length(unlist(q_genes))) %>% arrange((len)) %>% pull(sd)
                      )
  ) 

ggplot(olap, aes(x = nw2, y = nw1)) +
  geom_tile(aes(fill=pct_overlap), alpha = .8) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  # theme(axis.text.x = element_blank(), legend.position = 'bottom') +
  # scale_fill_gradient2('% Total', low = 'white', high = '4a66ac', na.value = 'grey90') +
  viridis::scale_fill_viridis("% Total", option = "A", direction = -1)+
  # scale_x_discrete(position = "top") +
  geom_text(aes(label = intersect ), color = 'grey66', size = 2.5) +
  labs(x='',y='', title = 'Query Genes') 

```

input genes (overlap with base net)
```{r fig.width=11, fig.height=9}

olap <- crossing(nw1 = nw.dat$sd, nw2 = nw.dat$sd) %>% 
    group_by(nw1,nw2) %>% 
    mutate(.keep = 'all', 
           intersect = length(intersect(
             nw.dat %>% filter(sd == nw1) %>% pull(input_genes) %>% unlist(),
             nw.dat %>% filter(sd == nw2) %>% pull(input_genes) %>% unlist()
             )),
             len_nw1 = nw.dat %>% filter(sd == nw1) %>% pull(input_genes) %>% unlist() %>% length(),
             len_nw2 = nw.dat %>% filter(sd == nw2) %>% pull(input_genes) %>% unlist() %>% length()
           ) %>% 
    ungroup() %>% group_by(nw1) %>% 
    mutate(.keep = 'all', pct_overlap = intersect / intersect[which(nw2 == nw1)]) %>% 
    ungroup()

olap <- olap %>% 
    mutate(
      nw1 = fct_relevel(
        nw1, 
        nw.dat %>% select(sd, input_genes) %>% distinct() %>% 
          mutate(len = length(unlist(input_genes))) %>% arrange(desc(len)) %>% pull(sd) ),
      nw2 = fct_relevel(
        nw2, 
        nw.dat %>% select(sd, input_genes) %>% distinct() %>% 
          mutate(len = length(unlist(input_genes))) %>% arrange(desc(len)) %>% pull(sd) )
    ) 

olap %>% 
  ggplot(., aes(x = nw2, y = nw1)) +
  geom_tile(aes(fill=pct_overlap), alpha = .8) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  # theme(axis.text.x = element_blank(), legend.position = 'bottom') +
  # scale_fill_gradient2('% Total', low = 'white', high = '4a66ac', na.value = 'grey90') +
  viridis::scale_fill_viridis("% Total", option = "A", direction = -1)+
  # scale_x_discrete(position = "top") +
  geom_text(aes(label = intersect ), color = 'grey66', size = 2.5) +
  labs(x='',y='', title = 'input genes', subtitle = 'query overlap with filtered base network nodes') 

```



### Nodes

```{r fig.width=11, fig.height=9}

olap <- crossing(nw1 = nw.dat$sd, nw2 = nw.dat$sd) %>% 
    group_by(nw1,nw2) %>% 
    mutate(.keep = 'all', 
           intersect = length(intersect(
             nw.dat %>% filter(sd == nw1) %>% pull(nodes) %>% unlist(),
             nw.dat %>% filter(sd == nw2) %>% pull(nodes) %>% unlist()
             )),
             len_nw1 = nw.dat %>% filter(sd == nw1) %>% pull(nodes) %>% unlist() %>% length(),
             len_nw2 = nw.dat %>% filter(sd == nw2) %>% pull(nodes) %>% unlist() %>% length()
           ) %>% 
    ungroup() %>% group_by(nw1) %>% 
    mutate(.keep = 'all', pct_overlap = intersect / intersect[which(nw2 == nw1)]) %>% 
    ungroup()

olap <- olap %>% 
    mutate(
      nw1 = fct_relevel(
        nw1, 
        nw.dat %>% select(sd, nodes) %>% distinct() %>% 
          mutate(len = length(unlist(nodes))) %>% arrange(desc(len)) %>% pull(sd) ),
      nw2 = fct_relevel(
        nw2, 
        nw.dat %>% select(sd, nodes) %>% distinct() %>% 
          mutate(len = length(unlist(nodes))) %>% arrange(desc(len)) %>% pull(sd) )
    ) 

olap %>% 
  ggplot(., aes(x = nw2, y = nw1)) +
  geom_tile(aes(fill=pct_overlap), alpha = .8) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  # theme(axis.text.x = element_blank(), legend.position = 'bottom') +
  # scale_fill_gradient2('% Total', low = 'white', high = '4a66ac', na.value = 'grey90') +
  viridis::scale_fill_viridis("% Total", option = "A", direction = -1)+
  # scale_x_discrete(position = "top") +
  geom_text(aes(label = intersect ), color = 'grey66', size = 2.5) +
  labs(x='',y='', title = 'common nodes') 

```


### Added Nodes

```{r fig.width=11, fig.height=9}

olap <- crossing(nw1 = nw.dat$sd, nw2 = nw.dat$sd) %>% 
    group_by(nw1,nw2) %>% 
    mutate(.keep = 'all', 
           intersect = length(intersect(
             nw.dat %>% filter(sd == nw1) %>% pull(added_genes) %>% unlist(),
             nw.dat %>% filter(sd == nw2) %>% pull(added_genes) %>% unlist()
             )),
             len_nw1 = nw.dat %>% filter(sd == nw1) %>% pull(added_genes) %>% unlist() %>% length(),
             len_nw2 = nw.dat %>% filter(sd == nw2) %>% pull(added_genes) %>% unlist() %>% length()
           ) %>% 
    ungroup() %>% group_by(nw1) %>% 
    mutate(.keep = 'all', pct_overlap = intersect / intersect[which(nw2 == nw1)]) %>% 
    ungroup()

olap <- olap %>% 
    mutate(
      nw1 = fct_relevel(
        nw1, 
        nw.dat %>% select(sd, added_genes) %>% distinct() %>% 
          mutate(len = length(unlist(added_genes))) %>% arrange(desc(len)) %>% pull(sd) ),
      nw2 = fct_relevel(
        nw2, 
        nw.dat %>% select(sd, added_genes) %>% distinct() %>% 
          mutate(len = length(unlist(added_genes))) %>% arrange(desc(len)) %>% pull(sd) )
    ) 

olap %>% 
  ggplot(., aes(x = nw2, y = nw1)) +
  geom_tile(aes(fill=pct_overlap), alpha = .8) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  # theme(axis.text.x = element_blank(), legend.position = 'bottom') +
  # scale_fill_gradient2('% Total', low = 'white', high = '4a66ac', na.value = 'grey90') +
  viridis::scale_fill_viridis("% Total", option = "A", direction = -1)+
  # scale_x_discrete(position = "top") +
  geom_text(aes(label = intersect ), color = 'grey66', size = 2.5) +
  labs(x='',y='', title = 'nodes added by trace') 

```


### Edges

```{r fig.width=11, fig.height=9}

olap <- crossing(nw1 = nw.dat$sd, nw2 = nw.dat$sd) %>% 
    group_by(nw1,nw2) %>% 
    mutate(.keep = 'all', 
           intersect = length(intersect(
             nw.dat %>% filter(sd == nw1) %>% pull(edges) %>% unlist(),
             nw.dat %>% filter(sd == nw2) %>% pull(edges) %>% unlist()
             )),
             len_nw1 = nw.dat %>% filter(sd == nw1) %>% pull(edges) %>% unlist() %>% length(),
             len_nw2 = nw.dat %>% filter(sd == nw2) %>% pull(edges) %>% unlist() %>% length()
           ) %>% 
    ungroup() %>% group_by(nw1) %>% 
    mutate(.keep = 'all', pct_overlap = intersect / intersect[which(nw2 == nw1)]) %>% 
    ungroup()

olap <- olap %>% 
    mutate(
      nw1 = fct_relevel(
        nw1, 
        nw.dat %>% select(sd, edges) %>% distinct() %>% 
          mutate(len = length(unlist(edges))) %>% arrange(desc(len)) %>% pull(sd) ),
      nw2 = fct_relevel(
        nw2, 
        nw.dat %>% select(sd, edges) %>% distinct() %>% 
          mutate(len = length(unlist(edges))) %>% arrange(desc(len)) %>% pull(sd) )
    ) 

olap %>% 
  ggplot(., aes(x = nw2, y = nw1)) +
  geom_tile(aes(fill=pct_overlap), alpha = .8) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  # theme(axis.text.x = element_blank(), legend.position = 'bottom') +
  # scale_fill_gradient2('% Total', low = 'white', high = '4a66ac', na.value = 'grey90') +
  viridis::scale_fill_viridis("% Total", option = "A", direction = -1)+
  # scale_x_discrete(position = "top") +
  geom_text(aes(label = intersect ), color = 'grey66', size = 1.5) +
  labs(x='',y='', title = 'common edges') 

```

### input, added, total nodes in common

```{r}
olap <- crossing(nw1 = nw.dat$sd, nw2 = nw.dat$sd) %>% 
  group_by(nw1,nw2) %>% 
  mutate(.keep = 'all', 
         
         input = length(intersect(
           nw.dat %>% filter(sd == nw1) %>% pull(input_genes) %>% unlist(),
           nw.dat %>% filter(sd == nw2) %>% pull(input_genes) %>% unlist()
           )),
         
         added = length(intersect(
           nw.dat %>% filter(sd == nw1) %>% pull(added_genes) %>% unlist(),
           nw.dat %>% filter(sd == nw2) %>% pull(added_genes) %>% unlist()
             )),
         
         total = length(intersect(
             nw.dat %>% filter(sd == nw1) %>% pull(nodes) %>% unlist(),
             nw.dat %>% filter(sd == nw2) %>% pull(nodes) %>% unlist()
             )),
         
         len_nw1 = nw.dat %>% filter(sd == nw1) %>% pull(nodes) %>% unlist() %>% length(),
         len_nw2 = nw.dat %>% filter(sd == nw2) %>% pull(nodes) %>% unlist() %>% length()
         
         ) %>% 
  ungroup() %>% group_by(nw1) %>% 
  mutate(.keep = 'all', 
         input_overlap = input / input[which(nw2 == nw1)],
         added_overlap = added / added[which(nw2 == nw1)],
         total_overlap = total / total[which(nw2 == nw1)],
         ) %>% 
  ungroup() 

olap <- olap %>% 
  pivot_longer(input:total, names_to = 'set', values_to = 'n') %>% 
  # pivot_longer(ends_with('_overlap')) %>% distinct() %>% 
  mutate(
    set = fct_relevel(set, c('total','input','added')), 
    pct = n / len_nw1,
    nw1 = fct_relevel(
        nw1, 
        nw.dat %>% select(sd, nodes) %>% distinct() %>% 
          mutate(len = length(unlist(nodes))) %>% arrange(desc(len)) %>% pull(sd) ),
    nw2 = fct_relevel(
        nw2, 
        nw.dat %>% select(sd, nodes) %>% distinct() %>% 
          mutate(len = length(unlist(nodes))) %>% arrange(desc(len)) %>% pull(sd) )
    ) 
```


```{r fig.width=25, fig.height=9}

olap %>% 
  ggplot(., aes(x = nw2, y = nw1)) +
  geom_tile(aes(fill=pct), alpha = .8) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  # theme(axis.text.x = element_blank(), legend.position = 'bottom') +
  # scale_fill_gradient2('% Total', low = 'white', high = '4a66ac', na.value = 'grey90') +
  viridis::scale_fill_viridis("% Total Nodes", option = "A", direction = -1)+
  # scale_x_discrete(position = "top") +
  geom_text(aes(label = round(pct,2) ), color = 'grey66', size = 2.5) +
  facet_wrap(~set, nrow = 1)+
  labs(x='',y='') 

```
```{r fig.width=18, fig.height=9}

olap %>%
  filter(set != 'total') %>% 
  ggplot(., aes(x = nw2, y = nw1)) +
  geom_tile(aes(fill=pct), alpha = .8) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  # theme(axis.text.x = element_blank(), legend.position = 'bottom') +
  # scale_fill_gradient2('% Total', low = 'white', high = '4a66ac', na.value = 'grey90') +
  viridis::scale_fill_viridis("% Total Nodes", option = "A", direction = -1)+
  # scale_x_discrete(position = "top") +
  geom_text(aes(label = round(pct,2) ), color = 'grey66', size = 2.5) +
  facet_wrap(~set, nrow = 1)+
  labs(x='',y='') 

```

## Query vs Added gene scores  
```{r}
tmp <- nw.dat %>% 
  select(bd, sd, input_genes, added_genes) %>% 
  pivot_longer(cols = c(input_genes, added_genes)) %>% 
  unnest(value) %>% 
  left_join(
    ., scores %>% select(value = GeneName, Overall, GeneticsScore, OmicsScore),
    by = 'value', na_matches = 'never'
  ) %>% 
  bind_rows(
    scores %>% select(value = GeneName, Overall, GeneticsScore, OmicsScore) %>% 
      mutate(name = 'all_scores')
  ) %>% 
  mutate(
    name = factor(name, levels = c('input_genes','added_genes','all_scores'))
  )
```


```{r fig.width=6, fig.height=4}
tmp %>% 
  select(-sd) %>% distinct() %>% 
  rename(set = name, gene = value) %>% 
  ggplot(aes(Overall))+
  theme(legend.position = 'top') + 
  geom_density(aes(fill = set, color = set), alpha = .3)
  # geom_histogram(aes(fill = set), alpha = .8, position='dodge')
```

```{r fig.width=10, fig.height=4}
tmp %>% 
  select(-sd) %>% distinct() %>% 
  rename(set = name, gene = value) %>% 
  pivot_longer(Overall:OmicsScore) %>% 
  filter(value >0) %>% 
  ggplot(aes(value))+
  theme(legend.position = 'top') + 
  geom_density(aes(fill = set), color = 'grey70', alpha = .3)+
  # geom_histogram(aes(fill = set),  alpha = .8, position='dodge')+
  labs(x='score')+
  facet_grid(~name, scales = 'free')
```

```{r fig.width=5, fig.height=20}
tmp %>% 
  rename(set = name, gene = value) %>% 
  filter(set!='all_scores') %>% 
  pivot_longer(Overall:OmicsScore) %>% 
  filter(value > 0) %>% 
  ggplot(aes(value))+
  theme(legend.position = 'top') + 
  # geom_density(aes(fill = set, color = set), alpha = .3)+
  geom_histogram(aes(fill = set), alpha = .8, position='dodge')+
  facet_grid(sd~name, scales = 'free')
```

```{r fig.width=14, fig.height=10}
tmp %>% 
  mutate(sd = paste0(bd,'\n',sd)) %>% 
  filter( name != 'all_scores' ) %>% 
  rename(set = name, gene = value) %>% 
  ggplot(aes(Overall))+
  theme(legend.position = 'top') + 
  # geom_density(aes(fill = set), color = 'grey70', alpha = .3)+
  geom_histogram(aes(fill = set), alpha = .8, position='dodge')+
  labs(x = 'TREAT-AD Target Risk Score')+
  facet_wrap(~sd, ncol = 6, scales = 'free_y')  #, scales = 'free'
```

## Biodom Enrichment - NW nodes

```{r}
univ <-as.data.frame(org.Hs.eg.db::org.Hs.egGO) %>%
  pull(gene_id) %>%
  unique() %>%
  gprofiler2::gconvert(., organism = 'hsapiens', target = 'HGNC', numeric_ns = 'ENTREZGENE_ACC') %>% 
  as_tibble() %>% 
  pull('name') %>%
  intersect(., names(V(undir_node_edge)) )

gl <- nw.dat %>%
  select(bd, sd, nodes, q_genes, added_genes) %>%
  pivot_longer(nodes:added_genes) %>%
  rowwise() %>%
  mutate(
    enr = gprofiler2::gost( query = unlist(value),
                            organism = 'hsapiens',
                            domain_scope = 'custom',
                            custom_bg = univ,
                            sources = 'GO'
                            ) %>%
      .$result %>%
      list(),
    enr = anno.enr(enr,
                   GO_ID_column = 'term_id',
                   biodomain_table = biodom,
                   domain_colors = biodom %>% select(domain = Biodomain, abbr:color) %>% distinct()) %>%
      list()
  ) %>% select(bd, sd, name, value, enr) %>%
  unnest(enr)
```


```{r warning=FALSE, fig.width=14, fig.height=7}
thresh = 1e-25

tmp <- gl %>% filter(bd == 'Mitochondrial Metabolism', Biodomain != 'none')

bdt <- bd.tally(tmp %>% filter(p_value <= thresh) %>% pull(term_name), biodom)

tmp = tmp %>%
  rowwise() %>%
  # mutate(bd = paste0(bd,'\n', length(unique(unlist(value))), ' nodes added') ) %>%
  mutate(Biodomain = factor(Biodomain, levels = bdt$domain %>% str_subset('none', negate = T) %>% c('none',.) ),
         sd = str_replace_all(sd, '_','\n'),
         name = factor(name, levels = c('q_genes', 'added_genes', 'nodes'))
         )

tmp %>%
  ggplot(aes( -log10(p_value), Biodomain ))+
  geom_violin(data = subset(tmp, p_value <= thresh), aes(color = color), scale = 'width')+
  geom_jitter(data = subset(tmp, p_value <= thresh), aes(color = color), alpha = .7)+
  scale_color_identity()+
  # xlim(c(0,30))+
  # theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+
  labs(y = '', title = unique(tmp$bd), subtitle = paste0('enrichment threshold: ', thresh))+
  facet_grid(name~sd, scales='free_x') #, scales = 'free_x'
```


```{r warning=FALSE, fig.width=14, fig.height=7}
thresh = 1e-25

tmp <- gl %>% filter(bd == 'Synapse', Biodomain != 'none')

bdt <- bd.tally(tmp %>% filter(p_value <= thresh) %>% pull(term_name), biodom)

tmp = tmp %>%
  rowwise() %>%
  # mutate(bd = paste0(bd,'\n', length(unique(unlist(value))), ' nodes added') ) %>%
  mutate(Biodomain = factor(Biodomain, levels = bdt$domain %>% str_subset('none', negate = T) %>% c('none',.) ),
         sd = str_replace_all(sd, '_','\n'),
         name = factor(name, levels = c('q_genes', 'added_genes', 'nodes'))
         )

tmp %>%
  ggplot(aes( -log10(p_value), Biodomain ))+
  geom_violin(data = subset(tmp, p_value <= thresh), aes(color = color), scale = 'width')+
  geom_jitter(data = subset(tmp, p_value <= thresh), aes(color = color), alpha = .7)+
  scale_color_identity()+
  # xlim(c(0,30))+
  # theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+
  labs(y = '', title = unique(tmp$bd), subtitle = paste0('enrichment threshold: ', thresh))+
  facet_grid(name~sd, scales='free_x') #, scales = 'free_x'
```

```{r warning=FALSE, fig.width=12, fig.height=7}
thresh = 1e-20

tmp <- gl %>% filter(bd == 'Immune Response', Biodomain != 'none')

bdt <- bd.tally(tmp %>% filter(p_value <= thresh) %>% pull(term_name), biodom)

tmp = tmp %>%
  rowwise() %>%
  # mutate(bd = paste0(bd,'\n', length(unique(unlist(value))), ' nodes added') ) %>%
  mutate(Biodomain = factor(Biodomain, levels = bdt$domain %>% str_subset('none', negate = T) %>% c('none',.) ),
         sd = str_replace_all(sd, '_','\n'),
         name = factor(name, levels = c('q_genes', 'added_genes', 'nodes'))
         )

tmp %>%
  ggplot(aes( -log10(p_value), Biodomain ))+
  geom_violin(data = subset(tmp, p_value <= thresh), aes(color = color), scale = 'width')+
  geom_jitter(data = subset(tmp, p_value <= thresh), aes(color = color), alpha = .7)+
  scale_color_identity()+
  # xlim(c(0,30))+
  # theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+
  labs(y = '', title = unique(tmp$bd), subtitle = paste0('enrichment threshold: ', thresh))+
  facet_grid(name~sd, scales='free_x') #, scales = 'free_x'
```

```{r warning=FALSE, fig.width=12, fig.height=7}
thresh = 1e-20

tmp <- gl %>% filter(bd == 'Lipid Metabolism', Biodomain != 'none')

bdt <- bd.tally(tmp %>% filter(p_value <= thresh) %>% pull(term_name), biodom)

tmp = tmp %>%
  rowwise() %>%
  # mutate(bd = paste0(bd,'\n', length(unique(unlist(value))), ' nodes added') ) %>%
  mutate(Biodomain = factor(Biodomain, levels = bdt$domain %>% str_subset('none', negate = T) %>% c('none',.) ),
         sd = str_replace_all(sd, '_','\n'),
         name = factor(name, levels = c('q_genes', 'added_genes', 'nodes'))
         )

tmp %>%
  ggplot(aes( -log10(p_value), Biodomain ))+
  geom_violin(data = subset(tmp, p_value <= thresh), aes(color = color), scale = 'width')+
  geom_jitter(data = subset(tmp, p_value <= thresh), aes(color = color), alpha = .7)+
  scale_color_identity()+
  # xlim(c(0,30))+
  # theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+
  labs(y = '', title = unique(tmp$bd), subtitle = paste0('enrichment threshold: ', thresh))+
  facet_grid(name~sd, scales='free_x') #, scales = 'free_x'
```


```{r warning=FALSE, fig.width=5, fig.height=5}
thresh = 1e-20

tmp <- gl %>% filter(bd == 'Epigenetic', Biodomain != 'none')

bdt <- bd.tally(tmp %>% filter(p_value <= thresh) %>% pull(term_name), biodom)

tmp = tmp %>%
  rowwise() %>%
  # mutate(bd = paste0(bd,'\n', length(unique(unlist(value))), ' nodes added') ) %>%
  mutate(Biodomain = factor(Biodomain, levels = bdt$domain %>% str_subset('none', negate = T) %>% c('none',.) ),
         sd = str_replace_all(sd, '_','\n'),
         name = factor(name, levels = c('q_genes', 'added_genes', 'nodes'))
         )

tmp %>%
  ggplot(aes( -log10(p_value), Biodomain ))+
  geom_violin(data = subset(tmp, p_value <= thresh), aes(color = color), scale = 'width')+
  geom_jitter(data = subset(tmp, p_value <= thresh), aes(color = color), alpha = .7)+
  scale_color_identity()+
  # xlim(c(0,30))+
  # theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+
  labs(y = '', title = unique(tmp$bd), subtitle = paste0('enrichment threshold: ', thresh))+
  facet_grid(name~sd, scales='free_x') #, scales = 'free_x'
```


# Session
```{r}
sessionInfo()
```

